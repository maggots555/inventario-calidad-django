{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes Avanzados - Score Card - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reportes.css' %}">
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-6">
                <i class="bi bi-file-earmark-bar-graph text-info"></i>
                Reportes Avanzados
            </h1>
            <p class="text-muted">Análisis detallado de incidencias de calidad - Fase 1</p>
        </div>
        <div class="col-md-4 text-end no-print">
            <div class="export-buttons">
                <a href="{% url 'scorecard:api_exportar_excel' %}" class="btn btn-success" download>
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </a>
                <button onclick="window.print()" class="btn btn-secondary">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
                <a href="{% url 'scorecard:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4 no-print">
        <div class="col-12">
            <div class="filter-card">
                <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros Avanzados</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="filtroFechaInicio">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="filtroFechaFin">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sucursal</label>
                        <select class="form-select" id="filtroSucursal">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Técnico</label>
                        <select class="form-select" id="filtroTecnico">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label">Área Detectora</label>
                        <select class="form-select" id="filtroArea">
                            <option value="">Todas</option>
                            <option value="Ventas">Ventas</option>
                            <option value="Bodega">Bodega</option>
                            <option value="Técnicos">Técnicos</option>
                            <option value="Garantías">Garantías</option>
                            <option value="Administración">Administración</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Severidad</label>
                        <select class="form-select" id="filtroSeveridad">
                            <option value="">Todas</option>
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                            <option value="critica">Crítica</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="filtroEstado">
                            <option value="">Todos</option>
                            <option value="abierta">Abierta</option>
                            <option value="en_proceso">En Proceso</option>
                            <option value="cerrada">Cerrada</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary flex-fill" onclick="aplicarFiltros()">
                                <i class="bi bi-search"></i> Aplicar
                            </button>
                            <button class="btn btn-secondary" onclick="limpiarFiltros()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-white-50">
                        <i class="bi bi-info-circle"></i> Los filtros se aplican a todos los tabs del reporte
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema de Tabs -->
    <div class="tabs-container no-print">
        <ul class="tabs-nav">
            <li class="tab-item">
                <a href="#" class="tab-link active" data-tab="tab-resumen">
                    <i class="bi bi-speedometer2"></i> Resumen Ejecutivo
                </a>
            </li>
            <li class="tab-item">
                <a href="#" class="tab-link" data-tab="tab-atribuibilidad">
                    <i class="bi bi-diagram-3"></i> Atribuibilidad
                </a>
            </li>
            <li class="tab-item">
                <a href="#" class="tab-link" data-tab="tab-tecnicos">
                    <i class="bi bi-people"></i> Análisis por Técnico
                </a>
            </li>
            <li class="tab-item">
                <a href="#" class="tab-link" data-tab="tab-reincidencias">
                    <i class="bi bi-arrow-repeat"></i> Reincidencias
                </a>
            </li>
            <li class="tab-item">
                <a href="#" class="tab-link" data-tab="tab-tiempos">
                    <i class="bi bi-clock-history"></i> Tiempos
                </a>
            </li>
            <li class="tab-item">
                <a href="#" class="tab-link" data-tab="tab-componentes">
                    <i class="bi bi-gear"></i> Componentes
                </a>
            </li>
            <li class="tab-item">
                <a href="#" class="tab-link" data-tab="tab-notificaciones">
                    <i class="bi bi-envelope"></i> Notificaciones
                </a>
            </li>
        </ul>
    </div>

    <!-- Contenido de Tabs -->
    <div class="tab-content-wrapper">
        
        <!-- ==========================================
             TAB 1: RESUMEN EJECUTIVO
             ========================================== -->
        <div id="tab-resumen" class="tab-pane active">
            <!-- Resumen Ejecutivo -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-clipboard-data"></i> Resumen Ejecutivo
                    </h3>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <h3 id="report-total">-</h3>
                        <p>Total Incidencias</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="bi bi-exclamation-octagon" style="font-size: 2rem;"></i>
                        <h3 id="report-criticas">-</h3>
                        <p>Incidencias Críticas</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="bi bi-arrow-repeat" style="font-size: 2rem;"></i>
                        <h3 id="report-reincidencias">-</h3>
                        <p>Reincidencias</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="bi bi-calendar-check" style="font-size: 2rem;"></i>
                        <h3 id="report-promedio">-</h3>
                        <p>Días Promedio Cierre</p>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Pareto -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-bar-chart-line text-primary"></i> Gráfico de Pareto - Fallos Más Frecuentes
                            <small class="text-muted">(Principio 80/20)</small>
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="paretoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tendencia Trimestral -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-graph-up text-success"></i> Tendencia Trimestral
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="tendenciaTriChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-pie-chart text-warning"></i> Por Tipo de Fallo
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="tipoFalloChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heatmap por Sucursal -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-thermometer-half text-danger"></i> Análisis por Sucursal (Heatmap)
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="heatmapChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparativa Mensual vs Métricas -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-calendar-month text-info"></i> Comparativa Mensual
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="comparativaMensualChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-speedometer2 text-primary"></i> Métricas de Calidad
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="metricasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TAB 2: ANÁLISIS DE ATRIBUIBILIDAD
             ========================================== -->
        <div id="tab-atribuibilidad" class="tab-pane">
            <!-- KPIs de Atribuibilidad -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-diagram-3"></i> Análisis de Atribuibilidad
                    </h3>
                    <p class="text-muted">
                        Análisis detallado de incidencias atribuibles vs no atribuibles al técnico responsable
                    </p>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);">
                        <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                        <h3 id="kpi-atribuibles">-</h3>
                        <p>Atribuibles <span class="badge-percentage" id="kpi-porcentaje-atribuibles">-</span></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);">
                        <i class="bi bi-x-circle" style="font-size: 2rem;"></i>
                        <h3 id="kpi-no-atribuibles">-</h3>
                        <p>No Atribuibles <span class="badge-percentage" id="kpi-porcentaje-no-atribuibles">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Atribuibilidad -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-pie-chart text-success"></i> Distribución Atribuibilidad
                        </h4>
                        <div class="chart-wrapper-report small">
                            <canvas id="graficoAtribuibilidad"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-graph-up text-warning"></i> Tendencia Mensual
                        </h4>
                        <div class="chart-wrapper-report small">
                            <canvas id="tendenciaAtribuibilidad"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranking y Razones -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-trophy text-danger"></i> Top Técnicos con NO Atribuibles
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="rankingNoAtribuibles"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-tags text-info"></i> Razones de NO Atribuibilidad
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="distribucionRazones"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Justificaciones Recientes -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-file-text text-primary"></i> Justificaciones Recientes (Últimas 10)
                        </h4>
                        <div id="lista-justificaciones">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TAB 3: ANÁLISIS POR TÉCNICO
             ========================================== -->
        <div id="tab-tecnicos" class="tab-pane">
            <!-- KPIs de Técnicos -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-people"></i> Análisis Detallado por Técnico
                    </h3>
                    <p class="text-muted">
                        Scorecard completo de desempeño de cada técnico con múltiples métricas
                    </p>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-person-badge text-primary" style="font-size: 2.5rem;"></i>
                            <h4 class="mt-2 mb-0" id="total-tecnicos">-</h4>
                            <small class="text-muted">Técnicos Activos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-star text-warning" style="font-size: 2.5rem;"></i>
                            <h4 class="mt-2 mb-0" id="promedio-score">-</h4>
                            <small class="text-muted">Score Promedio</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-clock text-info" style="font-size: 2.5rem;"></i>
                            <h4 class="mt-2 mb-0" id="promedio-dias-tecnicos">-</h4>
                            <small class="text-muted">Días Prom. Resolución</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranking de Técnicos -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-bar-chart text-primary"></i> Ranking Top 10 Técnicos
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="rankingTecnicosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Mejores -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-trophy-fill text-warning"></i> Top 3 Mejores Técnicos
                        </h4>
                        <div id="top-mejores">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Requieren Atención -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-exclamation-triangle text-warning"></i> Técnicos que Requieren Atención
                        </h4>
                        <div id="top-atencion">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scorecard Completo -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-table text-success"></i> Scorecard Completo de Técnicos
                        </h4>
                        <div id="scorecard-completo" style="overflow-x: auto;">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TAB 4: ANÁLISIS DE REINCIDENCIAS (FASE 2)
             ========================================== -->
        <div id="tab-reincidencias" class="tab-pane">
            <!-- KPIs de Reincidencias -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-arrow-repeat"></i> Análisis de Reincidencias
                    </h3>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <i class="bi bi-arrow-repeat" style="font-size: 2rem;"></i>
                        <h3 id="kpi-total-reincidencias">-</h3>
                        <p>Total Reincidencias</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <i class="bi bi-percent" style="font-size: 2rem;"></i>
                        <h3 id="kpi-porcentaje-reincidencias">-</h3>
                        <p>% Reincidencias</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <i class="bi bi-calendar-range" style="font-size: 2rem;"></i>
                        <h3 id="kpi-tiempo-entre-reincidencias">-</h3>
                        <p>Días Entre Reincidencias</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">
                        <i class="bi bi-link-45deg" style="font-size: 2rem;"></i>
                        <h3 id="kpi-cadenas-largas">-</h3>
                        <p>Cadenas Largas (3+)</p>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Reincidencias por Técnico -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-person-badge text-warning"></i> Reincidencias por Técnico
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="graficoReincidenciasTecnico"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-tools text-danger"></i> Top 10 Equipos con Más Reincidencias
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="graficoTopEquiposReincidentes"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tendencia y Distribución -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-graph-up text-info"></i> Tendencia de Reincidencias (6 Meses)
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="tendenciaReincidencias"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-pie-chart text-success"></i> Por Categoría
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="distribucionCategoriasReincidencias"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Cadenas de Reincidencias -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-list-task text-primary"></i> Cadenas de Reincidencias Detectadas
                        </h4>
                        <div id="tabla-cadenas-reincidencias">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TAB 5: ANÁLISIS DE TIEMPOS (FASE 2)
             ========================================== -->
        <div id="tab-tiempos" class="tab-pane">
            <!-- KPIs de Tiempos -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-clock-history"></i> Análisis de Tiempos de Cierre
                    </h3>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <i class="bi bi-clock" style="font-size: 2rem;"></i>
                        <h3 id="kpi-tiempo-promedio-cierre">-</h3>
                        <p>Tiempo Promedio Cierre</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                        <i class="bi bi-speedometer2" style="font-size: 2rem;"></i>
                        <h3 id="kpi-tiempo-minimo">-</h3>
                        <p>Tiempo Mínimo</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                        <h3 id="kpi-tiempo-maximo">-</h3>
                        <p>Tiempo Máximo</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <h3 id="kpi-total-alertas">-</h3>
                        <p>Alertas de Tiempo</p>
                    </div>
                </div>
            </div>

            <!-- Distribución de Tiempos -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-bar-chart text-info"></i> Distribución de Tiempos de Cierre
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="distribucionTiempos"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rankings de Técnicos -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-trophy text-success"></i> Técnicos Más Rápidos
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="rankingRapidos"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-hourglass text-danger"></i> Técnicos Más Lentos
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="rankingLentos"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tendencia y Análisis por Severidad -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-graph-up text-primary"></i> Tendencia de Tiempos (6 Meses)
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="tendenciaTiempos"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-exclamation-circle text-warning"></i> Por Severidad
                        </h4>
                        <div class="chart-wrapper-report">
                            <canvas id="analisisPorSeveridad"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Alertas -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container-report">
                        <h4 class="mb-3">
                            <i class="bi bi-bell text-danger"></i> Incidencias con Alertas de Tiempo (>15 días)
                        </h4>
                        <div id="lista-alertas-tiempos">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TAB 6: COMPONENTES
             ========================================== -->
        <div id="tab-componentes" class="tab-pane">
            <!-- KPIs de Componentes -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-gear-fill"></i> Análisis de Componentes Defectuosos
                    </h3>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <i class="bi bi-gear-fill" style="font-size: 2rem;"></i>
                        <h3 id="total-con-componente">-</h3>
                        <p>Incidencias con Componente</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                        <i class="bi bi-percent" style="font-size: 2rem;"></i>
                        <h3 id="porcentaje-con-componente">-</h3>
                        <p>% Con Componente Identificado</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <i class="bi bi-collection" style="font-size: 2rem;"></i>
                        <h3 id="componentes-unicos">-</h3>
                        <p>Componentes Únicos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i>
                        <h3 id="componente-mas-frecuente">-</h3>
                        <p>Componente Más Frecuente</p>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Componentes -->
            <div class="row">
                <!-- Top Componentes con Más Fallas -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-bar-chart"></i> Top 10 Componentes con Más Fallas
                        </h5>
                        <div style="position: relative; min-height: 300px; max-height: 600px; overflow-y: auto;">
                            <canvas id="graficoTopComponentes"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Distribución de Severidad por Componente -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-layers"></i> Severidad por Componente (Top 10)
                        </h5>
                        <div style="position: relative; min-height: 300px; max-height: 600px; overflow-y: auto;">
                            <canvas id="graficoSeveridadComponentes"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tendencia de Componentes -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-graph-up"></i> Tendencia Últimos 6 Meses (Top 5 Componentes)
                        </h5>
                        <div style="position: relative; height: 400px;">
                            <canvas id="tendenciaComponentes"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Componentes Críticos -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-shield-exclamation"></i> Componentes Críticos (>30% Incidencias Críticas)
                        </h5>
                        <div id="tabla-componentes-criticos">
                            <p class="text-center text-muted">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             TAB 7: NOTIFICACIONES
             ========================================== -->
        <div id="tab-notificaciones" class="tab-pane">
            <!-- KPIs de Notificaciones -->
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="report-title">
                        <i class="bi bi-envelope-fill"></i> Análisis de Notificaciones del Sistema
                    </h3>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <i class="bi bi-envelope-fill" style="font-size: 2rem;"></i>
                        <h3 id="total-notificaciones">-</h3>
                        <p>Total Notificaciones</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                        <i class="bi bi-check-circle-fill" style="font-size: 2rem;"></i>
                        <h3 id="tasa-exito">-</h3>
                        <p>Tasa de Éxito</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        <i class="bi bi-clock-fill" style="font-size: 2rem;"></i>
                        <h3 id="tiempo-promedio-notif">-</h3>
                        <p>Tiempo Promedio (min)</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <i class="bi bi-x-circle-fill" style="font-size: 2rem;"></i>
                        <h3 id="notificaciones-fallidas">-</h3>
                        <p>Notificaciones Fallidas</p>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Notificaciones - Fila 1 -->
            <div class="row">
                <!-- Distribución por Tipo -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-pie-chart"></i> Distribución por Tipo de Notificación
                        </h5>
                        <div style="position: relative; height: 300px;">
                            <canvas id="graficoTiposNotificacion"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tendencia de Notificaciones -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-graph-up"></i> Tendencia Últimos 6 Meses
                        </h5>
                        <div style="position: relative; height: 300px;">
                            <canvas id="tendenciaNotificaciones"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Notificaciones - Fila 2 -->
            <div class="row">
                <!-- Top Destinatarios -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-person-circle"></i> Top 10 Destinatarios Más Frecuentes
                        </h5>
                        <div style="position: relative; min-height: 300px; max-height: 600px; overflow-y: auto;">
                            <canvas id="graficoTopDestinatarios"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Distribución por Día de la Semana -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-calendar-week"></i> Distribución por Día de la Semana
                        </h5>
                        <div style="position: relative; height: 300px;">
                            <canvas id="graficoDiasSemana"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribución por Severidad -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-card">
                        <h5 class="chart-title">
                            <i class="bi bi-exclamation-diamond"></i> Notificaciones por Severidad de Incidencia
                        </h5>
                        <div style="position: relative; height: 300px;">
                            <canvas id="graficoSeveridadNotificaciones"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Volver al Dashboard -->
    <div class="row mt-4 mb-5 no-print">
        <div class="col-12 text-center">
            <a href="{% url 'scorecard:dashboard' %}" class="btn btn-outline-primary btn-lg">
                <i class="bi bi-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Script de reportes -->
<script src="{% static 'js/reportes.js' %}"></script>
{% endblock %}
