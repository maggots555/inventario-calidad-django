{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Score Card - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para el dashboard de Score Card */
    .kpi-card {
        transition: transform 0.2s;
        border-left: 4px solid;
    }
    
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .kpi-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-icon {
        font-size: 3rem;
        opacity: 0.3;
        position: absolute;
        right: 20px;
        top: 20px;
    }
    
    .chart-container {
        position: relative;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .chart-wrapper {
        position: relative;
        height: 350px;
    }
    
    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 50px;
        color: #6c757d;
    }
    
    .badge-percentage {
        font-size: 0.85rem;
        font-weight: normal;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="bi bi-shield-check text-primary"></i>
                Score Card - Control de Calidad
            </h1>
            <p class="text-muted">Dashboard de Incidencias y Análisis de Calidad</p>
        </div>
    </div>

    <!-- KPIs Principales -->
    <div class="row g-4 mb-4">
        <!-- Total de Incidencias -->
        <div class="col-xl-3 col-md-6">
            <div class="card kpi-card" style="border-left-color: #0d6efd;">
                <div class="card-body position-relative">
                    <i class="bi bi-exclamation-triangle stat-icon text-primary"></i>
                    <div class="kpi-label">Total Incidencias</div>
                    <div class="kpi-value text-primary" id="kpi-total">{{ total_incidencias|default:0 }}</div>
                    <a href="{% url 'scorecard:lista_incidencias' %}" class="btn btn-sm btn-outline-primary">
                        Ver todas <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Incidencias Abiertas -->
        <div class="col-xl-3 col-md-6">
            <div class="card kpi-card" style="border-left-color: #ffc107;">
                <div class="card-body position-relative">
                    <i class="bi bi-hourglass-split stat-icon text-warning"></i>
                    <div class="kpi-label">Incidencias Abiertas</div>
                    <div class="kpi-value text-warning" id="kpi-abiertas">{{ incidencias_abiertas|default:0 }}</div>
                    <small class="text-muted">Requieren atención</small>
                </div>
            </div>
        </div>

        <!-- Incidencias Críticas -->
        <div class="col-xl-3 col-md-6">
            <div class="card kpi-card" style="border-left-color: #dc3545;">
                <div class="card-body position-relative">
                    <i class="bi bi-exclamation-octagon stat-icon text-danger"></i>
                    <div class="kpi-label">Críticas</div>
                    <div class="kpi-value text-danger" id="kpi-criticas">{{ incidencias_criticas|default:0 }}</div>
                    <small class="text-muted">Prioridad alta</small>
                </div>
            </div>
        </div>

        <!-- Acción Rápida -->
        <div class="col-xl-3 col-md-6">
            <div class="card kpi-card" style="border-left-color: #28a745;">
                <div class="card-body text-center">
                    <i class="bi bi-plus-circle" style="font-size: 3rem; color: #28a745;"></i>
                    <div class="mt-3">
                        <a href="{% url 'scorecard:crear_incidencia' %}" class="btn btn-success btn-lg w-100">
                            <i class="bi bi-plus-lg"></i> Registrar Incidencia
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Secundarios -->
    <div class="row g-4 mb-4">
        <!-- Incidencias Cerradas -->
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle text-success" style="font-size: 2.5rem;"></i>
                    <h4 class="mt-2 mb-0" id="kpi-cerradas">-</h4>
                    <small class="text-muted">Incidencias Cerradas</small>
                </div>
            </div>
        </div>

        <!-- Reincidencias -->
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-repeat text-danger" style="font-size: 2.5rem;"></i>
                    <h4 class="mt-2 mb-0">
                        <span id="kpi-reincidencias">-</span>
                        <small class="badge-percentage text-muted" id="kpi-porcentaje-reincidencias"></small>
                    </h4>
                    <small class="text-muted">Reincidencias</small>
                </div>
            </div>
        </div>

        <!-- Promedio Días Cierre -->
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check text-info" style="font-size: 2.5rem;"></i>
                    <h4 class="mt-2 mb-0" id="kpi-promedio-dias">-</h4>
                    <small class="text-muted">Promedio Días Cierre</small>
                </div>
            </div>
        </div>

        <!-- Exportar Datos -->
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-excel text-success" style="font-size: 2.5rem;"></i>
                    <div class="mt-2">
                        <a href="{% url 'scorecard:api_exportar_excel' %}" class="btn btn-success btn-sm w-100" download>
                            <i class="bi bi-download"></i> Exportar Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje si no hay datos -->
    {% if total_incidencias == 0 %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading"><i class="bi bi-info-circle"></i> Bienvenido al Score Card</h4>
                <p>No hay incidencias registradas aún. Comienza registrando tu primera incidencia.</p>
                <hr>
                <p class="mb-0">
                    <a href="{% url 'scorecard:crear_incidencia' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Registrar Primera Incidencia
                    </a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráficos y Análisis -->
    <div class="row g-4 mb-4">
        <!-- Tendencia Mensual -->
        <div class="col-lg-8">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="chart-title mb-0">
                        <i class="bi bi-graph-up text-primary"></i> Tendencia de Incidencias (Últimos 6 Meses)
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="descargarGrafico('tendenciaChart')">
                        <i class="bi bi-download"></i> Descargar
                    </button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tendenciaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Distribución por Severidad -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h5 class="chart-title">
                    <i class="bi bi-pie-chart text-warning"></i> Distribución por Severidad
                </h5>
                <div class="chart-wrapper">
                    <canvas id="severidadChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda Fila de Gráficos -->
    <div class="row g-4 mb-4">
        <!-- Top 10 Técnicos -->
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="chart-title">
                    <i class="bi bi-person-badge text-danger"></i> Top 10 Técnicos con Más Incidencias
                </h5>
                <div class="chart-wrapper">
                    <canvas id="tecnicosChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Distribución por Categoría -->
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="chart-title">
                    <i class="bi bi-tags text-info"></i> Distribución por Categoría
                </h5>
                <div class="chart-wrapper">
                    <canvas id="categoriasChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tercera Fila de Gráficos -->
    <div class="row g-4 mb-4">
        <!-- Análisis por Sucursal -->
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="chart-title">
                    <i class="bi bi-building text-success"></i> Análisis por Sucursal
                </h5>
                <div class="chart-wrapper">
                    <canvas id="sucursalesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Componentes Más Afectados -->
        <div class="col-lg-6">
            <div class="chart-container">
                <h5 class="chart-title">
                    <i class="bi bi-cpu text-secondary"></i> Top 10 Componentes Más Afectados
                </h5>
                <div class="chart-wrapper">
                    <canvas id="componentesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Accesos Rápidos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Accesos Rápidos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{% url 'scorecard:lista_incidencias' %}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-list-ul"></i><br>Ver Incidencias
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'scorecard:reportes' %}" class="btn btn-outline-info w-100">
                                <i class="bi bi-file-earmark-bar-graph"></i><br>Reportes
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'scorecard:lista_categorias' %}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-tags"></i><br>Categorías
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'scorecard:lista_componentes' %}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-cpu"></i><br>Componentes
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Variables globales para los gráficos
let chartInstances = {};

/**
 * Función principal que se ejecuta al cargar la página
 * Obtiene los datos del servidor y crea todos los gráficos
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('Cargando dashboard Score Card...');
    cargarDatosDashboard();
});

/**
 * Obtiene los datos de la API y llama a las funciones para crear los gráficos
 */
function cargarDatosDashboard() {
    fetch("{% url 'scorecard:api_datos_dashboard' %}")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Datos recibidos:', data);
                
                // Actualizar KPIs adicionales
                actualizarKPIs(data.kpis);
                
                // Crear gráficos
                crearGraficoTendencia(data.tendencia_mensual);
                crearGraficoSeveridad(data.distribucion_severidad);
                crearGraficoTecnicos(data.ranking_tecnicos);
                crearGraficoCategorias(data.distribucion_categorias);
                crearGraficoSucursales(data.analisis_sucursales);
                crearGraficoComponentes(data.componentes_afectados);
                
            } else {
                console.error('Error al cargar datos:', data.error);
                mostrarMensajeError();
            }
        })
        .catch(error => {
            console.error('Error en la petición:', error);
            mostrarMensajeError();
        });
}

/**
 * Actualiza los KPIs secundarios en la interfaz
 */
function actualizarKPIs(kpis) {
    document.getElementById('kpi-total').textContent = kpis.total_incidencias;
    document.getElementById('kpi-abiertas').textContent = kpis.incidencias_abiertas;
    document.getElementById('kpi-criticas').textContent = kpis.incidencias_criticas;
    document.getElementById('kpi-cerradas').textContent = kpis.incidencias_cerradas;
    document.getElementById('kpi-reincidencias').textContent = kpis.reincidencias;
    document.getElementById('kpi-porcentaje-reincidencias').textContent = 
        `(${kpis.porcentaje_reincidencias}%)`;
    document.getElementById('kpi-promedio-dias').textContent = 
        `${kpis.promedio_dias_cierre} días`;
}

/**
 * Crea el gráfico de tendencia mensual (línea)
 */
function crearGraficoTendencia(datos) {
    const ctx = document.getElementById('tendenciaChart');
    
    chartInstances.tendenciaChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: datos.labels,
            datasets: [{
                label: 'Incidencias',
                data: datos.data,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#0d6efd',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return `Incidencias: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11 }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

/**
 * Crea el gráfico de distribución por severidad (dona)
 */
function crearGraficoSeveridad(datos) {
    const ctx = document.getElementById('severidadChart');
    
    chartInstances.severidadChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: datos.labels,
            datasets: [{
                data: datos.data,
                backgroundColor: datos.colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

/**
 * Crea el gráfico de ranking de técnicos (barras horizontales)
 */
function crearGraficoTecnicos(datos) {
    const ctx = document.getElementById('tecnicosChart');
    
    chartInstances.tecnicosChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datos.labels,
            datasets: [{
                label: 'Incidencias',
                data: datos.data,
                backgroundColor: '#dc3545',
                borderColor: '#dc3545',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 11 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    ticks: {
                        font: { size: 10 }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

/**
 * Crea el gráfico de distribución por categoría (pastel)
 */
function crearGraficoCategorias(datos) {
    const ctx = document.getElementById('categoriasChart');
    
    chartInstances.categoriasChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: datos.labels,
            datasets: [{
                data: datos.data,
                backgroundColor: datos.colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 10,
                        font: { size: 11 },
                        usePointStyle: true,
                        boxWidth: 12
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

/**
 * Crea el gráfico de análisis por sucursal (barras)
 */
function crearGraficoSucursales(datos) {
    const ctx = document.getElementById('sucursalesChart');
    
    // Generar colores aleatorios para cada sucursal
    const colores = generarColoresAleatorios(datos.labels.length);
    
    chartInstances.sucursalesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datos.labels,
            datasets: [{
                label: 'Incidencias',
                data: datos.data,
                backgroundColor: colores,
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11 }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

/**
 * Crea el gráfico de componentes más afectados (barras horizontales)
 */
function crearGraficoComponentes(datos) {
    const ctx = document.getElementById('componentesChart');
    
    chartInstances.componentesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: datos.labels,
            datasets: [{
                label: 'Incidencias',
                data: datos.data,
                backgroundColor: '#6c757d',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 11 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    ticks: {
                        font: { size: 10 }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

/**
 * Genera un array de colores aleatorios
 */
function generarColoresAleatorios(cantidad) {
    const colores = [
        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
        '#fd7e14', '#ffc107', '#28a745', '#20c997', '#17a2b8',
        '#6c757d', '#e83e8c', '#fd7e14', '#20c997', '#6610f2'
    ];
    return colores.slice(0, cantidad);
}

/**
 * Función para descargar un gráfico como imagen
 */
function descargarGrafico(chartId) {
    const chart = chartInstances[chartId];
    if (chart) {
        const url = chart.toBase64Image();
        const link = document.createElement('a');
        link.download = `${chartId}_${new Date().getTime()}.png`;
        link.href = url;
        link.click();
    }
}

/**
 * Muestra un mensaje de error si no se pueden cargar los datos
 */
function mostrarMensajeError() {
    const containers = document.querySelectorAll('.chart-wrapper');
    containers.forEach(container => {
        container.innerHTML = `
            <div class="loading-spinner">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                <p class="mt-3">Error al cargar los datos. Por favor recarga la página.</p>
            </div>
        `;
    });
}
</script>
{% endblock %}
