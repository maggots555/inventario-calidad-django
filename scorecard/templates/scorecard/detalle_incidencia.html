{% extends 'base.html' %}
{% load scorecard_filters %}

{% block title %}{{ incidencia.folio }} - Score Card - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado Modernizado -->
    <div class="detalle-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-6 mb-2">
                    <i class="bi bi-file-earmark-text text-info"></i>
                    {{ incidencia.folio }}
                    {% if not incidencia.es_atribuible %}
                    <span class="badge bg-info ms-2" title="Esta incidencia NO es atribuible al técnico">
                        <i class="bi bi-shield-x"></i> No Atribuible
                    </span>
                    {% endif %}
                </h1>
                <p class="text-muted fs-5 mb-0">Detalle completo de la incidencia</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <a href="{% url 'scorecard:editar_incidencia' incidencia.id %}" class="btn btn-warning btn-lg">
                    <i class="bi bi-pencil-fill"></i> Editar Incidencia
                </a>
            </div>
        </div>
    </div>

    <!-- Botones de Acción Rápida -->
    <div class="card acciones-rapidas-card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-lightning-charge-fill"></i> 
                Acciones Rápidas
            </h5>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                <!-- Enviar Notificación Manual -->
                <div class="col-xl-3 col-lg-6 col-md-6">
                    {% if incidencia.estado != 'cerrada' %}
                        <button type="button" class="btn-accion-individual btn-notificar w-100 h-100 p-4" id="btnAbrirModalNotificacion">
                            <i class="bi bi-send-fill fs-1 mb-3 text-secondary"></i>
                            <strong class="fs-5">Enviar Notificación</strong>
                            <small class="text-muted mt-2">Manual a destinatarios</small>
                        </button>
                    {% else %}
                        <div class="alert alert-accion-completada alert-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4 mb-0">
                            <i class="bi bi-send-slash-fill fs-1 mb-3"></i>
                            <strong class="fs-5">Notificaciones Deshabilitadas</strong>
                            <small class="text-muted mt-2">Incidencia cerrada</small>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Marcar NO Atribuible -->
                {% if incidencia.es_atribuible and incidencia.estado != 'cerrada' %}
                <div class="col-xl-3 col-lg-6 col-md-6">
                    <a href="{% url 'scorecard:marcar_no_atribuible' incidencia.id %}" class="btn-accion-individual btn-no-atribuible w-100 h-100 p-4">
                        <i class="bi bi-shield-x fs-1 mb-3 text-info"></i>
                        <strong class="fs-5">Marcar NO Atribuible</strong>
                        <small class="text-muted mt-2">No cuenta en scorecard</small>
                    </a>
                </div>
                {% elif not incidencia.es_atribuible %}
                <div class="col-xl-3 col-lg-6 col-md-6">
                    <div class="alert alert-accion-completada alert-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4 mb-0">
                        <i class="bi bi-shield-check-fill fs-1 mb-3"></i>
                        <strong class="fs-5">Ya NO es Atribuible</strong>
                        <small class="text-muted mt-2">Marcado el {{ incidencia.fecha_marcado_no_atribuible|date:"d/m/Y" }}</small>
                    </div>
                </div>
                {% endif %}
                
                <!-- Cambiar Estado - Dinámico según estado actual -->
                <div class="col-xl-3 col-lg-6 col-md-6">
                    {% if incidencia.estado != 'cerrada' %}
                        <a href="{% url 'scorecard:cambiar_estado_incidencia' incidencia.id %}" 
                           class="btn-accion-individual 
                                  {% if incidencia.estado == 'abierta' %}btn-estado-abierta
                                  {% elif incidencia.estado == 'en_revision' %}btn-estado-en_revision
                                  {% elif incidencia.estado == 'reincidente' %}btn-estado-reincidente
                                  {% endif %} 
                                  w-100 h-100 p-4">
                            {% if incidencia.estado == 'abierta' %}
                                <i class="bi bi-play-circle-fill fs-1 mb-3 text-info"></i>
                                <strong class="fs-5">Cambiar Estado</strong>
                                <small class="text-muted mt-2">Actual: <span class="badge bg-info text-dark">{{ incidencia.get_estado_display }}</span></small>
                            {% elif incidencia.estado == 'en_revision' %}
                                <i class="bi bi-hourglass-split fs-1 mb-3 text-warning"></i>
                                <strong class="fs-5">Cambiar Estado</strong>
                                <small class="text-muted mt-2">Actual: <span class="badge bg-warning ">{{ incidencia.get_estado_display }}</span></small>
                            {% elif incidencia.estado == 'reincidente' %}
                                <i class="bi bi-exclamation-triangle-fill fs-1 mb-3 text-danger"></i>
                                <strong class="fs-5">Cambiar Estado</strong>
                                <small class="text-muted mt-2">Actual: <span class="badge bg-danger">{{ incidencia.get_estado_display }}</span></small>
                            {% endif %}
                        </a>
                    {% else %}
                        <div class="alert alert-accion-completada alert-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4 mb-0">
                            <i class="bi bi-lock-fill fs-1 mb-3"></i>
                            <strong class="fs-5">Estado Cerrado</strong>
                            <small class="text-muted mt-2">No se puede cambiar</small>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Cerrar Incidencia -->
                {% if incidencia.estado != 'cerrada' %}
                <div class="col-xl-3 col-lg-6 col-md-6">
                    <a href="{% url 'scorecard:cerrar_incidencia' incidencia.id %}" class="btn-accion-individual btn-cerrar w-100 h-100 p-4">
                        <i class="bi bi-check-circle-fill fs-1 mb-3 text-success"></i>
                        <strong class="fs-5">Cerrar Incidencia</strong>
                        <small class="text-muted mt-2">Con notificación automática</small>
                    </a>
                </div>
                {% else %}
                <div class="col-xl-3 col-lg-6 col-md-6">
                    <div class="alert alert-accion-completada alert-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4 mb-0">
                        <i class="bi bi-check-circle-fill fs-1 mb-3"></i>
                        <strong class="fs-5">Incidencia Cerrada</strong>
                        <small class="text-muted mt-2">{{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Justificación NO Atribuible (si aplica) -->
    {% if not incidencia.es_atribuible %}
    <div class="alert alert-info border-info shadow-sm mb-4">
        <h5 class="alert-heading">
            <i class="bi bi-shield-x"></i> Incidencia Marcada como NO Atribuible
        </h5>
        <hr>
        <p class="mb-2"><strong>Justificación:</strong></p>
        <p style="white-space: pre-line;" class="mb-2">{{ incidencia.justificacion_no_atribuible }}</p>
        <hr>
        <p class="mb-0 small text-muted">
            <i class="bi bi-person"></i> Marcado por: 
            {% if incidencia.marcado_no_atribuible_por %}
                {{ incidencia.marcado_no_atribuible_por.nombre_completo }}
            {% else %}
                Sistema
            {% endif %}
            | 
            <i class="bi bi-calendar"></i> {{ incidencia.fecha_marcado_no_atribuible|date:"d/m/Y H:i" }}
        </p>
    </div>
    {% endif %}

    <!-- Row para Cards lado a lado -->
    <div class="row g-4 mb-4">
        <!-- Columna: Información General -->
        <div class="col-lg-6">
            <!-- Información básica -->
            <div class="card info-card-modern h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill"></i> 
                        Información General
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="info-list">
                        <!-- Folio -->
                        <li class="info-list-item">
                            <div class="info-icon">
                                <i class="bi bi-file-earmark-text-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Folio:</span>
                                <span class="info-value">{{ incidencia.folio }}</span>
                            </div>
                        </li>

                        <!-- Fecha Detección -->
                        <li class="info-list-item">
                            <div class="info-icon icon-info">
                                <i class="bi bi-calendar3"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Fecha Detección:</span>
                                <span class="info-value">{{ incidencia.fecha_deteccion|date:"d/m/Y" }}</span>
                            </div>
                        </li>

                        <!-- Estado -->
                        <li class="info-list-item">
                            <div class="info-icon icon-warning">
                                <i class="bi bi-circle-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Estado:</span>
                                <span class="info-value">
                                    <span class="badge badge-categoria" 
                                          style="background-color: {{ incidencia.estado|color_estado }}; 
                                                 color: {{ incidencia.estado|color_estado|text_color_for_bg }};">
                                        <i class="bi bi-circle-fill"></i>
                                        {{ incidencia.get_estado_display }}
                                    </span>
                                </span>
                            </div>
                        </li>

                        <!-- Severidad -->
                        <li class="info-list-item">
                            <div class="info-icon icon-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Severidad:</span>
                                <span class="info-value">
                                    <span class="badge badge-categoria" 
                                          style="background-color: {{ incidencia.grado_severidad|color_severidad }}; 
                                                 color: {{ incidencia.grado_severidad|color_severidad|text_color_for_bg }};">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        {{ incidencia.get_grado_severidad_display }}
                                    </span>
                                </span>
                            </div>
                        </li>

                        <!-- Tipo de Equipo -->
                        <li class="info-list-item">
                            <div class="info-icon icon-secondary">
                                <i class="bi bi-laptop"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Tipo de Equipo:</span>
                                <span class="info-value">{{ incidencia.get_tipo_equipo_display }}</span>
                            </div>
                        </li>

                        <!-- Marca -->
                        <li class="info-list-item">
                            <div class="info-icon">
                                <i class="bi bi-tag-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Marca:</span>
                                <span class="info-value">{{ incidencia.marca }}</span>
                            </div>
                        </li>

                        <!-- Modelo -->
                        <li class="info-list-item">
                            <div class="info-icon icon-secondary">
                                <i class="bi bi-cpu-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Modelo:</span>
                                <span class="info-value">{{ incidencia.modelo|default:"N/A" }}</span>
                            </div>
                        </li>

                        <!-- Número de Serie -->
                        <li class="info-list-item">
                            <div class="info-icon icon-info">
                                <i class="bi bi-upc-scan"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">N° Serie (Service Tag):</span>
                                <span class="info-value"><code>{{ incidencia.numero_serie }}</code></span>
                            </div>
                        </li>

                        <!-- Número de Orden (si existe) -->
                        {% if incidencia.numero_orden %}
                        <li class="info-list-item">
                            <div class="info-icon icon-warning">
                                <i class="bi bi-receipt"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Número de Orden:</span>
                                <span class="info-value"><code>{{ incidencia.numero_orden }}</code></span>
                            </div>
                        </li>
                        {% endif %}

                        <!-- Servicio Realizado -->
                        <li class="info-list-item">
                            <div class="info-icon icon-success">
                                <i class="bi bi-tools"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Servicio Realizado:</span>
                                <span class="info-value">
                                    {% if incidencia.servicio_realizado %}
                                        <span class="badge badge-categoria" 
                                              style="background-color: {{ incidencia.servicio_realizado.nombre|color_servicio }}; 
                                                     color: {{ incidencia.servicio_realizado.nombre|color_servicio|text_color_for_bg }};">
                                            <i class="bi bi-tools"></i> {{ incidencia.servicio_realizado.nombre }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Columna: Responsables -->
        <div class="col-lg-6">
            <!-- Responsables -->
            <div class="card info-card-modern card-info h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill"></i> 
                        Responsables
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="info-list">
                        <!-- Sucursal -->
                        <li class="info-list-item">
                            <div class="info-icon icon-info">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Sucursal:</span>
                                <span class="info-value">{{ incidencia.sucursal.nombre }}</span>
                            </div>
                        </li>

                        <!-- Área Detectora -->
                        <li class="info-list-item">
                            <div class="info-icon icon-warning">
                                <i class="bi bi-geo-alt-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Área Detectora:</span>
                                <span class="info-value">{{ incidencia.get_area_detectora_display }}</span>
                            </div>
                        </li>

                        <!-- Técnico Responsable -->
                        <li class="info-list-item">
                            <div class="info-icon icon-danger">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Técnico/Personal:</span>
                                <span class="info-value">{{ incidencia.tecnico_responsable.nombre_completo }}</span>
                            </div>
                        </li>

                        <!-- Área del Técnico (si existe) -->
                        {% if incidencia.area_tecnico %}
                        <li class="info-list-item">
                            <div class="info-icon icon-secondary">
                                <i class="bi bi-briefcase-fill"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Área:</span>
                                <span class="info-value">
                                    <span class="badge badge-categoria" 
                                          style="background-color: {{ incidencia.area_tecnico|color_area }}; 
                                                 color: {{ incidencia.area_tecnico|color_area|text_color_for_bg }};">
                                        <i class="bi bi-briefcase"></i> {{ incidencia.area_tecnico }}
                                    </span>
                                </span>
                            </div>
                        </li>
                        {% endif %}

                        <!-- Inspector de Calidad -->
                        <li class="info-list-item">
                            <div class="info-icon icon-success">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">Inspector de Calidad:</span>
                                <span class="info-value">{{ incidencia.inspector_calidad.nombre_completo }}</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Descripción -->
    <div class="card info-card-modern card-warning">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-file-text-fill"></i> 
                Descripción de la Incidencia
            </h5>
        </div>
        <div class="card-body">
            <div class="info-description-box">
                <div class="info-description-label">
                    <i class="bi bi-journal-text"></i>
                    Descripción de la Incidencia:
                </div>
                <p>{{ incidencia.descripcion_incidencia }}</p>
            </div>
            
            {% if incidencia.acciones_tomadas %}
            <div class="info-section-divider"></div>
            <div class="info-description-box" style="border-left-color: var(--success-color);">
                <div class="info-description-label">
                    <i class="bi bi-check2-circle" style="color: var(--success-color);"></i>
                    Acciones Tomadas:
                </div>
                <p>{{ incidencia.acciones_tomadas }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Evidencias -->
    {% if evidencias %}
    <div class="card info-card-modern card-success">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-images"></i> 
                Evidencias Fotográficas ({{ evidencias.count }})
            </h5>
        </div>
        <div class="card-body p-4">
            <div class="gallery-modern">
                {% for evidencia in evidencias %}
                <div class="gallery-item">
                    <img src="{{ evidencia.imagen.url }}" alt="Evidencia {{ forloop.counter }}">
                    <div class="gallery-zoom-icon">
                        <i class="bi bi-zoom-in"></i>
                    </div>
                    {% if evidencia.descripcion %}
                    <div class="gallery-item-caption">
                        <p>{{ evidencia.descripcion }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Notificaciones -->
    <div class="card info-card-modern">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> 
                Historial de Notificaciones
            </h5>
        </div>
        <div class="card-body p-4">
                    
                    {% if notificaciones_enviadas %}
                        <div class="timeline-modern">
                            {% for notif in notificaciones_enviadas %}
                            <div class="timeline-modern-item">
                                <!-- Icono del timeline -->
                                <div class="timeline-icon {% if notif.exitoso or notif.enviado_exitoso %}success{% else %}danger{% endif %}">
                                    {% if notif.exitoso or notif.enviado_exitoso %}
                                        <i class="bi bi-check-lg"></i>
                                    {% else %}
                                        <i class="bi bi-x-lg"></i>
                                    {% endif %}
                                </div>
                                
                                <!-- Contenido del timeline -->
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <div>
                                            <h6 class="timeline-title">
                                                {% if notif.exitoso or notif.enviado_exitoso %}
                                                    <span class="text-success">
                                                        <i class="bi bi-check-circle-fill"></i> Enviado exitosamente
                                                    </span>
                                                {% else %}
                                                    <span class="text-danger">
                                                        <i class="bi bi-exclamation-circle-fill"></i> Error en envío
                                                    </span>
                                                {% endif %}
                                            </h6>
                                            <div class="timeline-date">
                                                <i class="bi bi-calendar3"></i> {{ notif.fecha_envio|date:"d/m/Y H:i" }}
                                                <span class="mx-2">|</span>
                                                <i class="bi bi-person-fill"></i> {{ notif.enviado_por }}
                                            </div>
                                        </div>
                                        <div class="timeline-badges">
                                            {% if notif.tipo_notificacion == 'no_atribuible' %}
                                                <span class="timeline-badge bg-info text-white">No Atribuible</span>
                                            {% elif notif.tipo_notificacion == 'cierre' %}
                                                <span class="timeline-badge bg-success text-white">Cierre</span>
                                            {% elif notif.tipo_notificacion == 'cierre_no_atribuible' %}
                                                <span class="timeline-badge bg-info text-white">Cierre (No Atribuible)</span>
                                            {% elif notif.tipo_notificacion == 'manual' %}
                                                <span class="timeline-badge bg-secondary text-white">Manual</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Asunto -->
                                    <div class="mt-3">
                                        <strong class="text-muted">
                                            <i class="bi bi-envelope-fill"></i> Asunto:
                                        </strong>
                                        <p class="mb-0 mt-1">{{ notif.asunto }}</p>
                                    </div>
                                    
                                    <!-- Destinatarios -->
                                    <div class="mt-3">
                                        <strong class="text-muted">
                                            <i class="bi bi-people-fill"></i> Destinatarios:
                                        </strong>
                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                            {% for dest in notif.get_destinatarios_list %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="bi bi-person"></i> {{ dest.nombre }}
                                                </span>
                                            {% empty %}
                                                <span class="text-muted small">Sin destinatarios</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Mensaje de error si existe -->
                                    {% if not notif.exitoso and not notif.enviado_exitoso and notif.mensaje_error %}
                                    <div class="alert alert-danger mt-3 mb-0 py-2 px-3">
                                        <small>
                                            <i class="bi bi-exclamation-triangle-fill"></i> 
                                            <strong>Error:</strong> {{ notif.mensaje_error }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox display-1 d-block mb-3 opacity-50"></i>
                            <h5 class="fw-bold">No se han enviado notificaciones aún</h5>
                            <p class="mb-0">Las notificaciones enviadas aparecerán aquí con su historial completo</p>
                        </div>
                    {% endif %}
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="mt-4 mb-5 d-flex gap-3 flex-wrap">
        <a href="{% url 'scorecard:lista_incidencias' %}" class="btn btn-outline-secondary btn-lg">
            <i class="bi bi-arrow-left-circle"></i> Volver a la Lista
        </a>
        <a href="{% url 'scorecard:editar_incidencia' incidencia.id %}" class="btn btn-warning btn-lg">
            <i class="bi bi-pencil-square"></i> Editar Incidencia
        </a>
    </div>
</div>

<!-- Modal para Galería de Imágenes -->
<div class="modal fade" id="modalGaleria" tabindex="-1" aria-labelledby="modalGaleriaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white" id="modalGaleriaLabel">
                    <i class="bi bi-images"></i> Evidencia <span id="imagenNumero"></span> de {{ evidencias.count }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0" style="position: relative;">
                <!-- Botón anterior -->
                <button type="button" class="btn btn-light position-absolute top-50 start-0 translate-middle-y ms-3" 
                        id="btnAnterior" style="z-index: 10; opacity: 0.8; border-radius: 50%; width: 45px; height: 45px;">
                    <i class="bi bi-chevron-left"></i>
                </button>
                
                <!-- Imagen principal -->
                <img id="imagenModal" src="" alt="Evidencia" class="img-fluid" style="max-height: 70vh; width: auto;">
                
                <!-- Botón siguiente -->
                <button type="button" class="btn btn-light position-absolute top-50 end-0 translate-middle-y me-3" 
                        id="btnSiguiente" style="z-index: 10; opacity: 0.8; border-radius: 50%; width: 45px; height: 45px;">
                    <i class="bi bi-chevron-right"></i>
                </button>
                
                <!-- Descripción de la imagen -->
                <div id="descripcionModal" class="text-white p-3 bg-dark bg-opacity-75" style="display: none;">
                    <p class="mb-0"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Enviar Notificación -->
<div class="modal fade" id="modalNotificacion" tabindex="-1" aria-labelledby="modalNotificacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalNotificacionLabel">
                    <i class="bi bi-envelope"></i> Enviar Notificación - {{ incidencia.folio }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading spinner -->
                <div id="loadingDestinatarios" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando destinatarios...</p>
                </div>

                <!-- Formulario de notificación -->
                <form id="formEnviarNotificacion" style="display: none;">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-people"></i> Seleccionar Destinatarios:
                        </label>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Selecciona las personas que recibirán esta notificación por correo electrónico.
                        </div>
                        
                        <!-- Lista de destinatarios (se llena dinámicamente) -->
                        <div id="listaDestinatarios" class="border rounded p-3 bg-light">
                            <!-- Se llenará con JavaScript -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="mensajeAdicional" class="form-label fw-bold">
                            <i class="bi bi-chat-text"></i> Mensaje Adicional (Opcional):
                        </label>
                        <textarea 
                            class="form-control" 
                            id="mensajeAdicional" 
                            rows="4" 
                            placeholder="Agrega un mensaje personalizado que se incluirá en el email (opcional)..."></textarea>
                        <div class="form-text">
                            Este mensaje se incluirá al final del email, junto con toda la información de la incidencia.
                        </div>
                    </div>

                    <!-- Preview de destinatarios seleccionados -->
                    <div id="previewDestinatarios" class="alert alert-secondary" style="display: none;">
                        <strong><i class="bi bi-check-circle"></i> Destinatarios seleccionados:</strong>
                        <ul id="listaPreviewDestinatarios" class="mb-0 mt-2"></ul>
                    </div>
                </form>

                <!-- Mensajes de resultado -->
                <div id="mensajeExito" class="alert alert-success" style="display: none;">
                    <h5 class="alert-heading">
                        <i class="bi bi-check-circle-fill"></i> ¡Notificación Enviada Exitosamente!
                    </h5>
                    <hr>
                    <p class="mb-2" id="textoExito"></p>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Estado actualizado:</strong> La incidencia cambió automáticamente a 
                        <span class="badge bg-info">En Revisión</span>
                    </div>
                </div>

                <div id="mensajeError" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    <strong>Error al enviar</strong>
                    <p class="mb-0 mt-2" id="textoError"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelar">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnEnviarNotificacion">
                    <span id="btnEnviarTexto">
                        <i class="bi bi-send"></i> Enviar Notificación
                    </span>
                    <span id="btnEnviarSpinner" style="display: none;">
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        Enviando...
                    </span>
                </button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" id="btnCerrarExito" style="display: none;">
                    <i class="bi bi-check-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript para manejar el modal de notificaciones
document.addEventListener('DOMContentLoaded', function() {
    // ==========================================
    // GALERÍA DE IMÁGENES
    // ==========================================
    {% if evidencias %}
    const modalGaleria = new bootstrap.Modal(document.getElementById('modalGaleria'));
    const imagenModal = document.getElementById('imagenModal');
    const descripcionModal = document.getElementById('descripcionModal');
    const imagenNumero = document.getElementById('imagenNumero');
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSiguiente = document.getElementById('btnSiguiente');
    
    // Array con todas las imágenes y sus descripciones
    const evidencias = [
        {% for evidencia in evidencias %}
        {
            url: "{{ evidencia.imagen.url }}",
            descripcion: "{{ evidencia.descripcion|default:''|escapejs }}",
            numero: {{ forloop.counter }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    let indiceActual = 0;
    
    // Función para mostrar imagen en el modal
    function mostrarImagen(indice) {
        indiceActual = indice;
        const evidencia = evidencias[indice];
        
        // Actualizar imagen
        imagenModal.src = evidencia.url;
        imagenModal.alt = `Evidencia ${evidencia.numero}`;
        
        // Actualizar número
        imagenNumero.textContent = evidencia.numero;
        
        // Mostrar u ocultar descripción
        if (evidencia.descripcion) {
            descripcionModal.querySelector('p').textContent = evidencia.descripcion;
            descripcionModal.style.display = 'block';
        } else {
            descripcionModal.style.display = 'none';
        }
        
        // Controlar visibilidad de botones de navegación
        btnAnterior.style.display = indice > 0 ? 'block' : 'none';
        btnSiguiente.style.display = indice < evidencias.length - 1 ? 'block' : 'none';
    }
    
    // Agregar event listeners a las miniaturas de la galería
    document.querySelectorAll('.gallery-item').forEach((item, index) => {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function() {
            mostrarImagen(index);
            modalGaleria.show();
        });
    });
    
    // Navegación entre imágenes
    btnAnterior.addEventListener('click', function() {
        if (indiceActual > 0) {
            mostrarImagen(indiceActual - 1);
        }
    });
    
    btnSiguiente.addEventListener('click', function() {
        if (indiceActual < evidencias.length - 1) {
            mostrarImagen(indiceActual + 1);
        }
    });
    
    // Navegación con teclado (flechas izquierda/derecha)
    document.getElementById('modalGaleria').addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft' && indiceActual > 0) {
            mostrarImagen(indiceActual - 1);
        } else if (e.key === 'ArrowRight' && indiceActual < evidencias.length - 1) {
            mostrarImagen(indiceActual + 1);
        }
    });
    {% endif %}
    
    // ==========================================
    // MODAL DE NOTIFICACIONES
    // ==========================================
    const modalNotificacion = new bootstrap.Modal(document.getElementById('modalNotificacion'));
    const btnAbrirModal = document.getElementById('btnAbrirModalNotificacion');
    const btnEnviar = document.getElementById('btnEnviarNotificacion');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnCerrarExito = document.getElementById('btnCerrarExito');
    const formNotificacion = document.getElementById('formEnviarNotificacion');
    const loadingDestinatarios = document.getElementById('loadingDestinatarios');
    const listaDestinatarios = document.getElementById('listaDestinatarios');
    const previewDestinatarios = document.getElementById('previewDestinatarios');
    const listaPreviewDestinatarios = document.getElementById('listaPreviewDestinatarios');
    
    let destinatariosDisponibles = [];
    
    // Abrir modal y cargar destinatarios
    btnAbrirModal.addEventListener('click', function() {
        // Resetear estado del modal
        formNotificacion.style.display = 'none';
        document.getElementById('mensajeExito').style.display = 'none';
        document.getElementById('mensajeError').style.display = 'none';
        btnCancelar.style.display = 'inline-block';
        btnEnviar.style.display = 'inline-block';
        btnCerrarExito.style.display = 'none';
        
        modalNotificacion.show();
        cargarDestinatarios();
    });
    
    // Cargar destinatarios desde la API
    function cargarDestinatarios() {
        loadingDestinatarios.style.display = 'block';
        formNotificacion.style.display = 'none';
        
        fetch('/scorecard/api/incidencias/{{ incidencia.id }}/destinatarios/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    destinatariosDisponibles = data.destinatarios;
                    mostrarDestinatarios(data.destinatarios);
                    loadingDestinatarios.style.display = 'none';
                    formNotificacion.style.display = 'block';
                } else {
                    mostrarError('No se pudieron cargar los destinatarios');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexión al cargar destinatarios');
            });
    }
    
    // Mostrar lista de destinatarios con checkboxes
    function mostrarDestinatarios(destinatarios) {
        listaDestinatarios.innerHTML = '';
        
        if (destinatarios.length === 0) {
            listaDestinatarios.innerHTML = '<p class="text-muted">No hay destinatarios disponibles.</p>';
            return;
        }
        
        // Separar destinatarios en dos grupos
        const destinatariosSistema = destinatarios.filter(d => d.es_sistema);
        const destinatariosOtros = destinatarios.filter(d => !d.es_sistema);
        
        // ========== GRUPO 1: OTROS DESTINATARIOS RELEVANTES (Primero) ==========
        if (destinatariosOtros.length > 0) {
            // Header para otros destinatarios
            const headerOtros = document.createElement('div');
            headerOtros.className = 'mb-2';
            headerOtros.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-people-fill text-success"></i>
                    <strong class="text-success ms-2">Otros Destinatarios Relevantes</strong>
                    <span class="badge bg-success ms-2">${destinatariosOtros.length}</span>
                </div>
                <small class="text-muted d-block mt-1 ms-4">
                    Técnico responsable, jefes directos y destinatarios del historial
                </small>
            `;
            listaDestinatarios.appendChild(headerOtros);
            
            destinatariosOtros.forEach((dest, index) => {
                const divDestinatario = document.createElement('div');
                divDestinatario.className = 'form-check mb-2 p-3 border-bottom';
                
                const checkbox = document.createElement('input');
                checkbox.className = 'form-check-input';
                checkbox.type = 'checkbox';
                checkbox.id = `dest_${index}`;
                checkbox.value = index;
                checkbox.checked = dest.seleccionado_default;
                checkbox.addEventListener('change', actualizarPreview);
                
                const label = document.createElement('label');
                label.className = 'form-check-label w-100';
                label.htmlFor = `dest_${index}`;
                label.innerHTML = `
                    <strong>${dest.nombre}</strong>
                    <br>
                    <small class="text-muted">
                        <i class="bi bi-envelope"></i> ${dest.email}
                        <br>
                        <i class="bi bi-person-badge"></i> ${dest.rol}
                    </small>
                `;
                
                divDestinatario.appendChild(checkbox);
                divDestinatario.appendChild(label);
                listaDestinatarios.appendChild(divDestinatario);
            });
        }
        
        // ========== GRUPO 2: DESTINATARIOS DEL SISTEMA (Abajo, Colapsado) ==========
        if (destinatariosSistema.length > 0) {
            // Agregar separador si hay otros destinatarios
            if (destinatariosOtros.length > 0) {
                const separador = document.createElement('div');
                separador.className = 'my-3';
                listaDestinatarios.appendChild(separador);
            }
            
            // Header del grupo con botón expandible
            const headerSistema = document.createElement('div');
            headerSistema.className = 'destinatarios-grupo-header';
            headerSistema.innerHTML = `
                <button type="button" class="btn btn-link p-0 text-decoration-none w-100 text-start d-flex justify-content-between align-items-center" 
                        id="btnToggleSistema" style="border: none; background: none;">
                    <div>
                        <i class="bi bi-gear-fill text-primary"></i>
                        <strong class="text-primary">Destinatarios Predeterminados del Sistema</strong>
                        <span class="badge bg-primary ms-2">${destinatariosSistema.length}</span>
                    </div>
                    <i class="bi bi-chevron-right" id="iconToggleSistema"></i>
                </button>
                <small class="text-muted d-block mt-1 ms-4">
                    Estos correos están configurados en el sistema y siempre aparecen como opciones
                </small>
            `;
            listaDestinatarios.appendChild(headerSistema);
            
            // Contenedor colapsable para destinatarios del sistema
            const contenedorSistema = document.createElement('div');
            contenedorSistema.id = 'contenedorDestinatariosSistema';
            contenedorSistema.className = 'destinatarios-grupo-contenido';
            contenedorSistema.style.display = 'none'; // Colapsado por defecto
            
            destinatariosSistema.forEach((dest, index) => {
                const indexReal = index + destinatariosOtros.length;
                const divDestinatario = document.createElement('div');
                divDestinatario.className = 'form-check mb-2 p-3 border-bottom bg-light';
                
                const checkbox = document.createElement('input');
                checkbox.className = 'form-check-input';
                checkbox.type = 'checkbox';
                checkbox.id = `dest_${indexReal}`;
                checkbox.value = indexReal;
                checkbox.checked = dest.seleccionado_default;
                checkbox.addEventListener('change', actualizarPreview);
                
                const label = document.createElement('label');
                label.className = 'form-check-label w-100';
                label.htmlFor = `dest_${indexReal}`;
                label.innerHTML = `
                    <strong>${dest.nombre}</strong>
                    <span class="badge bg-primary ms-2" style="font-size: 0.7rem;">
                        <i class="bi bi-gear"></i> Sistema
                    </span>
                    <br>
                    <small class="text-muted">
                        <i class="bi bi-envelope"></i> ${dest.email}
                        <br>
                        <i class="bi bi-person-badge"></i> ${dest.rol}
                    </small>
                `;
                
                divDestinatario.appendChild(checkbox);
                divDestinatario.appendChild(label);
                contenedorSistema.appendChild(divDestinatario);
            });
            
            listaDestinatarios.appendChild(contenedorSistema);
            
            // Funcionalidad de expandir/colapsar
            document.getElementById('btnToggleSistema').addEventListener('click', function() {
                const contenedor = document.getElementById('contenedorDestinatariosSistema');
                const icono = document.getElementById('iconToggleSistema');
                
                if (contenedor.style.display === 'none') {
                    contenedor.style.display = 'block';
                    icono.className = 'bi bi-chevron-down';
                } else {
                    contenedor.style.display = 'none';
                    icono.className = 'bi bi-chevron-right';
                }
            });
        }
        
        // Actualizar preview inicial
        actualizarPreview();
    }
    
    // Actualizar preview de destinatarios seleccionados
    function actualizarPreview() {
        const checkboxes = document.querySelectorAll('#listaDestinatarios input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
            previewDestinatarios.style.display = 'none';
            return;
        }
        
        listaPreviewDestinatarios.innerHTML = '';
        checkboxes.forEach(checkbox => {
            const index = checkbox.value;
            const dest = destinatariosDisponibles[index];
            const li = document.createElement('li');
            li.textContent = `${dest.nombre} (${dest.email}) - ${dest.rol}`;
            listaPreviewDestinatarios.appendChild(li);
        });
        
        previewDestinatarios.style.display = 'block';
    }
    
    // Enviar notificación
    btnEnviar.addEventListener('click', function() {
        // Obtener destinatarios seleccionados
        const checkboxes = document.querySelectorAll('#listaDestinatarios input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
            alert('Debe seleccionar al menos un destinatario');
            return;
        }
        
        const destinatariosSeleccionados = [];
        checkboxes.forEach(checkbox => {
            const index = checkbox.value;
            const dest = destinatariosDisponibles[index];
            destinatariosSeleccionados.push({
                nombre: dest.nombre,
                email: dest.email,
                rol: dest.rol
            });
        });
        
        const mensajeAdicional = document.getElementById('mensajeAdicional').value;
        
        // Mostrar spinner
        document.getElementById('btnEnviarTexto').style.display = 'none';
        document.getElementById('btnEnviarSpinner').style.display = 'inline-block';
        btnEnviar.disabled = true;
        
        // Enviar request
        fetch('/scorecard/api/incidencias/{{ incidencia.id }}/enviar-notificacion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                destinatarios: destinatariosSeleccionados,
                mensaje_adicional: mensajeAdicional
            })
        })
        .then(response => response.json())
        .then(data => {
            // Ocultar spinner
            document.getElementById('btnEnviarTexto').style.display = 'inline-block';
            document.getElementById('btnEnviarSpinner').style.display = 'none';
            btnEnviar.disabled = false;
            
            if (data.success) {
                mostrarExito(data.message);
                formNotificacion.style.display = 'none';
                
                // Ocultar botones de formulario y mostrar botón de cerrar
                btnCancelar.style.display = 'none';
                btnEnviar.style.display = 'none';
                btnCerrarExito.style.display = 'inline-block';
                
                // Al cerrar el modal, recargar la página para mostrar cambios
                btnCerrarExito.addEventListener('click', function() {
                    location.reload();
                }, { once: true });
            } else {
                mostrarError(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('btnEnviarTexto').style.display = 'inline-block';
            document.getElementById('btnEnviarSpinner').style.display = 'none';
            btnEnviar.disabled = false;
            mostrarError('Error de conexión al enviar notificación');
        });
    });
    
    // Mostrar mensaje de éxito
    function mostrarExito(mensaje) {
        document.getElementById('textoExito').textContent = mensaje;
        document.getElementById('mensajeExito').style.display = 'block';
        document.getElementById('mensajeError').style.display = 'none';
    }
    
    // Mostrar mensaje de error
    function mostrarError(mensaje) {
        document.getElementById('textoError').textContent = mensaje;
        document.getElementById('mensajeError').style.display = 'block';
        document.getElementById('mensajeExito').style.display = 'none';
    }
    
    // Obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

{% endblock %}
