{% extends 'base.html' %}

{% block title %}Scanner QR - Movimiento R√°pido - {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h3">
                    <i class="bi bi-qr-code-scan text-primary"></i> Scanner QR - Movimiento R√°pido
                </h1>
                <p class="text-muted">Escanea el c√≥digo QR del producto o ingresa el c√≥digo manualmente</p>
            </div>

            <!-- Formulario Principal -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning-charge"></i> Registro R√°pido de Movimiento
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="movimientoRapidoForm">
                        {% csrf_token %}
                        
                        <!-- Scanner QR Section -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <label for="{{ form.codigo_qr.id_for_label }}" class="form-label">
                                    <i class="bi bi-qr-code"></i> C√≥digo de Barras/QR del Producto *
                                </label>
                                {{ form.codigo_qr }}
                                {% if form.codigo_qr.help_text %}
                                    <div class="form-text">{{ form.codigo_qr.help_text }}</div>
                                {% endif %}
                                {% if form.codigo_qr.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.codigo_qr.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-primary w-100" id="activarScannerBtn">
                                    <i class="bi bi-camera"></i> Activar Scanner de C√°mara
                                </button>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Producto (se llena autom√°ticamente) -->
                        <div id="productoInfo" class="alert alert-info d-none">
                            <h6><i class="bi bi-info-circle"></i> Informaci√≥n del Producto</h6>
                            <div id="productoDetalles"></div>
                        </div>

                        <!-- Detalles del Movimiento -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                    <i class="bi bi-arrow-left-right"></i> Tipo de Movimiento *
                                </label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tipo.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.cantidad.id_for_label }}" class="form-label">
                                    <i class="bi bi-123"></i> Cantidad *
                                </label>
                                {{ form.cantidad }}
                                {% if form.cantidad.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cantidad.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.motivo.id_for_label }}" class="form-label">
                                    <i class="bi bi-tag"></i> Motivo *
                                </label>
                                {{ form.motivo }}
                                {% if form.motivo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.motivo.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.sucursal_destino.id_for_label }}" class="form-label">
                                    <i class="bi bi-building"></i> Sucursal Destino *
                                </label>
                                {{ form.sucursal_destino }}
                                <div class="form-text">Selecciona la sucursal donde se entrega el producto</div>
                                {% if form.sucursal_destino.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sucursal_destino.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.usuario_registro_empleado.id_for_label }}" class="form-label">
                                    <i class="bi bi-person-badge-fill"></i> Usuario que Registra *
                                </label>
                                {{ form.usuario_registro_empleado }}
                                <div class="form-text">Selecciona el empleado que registra el movimiento</div>
                                {% if form.usuario_registro_empleado.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.usuario_registro_empleado.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.empleado_destinatario.id_for_label }}" class="form-label">
                                    <i class="bi bi-person-check"></i> Empleado Destinatario *
                                </label>
                                {{ form.empleado_destinatario }}
                                <div class="form-text">Selecciona el empleado que recibe el producto</div>
                                {% if form.empleado_destinatario.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.empleado_destinatario.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- √Årea de Destino autom√°tica (mantener funcionalidad existente) -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-geo-alt"></i> √Årea de Destino (Empleado)
                                </label>
                                <input type="text" id="areaDestinoDisplay" class="form-control" readonly placeholder="Se llena autom√°ticamente">
                                <div class="form-text">Se completa autom√°ticamente al seleccionar empleado destinatario</div>
                            </div>
                        </div>

                        <!-- Campo de Observaciones -->
                        <div class="mb-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                <i class="bi bi-chat-text"></i> Observaciones
                            </label>
                            {{ form.observaciones }}
                            <div class="form-text">Informaci√≥n adicional sobre el movimiento (opcional)</div>
                            {% if form.observaciones.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.observaciones.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Registrar Movimiento
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Instrucciones de Uso -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Instrucciones de Uso</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üì± Con Scanner de C√°mara:</h6>
                            <ol class="small">
                                <li>Haz clic en "Activar Scanner de C√°mara"</li>
                                <li>Permite acceso a la c√°mara cuando se solicite</li>
                                <li>Coloca el c√≥digo de barras/QR dentro del marco azul</li>
                                <li>El c√≥digo se detectar√° y completar√° autom√°ticamente</li>
                                <li>El modal se cerrar√° autom√°ticamente al detectar el c√≥digo</li>
                            </ol>
                            <div class="alert alert-warning alert-sm">
                                <small><i class="bi bi-exclamation-triangle"></i> 
                                <strong>Android/iOS:</strong> Para usar la c√°mara necesitas conexi√≥n HTTPS. 
                                Si no funciona, usa entrada manual.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>‚å®Ô∏è Entrada Manual:</h6>
                            <ol class="small">
                                <li>Escribe el c√≥digo QR/barras en el campo de texto</li>
                                <li>El sistema verificar√° que exista en el inventario</li>
                                <li>Completa los datos del movimiento</li>
                                <li>Haz clic en "Registrar Movimiento"</li>
                            </ol>
                            <div class="alert alert-success alert-sm">
                                <small><i class="bi bi-check-circle"></i> 
                                <strong>Recomendado:</strong> Funciona en todos los navegadores y dispositivos.</small>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            <strong>Scanner Universal:</strong> Detecta autom√°ticamente c√≥digos QR y c√≥digos de barras 
                            (EAN-13, EAN-8, UPC-A, UPC-E, Code 128, Code 39, Codabar, ITF). 
                            Para dispositivos m√≥viles se requiere HTTPS para usar la c√°mara.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- √Årea del Scanner de Video -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scannerModalLabel">
                    <i class="bi bi-camera"></i> Scanner Universal - QR y C√≥digos de Barras
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- √Årea de estado/mensajes -->
                <div id="scanner-status" class="mb-3"></div>
                
                <div class="scanner-container">
                    <div id="qr-video"></div>
                    <div class="scanner-overlay">
                        <div class="scanner-frame"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Scanner Universal:</strong> Detecta autom√°ticamente c√≥digos QR y c√≥digos de barras. 
                        Coloca el c√≥digo dentro del marco azul para escanearlo.
                    </div>
                    <div class="row text-start">
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>üì± C√≥digos QR:</strong><br>
                                ‚Ä¢ Cuadrados con puntos<br>
                                ‚Ä¢ Datos de texto/URL<br>
                                ‚Ä¢ Lectura 360¬∞
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>üìä C√≥digos de Barras:</strong><br>
                                ‚Ä¢ L√≠neas verticales<br>
                                ‚Ä¢ EAN, UPC, Code 128<br>
                                ‚Ä¢ Lectura horizontal
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cerrar Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Librer√≠as para Scanner Universal -->
<!-- QuaggaJS para c√≥digos de barras (EAN, UPC, Code 128, etc.) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<!-- jsQR para c√≥digos QR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const codigoQRInput = document.getElementById('{{ form.codigo_qr.id_for_label }}');
    const productoInfo = document.getElementById('productoInfo');
    const productoDetalles = document.getElementById('productoDetalles');
    const activarScannerBtn = document.getElementById('activarScannerBtn');
    
    // Variables del scanner universal
    let scannerActivo = false;
    let videoElement = null;
    let canvasElement = null;
    let canvasContext = null;
    let intervalId = null;
    
    // Variables para detecci√≥n de scanner f√≠sico
    let ultimaTecla = 0;
    let tiempoScanner = [];
    let timeoutBusqueda = null;
    let intentosReintentar = 0;
    const MAX_REINTENTOS = 2;
    
    // Funci√≥n mejorada para buscar producto por c√≥digo QR con reintentos autom√°ticos
    function buscarProducto(codigoQR, esReintento = false) {
        if (codigoQR.length < 3) {
            // Ocultar informaci√≥n si el c√≥digo es muy corto
            productoInfo.classList.add('d-none');
            actualizarValidacionVisual('neutro');
            return;
        }
        
        // Mostrar estado de carga
        if (!esReintento) {
            actualizarValidacionVisual('buscando');
            productoInfo.classList.remove('d-none');
            productoInfo.classList.remove('alert-success', 'alert-warning', 'alert-danger');
            productoInfo.classList.add('alert-info');
            productoDetalles.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Buscando producto: "${codigoQR}"...</span>
                </div>
            `;
        }
        
        fetch(`{% url 'buscar_producto_qr' %}?codigo_qr=${encodeURIComponent(codigoQR)}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(data => Promise.reject(data));
                }
            })
            .then(data => {
                // √âxito: producto encontrado
                intentosReintentar = 0; // Resetear contador de reintentos
                
                let mensajeExtra = '';
                if (data.mensaje && data.mensaje.includes('normalizado')) {
                    mensajeExtra = `<br><small class="text-info"><i class="bi bi-info-circle"></i> ${data.mensaje}</small>`;
                }
                
                productoDetalles.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <strong>${data.nombre}</strong><br>
                            <small class="text-muted">
                                C√≥digo: ${data.codigo_qr} | 
                                Categor√≠a: ${data.categoria} | 
                                Stock actual: ${data.cantidad_actual} unidades
                                ${data.ubicacion ? ' | Ubicaci√≥n: ' + data.ubicacion : ''}
                            </small>
                            ${mensajeExtra}
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-success">‚úì Producto Encontrado</span>
                        </div>
                    </div>
                `;
                productoInfo.classList.remove('d-none');
                productoInfo.classList.remove('alert-danger', 'alert-warning', 'alert-info');
                productoInfo.classList.add('alert-success');
                
                // Actualizar validaci√≥n visual a √©xito
                actualizarValidacionVisual('exito');
                
                // Hacer foco en el siguiente campo
                setTimeout(() => {
                    document.getElementById('{{ form.tipo.id_for_label }}').focus();
                }, 200);
            })
            .catch(error => {
                // Verificar si es un producto fraccionario
                if (error.es_fraccionable) {
                    // PRODUCTO FRACCIONARIO: Mostrar mensaje de redirecci√≥n
                    intentosReintentar = 0;
                    productoDetalles.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-droplet-half text-info me-2 fs-4"></i>
                                    <div>
                                        <strong class="text-info">Producto Fraccionario Detectado</strong><br>
                                        <span class="fw-semibold">${error.nombre}</span>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Este producto requiere manejo fraccionario en <strong>${error.unidad_base}</strong> 
                                    (${error.cantidad_unitaria} ${error.unidad_base} por unidad).
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="${error.url_fraccionario}" class="btn btn-info">
                                    <i class="bi bi-arrow-right"></i> Ir a Movimiento Fraccionario
                                </a>
                            </div>
                        </div>
                    `;
                    productoInfo.classList.remove('d-none', 'alert-success', 'alert-warning');
                    productoInfo.classList.add('alert-info');
                    
                    // Actualizar validaci√≥n visual
                    actualizarValidacionVisual('info');
                    return;
                }
                
                // Error: producto no encontrado u otro error
                const mensajeError = error.error || 'Producto no encontrado';
                const codigoRecibido = error.codigo_recibido || codigoQR;
                const sugerencia = error.sugerencia || 'Verifica que el c√≥digo sea correcto';
                
                // Si no es un reintento y quedan intentos, reintentar autom√°ticamente
                if (!esReintento && intentosReintentar < MAX_REINTENTOS) {
                    intentosReintentar++;
                    console.log(`üîÑ Reintentando b√∫squeda (intento ${intentosReintentar}/${MAX_REINTENTOS}): ${codigoQR}`);
                    
                    // Reintento con una versi√≥n m√°s limpia del c√≥digo
                    const codigoMasLimpio = limpiarCodigoAvanzado(codigoQR);
                    setTimeout(() => {
                        buscarProducto(codigoMasLimpio, true);
                    }, 300);
                    return;
                }
                
                // Mostrar error definitivo
                intentosReintentar = 0;
                productoDetalles.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i> 
                        <div>
                            <strong>${mensajeError}</strong><br>
                            <small>C√≥digo: "${codigoRecibido}"</small><br>
                            <small class="text-muted">${sugerencia}</small>
                        </div>
                    </div>
                `;
                productoInfo.classList.remove('d-none', 'alert-success', 'alert-info');
                productoInfo.classList.add('alert-warning');
                
                // Actualizar validaci√≥n visual a error
                actualizarValidacionVisual('error');
            });
    }
    
    // Funci√≥n para limpiar c√≥digo con m√∫ltiples estrategias
    function limpiarCodigoAvanzado(codigo) {
        if (!codigo) return '';
        
        // Estrategia 1: Limpieza b√°sica
        let codigoLimpio = codigo.toString().trim();
        
        // Estrategia 2: Remover caracteres invisibles comunes de scanners
        codigoLimpio = codigoLimpio.replace(/[\r\n\t\x00-\x08\x0B\x0C\x0E-\x1f\x7f-\x9f]/g, '');
        
        // Estrategia 3: Remover espacios internos y externos
        codigoLimpio = codigoLimpio.replace(/\s+/g, '');
        
        // Estrategia 4: Normalizar caracteres especiales
        codigoLimpio = codigoLimpio.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        // Estrategia 5: Convertir a may√∫sculas para consistencia
        codigoLimpio = codigoLimpio.toUpperCase();
        
        return codigoLimpio;
    }
    
    // Funci√≥n para actualizar la validaci√≥n visual del campo
    function actualizarValidacionVisual(estado) {
        const campo = codigoQRInput;
        
        // Remover todas las clases de estado previas
        campo.classList.remove('is-valid', 'is-invalid');
        campo.style.borderColor = '';
        campo.style.backgroundColor = '';
        
        switch(estado) {
            case 'exito':
                campo.classList.add('is-valid');
                campo.style.borderColor = '#28a745';
                campo.style.backgroundColor = '#d4edda';
                break;
            case 'info':
                campo.style.borderColor = '#17a2b8';
                campo.style.backgroundColor = '#d1ecf1';
                break;
            case 'error':
                campo.classList.add('is-invalid');
                campo.style.borderColor = '#dc3545';
                campo.style.backgroundColor = '#f8d7da';
                break;
            case 'buscando':
                campo.style.borderColor = '#007bff';
                campo.style.backgroundColor = '#e3f2fd';
                break;
            case 'neutro':
            default:
                // Estado neutro - sin colores especiales
                campo.style.borderColor = '#ced4da';
                campo.style.backgroundColor = '#fff';
                break;
        }
    }
    
    // Funci√≥n para detectar si es un scanner f√≠sico
    function detectarScannerFisico() {
        const ahora = Date.now();
        tiempoScanner.push(ahora);
        
        // Mantener solo los √∫ltimos 10 eventos
        if (tiempoScanner.length > 10) {
            tiempoScanner = tiempoScanner.slice(-10);
        }
        
        // Si hay varios caracteres en menos de 100ms, probablemente es scanner f√≠sico
        if (tiempoScanner.length >= 3) {
            const tiempoTotal = tiempoScanner[tiempoScanner.length - 1] - tiempoScanner[0];
            const caracteresporMs = tiempoScanner.length / tiempoTotal;
            
            // Si escribe m√°s de 10 caracteres por segundo, es probable que sea scanner
            return caracteresporMs > 0.01; // 10 chars/segundo
        }
        
        return false;
    }
    
    // Funci√≥n principal para manejar cambios en el campo con debouncing inteligente
    function manejarCambioCodigo(event) {
        const esScanner = detectarScannerFisico();
        let codigo = codigoQRInput.value;
        
        // Limpiar c√≥digo autom√°ticamente
        const codigoLimpio = limpiarCodigoAvanzado(codigo);
        
        // Si el c√≥digo fue limpiado, actualizar el campo
        if (codigo !== codigoLimpio && codigoLimpio.length > 0) {
            codigoQRInput.value = codigoLimpio;
            // Mantener cursor al final
            codigoQRInput.setSelectionRange(codigoLimpio.length, codigoLimpio.length);
        }
        
        // Cancelar b√∫squeda anterior si existe
        if (timeoutBusqueda) {
            clearTimeout(timeoutBusqueda);
        }
        
        // Debouncing inteligente: menos tiempo para scanners, m√°s para escritura manual
        const tiempoEspera = esScanner ? 100 : 500;
        
        timeoutBusqueda = setTimeout(() => {
            if (codigoLimpio.length >= 3) {
                console.log(`üîç Buscando producto: "${codigoLimpio}" (Scanner: ${esScanner})`);
                buscarProducto(codigoLimpio);
            } else if (codigoLimpio.length === 0) {
                // Campo vac√≠o
                productoInfo.classList.add('d-none');
                actualizarValidacionVisual('neutro');
            } else {
                // C√≥digo muy corto
                actualizarValidacionVisual('neutro');
            }
        }, tiempoEspera);
    }
    
    // ========================================================================
    // EVENTOS MEJORADOS PARA SCANNER F√çSICO Y MANUAL
    // ========================================================================
    
    // Evento principal: input (escritura en tiempo real)
    codigoQRInput.addEventListener('input', manejarCambioCodigo);
    
    // Evento de cambio (cuando el campo pierde foco o Enter)
    codigoQRInput.addEventListener('change', function() {
        console.log('üìù Evento change disparado');
        manejarCambioCodigo();
    });
    
    // Evento keyup (√∫til para scanners que no disparan input correctamente)
    codigoQRInput.addEventListener('keyup', function(e) {
        // Solo procesar si es una tecla significativa (no flechas, ctrl, etc.)
        if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
            manejarCambioCodigo();
        }
    });
    
    // Evento paste (copiar y pegar)
    codigoQRInput.addEventListener('paste', function(e) {
        console.log('üìã Evento paste disparado');
        // Esperar a que el paste se complete
        setTimeout(() => {
            manejarCambioCodigo();
        }, 50);
    });
    
    // Evento para Internet Explorer (compatibilidad legacy)
    if (codigoQRInput.attachEvent) {
        codigoQRInput.attachEvent('onpropertychange', function() {
            if (event.propertyName === 'value') {
                manejarCambioCodigo();
            }
        });
    }
    
    // Evento focus - resetear estado visual
    codigoQRInput.addEventListener('focus', function() {
        if (this.value.length === 0) {
            actualizarValidacionVisual('neutro');
        }
    });
    
    // Evento blur - validar una vez m√°s al salir del campo
    codigoQRInput.addEventListener('blur', function() {
        if (this.value.length >= 3) {
            // Forzar una √∫ltima b√∫squeda al salir del campo
            setTimeout(() => {
                buscarProducto(limpiarCodigoAvanzado(this.value));
            }, 100);
        }
    });
    
    // ========================================================================
    // FUNCIONALIDAD DE AUTO-LLENADO DE √ÅREA PARA EMPLEADOS
    // ========================================================================
    
    // Elementos para funcionalidad de empleados
    const empleadoDestinatarioSelect = document.getElementById('{{ form.empleado_destinatario.id_for_label }}');
    const areaDestinoDisplay = document.getElementById('areaDestinoDisplay');
    
    // Funci√≥n para actualizar √°rea autom√°ticamente al seleccionar empleado destinatario
    function actualizarAreaEmpleado() {
        if (!empleadoDestinatarioSelect || !areaDestinoDisplay) return;
        
        const selectedOption = empleadoDestinatarioSelect.options[empleadoDestinatarioSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.area) {
            const area = selectedOption.dataset.area;
            areaDestinoDisplay.value = area;
            areaDestinoDisplay.className = 'form-control text-success fw-bold';
            areaDestinoDisplay.style.backgroundColor = '#d4edda';
        } else if (selectedOption.value) {
            areaDestinoDisplay.value = '√Årea no especificada';
            areaDestinoDisplay.className = 'form-control text-muted';
            areaDestinoDisplay.style.backgroundColor = '#fff3cd';
        } else {
            areaDestinoDisplay.value = '';
            areaDestinoDisplay.className = 'form-control';
            areaDestinoDisplay.style.backgroundColor = '';
        }
    }
    
    // Event listener para empleado destinatario
    if (empleadoDestinatarioSelect && areaDestinoDisplay) {
        empleadoDestinatarioSelect.addEventListener('change', actualizarAreaEmpleado);
        // Ejecutar al cargar para casos de edici√≥n
        actualizarAreaEmpleado();
    }
    
    // ========================================================================
    // SCANNER UNIVERSAL - H√çBRIDO PARA QR Y C√ìDIGOS DE BARRAS
    // ========================================================================
    
    // Activar scanner universal
    activarScannerBtn.addEventListener('click', function() {
        const scannerModal = new bootstrap.Modal(document.getElementById('scannerModal'));
        scannerModal.show();
        
        // Inicializar scanner cuando se abra el modal
        document.getElementById('scannerModal').addEventListener('shown.bs.modal', function() {
            iniciarScannerUniversal();
        });
        
        // Detener scanner cuando se cierre el modal
        document.getElementById('scannerModal').addEventListener('hidden.bs.modal', function() {
            detenerScannerUniversal();
        });
    });
    
    // Funci√≥n principal del scanner universal
    async function iniciarScannerUniversal() {
        // Verificar compatibilidad del navegador
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            mostrarError('Tu navegador no soporta acceso a la c√°mara. Usa entrada manual.');
            return;
        }
        
        // Verificar HTTPS (requerido para c√°mara en m√≥viles)
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            mostrarErrorHTTPS();
            return;
        }
        
        try {
            // Configurar elementos de video y canvas
            setupVideoCanvas();
            
            // Solicitar acceso a la c√°mara con configuraci√≥n optimizada
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment', // C√°mara trasera en m√≥viles
                    width: { ideal: 1280, min: 640, max: 1920 },
                    height: { ideal: 720, min: 480, max: 1080 },
                    aspectRatio: { ideal: 16/9 },
                    frameRate: { ideal: 30, min: 15 }
                }
            });
            
            videoElement.srcObject = stream;
            
            // Esperar a que el video se cargue completamente
            await new Promise((resolve) => {
                videoElement.addEventListener('loadedmetadata', () => {
                    // Ajustar canvas al tama√±o real del video
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    resolve();
                });
            });
            
            await videoElement.play();
            scannerActivo = true;
            
            mostrarMensaje('success', 'üìπ Scanner activo - Enfoca el c√≥digo hacia la c√°mara');
            
            // Inicializar Quagga para c√≥digos de barras
            iniciarQuaggaScanner();
            
            // Inicializar jsQR para c√≥digos QR (en paralelo)
            iniciarQRScanner();
            
        } catch (error) {
            console.error('Error al iniciar scanner:', error);
            
            if (error.name === 'NotAllowedError') {
                mostrarError('Permisos de c√°mara denegados. Permite el acceso en la configuraci√≥n del navegador.');
            } else if (error.name === 'NotFoundError') {
                mostrarError('No se encontr√≥ c√°mara en tu dispositivo.');
            } else if (error.name === 'NotSupportedError') {
                mostrarError('Tu navegador no soporta esta funcionalidad.');
            } else {
                mostrarError(`Error del scanner: ${error.message}`);
            }
        }
    }
    
    // Configurar elementos de video y canvas
    function setupVideoCanvas() {
        const videoContainer = document.getElementById('qr-video');
        videoContainer.innerHTML = '';
        
        // Crear elemento de video
        videoElement = document.createElement('video');
        videoElement.style.cssText = `
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            border: none;
            outline: none;
            display: block;
            margin: 0;
            padding: 0;
        `;
        videoElement.setAttribute('autoplay', '');
        videoElement.setAttribute('muted', '');
        videoElement.setAttribute('playsinline', ''); // iOS compatibility
        videoContainer.appendChild(videoElement);
        
        // Crear canvas para jsQR (completamente oculto)
        canvasElement = document.createElement('canvas');
        canvasContext = canvasElement.getContext('2d');
        canvasElement.style.cssText = 'display: none; position: absolute; top: -9999px; left: -9999px;';
        document.body.appendChild(canvasElement); // Agregar al body en lugar del contenedor
    }
    
    // Inicializar Quagga para c√≥digos de barras
    function iniciarQuaggaScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoElement,
                constraints: {
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",    // Code 128 (com√∫n en inventarios)
                    "ean_reader",         // EAN-13 (productos comerciales)
                    "ean_8_reader",       // EAN-8 (productos peque√±os)
                    "code_39_reader",     // Code 39 (uso industrial)
                    "upc_reader",         // UPC-A (productos USA)
                    "upc_e_reader",       // UPC-E (productos peque√±os USA)
                    "codabar_reader",     // Codabar (bibliotecas, bancos)
                    "i2of5_reader"        // Interleaved 2 of 5
                ]
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: 2,
            frequency: 10, // Verificar cada 100ms
            debug: false   // Sin debug en producci√≥n
        }, function(err) {
            if (err) {
                console.error('Error Quagga:', err);
                return;
            }
            
            Quagga.start();
            console.log('‚úÖ Scanner de c√≥digos de barras iniciado');
        });
        
        // Detectar c√≥digos de barras
        Quagga.onDetected(function(result) {
            const codigo = result.codeResult.code;
            const confianza = result.codeResult.confidence || 0;
            
            // Solo aceptar c√≥digos con buena confianza
            if (confianza > 70) {
                console.log(`üìä C√≥digo de barras detectado: ${codigo} (confianza: ${confianza.toFixed(1)}%)`);
                procesarCodigoDetectado(codigo, 'C√≥digo de Barras');
            }
        });
    }
    
    // Inicializar jsQR para c√≥digos QR
    function iniciarQRScanner() {
        intervalId = setInterval(() => {
            if (scannerActivo && videoElement && videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                escanearQR();
            }
        }, 100); // Verificar cada 100ms
        
        console.log('‚úÖ Scanner de c√≥digos QR iniciado');
    }
    
    // Funci√≥n para escanear c√≥digos QR con jsQR
    function escanearQR() {
        if (!videoElement || !canvasElement || !canvasContext) return;
        
        // Ajustar canvas al video
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        
        // Dibujar frame actual del video en canvas
        canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        
        // Obtener datos de imagen
        const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
        
        // Buscar c√≥digo QR
        const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert"
        });
        
        if (qrCode) {
            console.log(`üì± C√≥digo QR detectado: ${qrCode.data}`);
            procesarCodigoDetectado(qrCode.data, 'C√≥digo QR');
        }
    }
    
    // Procesar c√≥digo detectado (com√∫n para QR y barras)
    function procesarCodigoDetectado(codigo, tipo) {
        if (!scannerActivo) return; // Evitar detecciones m√∫ltiples
        
        scannerActivo = false; // Pausar scanner temporalmente
        
        // Sonido de confirmaci√≥n
        reproducirSonidoConfirmacion();
        
        // Feedback visual
        mostrarMensaje('success', `‚úÖ ${tipo} detectado: ${codigo}`);
        
        // Llenar campo de entrada
        codigoQRInput.value = codigo;
        
        // Disparar evento 'input' para activar la b√∫squeda del producto
        const inputEvent = new Event('input', { bubbles: true });
        codigoQRInput.dispatchEvent(inputEvent);
        
        // Buscar producto autom√°ticamente
        buscarProducto(codigo);
        
        // Cerrar modal despu√©s de un momento
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
            
            // Hacer foco en el siguiente campo
            document.getElementById('{{ form.tipo.id_for_label }}').focus();
        }, 1000);
    }
    
    // Detener scanner universal
    function detenerScannerUniversal() {
        scannerActivo = false;
        
        // Detener Quagga
        if (typeof Quagga !== 'undefined') {
            Quagga.stop();
        }
        
        // Detener jsQR
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }
        
        // Detener video stream
        if (videoElement && videoElement.srcObject) {
            const tracks = videoElement.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            videoElement.srcObject = null;
        }
        
        console.log('üõë Scanner universal detenido');
    }
    
    // Funciones de utilidad
    function mostrarMensaje(tipo, mensaje) {
        const iconos = {
            success: '‚úÖ',
            warning: '‚ö†Ô∏è', 
            error: '‚ùå',
            info: '‚ÑπÔ∏è'
        };
        
        const clases = {
            success: 'alert-success',
            warning: 'alert-warning',
            error: 'alert-danger', 
            info: 'alert-info'
        };
        
        document.getElementById('scanner-status').innerHTML = 
            `<div class="alert ${clases[tipo]}">
                ${iconos[tipo]} ${mensaje}
            </div>`;
    }
    
    function mostrarError(mensaje) {
        mostrarMensaje('error', mensaje);
    }
    
    function mostrarErrorHTTPS() {
        mostrarMensaje('warning', 
            'Para usar la c√°mara necesitas conexi√≥n HTTPS. Mientras tanto, escribe el c√≥digo manualmente.');
    }
    
    function reproducirSonidoConfirmacion() {
        try {
            // Crear sonido de beep de confirmaci√≥n
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // Frecuencia del beep
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
            // Silenciosamente ignorar errores de audio
        }
    }
    
    // ========================================================================
    // VALIDACI√ìN DEL FORMULARIO
    // ========================================================================
    
    document.getElementById('movimientoRapidoForm').addEventListener('submit', function(e) {
        const codigoQR = codigoQRInput.value.trim();
        const tipo = document.getElementById('{{ form.tipo.id_for_label }}').value;
        const cantidad = document.getElementById('{{ form.cantidad.id_for_label }}').value;
        const motivo = document.getElementById('{{ form.motivo.id_for_label }}').value;
        const sucursalDestino = document.getElementById('{{ form.sucursal_destino.id_for_label }}').value;
        const usuarioRegistro = document.getElementById('{{ form.usuario_registro_empleado.id_for_label }}').value;
        const empleadoDestinatario = document.getElementById('{{ form.empleado_destinatario.id_for_label }}').value;
        
        // Validar campos obligatorios
        if (!codigoQR || !tipo || !cantidad || !motivo || !sucursalDestino || !usuarioRegistro || !empleadoDestinatario) {
            e.preventDefault();
            
            // Identificar qu√© campo espec√≠fico falta
            const camposFaltantes = [];
            if (!codigoQR) camposFaltantes.push('C√≥digo QR');
            if (!tipo) camposFaltantes.push('Tipo de Movimiento');
            if (!cantidad) camposFaltantes.push('Cantidad');
            if (!motivo) camposFaltantes.push('Motivo');
            if (!sucursalDestino) camposFaltantes.push('Sucursal Destino');
            if (!usuarioRegistro) camposFaltantes.push('Usuario que Registra');
            if (!empleadoDestinatario) camposFaltantes.push('Empleado Destinatario');
            
            alert(`‚ö†Ô∏è Por favor, completa los siguientes campos obligatorios:\n‚Ä¢ ${camposFaltantes.join('\n‚Ä¢ ')}`);
            return false;
        }
        
        if (parseInt(cantidad) <= 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è La cantidad debe ser mayor que cero.');
            return false;
        }
        
        // Confirmaci√≥n antes de registrar con informaci√≥n m√°s completa
        const tipoTexto = document.getElementById('{{ form.tipo.id_for_label }}').options[document.getElementById('{{ form.tipo.id_for_label }}').selectedIndex].text;
        const sucursalTexto = document.getElementById('{{ form.sucursal_destino.id_for_label }}').options[document.getElementById('{{ form.sucursal_destino.id_for_label }}').selectedIndex].text;
        
        if (!confirm(`¬øConfirmas registrar el siguiente movimiento?\n\n` +
                    `‚Ä¢ Tipo: ${tipoTexto}\n` +
                    `‚Ä¢ Cantidad: ${cantidad} unidades\n` +
                    `‚Ä¢ Producto: ${codigoQR}\n` +
                    `‚Ä¢ Sucursal destino: ${sucursalTexto}`)) {
            e.preventDefault();
            return false;
        }
    });
    
    // Auto-focus en el campo de c√≥digo QR
    codigoQRInput.focus();
});
</script>
{% endblock %}