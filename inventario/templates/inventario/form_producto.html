{% extends 'base.html' %}

{% block title %}{{ titulo|default:"Producto" }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="bi bi-box-seam"></i> {{ titulo|default:"Formulario de Producto" }}
                </h1>
                {% if producto %}
                    <span class="badge bg-info">{{ producto.codigo_qr }}</span>
                {% endif %}
            </div>

            <form method="post">
                {% csrf_token %}
                
                <!-- Información Básica -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información Básica</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                    <i class="bi bi-tag"></i> Nombre del Producto *
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.nombre.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.categoria.id_for_label }}" class="form-label">
                                    <i class="bi bi-grid"></i> Categoría *
                                </label>
                                {{ form.categoria }}
                                {% if form.categoria.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.categoria.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                                    <i class="bi bi-card-text"></i> Descripción
                                </label>
                                {{ form.descripcion }}
                                {% if form.descripcion.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.descripcion.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                    <i class="bi bi-box"></i> Tipo de Producto *
                                </label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tipo.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control de Inventario -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-boxes"></i> Control de Inventario</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.cantidad.id_for_label }}" class="form-label">
                                    <i class="bi bi-123"></i> Cantidad Actual *
                                </label>
                                {{ form.cantidad }}
                                <div class="form-text">Cantidad actual en inventario</div>
                                {% if form.cantidad.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cantidad.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.stock_minimo.id_for_label }}" class="form-label">
                                    <i class="bi bi-exclamation-triangle"></i> Stock Mínimo *
                                </label>
                                {{ form.stock_minimo }}
                                <div class="form-text stock-minimo-help-normal" id="stock-help-normal">
                                    Cantidad mínima antes de mostrar alerta de stock bajo
                                </div>
                                <div class="form-text stock-minimo-help-unico" id="stock-help-unico" style="display: none;">
                                    <i class="bi bi-info-circle"></i>
                                    Para objetos únicos, puedes usar 0. La alerta aparecerá solo cuando no esté disponible (cantidad = 0)
                                </div>
                                {% if form.stock_minimo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.stock_minimo.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.ubicacion.id_for_label }}" class="form-label">
                                    <i class="bi bi-geo-alt"></i> Ubicación
                                </label>
                                {{ form.ubicacion }}
                                <div class="form-text">Ubicación física en almacén</div>
                                {% if form.ubicacion.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.ubicacion.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Configuración de Objeto Único -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <div class="form-check">
                                            {{ form.es_objeto_unico }}
                                            <label class="form-check-label" for="{{ form.es_objeto_unico.id_for_label }}">
                                                <strong>Objeto único</strong>
                                            </label>
                                        </div>
                                        <div class="form-text mt-2">
                                            <i class="bi bi-info-circle"></i>
                                            Solo se alerta cuando no están disponibles (cantidad = 0).
                                            Puedes usar stock mínimo = 0 para estos productos.
                                        </div>
                                        {% if form.es_objeto_unico.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.es_objeto_unico.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Producto Fraccionable -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-droplet"></i> Configuración de Producto Fraccionable
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Checkbox principal para activar modo fraccionable -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.es_fraccionable }}
                                    <label class="form-check-label fw-bold" for="{{ form.es_fraccionable.id_for_label }}">
                                        <i class="bi bi-flask text-info me-1"></i>
                                        Este producto se puede consumir en porciones (líquidos, granulados, etc.)
                                    </label>
                                </div>
                                <div class="form-text">
                                    Marque esta opción si el producto se puede usar parcialmente, como líquidos medidos en ml, polvos en gramos, etc.
                                </div>
                                {% if form.es_fraccionable.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.es_fraccionable.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Campos específicos para productos fraccionables (se muestran/ocultan dinámicamente) -->
                        <div id="campos-fraccionables" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Configuración Fraccionaria:</strong> Configure los detalles para el manejo de consumo parcial.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.unidad_base.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-rulers"></i> Unidad de Medida Base *
                                    </label>
                                    {{ form.unidad_base }}
                                    <div class="form-text">Ejemplo: ml, litros, gramos, kg</div>
                                    {% if form.unidad_base.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.unidad_base.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.cantidad_unitaria.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-cup"></i> Cantidad por Unidad Completa *
                                    </label>
                                    {{ form.cantidad_unitaria }}
                                    <div class="form-text">Ejemplo: 1000 ml por botella, 500 gramos por paquete</div>
                                    {% if form.cantidad_unitaria.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.cantidad_unitaria.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.cantidad_actual.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-thermometer-half"></i> Cantidad Actual Disponible
                                    </label>
                                    {{ form.cantidad_actual }}
                                    <div class="form-text">Cantidad disponible en la unidad abierta actualmente</div>
                                    {% if form.cantidad_actual.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.cantidad_actual.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.cantidad_minima_alerta.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-exclamation-triangle"></i> Nivel Mínimo de Alerta
                                    </label>
                                    {{ form.cantidad_minima_alerta }}
                                    <div class="form-text">Mostrar alerta cuando esté por debajo de este nivel</div>
                                    {% if form.cantidad_minima_alerta.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.cantidad_minima_alerta.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Ejemplo visual para ayudar al usuario -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-lightbulb text-warning"></i> Ejemplo:
                                            </h6>
                                            <p class="card-text small mb-0">
                                                <strong>Producto:</strong> Agua destilada<br>
                                                <strong>Unidad Base:</strong> ml<br>
                                                <strong>Cantidad por Unidad:</strong> 1000 ml (1 botella completa)<br>
                                                <strong>Cantidad Actual:</strong> 600 ml (lo que queda en la botella abierta)<br>
                                                <strong>Alerta:</strong> 100 ml (avisar cuando queden menos de 100ml)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información Comercial -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Información Comercial</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.proveedor.id_for_label }}" class="form-label">
                                    <i class="bi bi-truck"></i> Proveedor
                                </label>
                                {{ form.proveedor }}
                                {% if form.proveedor.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.proveedor.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.costo_unitario.id_for_label }}" class="form-label">
                                    <i class="bi bi-currency-dollar"></i> Costo Unitario
                                </label>
                                {{ form.costo_unitario }}
                                <div class="form-text">Precio por unidad</div>
                                {% if form.costo_unitario.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.costo_unitario.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.estado_calidad.id_for_label }}" class="form-label">
                                    <i class="bi bi-shield-check"></i> Estado de Calidad *
                                </label>
                                {{ form.estado_calidad }}
                                {% if form.estado_calidad.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.estado_calidad.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{% url 'lista_productos' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Volver a Lista
                                </a>
                                {% if producto %}
                                    <a href="{% url 'detalle_producto' producto.id %}" class="btn btn-outline-info ms-2">
                                        <i class="bi bi-eye"></i> Ver Detalles
                                    </a>
                                {% endif %}
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> {{ boton_texto|default:"Guardar Producto" }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Información adicional para productos existentes -->
            {% if producto %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Información del Sistema</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <strong>Código QR:</strong><br>
                                    <span class="badge bg-primary">{{ producto.codigo_qr }}</span>
                                </small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <strong>Fecha de Creación:</strong><br>
                                    {{ producto.fecha_ingreso|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <strong>Última Actualización:</strong><br>
                                    {{ producto.fecha_actualizacion|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                        </div>
                        {% if producto.valor_total_stock > 0 %}
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Valor Total en Stock:</strong> 
                                    <span class="text-success">${{ producto.valor_total_stock|floatformat:2 }}</span>
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función global para manejar el toggle de stock mínimo (llamada desde el widget)
function toggleStockMinimoUnico() {
    const esObjetoUnico = document.getElementById('{{ form.es_objeto_unico.id_for_label }}').checked;
    const stockMinimoInput = document.getElementById('{{ form.stock_minimo.id_for_label }}');
    const helpNormal = document.getElementById('stock-help-normal');
    const helpUnico = document.getElementById('stock-help-unico');
    const objetoUnicoCard = document.getElementById('objeto-unico-card');
    
    if (esObjetoUnico) {
        // Mostrar tarjeta de objeto único
        objetoUnicoCard.style.display = 'block';
        
        // Cambiar validación del stock mínimo
        stockMinimoInput.setAttribute('min', '0');
        
        // Cambiar textos de ayuda
        helpNormal.style.display = 'none';
        helpUnico.style.display = 'block';
        
        // Si el stock mínimo es mayor que 0, sugerir cambiar a 0
        if (parseInt(stockMinimoInput.value) > 0) {
            if (confirm('Para objetos únicos se recomienda usar stock mínimo 0. ¿Deseas cambiarlo automáticamente?')) {
                stockMinimoInput.value = '0';
            }
        }
    } else {
        // Ocultar tarjeta de objeto único
        objetoUnicoCard.style.display = 'none';
        
        // Restaurar validación del stock mínimo
        stockMinimoInput.setAttribute('min', '1');
        
        // Cambiar textos de ayuda
        helpNormal.style.display = 'block';
        helpUnico.style.display = 'none';
        
        // Si el stock mínimo es 0, cambiarlo a 1
        if (parseInt(stockMinimoInput.value) === 0) {
            stockMinimoInput.value = '1';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Cálculo automático del valor total
    const cantidadInput = document.getElementById('{{ form.cantidad.id_for_label }}');
    const costoInput = document.getElementById('{{ form.costo_unitario.id_for_label }}');
    
    function calcularValorTotal() {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const costo = parseFloat(costoInput.value) || 0;
        const total = cantidad * costo;
        
        // Mostrar valor calculado (opcional)
        console.log('Valor total calculado: $' + total.toFixed(2));
    }
    
    cantidadInput.addEventListener('input', calcularValorTotal);
    costoInput.addEventListener('input', calcularValorTotal);
    
    // Validación del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const nombre = document.getElementById('{{ form.nombre.id_for_label }}').value.trim();
        const cantidad = document.getElementById('{{ form.cantidad.id_for_label }}').value;
        const stockMinimo = document.getElementById('{{ form.stock_minimo.id_for_label }}').value;
        
        if (!nombre) {
            e.preventDefault();
            alert('El nombre del producto es obligatorio.');
            return false;
        }
        
        if (parseInt(cantidad) < 0) {
            e.preventDefault();
            alert('La cantidad no puede ser negativa.');
            return false;
        }
        
        // Validación condicional de stock mínimo
        const esObjetoUnico = document.getElementById('{{ form.es_objeto_unico.id_for_label }}').checked;
        if (!esObjetoUnico && parseInt(stockMinimo) < 1) {
            e.preventDefault();
            alert('El stock mínimo debe ser al menos 1 para productos normales.');
            return false;
        }
        if (esObjetoUnico && parseInt(stockMinimo) < 0) {
            e.preventDefault();
            alert('El stock mínimo no puede ser negativo.');
            return false;
        }
    });
    
    // Auto-focus en el primer campo
    document.getElementById('{{ form.nombre.id_for_label }}').focus();
    
    // Manejo de campos fraccionables
    const esFraccionableCheckbox = document.getElementById('{{ form.es_fraccionable.id_for_label }}');
    const camposFraccionables = document.getElementById('campos-fraccionables');
    const unidadBaseInput = document.getElementById('{{ form.unidad_base.id_for_label }}');
    const cantidadUnitariaInput = document.getElementById('{{ form.cantidad_unitaria.id_for_label }}');
    const cantidadActualInput = document.getElementById('{{ form.cantidad_actual.id_for_label }}');
    const cantidadMinimaAlertaInput = document.getElementById('{{ form.cantidad_minima_alerta.id_for_label }}');
    
    function toggleCamposFraccionables() {
        if (esFraccionableCheckbox.checked) {
            camposFraccionables.style.display = 'block';
            // Hacer campos requeridos
            unidadBaseInput.required = true;
            cantidadUnitariaInput.required = true;
            
            // Valores por defecto si están vacíos
            if (!unidadBaseInput.value) {
                unidadBaseInput.value = 'ml';
            }
            if (!cantidadUnitariaInput.value) {
                cantidadUnitariaInput.value = '1000';
            }
            if (!cantidadActualInput.value) {
                cantidadActualInput.value = cantidadUnitariaInput.value;
            }
            if (!cantidadMinimaAlertaInput.value) {
                cantidadMinimaAlertaInput.value = '100';
            }
        } else {
            camposFraccionables.style.display = 'none';
            // Quitar requerimientos
            unidadBaseInput.required = false;
            cantidadUnitariaInput.required = false;
            
            // Limpiar valores
            unidadBaseInput.value = 'unidades';
            cantidadUnitariaInput.value = '1';
            cantidadActualInput.value = '0';
            cantidadMinimaAlertaInput.value = '0';
        }
    }
    
    // Inicializar estado
    toggleCamposFraccionables();
    
    // Event listener para el checkbox
    esFraccionableCheckbox.addEventListener('change', toggleCamposFraccionables);
    
    // Manejo de objetos únicos
    const esObjetoUnicoCheckbox = document.getElementById('{{ form.es_objeto_unico.id_for_label }}');
    
    // Inicializar estado del objeto único
    toggleStockMinimoUnico();
    
    // Event listener para el checkbox de objeto único
    esObjetoUnicoCheckbox.addEventListener('change', toggleStockMinimoUnico);
    
    // Auto-completar cantidad actual cuando cambia la cantidad unitaria
    cantidadUnitariaInput.addEventListener('input', function() {
        if (esFraccionableCheckbox.checked && !cantidadActualInput.value) {
            cantidadActualInput.value = this.value;
        }
    });
    
    // Validación adicional para campos fraccionables
    document.querySelector('form').addEventListener('submit', function(e) {
        if (esFraccionableCheckbox.checked) {
            const unidadBase = unidadBaseInput.value.trim();
            const cantidadUnitaria = parseFloat(cantidadUnitariaInput.value);
            const cantidadActual = parseFloat(cantidadActualInput.value);
            
            if (!unidadBase) {
                e.preventDefault();
                alert('La unidad base es obligatoria para productos fraccionables.');
                unidadBaseInput.focus();
                return false;
            }
            
            if (cantidadUnitaria <= 0) {
                e.preventDefault();
                alert('La cantidad unitaria debe ser mayor a 0.');
                cantidadUnitariaInput.focus();
                return false;
            }
            
            if (cantidadActual > cantidadUnitaria) {
                e.preventDefault();
                alert('La cantidad actual no puede ser mayor a la cantidad unitaria.');
                cantidadActualInput.focus();
                return false;
            }
        }
    });
});
</script>
{% endblock %}