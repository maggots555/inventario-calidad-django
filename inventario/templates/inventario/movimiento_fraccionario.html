{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">{{ titulo }}</h2>
                    <p class="text-muted mb-0">Consumo parcial de productos l√≠quidos o granulados</p>
                </div>
                <div>
                    <a href="{% url 'lista_movimientos' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-list"></i> Ver Movimientos
                    </a>
                    <a href="{% url 'movimiento_rapido' %}" class="btn btn-outline-primary">
                        <i class="fas fa-qrcode"></i> Movimiento Normal
                    </a>
                </div>
            </div>

            <!-- Informaci√≥n del Producto (Se llena din√°micamente) -->
            <div id="info-producto-container" style="display: none;">
                <div class="info-fraccionario">
                    <div class="titulo">
                        Informaci√≥n del Producto Fraccionable
                    </div>
                    <div id="info-producto-content">
                        <!-- Contenido din√°mico del producto -->
                    </div>
                    
                    <!-- Barra de progreso -->
                    <div class="mt-3">
                        <label class="form-label fw-bold">Nivel Actual:</label>
                        <div class="progress-fraccionario">
                            <div id="progress-bar-nivel" class="progress-bar-fraccionario nivel-alto" style="width: 0%">
                                <span id="progress-text">0%</span>
                            </div>
                        </div>
                        <div id="info-cantidad" class="text-muted small mt-1">
                            <!-- Informaci√≥n de cantidad -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas din√°micas -->
            <div id="alertas-container"></div>

            <!-- Formulario -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-flask text-primary me-2"></i>
                        Registrar Consumo Fraccionario
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="form-fraccionario">
                        {% csrf_token %}
                        
                        <!-- Secci√≥n 1: Identificaci√≥n del Producto -->
                        <div class="form-fraccionario mb-4">
                            <div class="titulo-seccion">
                                1. Identificar Producto
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="{{ form.codigo_qr.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-qr-code"></i> {{ form.codigo_qr.label }}
                                    </label>
                                    {{ form.codigo_qr }}
                                    {% if form.codigo_qr.help_text %}
                                        <div class="form-text">{{ form.codigo_qr.help_text }}</div>
                                    {% endif %}
                                    {% if form.codigo_qr.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.codigo_qr.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-primary w-100" id="btn-buscar-producto">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-scanner w-100" id="activarScannerBtn">
                                        <i class="bi bi-camera"></i> Scanner
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Informaci√≥n del Producto buscado (se llena autom√°ticamente) -->
                            <div id="productoInfoBusqueda" class="alert alert-info d-none mt-3">
                                <h6><i class="bi bi-info-circle"></i> Resultado de B√∫squeda</h6>
                                <div id="productoDetallesBusqueda"></div>
                            </div>
                        </div>

                        <!-- Secci√≥n 2: Informaci√≥n del Movimiento -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.tipo.id_for_label }}" class="form-label fw-bold">{{ form.tipo.label }}</label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                    <div class="text-danger small mt-1">{{ form.tipo.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.motivo.id_for_label }}" class="form-label fw-bold">{{ form.motivo.label }}</label>
                                {{ form.motivo }}
                                {% if form.motivo.errors %}
                                    <div class="text-danger small mt-1">{{ form.motivo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Secci√≥n 3: Cantidad Fraccionaria -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="{{ form.cantidad_fraccionaria.id_for_label }}" class="form-label fw-bold">
                                    {{ form.cantidad_fraccionaria.label }}
                                </label>
                                {{ form.cantidad_fraccionaria }}
                                {% if form.cantidad_fraccionaria.help_text %}
                                    <div class="form-text">{{ form.cantidad_fraccionaria.help_text }}</div>
                                {% endif %}
                                {% if form.cantidad_fraccionaria.errors %}
                                    <div class="text-danger small mt-1">{{ form.cantidad_fraccionaria.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.unidad_utilizada.id_for_label }}" class="form-label fw-bold">
                                    {{ form.unidad_utilizada.label }}
                                </label>
                                {{ form.unidad_utilizada }}
                                {% if form.unidad_utilizada.help_text %}
                                    <div class="form-text">{{ form.unidad_utilizada.help_text }}</div>
                                {% endif %}
                                {% if form.unidad_utilizada.errors %}
                                    <div class="text-danger small mt-1">{{ form.unidad_utilizada.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Secci√≥n 4: Destino -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="{{ form.sucursal_destino.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-building"></i> {{ form.sucursal_destino.label }}
                                </label>
                                {{ form.sucursal_destino }}
                                <div class="form-text">Selecciona la sucursal donde se utiliza el producto</div>
                                {% if form.sucursal_destino.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sucursal_destino.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.empleado_destinatario.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-person-check"></i> {{ form.empleado_destinatario.label }}
                                </label>
                                {{ form.empleado_destinatario }}
                                <div class="form-text">Selecciona el empleado que utiliza el producto</div>
                                {% if form.empleado_destinatario.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.empleado_destinatario.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- √Årea de Destino autom√°tica (se llena al seleccionar empleado) -->
                        <div class="row mt-3">
                            <div class="col-md-6 area-destino-container">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-geo-alt"></i> √Årea de Destino
                                </label>
                                <input type="text" id="areaDestinoDisplay" class="form-control" readonly placeholder="Se llena autom√°ticamente">
                                <div class="form-text">Se completa autom√°ticamente al seleccionar empleado destinatario</div>
                            </div>
                        </div>

                        <!-- Secci√≥n 5: Registro -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="{{ form.usuario_registro_empleado.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-person-badge-fill"></i> {{ form.usuario_registro_empleado.label }}
                                </label>
                                {{ form.usuario_registro_empleado }}
                                <div class="form-text">Selecciona el empleado que registra el movimiento fraccionario</div>
                                {% if form.usuario_registro_empleado.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.usuario_registro_empleado.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="mt-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-chat-text"></i> {{ form.observaciones.label }}
                            </label>
                            {{ form.observaciones }}
                            <div class="form-text">Informaci√≥n adicional sobre el consumo fraccionario (opcional)</div>
                            {% if form.observaciones.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.observaciones.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Errores generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger mt-3">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'lista_movimientos' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-primary" id="btn-registrar">
                                <i class="fas fa-save"></i> Registrar Movimiento Fraccionario
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Instrucciones de Uso del Scanner -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Instrucciones de Uso del Scanner</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üì± Con Scanner de C√°mara:</h6>
                            <ol class="small">
                                <li>Haz clic en "Scanner" junto al campo c√≥digo QR</li>
                                <li>Permite acceso a la c√°mara cuando se solicite</li>
                                <li>Coloca el c√≥digo de barras/QR dentro del marco azul</li>
                                <li>El c√≥digo se detectar√° y completar√° autom√°ticamente</li>
                                <li>Se buscar√° autom√°ticamente el producto fraccionario</li>
                            </ol>
                            <div class="alert alert-warning alert-sm">
                                <small><i class="bi bi-exclamation-triangle"></i> 
                                <strong>Android/iOS:</strong> Para usar la c√°mara necesitas conexi√≥n HTTPS. 
                                Si no funciona, usa entrada manual.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>‚å®Ô∏è Entrada Manual o Scanner F√≠sico:</h6>
                            <ol class="small">
                                <li>Escribe o escanea el c√≥digo QR/barras en el campo</li>
                                <li>El sistema buscar√° autom√°ticamente mientras escribes</li>
                                <li>Verifica la informaci√≥n del producto fraccionario</li>
                                <li>Completa los datos del consumo</li>
                                <li>Haz clic en "Registrar Movimiento Fraccionario"</li>
                            </ol>
                            <div class="alert alert-success alert-sm">
                                <small><i class="bi bi-check-circle"></i> 
                                <strong>Recomendado:</strong> Funciona con scanners f√≠sicos autom√°ticamente.</small>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="bi bi-droplet-half"></i>
                            <strong>Productos Fraccionarios:</strong> Solo productos configurados como fraccionarios 
                            (l√≠quidos, granulados, etc.) pueden ser procesados aqu√≠. 
                            Los productos normales se redirigen autom√°ticamente al movimiento est√°ndar.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- √Årea del Scanner de Video -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scannerModalLabel">
                    <i class="bi bi-camera"></i> Scanner Universal - QR y C√≥digos de Barras
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- √Årea de estado/mensajes -->
                <div id="scanner-status" class="mb-3"></div>
                
                <div class="scanner-container">
                    <div id="qr-video"></div>
                    <div class="scanner-overlay">
                        <div class="scanner-frame"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Scanner para Productos Fraccionarios:</strong> Detecta autom√°ticamente c√≥digos QR y c√≥digos de barras. 
                        Coloca el c√≥digo dentro del marco azul para escanearlo.
                    </div>
                    <div class="row text-start">
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>üì± C√≥digos QR:</strong><br>
                                ‚Ä¢ Cuadrados con puntos<br>
                                ‚Ä¢ Datos de texto/URL<br>
                                ‚Ä¢ Lectura 360¬∞
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>üìä C√≥digos de Barras:</strong><br>
                                ‚Ä¢ L√≠neas verticales<br>
                                ‚Ä¢ EAN, UPC, Code 128<br>
                                ‚Ä¢ Lectura horizontal
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cerrar Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Librer√≠as para Scanner Universal -->
<!-- QuaggaJS para c√≥digos de barras (EAN, UPC, Code 128, etc.) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<!-- jsQR para c√≥digos QR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========================================================================
    // VARIABLES PRINCIPALES PARA MOVIMIENTO FRACCIONARIO
    // ========================================================================
    
    const codigoQrInput = document.getElementById('codigo_qr_fraccionario');
    const btnBuscar = document.getElementById('btn-buscar-producto');
    const activarScannerBtn = document.getElementById('activarScannerBtn');
    const infoContainer = document.getElementById('info-producto-container');
    const alertasContainer = document.getElementById('alertas-container');
    const unidadUtilizadaInput = document.getElementById('{{ form.unidad_utilizada.id_for_label }}');
    
    // Variables para validaci√≥n visual y b√∫squeda de productos
    const productoInfoBusqueda = document.getElementById('productoInfoBusqueda');
    const productoDetallesBusqueda = document.getElementById('productoDetallesBusqueda');
    
    // Variables del scanner universal
    let scannerActivo = false;
    let videoElement = null;
    let canvasElement = null;
    let canvasContext = null;
    let intervalId = null;
    
    // Variables para detecci√≥n de scanner f√≠sico
    let ultimaTecla = 0;
    let tiempoScanner = [];
    let timeoutBusqueda = null;
    let intentosReintentar = 0;
    const MAX_REINTENTOS = 2;
    
    // ========================================================================
    // FUNCIONES DE B√öSQUEDA DE PRODUCTOS FRACCIONARIOS CON VALIDACI√ìN ROBUSTA
    // ========================================================================
    
    // Funci√≥n mejorada para buscar producto fraccionario con reintentos autom√°ticos
    function buscarProductoFraccionario(codigoQR, esReintento = false) {
        if (codigoQR.length < 3) {
            // Ocultar informaci√≥n si el c√≥digo es muy corto
            productoInfoBusqueda.classList.add('d-none');
            actualizarValidacionVisual('neutro');
            return;
        }
        
        // Mostrar estado de carga
        if (!esReintento) {
            actualizarValidacionVisual('buscando');
            productoInfoBusqueda.classList.remove('d-none');
            productoInfoBusqueda.classList.remove('alert-success', 'alert-warning', 'alert-danger');
            productoInfoBusqueda.classList.add('alert-info');
            productoDetallesBusqueda.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Buscando producto fraccionario: "${codigoQR}"...</span>
                </div>
            `;
        }
        
        fetch(`{% url 'buscar_producto_fraccionable_qr' %}?codigo_qr=${encodeURIComponent(codigoQR)}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(data => Promise.reject(data));
                }
            })
            .then(data => {
                // √âxito: producto fraccionario encontrado
                intentosReintentar = 0; // Resetear contador de reintentos
                
                let mensajeExtra = '';
                if (data.mensaje && data.mensaje.includes('normalizado')) {
                    mensajeExtra = `<br><small class="text-info"><i class="bi bi-info-circle"></i> ${data.mensaje}</small>`;
                }
                
                productoDetallesBusqueda.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <strong>${data.nombre}</strong><br>
                            <small class="text-muted">
                                C√≥digo: ${data.codigo_qr} | 
                                Unidad Base: ${data.unidad_base} | 
                                Capacidad: ${data.cantidad_unitaria} ${data.unidad_base} | 
                                Disponible: ${data.cantidad_total_disponible.toFixed(2)} ${data.unidad_base}
                            </small>
                            ${mensajeExtra}
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-success">‚úì Producto Fraccionario</span>
                        </div>
                    </div>
                `;
                productoInfoBusqueda.classList.remove('d-none');
                productoInfoBusqueda.classList.remove('alert-danger', 'alert-warning', 'alert-info');
                productoInfoBusqueda.classList.add('alert-success');
                
                // Actualizar validaci√≥n visual a √©xito
                actualizarValidacionVisual('exito');
                
                // Mostrar informaci√≥n detallada del producto fraccionario
                mostrarInfoProductoFraccionario(data);
                limpiarAlertas();
                
                // Hacer foco en el siguiente campo
                setTimeout(() => {
                    document.getElementById('{{ form.tipo.id_for_label }}').focus();
                }, 200);
            })
            .catch(error => {
                // Verificar si es un producto NO fraccionario
                if (error.es_no_fraccionable) {
                    // PRODUCTO NORMAL: Mostrar mensaje de redirecci√≥n
                    intentosReintentar = 0;
                    productoDetallesBusqueda.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-box text-warning me-2 fs-4"></i>
                                    <div>
                                        <strong class="text-warning">Producto Normal Detectado</strong><br>
                                        <span class="fw-semibold">${error.nombre}</span>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Este producto NO es fraccionario y debe procesarse 
                                    en el <strong>Movimiento R√°pido est√°ndar</strong>.
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="${error.url_movimiento_normal}" class="btn btn-warning">
                                    <i class="bi bi-arrow-right"></i> Ir a Movimiento R√°pido
                                </a>
                            </div>
                        </div>
                    `;
                    productoInfoBusqueda.classList.remove('d-none', 'alert-success', 'alert-danger');
                    productoInfoBusqueda.classList.add('alert-warning');
                    
                    // Actualizar validaci√≥n visual
                    actualizarValidacionVisual('info');
                    return;
                }
                
                // Error: producto no encontrado u otro error
                const mensajeError = error.error || 'Producto fraccionario no encontrado';
                const codigoRecibido = error.codigo_recibido || codigoQR;
                const sugerencia = error.sugerencia || 'Verifica que el c√≥digo pertenezca a un producto fraccionario';
                
                // Si no es un reintento y quedan intentos, reintentar autom√°ticamente
                if (!esReintento && intentosReintentar < MAX_REINTENTOS) {
                    intentosReintentar++;
                    console.log(`üîÑ Reintentando b√∫squeda fraccionaria (intento ${intentosReintentar}/${MAX_REINTENTOS}): ${codigoQR}`);
                    
                    // Reintento con una versi√≥n m√°s limpia del c√≥digo
                    const codigoMasLimpio = limpiarCodigoAvanzado(codigoQR);
                    setTimeout(() => {
                        buscarProductoFraccionario(codigoMasLimpio, true);
                    }, 300);
                    return;
                }
                
                // Mostrar error definitivo
                intentosReintentar = 0;
                productoDetallesBusqueda.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i> 
                        <div>
                            <strong>${mensajeError}</strong><br>
                            <small>C√≥digo: "${codigoRecibido}"</small><br>
                            <small class="text-muted">${sugerencia}</small>
                        </div>
                    </div>
                `;
                productoInfoBusqueda.classList.remove('d-none', 'alert-success', 'alert-info');
                productoInfoBusqueda.classList.add('alert-warning');
                
                // Ocultar informaci√≥n detallada del producto
                ocultarInfoProducto();
                
                // Actualizar validaci√≥n visual a error
                actualizarValidacionVisual('error');
            });
    }
    
    // Funci√≥n para limpiar c√≥digo con m√∫ltiples estrategias (igual que en movimiento r√°pido)
    function limpiarCodigoAvanzado(codigo) {
        if (!codigo) return '';
        
        // Estrategia 1: Limpieza b√°sica
        let codigoLimpio = codigo.toString().trim();
        
        // Estrategia 2: Remover caracteres invisibles comunes de scanners
        codigoLimpio = codigoLimpio.replace(/[\r\n\t\x00-\x08\x0B\x0C\x0E-\x1f\x7f-\x9f]/g, '');
        
        // Estrategia 3: Remover espacios internos y externos
        codigoLimpio = codigoLimpio.replace(/\s+/g, '');
        
        // Estrategia 4: Normalizar caracteres especiales
        codigoLimpio = codigoLimpio.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        // Estrategia 5: Convertir a may√∫sculas para consistencia
        codigoLimpio = codigoLimpio.toUpperCase();
        
        return codigoLimpio;
    }
    
    // Funci√≥n para actualizar la validaci√≥n visual del campo
    function actualizarValidacionVisual(estado) {
        const campo = codigoQrInput;
        
        // Remover todas las clases de estado previas
        campo.classList.remove('is-valid', 'is-invalid', 'field-searching', 'field-success', 'field-error', 'field-info');
        campo.style.borderColor = '';
        campo.style.backgroundColor = '';
        
        switch(estado) {
            case 'exito':
                campo.classList.add('is-valid', 'field-success');
                break;
            case 'info':
                campo.classList.add('field-info');
                break;
            case 'error':
                campo.classList.add('is-invalid', 'field-error');
                break;
            case 'buscando':
                campo.classList.add('field-searching');
                break;
            case 'neutro':
            default:
                // Estado neutro - sin colores especiales
                break;
        }
    }
    
    // Funci√≥n para detectar si es un scanner f√≠sico
    function detectarScannerFisico() {
        const ahora = Date.now();
        tiempoScanner.push(ahora);
        
        // Mantener solo los √∫ltimos 10 eventos
        if (tiempoScanner.length > 10) {
            tiempoScanner = tiempoScanner.slice(-10);
        }
        
        // Si hay varios caracteres en menos de 100ms, probablemente es scanner f√≠sico
        if (tiempoScanner.length >= 3) {
            const tiempoTotal = tiempoScanner[tiempoScanner.length - 1] - tiempoScanner[0];
            const caracteresporMs = tiempoScanner.length / tiempoTotal;
            
            // Si escribe m√°s de 10 caracteres por segundo, es probable que sea scanner
            return caracteresporMs > 0.01; // 10 chars/segundo
        }
        
        return false;
    }
    
    // Funci√≥n principal para manejar cambios en el campo con debouncing inteligente
    function manejarCambioCodigo(event) {
        const esScanner = detectarScannerFisico();
        let codigo = codigoQrInput.value;
        
        // Limpiar c√≥digo autom√°ticamente
        const codigoLimpio = limpiarCodigoAvanzado(codigo);
        
        // Si el c√≥digo fue limpiado, actualizar el campo
        if (codigo !== codigoLimpio && codigoLimpio.length > 0) {
            codigoQrInput.value = codigoLimpio;
            // Mantener cursor al final
            codigoQrInput.setSelectionRange(codigoLimpio.length, codigoLimpio.length);
        }
        
        // Cancelar b√∫squeda anterior si existe
        if (timeoutBusqueda) {
            clearTimeout(timeoutBusqueda);
        }
        
        // Debouncing inteligente: menos tiempo para scanners, m√°s para escritura manual
        const tiempoEspera = esScanner ? 100 : 500;
        
        timeoutBusqueda = setTimeout(() => {
            if (codigoLimpio.length >= 3) {
                console.log(`üîç Buscando producto fraccionario: "${codigoLimpio}" (Scanner: ${esScanner})`);
                buscarProductoFraccionario(codigoLimpio);
            } else if (codigoLimpio.length === 0) {
                // Campo vac√≠o
                productoInfoBusqueda.classList.add('d-none');
                actualizarValidacionVisual('neutro');
                ocultarInfoProducto();
            } else {
                // C√≥digo muy corto
                actualizarValidacionVisual('neutro');
            }
        }, tiempoEspera);
    }
    
    // ========================================================================
    // FUNCIONES EXISTENTES PARA PRODUCTOS FRACCIONARIOS (PRESERVADAS)
    // ========================================================================
    
    // Funci√≥n para buscar producto (bot√≥n manual - preservada)
    function buscarProducto() {
        const codigo = codigoQrInput.value.trim();
        if (!codigo) {
            mostrarAlerta('Por favor ingrese un c√≥digo QR', 'warning');
            return;
        }
        
        // Usar la nueva funci√≥n robusta
        buscarProductoFraccionario(codigo);
    }
    
    // Funci√≥n para mostrar informaci√≥n del producto fraccionario (preservada y mejorada)
    function mostrarInfoProductoFraccionario(producto) {
        const infoContent = document.getElementById('info-producto-content');
        const progressBar = document.getElementById('progress-bar-nivel');
        const progressText = document.getElementById('progress-text');
        const infoCantidad = document.getElementById('info-cantidad');
        
        // Actualizar contenido de informaci√≥n
        infoContent.innerHTML = `
            <div class="detalle">
                <div class="item">
                    <span class="label">Producto:</span>
                    <span class="valor">${producto.nombre}</span>
                </div>
                <div class="item">
                    <span class="label">Unidad Base:</span>
                    <span class="valor">${producto.unidad_base}</span>
                </div>
                <div class="item">
                    <span class="label">Capacidad Unitaria:</span>
                    <span class="valor">${producto.cantidad_unitaria} ${producto.unidad_base}</span>
                </div>
                <div class="item">
                    <span class="label">Total Disponible:</span>
                    <span class="valor">${producto.cantidad_total_disponible.toFixed(2)} ${producto.unidad_base}</span>
                </div>
            </div>
        `;
        
        // Actualizar barra de progreso
        const porcentaje = producto.porcentaje_disponible;
        progressBar.style.width = porcentaje + '%';
        progressText.textContent = porcentaje.toFixed(1) + '%';
        
        // Determinar clase de nivel
        let claseNivel = 'nivel-alto';
        if (porcentaje <= 30) {
            claseNivel = 'nivel-bajo';
        } else if (porcentaje <= 70) {
            claseNivel = 'nivel-medio';
        }
        
        progressBar.className = `progress-bar-fraccionario ${claseNivel}`;
        
        // Informaci√≥n de cantidad
        infoCantidad.innerHTML = `
            Disponible: ${producto.cantidad_actual.toFixed(2)} ${producto.unidad_base} de ${producto.cantidad_unitaria} ${producto.unidad_base}
            (${producto.unidades_completas} unidades completas restantes)
        `;
        
        // Auto-completar unidad utilizada
        if (unidadUtilizadaInput) {
            unidadUtilizadaInput.value = producto.unidad_base;
        }
        
        // Mostrar alerta si stock bajo
        if (producto.stock_fraccionario_bajo) {
            mostrarAlerta(
                `‚ö†Ô∏è Stock fraccionario bajo: Solo quedan ${producto.cantidad_actual.toFixed(2)} ${producto.unidad_base}`,
                'warning'
            );
        }
        
        // Mostrar contenedor
        infoContainer.style.display = 'block';
    }
    
    // Funci√≥n para ocultar informaci√≥n del producto
    function ocultarInfoProducto() {
        infoContainer.style.display = 'none';
    }
    
    // Funci√≥n para mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        limpiarAlertas();
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
        alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertasContainer.appendChild(alerta);
    }
    
    // Funci√≥n para limpiar alertas
    function limpiarAlertas() {
        alertasContainer.innerHTML = '';
    }
    
    // ========================================================================
    // EVENTOS MEJORADOS PARA SCANNER F√çSICO Y MANUAL (MOVIMIENTO FRACCIONARIO)
    // ========================================================================
    
    // Evento principal: input (escritura en tiempo real)
    codigoQrInput.addEventListener('input', manejarCambioCodigo);
    
    // Evento de cambio (cuando el campo pierde foco o Enter)
    codigoQrInput.addEventListener('change', function() {
        console.log('üìù Evento change disparado (fraccionario)');
        manejarCambioCodigo();
    });
    
    // Evento keyup (√∫til para scanners que no disparan input correctamente)
    codigoQrInput.addEventListener('keyup', function(e) {
        // Solo procesar si es una tecla significativa (no flechas, ctrl, etc.)
        if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
            manejarCambioCodigo();
        }
    });
    
    // Evento paste (copiar y pegar)
    codigoQrInput.addEventListener('paste', function(e) {
        console.log('üìã Evento paste disparado (fraccionario)');
        // Esperar a que el paste se complete
        setTimeout(() => {
            manejarCambioCodigo();
        }, 50);
    });
    
    // Evento para Internet Explorer (compatibilidad legacy)
    if (codigoQrInput.attachEvent) {
        codigoQrInput.attachEvent('onpropertychange', function() {
            if (event.propertyName === 'value') {
                manejarCambioCodigo();
            }
        });
    }
    
    // Evento focus - resetear estado visual
    codigoQrInput.addEventListener('focus', function() {
        if (this.value.length === 0) {
            actualizarValidacionVisual('neutro');
        }
    });
    
    // Evento blur - validar una vez m√°s al salir del campo
    codigoQrInput.addEventListener('blur', function() {
        if (this.value.length >= 3) {
            // Forzar una √∫ltima b√∫squeda al salir del campo
            setTimeout(() => {
                buscarProductoFraccionario(limpiarCodigoAvanzado(this.value));
            }, 100);
        }
    });
    
    // ========================================================================
    // FUNCIONALIDAD DE AUTO-LLENADO DE √ÅREA PARA EMPLEADOS
    // ========================================================================
    
    // Elementos para funcionalidad de empleados
    const empleadoDestinatarioSelect = document.getElementById('{{ form.empleado_destinatario.id_for_label }}');
    const areaDestinoDisplay = document.getElementById('areaDestinoDisplay');
    
    // Funci√≥n para actualizar √°rea autom√°ticamente al seleccionar empleado destinatario
    function actualizarAreaEmpleado() {
        if (!empleadoDestinatarioSelect || !areaDestinoDisplay) {
            console.warn('üö® Elementos de √°rea no encontrados:', {
                empleadoSelect: !!empleadoDestinatarioSelect,
                areaDisplay: !!areaDestinoDisplay
            });
            return;
        }
        
        const selectedOption = empleadoDestinatarioSelect.options[empleadoDestinatarioSelect.selectedIndex];
        
        if (selectedOption && selectedOption.value && selectedOption.dataset.area) {
            const area = selectedOption.dataset.area;
            areaDestinoDisplay.value = area;
            areaDestinoDisplay.className = 'form-control area-destino-success';
            console.log(`‚úÖ √Årea actualizada: ${area}`);
        } else if (selectedOption && selectedOption.value) {
            areaDestinoDisplay.value = '√Årea no especificada';
            areaDestinoDisplay.className = 'form-control area-destino-warning';
            console.log('‚ö†Ô∏è Empleado sin √°rea especificada');
        } else {
            areaDestinoDisplay.value = '';
            areaDestinoDisplay.className = 'form-control';
            console.log('üìù Campo √°rea limpiado');
        }
    }
    
    // Event listener para empleado destinatario con debugging
    if (empleadoDestinatarioSelect && areaDestinoDisplay) {
        console.log('‚úÖ Elementos de √°rea encontrados correctamente');
        console.log('ID empleado select:', empleadoDestinatarioSelect.id);
        console.log('ID √°rea display:', areaDestinoDisplay.id);
        
        empleadoDestinatarioSelect.addEventListener('change', function() {
            console.log('üìù Evento change disparado en empleado destinatario');
            actualizarAreaEmpleado();
        });
        
        // Ejecutar al cargar para casos de edici√≥n
        actualizarAreaEmpleado();
    } else {
        console.error('üö® Error: No se encontraron los elementos de √°rea');
        console.log('Empleado select:', empleadoDestinatarioSelect);
        console.log('√Årea display:', areaDestinoDisplay);
    }
    
    // ========================================================================
    // SCANNER UNIVERSAL - H√çBRIDO PARA QR Y C√ìDIGOS DE BARRAS
    // ========================================================================
    
    // Activar scanner universal
    if (activarScannerBtn) {
        activarScannerBtn.addEventListener('click', function() {
            const scannerModal = new bootstrap.Modal(document.getElementById('scannerModal'));
            scannerModal.show();
            
            // Inicializar scanner cuando se abra el modal
            document.getElementById('scannerModal').addEventListener('shown.bs.modal', function() {
                iniciarScannerUniversal();
            });
            
            // Detener scanner cuando se cierre el modal
            document.getElementById('scannerModal').addEventListener('hidden.bs.modal', function() {
                detenerScannerUniversal();
            });
        });
    }
    
    // Funci√≥n principal del scanner universal (igual que en movimiento r√°pido)
    async function iniciarScannerUniversal() {
        // Verificar compatibilidad del navegador
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            mostrarError('Tu navegador no soporta acceso a la c√°mara. Usa entrada manual.');
            return;
        }
        
        // Verificar HTTPS (requerido para c√°mara en m√≥viles)
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            mostrarErrorHTTPS();
            return;
        }
        
        try {
            // Configurar elementos de video y canvas
            setupVideoCanvas();
            
            // Solicitar acceso a la c√°mara con configuraci√≥n optimizada
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment', // C√°mara trasera en m√≥viles
                    width: { ideal: 1280, min: 640, max: 1920 },
                    height: { ideal: 720, min: 480, max: 1080 },
                    aspectRatio: { ideal: 16/9 },
                    frameRate: { ideal: 30, min: 15 }
                }
            });
            
            videoElement.srcObject = stream;
            
            // Esperar a que el video se cargue completamente
            await new Promise((resolve) => {
                videoElement.addEventListener('loadedmetadata', () => {
                    // Ajustar canvas al tama√±o real del video
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    resolve();
                });
            });
            
            await videoElement.play();
            scannerActivo = true;
            
            mostrarMensaje('success', 'üìπ Scanner activo - Enfoca el c√≥digo hacia la c√°mara');
            
            // Inicializar Quagga para c√≥digos de barras
            iniciarQuaggaScanner();
            
            // Inicializar jsQR para c√≥digos QR (en paralelo)
            iniciarQRScanner();
            
        } catch (error) {
            console.error('Error al iniciar scanner:', error);
            
            if (error.name === 'NotAllowedError') {
                mostrarError('Permisos de c√°mara denegados. Permite el acceso en la configuraci√≥n del navegador.');
            } else if (error.name === 'NotFoundError') {
                mostrarError('No se encontr√≥ c√°mara en tu dispositivo.');
            } else if (error.name === 'NotSupportedError') {
                mostrarError('Tu navegador no soporta esta funcionalidad.');
            } else {
                mostrarError(`Error del scanner: ${error.message}`);
            }
        }
    }
    
    // Configurar elementos de video y canvas
    function setupVideoCanvas() {
        const videoContainer = document.getElementById('qr-video');
        videoContainer.innerHTML = '';
        
        // Crear elemento de video
        videoElement = document.createElement('video');
        videoElement.style.cssText = `
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            border: none;
            outline: none;
            display: block;
            margin: 0;
            padding: 0;
        `;
        videoElement.setAttribute('autoplay', '');
        videoElement.setAttribute('muted', '');
        videoElement.setAttribute('playsinline', ''); // iOS compatibility
        videoContainer.appendChild(videoElement);
        
        // Crear canvas para jsQR (completamente oculto)
        canvasElement = document.createElement('canvas');
        canvasContext = canvasElement.getContext('2d');
        canvasElement.style.cssText = 'display: none; position: absolute; top: -9999px; left: -9999px;';
        document.body.appendChild(canvasElement); // Agregar al body en lugar del contenedor
    }
    
    // Inicializar Quagga para c√≥digos de barras
    function iniciarQuaggaScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoElement,
                constraints: {
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",    // Code 128 (com√∫n en inventarios)
                    "ean_reader",         // EAN-13 (productos comerciales)
                    "ean_8_reader",       // EAN-8 (productos peque√±os)
                    "code_39_reader",     // Code 39 (uso industrial)
                    "upc_reader",         // UPC-A (productos USA)
                    "upc_e_reader",       // UPC-E (productos peque√±os USA)
                    "codabar_reader",     // Codabar (bibliotecas, bancos)
                    "i2of5_reader"        // Interleaved 2 of 5
                ]
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: 2,
            frequency: 10, // Verificar cada 100ms
            debug: false   // Sin debug en producci√≥n
        }, function(err) {
            if (err) {
                console.error('Error Quagga:', err);
                return;
            }
            
            Quagga.start();
            console.log('‚úÖ Scanner de c√≥digos de barras iniciado (fraccionario)');
        });
        
        // Detectar c√≥digos de barras
        Quagga.onDetected(function(result) {
            const codigo = result.codeResult.code;
            const confianza = result.codeResult.confidence || 0;
            
            // Solo aceptar c√≥digos con buena confianza
            if (confianza > 70) {
                console.log(`üìä C√≥digo de barras detectado (fraccionario): ${codigo} (confianza: ${confianza.toFixed(1)}%)`);
                procesarCodigoDetectado(codigo, 'C√≥digo de Barras');
            }
        });
    }
    
    // Inicializar jsQR para c√≥digos QR
    function iniciarQRScanner() {
        intervalId = setInterval(() => {
            if (scannerActivo && videoElement && videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                escanearQR();
            }
        }, 100); // Verificar cada 100ms
        
        console.log('‚úÖ Scanner de c√≥digos QR iniciado (fraccionario)');
    }
    
    // Funci√≥n para escanear c√≥digos QR con jsQR
    function escanearQR() {
        if (!videoElement || !canvasElement || !canvasContext) return;
        
        // Ajustar canvas al video
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        
        // Dibujar frame actual del video en canvas
        canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        
        // Obtener datos de imagen
        const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
        
        // Buscar c√≥digo QR
        const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert"
        });
        
        if (qrCode) {
            console.log(`üì± C√≥digo QR detectado (fraccionario): ${qrCode.data}`);
            procesarCodigoDetectado(qrCode.data, 'C√≥digo QR');
        }
    }
    
    // Procesar c√≥digo detectado (com√∫n para QR y barras) - adaptado para fraccionario
    function procesarCodigoDetectado(codigo, tipo) {
        if (!scannerActivo) return; // Evitar detecciones m√∫ltiples
        
        scannerActivo = false; // Pausar scanner temporalmente
        
        // Sonido de confirmaci√≥n
        reproducirSonidoConfirmacion();
        
        // Feedback visual
        mostrarMensaje('success', `‚úÖ ${tipo} detectado: ${codigo}`);
        
        // Llenar campo de entrada
        codigoQrInput.value = codigo;
        
        // Disparar evento 'input' para activar la b√∫squeda del producto fraccionario
        const inputEvent = new Event('input', { bubbles: true });
        codigoQrInput.dispatchEvent(inputEvent);
        
        // Buscar producto fraccionario autom√°ticamente
        buscarProductoFraccionario(codigo);
        
        // Cerrar modal despu√©s de un momento
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
            
            // Hacer foco en el siguiente campo
            document.getElementById('{{ form.tipo.id_for_label }}').focus();
        }, 1000);
    }
    
    // Detener scanner universal
    function detenerScannerUniversal() {
        scannerActivo = false;
        
        // Detener Quagga
        if (typeof Quagga !== 'undefined') {
            Quagga.stop();
        }
        
        // Detener jsQR
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }
        
        // Detener video stream
        if (videoElement && videoElement.srcObject) {
            const tracks = videoElement.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            videoElement.srcObject = null;
        }
        
        console.log('üõë Scanner universal detenido (fraccionario)');
    }
    
    // Funciones de utilidad para el scanner
    function mostrarMensaje(tipo, mensaje) {
        const iconos = {
            success: '‚úÖ',
            warning: '‚ö†Ô∏è', 
            error: '‚ùå',
            info: '‚ÑπÔ∏è'
        };
        
        const clases = {
            success: 'alert-success',
            warning: 'alert-warning',
            error: 'alert-danger', 
            info: 'alert-info'
        };
        
        document.getElementById('scanner-status').innerHTML = 
            `<div class="alert ${clases[tipo]}">
                ${iconos[tipo]} ${mensaje}
            </div>`;
    }
    
    function mostrarError(mensaje) {
        mostrarMensaje('error', mensaje);
    }
    
    function mostrarErrorHTTPS() {
        mostrarMensaje('warning', 
            'Para usar la c√°mara necesitas conexi√≥n HTTPS. Mientras tanto, escribe el c√≥digo manualmente.');
    }
    
    function reproducirSonidoConfirmacion() {
        try {
            // Crear sonido de beep de confirmaci√≥n
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // Frecuencia del beep
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
            // Silenciosamente ignorar errores de audio
        }
    }
    
    // ========================================================================
    // EVENTOS LEGACY (preservados para compatibilidad)
    // ========================================================================
    
    // Event listeners preservados para compatibilidad
    btnBuscar.addEventListener('click', buscarProducto);
    
    // Buscar autom√°ticamente cuando se presiona Enter en el campo de c√≥digo QR
    codigoQrInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarProducto();
        }
    });
    
    // Auto-focus en el campo de c√≥digo QR
    codigoQrInput.focus();
    
    // ========================================================================
    // VALIDACI√ìN DEL FORMULARIO FRACCIONARIO
    // ========================================================================
    
    document.getElementById('form-fraccionario').addEventListener('submit', function(e) {
        const codigoQR = codigoQrInput.value.trim();
        const tipo = document.getElementById('{{ form.tipo.id_for_label }}').value;
        const cantidadFraccionaria = document.getElementById('{{ form.cantidad_fraccionaria.id_for_label }}').value;
        const unidadUtilizada = document.getElementById('{{ form.unidad_utilizada.id_for_label }}').value;
        const sucursalDestino = document.getElementById('{{ form.sucursal_destino.id_for_label }}').value;
        const usuarioRegistro = document.getElementById('{{ form.usuario_registro_empleado.id_for_label }}').value;
        const empleadoDestinatario = document.getElementById('{{ form.empleado_destinatario.id_for_label }}').value;
        
        // Validar campos obligatorios
        if (!codigoQR || !tipo || !cantidadFraccionaria || !unidadUtilizada || !sucursalDestino || !usuarioRegistro || !empleadoDestinatario) {
            e.preventDefault();
            
            // Identificar qu√© campo espec√≠fico falta
            const camposFaltantes = [];
            if (!codigoQR) camposFaltantes.push('C√≥digo QR');
            if (!tipo) camposFaltantes.push('Tipo de Movimiento');
            if (!cantidadFraccionaria) camposFaltantes.push('Cantidad Fraccionaria');
            if (!unidadUtilizada) camposFaltantes.push('Unidad Utilizada');
            if (!sucursalDestino) camposFaltantes.push('Sucursal Destino');
            if (!usuarioRegistro) camposFaltantes.push('Usuario que Registra');
            if (!empleadoDestinatario) camposFaltantes.push('Empleado Destinatario');
            
            alert(`‚ö†Ô∏è Por favor, completa los siguientes campos obligatorios:\n‚Ä¢ ${camposFaltantes.join('\n‚Ä¢ ')}`);
            return false;
        }
        
        if (parseFloat(cantidadFraccionaria) <= 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è La cantidad fraccionaria debe ser mayor que cero.');
            return false;
        }
        
        // Confirmaci√≥n antes de registrar con informaci√≥n espec√≠fica para fraccionarios
        const tipoTexto = document.getElementById('{{ form.tipo.id_for_label }}').options[document.getElementById('{{ form.tipo.id_for_label }}').selectedIndex].text;
        const sucursalTexto = document.getElementById('{{ form.sucursal_destino.id_for_label }}').options[document.getElementById('{{ form.sucursal_destino.id_for_label }}').selectedIndex].text;
        
        if (!confirm(`¬øConfirmas registrar el siguiente movimiento fraccionario?\n\n` +
                    `‚Ä¢ Tipo: ${tipoTexto}\n` +
                    `‚Ä¢ Cantidad: ${cantidadFraccionaria} ${unidadUtilizada}\n` +
                    `‚Ä¢ Producto: ${codigoQR}\n` +
                    `‚Ä¢ Sucursal destino: ${sucursalTexto}`)) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}