{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">{{ titulo }}</h2>
                    <p class="text-muted mb-0">Consumo parcial de productos líquidos o granulados</p>
                </div>
                <div>
                    <a href="{% url 'lista_movimientos' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-list"></i> Ver Movimientos
                    </a>
                    <a href="{% url 'movimiento_rapido' %}" class="btn btn-outline-primary">
                        <i class="fas fa-qrcode"></i> Movimiento Normal
                    </a>
                </div>
            </div>

            <!-- Información del Producto (Se llena dinámicamente) -->
            <div id="info-producto-container" style="display: none;">
                <div class="info-fraccionario">
                    <div class="titulo">
                        Información del Producto Fraccionable
                    </div>
                    <div id="info-producto-content">
                        <!-- Contenido dinámico del producto -->
                    </div>
                    
                    <!-- Barra de progreso -->
                    <div class="mt-3">
                        <label class="form-label fw-bold">Nivel Actual:</label>
                        <div class="progress-fraccionario">
                            <div id="progress-bar-nivel" class="progress-bar-fraccionario nivel-alto" style="width: 0%">
                                <span id="progress-text">0%</span>
                            </div>
                        </div>
                        <div id="info-cantidad" class="text-muted small mt-1">
                            <!-- Información de cantidad -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas dinámicas -->
            <div id="alertas-container"></div>

            <!-- Formulario -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-flask text-primary me-2"></i>
                        Registrar Consumo Fraccionario
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="form-fraccionario">
                        {% csrf_token %}
                        
                        <!-- Sección 1: Identificación del Producto -->
                        <div class="form-fraccionario mb-4">
                            <div class="titulo-seccion">
                                1. Identificar Producto
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="{{ form.codigo_qr.id_for_label }}" class="form-label fw-bold">
                                        {{ form.codigo_qr.label }}
                                    </label>
                                    {{ form.codigo_qr }}
                                    {% if form.codigo_qr.help_text %}
                                        <div class="form-text">{{ form.codigo_qr.help_text }}</div>
                                    {% endif %}
                                    {% if form.codigo_qr.errors %}
                                        <div class="text-danger small mt-1">{{ form.codigo_qr.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-primary" id="btn-buscar-producto">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 2: Información del Movimiento -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.tipo.id_for_label }}" class="form-label fw-bold">{{ form.tipo.label }}</label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                    <div class="text-danger small mt-1">{{ form.tipo.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.motivo.id_for_label }}" class="form-label fw-bold">{{ form.motivo.label }}</label>
                                {{ form.motivo }}
                                {% if form.motivo.errors %}
                                    <div class="text-danger small mt-1">{{ form.motivo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sección 3: Cantidad Fraccionaria -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="{{ form.cantidad_fraccionaria.id_for_label }}" class="form-label fw-bold">
                                    {{ form.cantidad_fraccionaria.label }}
                                </label>
                                {{ form.cantidad_fraccionaria }}
                                {% if form.cantidad_fraccionaria.help_text %}
                                    <div class="form-text">{{ form.cantidad_fraccionaria.help_text }}</div>
                                {% endif %}
                                {% if form.cantidad_fraccionaria.errors %}
                                    <div class="text-danger small mt-1">{{ form.cantidad_fraccionaria.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.unidad_utilizada.id_for_label }}" class="form-label fw-bold">
                                    {{ form.unidad_utilizada.label }}
                                </label>
                                {{ form.unidad_utilizada }}
                                {% if form.unidad_utilizada.help_text %}
                                    <div class="form-text">{{ form.unidad_utilizada.help_text }}</div>
                                {% endif %}
                                {% if form.unidad_utilizada.errors %}
                                    <div class="text-danger small mt-1">{{ form.unidad_utilizada.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sección 4: Destino -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="{{ form.sucursal_destino.id_for_label }}" class="form-label fw-bold">{{ form.sucursal_destino.label }}</label>
                                {{ form.sucursal_destino }}
                                {% if form.sucursal_destino.errors %}
                                    <div class="text-danger small mt-1">{{ form.sucursal_destino.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.empleado_destinatario.id_for_label }}" class="form-label fw-bold">{{ form.empleado_destinatario.label }}</label>
                                {{ form.empleado_destinatario }}
                                {% if form.empleado_destinatario.errors %}
                                    <div class="text-danger small mt-1">{{ form.empleado_destinatario.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sección 5: Registro -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="{{ form.usuario_registro_empleado.id_for_label }}" class="form-label fw-bold">{{ form.usuario_registro_empleado.label }}</label>
                                {{ form.usuario_registro_empleado }}
                                {% if form.usuario_registro_empleado.errors %}
                                    <div class="text-danger small mt-1">{{ form.usuario_registro_empleado.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="mt-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label fw-bold">{{ form.observaciones.label }}</label>
                            {{ form.observaciones }}
                            {% if form.observaciones.errors %}
                                <div class="text-danger small mt-1">{{ form.observaciones.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Errores generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger mt-3">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'lista_movimientos' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-primary" id="btn-registrar">
                                <i class="fas fa-save"></i> Registrar Movimiento Fraccionario
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const codigoQrInput = document.getElementById('codigo_qr_fraccionario');
    const btnBuscar = document.getElementById('btn-buscar-producto');
    const infoContainer = document.getElementById('info-producto-container');
    const alertasContainer = document.getElementById('alertas-container');
    const unidadUtilizadaInput = document.getElementById('unidad_utilizada');
    
    // Función para buscar producto
    function buscarProducto() {
        const codigo = codigoQrInput.value.trim();
        if (!codigo) {
            mostrarAlerta('Por favor ingrese un código QR', 'warning');
            return;
        }
        
        // Mostrar indicador de carga
        btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        btnBuscar.disabled = true;
        
        fetch(`{% url 'buscar_producto_fraccionable_qr' %}?codigo_qr=${encodeURIComponent(codigo)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarAlerta(data.error, 'danger');
                    ocultarInfoProducto();
                } else {
                    mostrarInfoProducto(data);
                    limpiarAlertas();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al buscar el producto', 'danger');
                ocultarInfoProducto();
            })
            .finally(() => {
                btnBuscar.innerHTML = '<i class="fas fa-search"></i> Buscar';
                btnBuscar.disabled = false;
            });
    }
    
    // Función para mostrar información del producto
    function mostrarInfoProducto(producto) {
        const infoContent = document.getElementById('info-producto-content');
        const progressBar = document.getElementById('progress-bar-nivel');
        const progressText = document.getElementById('progress-text');
        const infoCantidad = document.getElementById('info-cantidad');
        
        // Actualizar contenido de información
        infoContent.innerHTML = `
            <div class="detalle">
                <div class="item">
                    <span class="label">Producto:</span>
                    <span class="valor">${producto.nombre}</span>
                </div>
                <div class="item">
                    <span class="label">Unidad Base:</span>
                    <span class="valor">${producto.unidad_base}</span>
                </div>
                <div class="item">
                    <span class="label">Capacidad Unitaria:</span>
                    <span class="valor">${producto.cantidad_unitaria} ${producto.unidad_base}</span>
                </div>
                <div class="item">
                    <span class="label">Total Disponible:</span>
                    <span class="valor">${producto.cantidad_total_disponible.toFixed(2)} ${producto.unidad_base}</span>
                </div>
            </div>
        `;
        
        // Actualizar barra de progreso
        const porcentaje = producto.porcentaje_disponible;
        progressBar.style.width = porcentaje + '%';
        progressText.textContent = porcentaje.toFixed(1) + '%';
        
        // Determinar clase de nivel
        let claseNivel = 'nivel-alto';
        if (porcentaje <= 30) {
            claseNivel = 'nivel-bajo';
        } else if (porcentaje <= 70) {
            claseNivel = 'nivel-medio';
        }
        
        progressBar.className = `progress-bar-fraccionario ${claseNivel}`;
        
        // Información de cantidad
        infoCantidad.innerHTML = `
            Disponible: ${producto.cantidad_actual.toFixed(2)} ${producto.unidad_base} de ${producto.cantidad_unitaria} ${producto.unidad_base}
            (${producto.unidades_completas} unidades completas restantes)
        `;
        
        // Auto-completar unidad utilizada
        unidadUtilizadaInput.value = producto.unidad_base;
        
        // Mostrar alerta si stock bajo
        if (producto.stock_fraccionario_bajo) {
            mostrarAlerta(
                `⚠️ Stock fraccionario bajo: Solo quedan ${producto.cantidad_actual.toFixed(2)} ${producto.unidad_base}`,
                'warning'
            );
        }
        
        // Mostrar contenedor
        infoContainer.style.display = 'block';
    }
    
    // Función para ocultar información del producto
    function ocultarInfoProducto() {
        infoContainer.style.display = 'none';
    }
    
    // Función para mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        limpiarAlertas();
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
        alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertasContainer.appendChild(alerta);
    }
    
    // Función para limpiar alertas
    function limpiarAlertas() {
        alertasContainer.innerHTML = '';
    }
    
    // Event listeners
    btnBuscar.addEventListener('click', buscarProducto);
    
    // Buscar automáticamente cuando se presiona Enter en el campo de código QR
    codigoQrInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarProducto();
        }
    });
    
    // Buscar automáticamente cuando el campo pierde el foco y tiene contenido
    codigoQrInput.addEventListener('blur', function() {
        if (this.value.trim()) {
            buscarProducto();
        }
    });
});
</script>
{% endblock %}