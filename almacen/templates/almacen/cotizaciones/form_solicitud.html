{% extends 'almacen/base_almacen.html' %}
{% load static %}

{% comment %}
Formulario para crear/editar Solicitudes de Cotización (Multi-Proveedor)
Incluye formset dinámico para agregar múltiples líneas con diferentes proveedores
{% endcomment %}

{% block title %}{{ titulo }} - Almacén{% endblock %}

{% block almacen_content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">
                <i class="bi bi-{% if es_creacion %}plus-circle{% else %}pencil{% endif %} me-2"></i>{{ titulo }}
            </h1>
            <p class="text-muted mb-0">
                {% if es_creacion %}
                Crea una cotización con múltiples productos y proveedores
                {% else %}
                Modifica la solicitud de cotización
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{% url 'almacen:lista_solicitudes_cotizacion' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Volver a Lista
            </a>
        </div>
    </div>

    <form method="post" id="solicitudForm">
        {% csrf_token %}
        
        <!-- Datos principales de la solicitud -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>Información de la Solicitud
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Checkbox Sin Orden Activa -->
                    <div class="col-12">
                        <div class="form-check form-switch">
                            {{ form.sin_orden_activa }}
                            <label class="form-check-label" for="sin_orden_activa">
                                <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                {{ form.sin_orden_activa.label }}
                            </label>
                            <div class="form-text">{{ form.sin_orden_activa.help_text }}</div>
                        </div>
                    </div>
                    
                    <!-- Número de Orden Cliente (visible cuando sin_orden_activa=false) -->
                    <div class="col-md-6" id="ordenClienteContainer">
                        <label class="form-label">
                            {{ form.numero_orden_cliente.label }} 
                            <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            {{ form.numero_orden_cliente }}
                            <button type="button" class="btn btn-outline-secondary" id="buscarOrdenBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            {{ form.numero_orden_cliente.help_text }}
                        </div>
                        {% if form.numero_orden_cliente.errors %}
                        <div class="text-danger small">
                            {{ form.numero_orden_cliente.errors.0 }}
                        </div>
                        {% endif %}
                        
                        <!-- Info de orden encontrada -->
                        <div id="ordenInfo" class="alert alert-info mt-2 d-none">
                            <strong>Orden encontrada:</strong>
                            <span id="ordenInfoTexto"></span>
                        </div>
                    </div>
                    
                    <!-- Folio de Referencia (visible cuando sin_orden_activa=true) -->
                    <div class="col-md-6 d-none" id="folioReferenciaContainer">
                        <label class="form-label">
                            {{ form.folio_referencia.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.folio_referencia }}
                        <div class="form-text">
                            {{ form.folio_referencia.help_text }}
                        </div>
                        {% if form.folio_referencia.errors %}
                        <div class="text-danger small">
                            {{ form.folio_referencia.errors.0 }}
                        </div>
                        {% endif %}
                        
                        <!-- Alerta informativa -->
                        <div class="alert alert-warning mt-2 small">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Nota:</strong> La orden de servicio se podrá vincular posteriormente 
                            desde "Editar Unidad" cuando se reciba la pieza.
                        </div>
                    </div>
                    
                    <!-- Observaciones -->
                    <div class="col-12">
                        <label class="form-label">{{ form.observaciones.label }}</label>
                        {{ form.observaciones }}
                        <div class="form-text">{{ form.observaciones.help_text }}</div>
                    </div>
                </div>
                
                <!-- Errores del formulario principal -->
                {% if form.errors %}
                <div class="alert alert-danger mt-3">
                    <strong>Errores en el formulario:</strong>
                    <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Líneas de Cotización (Formset) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Líneas de Cotización
                </h5>
                <button type="button" id="addLineaBtn" class="btn btn-light btn-sm">
                    <i class="bi bi-plus-lg me-1"></i>Agregar Línea
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Agrega cada producto que deseas cotizar. Puedes seleccionar diferentes proveedores para cada línea.
                </p>
                
                {{ formset.management_form }}
                
                <!-- Errores del formset -->
                {% if formset.non_form_errors %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                    {% for error in formset.non_form_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <div id="lineasContainer">
                    {% for linea_form in formset %}
                    <div class="linea-form border rounded p-3 mb-3 {% if linea_form.instance.pk %}bg-light{% endif %}">
                        <div class="row g-2">
                            <!-- Número de línea -->
                            <div class="col-md-1">
                                <label class="form-label small fw-bold">#</label>
                                <input type="text" class="form-control form-control-sm text-center linea-numero" 
                                       value="{{ forloop.counter }}" readonly>
                                {% if linea_form.instance.pk %}
                                {{ linea_form.id }}
                                {% endif %}
                            </div>
                            
                            <!-- Producto -->
                            <div class="col-md-3">
                                <label class="form-label small">Producto <span class="text-danger">*</span></label>
                                {{ linea_form.producto }}
                                {% if linea_form.producto.errors %}
                                <div class="text-danger small">{{ linea_form.producto.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Descripción de la pieza -->
                            <div class="col-md-4">
                                <label class="form-label small">Descripción <span class="text-danger">*</span></label>
                                {{ linea_form.descripcion_pieza }}
                                {% if linea_form.descripcion_pieza.errors %}
                                <div class="text-danger small">{{ linea_form.descripcion_pieza.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Proveedor -->
                            <div class="col-md-3">
                                <label class="form-label small">Proveedor <span class="text-danger">*</span></label>
                                {{ linea_form.proveedor }}
                                {% if linea_form.proveedor.errors %}
                                <div class="text-danger small">{{ linea_form.proveedor.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Eliminar -->
                            <div class="col-md-1 d-flex align-items-end">
                                {% if linea_form.instance.pk %}
                                <div class="form-check">
                                    {{ linea_form.DELETE }}
                                    <label class="form-check-label text-danger small">
                                        <i class="bi bi-trash"></i>
                                    </label>
                                </div>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-outline-danger remove-linea-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            
                            <!-- Segunda fila: Cantidad, Costo, Tiempo entrega, Notas -->
                            <div class="col-md-2">
                                <label class="form-label small">Cantidad <span class="text-danger">*</span></label>
                                {{ linea_form.cantidad }}
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label small">Costo Unit. <span class="text-danger">*</span></label>
                                {{ linea_form.costo_unitario }}
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label small">Entrega (días)</label>
                                {{ linea_form.tiempo_entrega_estimado }}
                            </div>
                            
                            <div class="col-md-5">
                                <label class="form-label small">Notas</label>
                                {{ linea_form.notas }}
                            </div>
                            
                            <!-- Subtotal calculado -->
                            <div class="col-md-1 d-flex align-items-end">
                                <div class="text-end w-100">
                                    <small class="text-muted">Subtotal:</small>
                                    <div class="fw-bold subtotal-linea">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <!-- Si no hay líneas, mostrar una vacía -->
                    {% endfor %}
                </div>
                
                <!-- Template para agregar nuevas líneas (oculto) -->
                <template id="lineaTemplate">
                    <div class="linea-form border rounded p-3 mb-3">
                        <div class="row g-2">
                            <div class="col-md-1">
                                <label class="form-label small fw-bold">#</label>
                                <input type="text" class="form-control form-control-sm text-center linea-numero" 
                                       value="1" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Producto <span class="text-danger">*</span></label>
                                <select name="lineas-__prefix__-producto" class="form-select form-select-sm producto-select" required>
                                    <option value="">-- Seleccionar Producto --</option>
                                    {% for producto in formset.form.fields.producto.queryset %}
                                    <option value="{{ producto.pk }}">{{ producto.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Descripción <span class="text-danger">*</span></label>
                                <input type="text" name="lineas-__prefix__-descripcion_pieza" 
                                       class="form-control form-control-sm" 
                                       placeholder="Ej: RAM DDR4 16GB 3200MHz Kingston Fury" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Proveedor <span class="text-danger">*</span></label>
                                <select name="lineas-__prefix__-proveedor" class="form-select form-select-sm proveedor-select" required>
                                    <option value="">-- Seleccionar Proveedor --</option>
                                    {% for proveedor in formset.form.fields.proveedor.queryset %}
                                    <option value="{{ proveedor.pk }}">{{ proveedor.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-linea-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label small">Cantidad <span class="text-danger">*</span></label>
                                <input type="number" name="lineas-__prefix__-cantidad" 
                                       class="form-control form-control-sm cantidad-input" 
                                       min="1" value="1" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Costo Unit. <span class="text-danger">*</span></label>
                                <input type="number" name="lineas-__prefix__-costo_unitario" 
                                       class="form-control form-control-sm costo-input" 
                                       min="0" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Entrega (días)</label>
                                <input type="number" name="lineas-__prefix__-tiempo_entrega_estimado" 
                                       class="form-control form-control-sm" min="0" placeholder="días">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label small">Notas</label>
                                <textarea name="lineas-__prefix__-notas" 
                                          class="form-control form-control-sm" rows="1"
                                          placeholder="Notas adicionales..."></textarea>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <div class="text-end w-100">
                                    <small class="text-muted">Subtotal:</small>
                                    <div class="fw-bold subtotal-linea">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Total general -->
                <div class="border-top pt-3 mt-3">
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4 text-end">
                            <h5>
                                Total General: 
                                <span id="totalGeneral" class="text-primary">$0.00</span>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between">
            <a href="{% url 'almacen:lista_solicitudes_cotizacion' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg me-1"></i>Cancelar
            </a>
            <div>
                <button type="submit" name="guardar_borrador" class="btn btn-secondary me-2">
                    <i class="bi bi-save me-1"></i>Guardar Borrador
                </button>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-lg me-1"></i>
                    {% if es_creacion %}Crear Solicitud{% else %}Guardar Cambios{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock almacen_content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('lineasContainer');
    const template = document.getElementById('lineaTemplate');
    const addBtn = document.getElementById('addLineaBtn');
    const totalFormsInput = document.querySelector('[name="lineas-TOTAL_FORMS"]');
    const buscarOrdenBtn = document.getElementById('buscarOrdenBtn');
    const ordenInput = document.getElementById('numero_orden_cliente');
    const ordenInfo = document.getElementById('ordenInfo');
    const ordenInfoTexto = document.getElementById('ordenInfoTexto');
    
    // ========== ELEMENTOS MODO SIN ORDEN ==========
    const sinOrdenCheckbox = document.getElementById('sin_orden_activa');
    const ordenClienteContainer = document.getElementById('ordenClienteContainer');
    const folioReferenciaContainer = document.getElementById('folioReferenciaContainer');
    const folioInput = document.getElementById('folio_referencia');
    
    let formCount = parseInt(totalFormsInput.value);
    
    // ========== FUNCIONES MODO SIN ORDEN ==========
    
    function toggleModoSinOrden() {
        const sinOrden = sinOrdenCheckbox.checked;
        
        if (sinOrden) {
            // Activar modo sin orden
            ordenClienteContainer.classList.add('d-none');
            folioReferenciaContainer.classList.remove('d-none');
            ordenInput.removeAttribute('required');
            folioInput.setAttribute('required', 'required');
            // Limpiar campo de orden
            ordenInput.value = '';
            ordenInfo.classList.add('d-none');
        } else {
            // Desactivar modo sin orden (modo normal)
            ordenClienteContainer.classList.remove('d-none');
            folioReferenciaContainer.classList.add('d-none');
            ordenInput.setAttribute('required', 'required');
            folioInput.removeAttribute('required');
            // Limpiar campo de folio
            folioInput.value = '';
        }
    }
    
    // Evento para el checkbox
    sinOrdenCheckbox.addEventListener('change', toggleModoSinOrden);
    
    // Inicializar estado al cargar (por si hay errores de validación)
    toggleModoSinOrden();
    
    // Convertir folio a mayúsculas mientras se escribe
    folioInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // ========== FUNCIONES DE LÍNEAS ==========
    
    // Actualizar números de línea
    function updateLineNumbers() {
        const forms = container.querySelectorAll('.linea-form:not([style*="display: none"])');
        forms.forEach((form, index) => {
            const lineaNumero = form.querySelector('.linea-numero');
            if (lineaNumero) {
                lineaNumero.value = index + 1;
            }
        });
    }
    
    // Calcular subtotal de una línea
    function calcularSubtotal(lineaForm) {
        const cantidadInput = lineaForm.querySelector('[name$="-cantidad"], .cantidad-input');
        const costoInput = lineaForm.querySelector('[name$="-costo_unitario"], .costo-input');
        const subtotalEl = lineaForm.querySelector('.subtotal-linea');
        
        if (cantidadInput && costoInput && subtotalEl) {
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const costo = parseFloat(costoInput.value) || 0;
            const subtotal = cantidad * costo;
            subtotalEl.textContent = '$' + subtotal.toFixed(2);
        }
        
        calcularTotalGeneral();
    }
    
    // Calcular total general
    function calcularTotalGeneral() {
        let total = 0;
        container.querySelectorAll('.linea-form:not([style*="display: none"])').forEach(form => {
            const cantidadInput = form.querySelector('[name$="-cantidad"], .cantidad-input');
            const costoInput = form.querySelector('[name$="-costo_unitario"], .costo-input');
            
            if (cantidadInput && costoInput) {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const costo = parseFloat(costoInput.value) || 0;
                total += cantidad * costo;
            }
        });
        
        document.getElementById('totalGeneral').textContent = '$' + total.toFixed(2);
    }
    
    // Agregar event listeners a los inputs de una línea
    function addLineaListeners(lineaForm) {
        const cantidadInput = lineaForm.querySelector('[name$="-cantidad"], .cantidad-input');
        const costoInput = lineaForm.querySelector('[name$="-costo_unitario"], .costo-input');
        
        if (cantidadInput) {
            cantidadInput.addEventListener('input', () => calcularSubtotal(lineaForm));
        }
        if (costoInput) {
            costoInput.addEventListener('input', () => calcularSubtotal(lineaForm));
        }
        
        const removeBtn = lineaForm.querySelector('.remove-linea-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                lineaForm.remove();
                updateLineNumbers();
                calcularTotalGeneral();
            });
        }
        
        // Calcular subtotal inicial
        calcularSubtotal(lineaForm);
    }
    
    // Agregar nueva línea
    addBtn.addEventListener('click', function() {
        const newForm = template.content.cloneNode(true);
        const formHtml = newForm.querySelector('.linea-form');
        
        // Reemplazar __prefix__ con el índice actual
        formHtml.innerHTML = formHtml.innerHTML.replace(/__prefix__/g, formCount);
        
        container.appendChild(newForm);
        formCount++;
        totalFormsInput.value = formCount;
        
        updateLineNumbers();
        
        // Agregar listeners a la nueva línea
        const nuevaLinea = container.lastElementChild;
        addLineaListeners(nuevaLinea);
    });
    
    // Inicializar listeners para líneas existentes
    container.querySelectorAll('.linea-form').forEach(addLineaListeners);
    
    // ========== BÚSQUEDA DE ORDEN ==========
    
    buscarOrdenBtn.addEventListener('click', buscarOrden);
    ordenInput.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' || e.key === 'Enter') {
            e.preventDefault();
            buscarOrden();
        }
    });
    
    function buscarOrden() {
        // No buscar si está en modo sin orden
        if (sinOrdenCheckbox.checked) return;
        
        const numero = ordenInput.value.trim().toUpperCase();
        
        if (!numero) {
            ordenInfo.classList.add('d-none');
            return;
        }
        
        // Validar formato
        if (!numero.startsWith('OOW-') && !numero.startsWith('FL-')) {
            ordenInfo.classList.remove('d-none');
            ordenInfo.classList.remove('alert-info');
            ordenInfo.classList.add('alert-warning');
            ordenInfoTexto.textContent = 'Formato inválido. Use OOW-12345 o FL-67890';
            return;
        }
        
        // Buscar usando el endpoint existente
        fetch(`{% url 'almacen:api_buscar_crear_orden' %}?orden_cliente=${encodeURIComponent(numero)}`)
            .then(response => response.json())
            .then(data => {
                ordenInfo.classList.remove('d-none');
                
                if (data.found) {
                    ordenInfo.classList.remove('alert-warning');
                    ordenInfo.classList.add('alert-info');
                    ordenInfoTexto.innerHTML = `
                        <strong>${data.orden_cliente}</strong><br>
                        Estado: ${data.estado_display || data.estado || '-'}<br>
                        Sucursal: ${data.sucursal || '-'}
                    `;
                    ordenInput.value = numero; // Normalizar
                } else if (data.success && !data.found) {
                    // No encontrada pero formato válido
                    ordenInfo.classList.remove('alert-info');
                    ordenInfo.classList.add('alert-warning');
                    ordenInfoTexto.textContent = `No se encontró ninguna orden con el número "${numero}". Verifica que sea correcta.`;
                } else {
                    ordenInfo.classList.remove('alert-info');
                    ordenInfo.classList.add('alert-warning');
                    ordenInfoTexto.textContent = data.error || `No se encontró ninguna orden con el número "${numero}"`;
                }
            })
            .catch(error => {
                console.error('Error buscando orden:', error);
                ordenInfo.classList.remove('d-none');
                ordenInfo.classList.remove('alert-info');
                ordenInfo.classList.add('alert-warning');
                ordenInfoTexto.textContent = 'Error al buscar la orden. Intenta de nuevo.';
            });
    }
    
    // Calcular totales al cargar
    calcularTotalGeneral();
    updateLineNumbers();
});
</script>
{% endblock extra_js %}
