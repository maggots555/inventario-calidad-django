{% extends 'almacen/base_almacen.html' %}
{% load static %}

{% comment %}
Formulario para crear/editar COMPRAS DIRECTAS
Incluye formset OBLIGATORIO para agregar unidades individuales con marca/modelo/costo

FLUJO:
1. Usuario define producto y cantidad total
2. Usuario DEBE especificar al menos 1 línea de detalle
3. Cada línea tiene: cantidad, marca (obligatorio), modelo, costo (obligatorio)
4. La suma de cantidades DEBE coincidir con la cantidad total
5. El costo unitario promedio se calcula automáticamente

NOTA: Las cotizaciones se manejan en el sistema de SolicitudCotizacion
{% endcomment %}

{% block title %}{{ titulo }} - Almacén{% endblock %}

{% block extra_css %}
<style>
    /* Ocultar checkboxes DELETE - se manejan con botones */
    input[name$="-DELETE"] {
        display: none;
    }
    
    /* Transiciones suaves para desactivar/activar */
    .unidad-form {
        transition: opacity 0.3s ease, background-color 0.3s ease;
    }
</style>
{% endblock extra_css %}

{% block almacen_content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">
                <i class="bi bi-{% if es_creacion %}plus-circle{% else %}pencil{% endif %} me-2"></i>{{ titulo }}
            </h1>
            <p class="text-muted mb-0">
                {% if es_creacion %}
                Registra una nueva compra directa de productos
                {% else %}
                Modifica los datos de la compra
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{% url 'almacen:lista_compras' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Volver a Lista
            </a>
        </div>
    </div>

    <form method="post" id="compraForm">
        {% csrf_token %}
        
        <!-- Datos principales de la compra -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Datos de la Compra Directa</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Producto -->
                    <div class="col-md-5">
                        <label class="form-label">{{ form.producto.label }} <span class="text-danger">*</span></label>
                        {{ form.producto }}
                    </div>
                    
                    <!-- Cantidad Total -->
                    <div class="col-md-2">
                        <label class="form-label">{{ form.cantidad.label }} <span class="text-danger">*</span></label>
                        {{ form.cantidad }}
                        <div class="form-text">Total de piezas</div>
                    </div>
                    
                    <!-- Costo Unitario Promedio (READONLY) -->
                    <div class="col-md-2">
                        <label class="form-label">{{ form.costo_unitario.label }}</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">$</span>
                            {{ form.costo_unitario }}
                        </div>
                        <div class="form-text text-info">
                            <i class="bi bi-calculator me-1"></i>Calculado automáticamente
                        </div>
                    </div>
                    
                    <!-- Costo Total (calculado) -->
                    <div class="col-md-3">
                        <label class="form-label">Costo Total</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">$</span>
                            <input type="text" id="costoTotalDisplay" class="form-control bg-light" 
                                   readonly value="0.00" style="font-weight: bold;">
                        </div>
                        <div class="form-text">Cantidad × Costo Promedio</div>
                    </div>
                    
                    <!-- Proveedor -->
                    <div class="col-md-4">
                        <label class="form-label">{{ form.proveedor.label }}</label>
                        {{ form.proveedor }}
                    </div>
                    
                    <!-- Fecha de Pedido -->
                    <div class="col-md-3">
                        <label class="form-label">{{ form.fecha_pedido.label }} <span class="text-danger">*</span></label>
                        {{ form.fecha_pedido }}
                    </div>
                    
                    <!-- Orden Cliente (para vincular con servicio técnico) -->
                    <div class="col-md-5">
                        <label class="form-label">{{ form.orden_cliente.label }}</label>
                        {{ form.orden_cliente }}
                        <div class="form-text">{{ form.orden_cliente.help_text }}</div>
                    </div>
                    
                    <!-- Número de Factura -->
                    <div class="col-md-3">
                        <label class="form-label">{{ form.numero_factura.label }}</label>
                        {{ form.numero_factura }}
                    </div>
                    
                    <!-- Número de Orden de Compra -->
                    <div class="col-md-3">
                        <label class="form-label">{{ form.numero_orden_compra.label }}</label>
                        {{ form.numero_orden_compra }}
                    </div>
                    
                    <!-- Observaciones -->
                    <div class="col-12">
                        <label class="form-label">{{ form.observaciones.label }}</label>
                        {{ form.observaciones }}
                    </div>
                </div>
                
                <!-- Errores del formulario principal -->
                {% if form.errors %}
                <div class="alert alert-danger mt-3">
                    <strong>Errores en el formulario:</strong>
                    <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Unidades Individuales (Formset) - OBLIGATORIO -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-boxes me-2"></i>Detalle por Unidad 
                    <span class="badge bg-danger ms-2">OBLIGATORIO</span>
                </h5>
                <button type="button" id="addUnidadBtn" class="btn btn-dark btn-sm">
                    <i class="bi bi-plus-lg me-1"></i>Agregar Línea
                </button>
            </div>
            <div class="card-body">
                <!-- Alerta informativa -->
                <div class="alert alert-info small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Obligatorio:</strong> Debes especificar al menos una línea con marca y costo.
                    La suma de cantidades debe coincidir con la cantidad total de la compra.
                </div>
                
                <!-- Resumen de validación -->
                <div id="validacionResumen" class="alert alert-secondary mb-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Cantidad total:</strong> <span id="cantidadTotalDisplay">0</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Suma unidades:</strong> <span id="sumaUnidadesDisplay">0</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Estado:</strong> <span id="estadoValidacionDisplay">-</span>
                        </div>
                    </div>
                </div>
                
                {{ formset.management_form }}
                
                <!-- Errores del formset -->
                {% if formset.non_form_errors %}
                <div class="alert alert-danger">
                    {% for error in formset.non_form_errors %}
                    <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div id="unidadesContainer">
                    {% for unidad_form in formset %}
                    <div class="unidad-form border rounded p-3 mb-3 {% if unidad_form.instance.pk %}bg-light{% endif %}">
                        <div class="row g-2 align-items-end">
                            <!-- Número de línea -->
                            <div class="col-md-1">
                                <label class="form-label small">#</label>
                                {{ unidad_form.numero_linea }}
                                {% if unidad_form.instance.pk %}
                                {{ unidad_form.id }}
                                {% endif %}
                            </div>
                            
                            <!-- Cantidad -->
                            <div class="col-md-1">
                                <label class="form-label small">Cant. <span class="text-danger">*</span></label>
                                {{ unidad_form.cantidad }}
                            </div>
                            
                            <!-- Marca (OBLIGATORIO) -->
                            <div class="col-md-2">
                                <label class="form-label small">Marca <span class="text-danger">*</span></label>
                                {{ unidad_form.marca }}
                            </div>
                            
                            <!-- Modelo -->
                            <div class="col-md-2">
                                <label class="form-label small">Modelo</label>
                                {{ unidad_form.modelo }}
                            </div>
                            
                            <!-- Número de Serie -->
                            <div class="col-md-2">
                                <label class="form-label small">N° Serie</label>
                                {{ unidad_form.numero_serie }}
                            </div>
                            
                            <!-- Costo (OBLIGATORIO) -->
                            <div class="col-md-2">
                                <label class="form-label small">Costo ($) <span class="text-danger">*</span></label>
                                {{ unidad_form.costo_unitario }}
                            </div>
                            
                            <!-- Desactivar -->
                            <div class="col-md-2 d-flex align-items-end">
                                {{ unidad_form.DELETE }}
                                <button type="button" class="btn btn-sm btn-outline-secondary remove-unidad-btn">
                                    <i class="bi bi-eye-slash"></i> Desactivar
                                </button>
                            </div>
                            
                            <!-- Especificaciones (fila completa) -->
                            <div class="col-md-10">
                                <label class="form-label small">Especificaciones / Notas</label>
                                {{ unidad_form.especificaciones }}
                            </div>
                        </div>
                        
                        <!-- Errores del formulario individual -->
                        {% if unidad_form.errors %}
                        <div class="alert alert-danger mt-2 mb-0 py-1 small">
                            {% for field, errors in unidad_form.errors.items %}
                                {% for error in errors %}
                                <span class="me-3"><strong>{{ field }}:</strong> {{ error }}</span>
                                {% endfor %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Template para agregar nuevas unidades (oculto) -->
                <template id="unidadTemplate">
                    <div class="unidad-form border rounded p-3 mb-3">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-1">
                                <label class="form-label small">#</label>
                                <input type="number" name="unidades-__prefix__-numero_linea" 
                                       class="form-control form-control-sm" min="1" readonly>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">Cant. <span class="text-danger">*</span></label>
                                <input type="number" name="unidades-__prefix__-cantidad" 
                                       class="form-control form-control-sm cantidad-input" min="1" value="1" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Marca <span class="text-danger">*</span></label>
                                <select name="unidades-__prefix__-marca" class="form-control form-select form-select-sm marca-input" required>
                                    <option value="">-- Seleccionar --</option>
                                    {% for value, label in formset.form.base_fields.marca.choices %}
                                    {% if value %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Modelo</label>
                                <input type="text" name="unidades-__prefix__-modelo" 
                                       class="form-control form-control-sm" placeholder="Ej: 870 EVO">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">N° Serie</label>
                                <input type="text" name="unidades-__prefix__-numero_serie" 
                                       class="form-control form-control-sm" placeholder="S/N">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Costo ($) <span class="text-danger">*</span></label>
                                <input type="number" name="unidades-__prefix__-costo_unitario" 
                                       class="form-control form-control-sm costo-unidad-input" 
                                       step="0.01" min="0.01" placeholder="$0.00" required>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-sm btn-outline-secondary remove-unidad-btn">
                                    <i class="bi bi-eye-slash"></i> Desactivar
                                </button>
                            </div>
                            <div class="col-md-10">
                                <label class="form-label small">Especificaciones / Notas</label>
                                <textarea name="unidades-__prefix__-especificaciones" 
                                          class="form-control form-control-sm" rows="1"
                                          placeholder="Detalles técnicos adicionales..."></textarea>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between">
            <a href="{% url 'almacen:lista_compras' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg me-1"></i>Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                <i class="bi bi-check-lg me-1"></i>
                {% if es_creacion %}Crear Compra{% else %}Guardar Cambios{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock almacen_content %}

{% block extra_js %}
<script src="{% static 'js/form_compra.js' %}"></script>
{% endblock extra_js %}
