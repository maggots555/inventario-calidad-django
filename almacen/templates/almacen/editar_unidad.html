{% extends 'almacen/base_almacen.html' %}
{% load static %}

{% comment %}
Template: Editar Unidad de Inventario
=====================================
Formulario para editar una unidad existente.

Contexto esperado:
- form: UnidadInventarioForm con instance
- unidad: Objeto UnidadInventario
- titulo: T√≠tulo de la p√°gina
{% endcomment %}

{% block title %}{{ titulo }} - {{ block.super }}{% endblock %}

{% block almacen_content %}
<div class="container py-4">
    
    <!-- Navegaci√≥n / Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'almacen:dashboard' %}">
                    <i class="bi bi-house me-1"></i>Almac√©n
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'almacen:lista_unidades' %}">Unidades</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'almacen:detalle_unidad' unidad.pk %}">{{ unidad.codigo_interno }}</a>
            </li>
            <li class="breadcrumb-item active">Editar</li>
        </ol>
    </nav>
    
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-pencil-square text-warning me-2"></i>
                {{ titulo }}
            </h2>
            <p class="text-muted mb-0">
                Modificando: {{ unidad.producto.nombre }}
                {% if unidad.marca %} ‚Ä¢ {{ unidad.marca }}{% endif %}
            </p>
        </div>
        <a href="{% url 'almacen:detalle_unidad' unidad.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Volver
        </a>
    </div>
    
    <!-- Formulario -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-hdd me-2"></i>Datos de la Unidad
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}
                        
                        <!-- C√≥digo (solo lectura) -->
                        <div class="mb-4">
                            <div class="alert alert-light border">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">C√≥digo Interno</small>
                                        <strong class="fs-5">{{ unidad.codigo_interno }}</strong>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <small class="text-muted">Este c√≥digo no se puede modificar</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Producto (solo lectura) -->
                        <div class="mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="bi bi-box me-2"></i>Producto Asociado
                            </h6>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>{{ unidad.producto.nombre }}</strong>
                                <span class="text-muted ms-2">({{ unidad.producto.codigo_producto }})</span>
                                <br>
                                <small class="text-muted">El producto no se puede cambiar despu√©s de crear la unidad.</small>
                            </div>
                            <!-- Campo oculto para mantener el producto -->
                            <input type="hidden" name="producto" value="{{ unidad.producto.pk }}">
                        </div>
                        
                        <!-- Especificaciones del Item -->
                        <div class="mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="bi bi-tags me-2"></i>Especificaciones del Item
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.marca.label }}</label>
                                    {{ form.marca }}
                                    {% if form.marca.errors %}
                                        <div class="text-danger small">{{ form.marca.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.modelo.label }}</label>
                                    {{ form.modelo }}
                                    {% if form.modelo.errors %}
                                        <div class="text-danger small">{{ form.modelo.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.numero_serie.label }}</label>
                                    {{ form.numero_serie }}
                                    {% if form.numero_serie.errors %}
                                        <div class="text-danger small">{{ form.numero_serie.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.ubicacion_especifica.label }}</label>
                                    {{ form.ubicacion_especifica }}
                                    {% if form.ubicacion_especifica.errors %}
                                        <div class="text-danger small">{{ form.ubicacion_especifica.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label class="form-label">{{ form.especificaciones.label }}</label>
                                    {{ form.especificaciones }}
                                    {% if form.especificaciones.errors %}
                                        <div class="text-danger small">{{ form.especificaciones.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estado y Disponibilidad -->
                        <div class="mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="bi bi-check2-circle me-2"></i>Estado y Disponibilidad
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.estado.label }} *</label>
                                    {{ form.estado }}
                                    {% if form.estado.errors %}
                                        <div class="text-danger small">{{ form.estado.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.disponibilidad.label }} *</label>
                                    {{ form.disponibilidad }}
                                    {% if form.disponibilidad.errors %}
                                        <div class="text-danger small">{{ form.disponibilidad.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Origen y Trazabilidad -->
                        <div class="mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="bi bi-signpost-split me-2"></i>Origen y Trazabilidad
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">{{ form.origen.label }} *</label>
                                    {{ form.origen }}
                                    {% if form.origen.errors %}
                                        <div class="text-danger small">{{ form.origen.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">{{ form.compra.label }}</label>
                                    {{ form.compra }}
                                    {% if form.compra.errors %}
                                        <div class="text-danger small">{{ form.compra.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">{{ form.orden_servicio_origen.label }}</label>
                                    <!-- Buscador de Orden por texto -->
                                    <div class="input-group">
                                        <input type="text" 
                                               id="buscar_orden_texto" 
                                               class="form-control"
                                               placeholder="Ej: OOW-12345 o FL-67890"
                                               autocomplete="off"
                                               value="{% if unidad.orden_servicio_origen and unidad.orden_servicio_origen.detalle_equipo %}{{ unidad.orden_servicio_origen.detalle_equipo.orden_cliente }}{% endif %}">
                                        <button type="button" class="btn btn-outline-secondary" id="btnBuscarOrden">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <!-- Campo oculto para el ID de la orden -->
                                    <input type="hidden" 
                                           name="orden_servicio_origen" 
                                           id="orden_servicio_origen_id"
                                           value="{{ form.orden_servicio_origen.value|default:'' }}">
                                    <div class="form-text">Busca por n√∫mero de orden del cliente (OOW-* o FL-*)</div>
                                    {% if form.orden_servicio_origen.errors %}
                                        <div class="text-danger small">{{ form.orden_servicio_origen.errors }}</div>
                                    {% endif %}
                                    <!-- Resultado de b√∫squeda -->
                                    <div id="ordenBuscadaInfo" class="mt-2 {% if not unidad.orden_servicio_origen %}d-none{% endif %}">
                                        {% if unidad.orden_servicio_origen %}
                                        <div class="alert alert-success py-2 mb-0">
                                            <i class="bi bi-check-circle me-1"></i>
                                            <strong>Orden vinculada:</strong> 
                                            <span id="ordenVinculadaTexto">{{ unidad.orden_servicio_origen }}</span>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info py-2 mb-0">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <span id="ordenVinculadaTexto"></span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Costo -->
                        <div class="mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="bi bi-currency-dollar me-2"></i>Valor
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">{{ form.costo_unitario.label }}</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.costo_unitario }}
                                    </div>
                                    {% if form.costo_unitario.errors %}
                                        <div class="text-danger small">{{ form.costo_unitario.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notas -->
                        <div class="mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="bi bi-chat-left-text me-2"></i>Notas Adicionales
                            </h6>
                            {{ form.notas }}
                            {% if form.notas.errors %}
                                <div class="text-danger small">{{ form.notas.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Botones -->
                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <a href="{% url 'almacen:detalle_unidad' unidad.pk %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panel lateral de informaci√≥n -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle me-2"></i>Estado Actual
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted d-block">Estado F√≠sico</small>
                        {% if unidad.estado == 'nuevo' %}
                            <span class="badge bg-success">üÜï Nuevo</span>
                        {% elif unidad.estado == 'usado_bueno' %}
                            <span class="badge bg-primary">üëç Usado Bueno</span>
                        {% elif unidad.estado == 'usado_regular' %}
                            <span class="badge bg-warning text-dark">üëå Usado Regular</span>
                        {% elif unidad.estado == 'reparado' %}
                            <span class="badge bg-info">üîß Reparado</span>
                        {% elif unidad.estado == 'defectuoso' %}
                            <span class="badge bg-danger">‚ùå Defectuoso</span>
                        {% elif unidad.estado == 'para_revision' %}
                            <span class="badge bg-secondary">üîç Para Revisi√≥n</span>
                        {% endif %}
                    </div>
                    <div>
                        <small class="text-muted d-block">Disponibilidad</small>
                        {% if unidad.disponibilidad == 'disponible' %}
                            <span class="badge bg-success">‚úÖ Disponible</span>
                        {% elif unidad.disponibilidad == 'reservada' %}
                            <span class="badge bg-warning text-dark">üìå Reservada</span>
                        {% elif unidad.disponibilidad == 'asignada' %}
                            <span class="badge bg-info">üîó Asignada</span>
                        {% elif unidad.disponibilidad == 'vendida' %}
                            <span class="badge bg-secondary">üí∞ Vendida</span>
                        {% elif unidad.disponibilidad == 'descartada' %}
                            <span class="badge bg-dark">üóëÔ∏è Descartada</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-clock-history me-2"></i>Informaci√≥n
                </div>
                <div class="card-body small">
                    <div class="mb-2">
                        <strong>Fecha de Ingreso:</strong><br>
                        {{ unidad.fecha_registro|date:"d/m/Y H:i" }}
                    </div>
                    <div class="mb-2">
                        <strong>√öltima Actualizaci√≥n:</strong><br>
                        {{ unidad.fecha_actualizacion|date:"d/m/Y H:i" }}
                    </div>
                    {% if unidad.numero_serie %}
                    <div>
                        <strong>N√∫mero de Serie:</strong><br>
                        <code>{{ unidad.numero_serie }}</code>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock almacen_content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== BUSCADOR DE ORDEN DE SERVICIO ==========
    const buscarOrdenTexto = document.getElementById('buscar_orden_texto');
    const btnBuscarOrden = document.getElementById('btnBuscarOrden');
    const ordenIdHidden = document.getElementById('orden_servicio_origen_id');
    const ordenBuscadaInfo = document.getElementById('ordenBuscadaInfo');
    const ordenVinculadaTexto = document.getElementById('ordenVinculadaTexto');
    
    // Funci√≥n para buscar orden
    function buscarOrdenServicio() {
        const numero = buscarOrdenTexto.value.trim().toUpperCase();
        
        if (!numero) {
            // Si est√° vac√≠o, limpiar la vinculaci√≥n
            ordenIdHidden.value = '';
            ordenBuscadaInfo.classList.add('d-none');
            return;
        }
        
        // Validar formato (OOW-* o FL-*)
        if (!numero.startsWith('OOW-') && !numero.startsWith('FL-')) {
            mostrarResultado('warning', 'Formato inv√°lido. Use OOW-12345 o FL-67890');
            ordenIdHidden.value = '';
            return;
        }
        
        // Normalizar el valor del input
        buscarOrdenTexto.value = numero;
        
        // Buscar usando la API existente
        fetch(`{% url 'almacen:api_buscar_crear_orden' %}?orden_cliente=${encodeURIComponent(numero)}`)
            .then(response => response.json())
            .then(data => {
                if (data.found && data.orden_id) {
                    // Orden encontrada - guardar el ID
                    ordenIdHidden.value = data.orden_id;
                    mostrarResultado('success', `
                        <strong>Orden encontrada:</strong> ${data.orden_cliente}<br>
                        <small>Estado: ${data.estado_display || data.estado || '-'} | Sucursal: ${data.sucursal || '-'}</small>
                    `);
                } else if (data.success && !data.found) {
                    // No encontrada
                    ordenIdHidden.value = '';
                    mostrarResultado('warning', `No se encontr√≥ ninguna orden con el n√∫mero "${numero}".`);
                } else {
                    // Error
                    ordenIdHidden.value = '';
                    mostrarResultado('danger', data.error || 'Error al buscar la orden.');
                }
            })
            .catch(error => {
                console.error('Error buscando orden:', error);
                ordenIdHidden.value = '';
                mostrarResultado('danger', 'Error de conexi√≥n. Intenta de nuevo.');
            });
    }
    
    // Funci√≥n para mostrar resultado
    function mostrarResultado(tipo, mensaje) {
        ordenBuscadaInfo.classList.remove('d-none');
        ordenBuscadaInfo.innerHTML = `
            <div class="alert alert-${tipo} py-2 mb-0">
                <i class="bi bi-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'x-circle'} me-1"></i>
                ${mensaje}
            </div>
        `;
    }
    
    // Event listeners
    btnBuscarOrden.addEventListener('click', buscarOrdenServicio);
    
    buscarOrdenTexto.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarOrdenServicio();
        }
    });
    
    // Convertir a may√∫sculas mientras se escribe
    buscarOrdenTexto.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
});
</script>
{% endblock extra_js %}