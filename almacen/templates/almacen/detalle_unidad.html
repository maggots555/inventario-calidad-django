{% extends 'almacen/base_almacen.html' %}
{% load static %}

{% comment %}
Template: Detalle de Unidad de Inventario
=========================================
Muestra toda la informaci√≥n de una unidad individual espec√≠fica.

Contexto esperado:
- unidad: Objeto UnidadInventario
- titulo: T√≠tulo de la p√°gina
{% endcomment %}

{% block title %}{{ unidad.codigo_interno }} - {{ block.super }}{% endblock %}

{% block almacen_content %}
<div class="container py-4">
    
    <!-- Navegaci√≥n / Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'almacen:dashboard' %}">
                    <i class="bi bi-house me-1"></i>Almac√©n
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'almacen:lista_unidades' %}">Unidades</a>
            </li>
            <li class="breadcrumb-item active">{{ unidad.codigo_interno }}</li>
        </ol>
    </nav>
    
    <!-- Encabezado con acciones -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-hdd text-primary me-2"></i>
                {{ unidad.codigo_interno }}
            </h2>
            <p class="text-muted mb-0">
                {{ unidad.producto.nombre }}
                {% if unidad.marca %} ‚Ä¢ {{ unidad.marca }}{% endif %}
                {% if unidad.modelo %} {{ unidad.modelo }}{% endif %}
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'almacen:editar_unidad' unidad.pk %}" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>Editar
            </a>
            <a href="{% url 'almacen:eliminar_unidad' unidad.pk %}" class="btn btn-outline-danger">
                <i class="bi bi-trash me-1"></i>Eliminar
            </a>
            <a href="{% url 'almacen:lista_unidades' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>
    
    <!-- Estado y Disponibilidad destacados -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card h-100 {% if unidad.estado == 'defectuoso' %}border-danger{% elif unidad.estado == 'para_revision' %}border-warning{% elif unidad.estado == 'nuevo' %}border-success{% else %}border-primary{% endif %}">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Estado F√≠sico</h6>
                    {% if unidad.estado == 'nuevo' %}
                        <span class="badge bg-success fs-6 px-3 py-2">üÜï Nuevo</span>
                    {% elif unidad.estado == 'usado_bueno' %}
                        <span class="badge bg-primary fs-6 px-3 py-2">üëç Usado - Bueno</span>
                    {% elif unidad.estado == 'usado_regular' %}
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2">üëå Usado - Regular</span>
                    {% elif unidad.estado == 'reparado' %}
                        <span class="badge bg-info fs-6 px-3 py-2">üîß Reparado</span>
                    {% elif unidad.estado == 'defectuoso' %}
                        <span class="badge bg-danger fs-6 px-3 py-2">‚ùå Defectuoso</span>
                    {% elif unidad.estado == 'para_revision' %}
                        <span class="badge bg-secondary fs-6 px-3 py-2">üîç Para Revisi√≥n</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 {% if unidad.disponibilidad == 'disponible' %}border-success{% elif unidad.disponibilidad == 'reservada' %}border-warning{% elif unidad.disponibilidad == 'descartada' %}border-dark{% else %}border-info{% endif %}">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Disponibilidad</h6>
                    {% if unidad.disponibilidad == 'disponible' %}
                        <span class="badge bg-success fs-6 px-3 py-2">‚úÖ Disponible</span>
                    {% elif unidad.disponibilidad == 'reservada' %}
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2">üìå Reservada</span>
                    {% elif unidad.disponibilidad == 'asignada' %}
                        <span class="badge bg-info fs-6 px-3 py-2">üîó Asignada</span>
                    {% elif unidad.disponibilidad == 'vendida' %}
                        <span class="badge bg-secondary fs-6 px-3 py-2">üí∞ Vendida</span>
                    {% elif unidad.disponibilidad == 'descartada' %}
                        <span class="badge bg-dark fs-6 px-3 py-2">üóëÔ∏è Descartada</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Columna principal -->
        <div class="col-lg-8">
            
            <!-- Informaci√≥n del Producto -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-box me-2"></i>Producto Asociado
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                            <i class="bi bi-box-seam text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-1">
                                <a href="{% url 'almacen:detalle_producto' unidad.producto.pk %}" 
                                   class="text-decoration-none">
                                    {{ unidad.producto.nombre }}
                                </a>
                            </h5>
                            <p class="text-muted mb-0">
                                <span class="me-3">
                                    <i class="bi bi-upc me-1"></i>
                                    {{ unidad.producto.codigo_producto }}
                                </span>
                                {% if unidad.producto.categoria %}
                                <span>
                                    <i class="bi bi-folder me-1"></i>
                                    {{ unidad.producto.categoria.nombre }}
                                </span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark">
                                Stock: {{ unidad.producto.stock_actual }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Especificaciones del Item -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-tags me-2"></i>Especificaciones del Item
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Marca</label>
                            <p class="fw-medium mb-0">
                                {% if unidad.marca %}
                                    {{ unidad.marca }}
                                {% else %}
                                    <span class="text-muted">No especificada</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Modelo</label>
                            <p class="fw-medium mb-0">
                                {% if unidad.modelo %}
                                    {{ unidad.modelo }}
                                {% else %}
                                    <span class="text-muted">No especificado</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">N√∫mero de Serie</label>
                            <p class="fw-medium mb-0">
                                {% if unidad.numero_serie %}
                                    <code>{{ unidad.numero_serie }}</code>
                                {% else %}
                                    <span class="text-muted">Sin S/N</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if unidad.especificaciones_tecnicas %}
                    <hr>
                    <div>
                        <label class="form-label text-muted small">Especificaciones T√©cnicas</label>
                        <p class="mb-0">{{ unidad.especificaciones_tecnicas }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Origen y Trazabilidad -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-signpost-split me-2"></i>Origen y Trazabilidad
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Origen</label>
                            <p class="mb-0">
                                {% if unidad.origen == 'compra' %}
                                    {% if unidad.compra and unidad.compra.tipo == 'cotizacion' %}
                                        <span class="badge bg-info">üìã Cotizaci√≥n</span>
                                    {% else %}
                                        <span class="badge bg-primary">üõí Compra Directa</span>
                                    {% endif %}
                                {% elif unidad.origen == 'orden_servicio' %}
                                    <span class="badge bg-success">üîß {{ unidad.get_origen_display }}</span>
                                {% elif unidad.origen == 'devolucion_cliente' %}
                                    <span class="badge bg-info">‚Ü©Ô∏è {{ unidad.get_origen_display }}</span>
                                {% elif unidad.origen == 'transferencia' %}
                                    <span class="badge bg-warning text-dark">üîÑ {{ unidad.get_origen_display }}</span>
                                {% elif unidad.origen == 'inventario_inicial' %}
                                    <span class="badge bg-secondary">üìã {{ unidad.get_origen_display }}</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">{{ unidad.get_origen_display }}</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Compra Asociada</label>
                            <p class="mb-0">
                                {% if unidad.compra %}
                                    <a href="#" class="text-decoration-none">
                                        Compra #{{ unidad.compra.pk }}
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        {{ unidad.compra.fecha_pedido|date:"d/m/Y" }}
                                    </small>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Orden de Servicio (Origen)</label>
                            <p class="mb-0">
                                {% if unidad.orden_servicio_origen %}
                                    <a href="{% url 'servicio_tecnico:detalle_orden' unidad.orden_servicio_origen.pk %}" 
                                       class="text-decoration-none">
                                        {{ unidad.orden_servicio_origen }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if unidad.orden_servicio_destino %}
                    <hr>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Esta unidad est√° <strong>asignada</strong> a la orden de servicio:
                        <a href="{% url 'servicio_tecnico:detalle_orden' unidad.orden_servicio_destino.pk %}" 
                           class="alert-link">
                            {{ unidad.orden_servicio_destino }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Im√°genes de Referencia de Cotizaci√≥n -->
            {% if imagenes_cotizacion %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-images me-2 text-primary"></i>Im√°genes de Referencia
                    </span>
                    {% if solicitud_cotizacion %}
                    <a href="{% url 'almacen:detalle_solicitud_cotizacion' solicitud_cotizacion.pk %}" 
                       class="btn btn-sm btn-outline-info">
                        <i class="bi bi-file-earmark-text me-1"></i>Ver Cotizaci√≥n {{ solicitud_cotizacion.numero_solicitud }}
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Im√°genes subidas durante la cotizaci√≥n para referencia de esta pieza.
                        {% if linea_cotizacion %}
                        <br>
                        <strong>Descripci√≥n de la l√≠nea:</strong> {{ linea_cotizacion.descripcion_pieza }}
                        {% endif %}
                    </p>
                    
                    <div class="row g-3">
                        {% for imagen in imagenes_cotizacion %}
                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 border-primary">
                                <a href="{{ imagen.imagen.url }}" target="_blank" 
                                   title="Clic para ver en tama√±o completo">
                                    <img src="{{ imagen.imagen.url }}" 
                                         class="card-img-top" 
                                         alt="{{ imagen.descripcion|default:imagen.nombre_archivo }}"
                                         style="height: 150px; object-fit: cover;">
                                </a>
                                <div class="card-body p-2">
                                    {% if imagen.descripcion %}
                                    <p class="card-text small mb-1">{{ imagen.descripcion }}</p>
                                    {% endif %}
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>{{ imagen.fecha_subida|date:"d/m/Y" }}
                                        {% if imagen.fue_comprimida %}
                                        <span class="badge bg-info ms-1" title="Imagen comprimida autom√°ticamente">
                                            <i class="bi bi-file-zip"></i>
                                        </span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% elif linea_cotizacion %}
            <!-- Si hay l√≠nea de cotizaci√≥n pero sin im√°genes -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-images me-2 text-muted"></i>Im√°genes de Referencia
                </div>
                <div class="card-body text-center text-muted py-4">
                    <i class="bi bi-image fs-1 d-block mb-2 opacity-50"></i>
                    No se subieron im√°genes de referencia para esta pieza durante la cotizaci√≥n.
                    <br>
                    <a href="{% url 'almacen:detalle_solicitud_cotizacion' solicitud_cotizacion.pk %}" 
                       class="btn btn-sm btn-outline-info mt-2">
                        <i class="bi bi-file-earmark-text me-1"></i>Ver Cotizaci√≥n {{ solicitud_cotizacion.numero_solicitud }}
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Notas -->
            {% if unidad.notas %}
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-chat-left-text me-2"></i>Notas
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ unidad.notas|linebreaks }}</p>
                </div>
            </div>
            {% endif %}
            
        </div>
        
        <!-- Columna lateral -->
        <div class="col-lg-4">
            
            <!-- Valor -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-currency-dollar me-2"></i>Valor
                </div>
                <div class="card-body text-center">
                    <h3 class="mb-0 text-success">
                        {% if unidad.costo_unitario %}
                            ${{ unidad.costo_unitario|floatformat:2 }}
                        {% else %}
                            <span class="text-muted">Sin valor</span>
                        {% endif %}
                    </h3>
                    <small class="text-muted">Costo Unitario</small>
                </div>
            </div>
            
            <!-- Ubicaci√≥n -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-geo-alt me-2"></i>Ubicaci√≥n
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        {% if unidad.ubicacion_especifica %}
                            <i class="bi bi-pin-map me-1 text-primary"></i>
                            {{ unidad.ubicacion_especifica }}
                        {% else %}
                            <span class="text-muted">
                                <i class="bi bi-dash me-1"></i>
                                Sin ubicaci√≥n espec√≠fica
                            </span>
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <!-- Informaci√≥n del Sistema -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <i class="bi bi-clock-history me-2"></i>Informaci√≥n del Sistema
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted d-block">Fecha de Ingreso</small>
                        <span>{{ unidad.fecha_registro|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div>
                        <small class="text-muted d-block">√öltima Actualizaci√≥n</small>
                        <span>{{ unidad.fecha_actualizacion|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Acciones R√°pidas -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-lightning me-2"></i>Acciones R√°pidas
                </div>
                <div class="card-body d-grid gap-2">
                    <a href="{% url 'almacen:editar_unidad' unidad.pk %}" 
                       class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-2"></i>Editar Unidad
                    </a>
                    <a href="{% url 'almacen:unidades_por_producto' unidad.producto.pk %}" 
                       class="btn btn-outline-secondary">
                        <i class="bi bi-collection me-2"></i>Ver Otras Unidades del Producto
                    </a>
                    <a href="{% url 'almacen:detalle_producto' unidad.producto.pk %}" 
                       class="btn btn-outline-info">
                        <i class="bi bi-box me-2"></i>Ver Producto
                    </a>
                </div>
            </div>
            
        </div>
    </div>
    
</div>
{% endblock almacen_content %}
