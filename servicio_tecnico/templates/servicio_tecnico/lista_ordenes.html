{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- Cargar estilos específicos de servicio técnico -->
<link rel="stylesheet" href="{% static 'css/servicio_tecnico.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header con título y botones de acción -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-laptop"></i> {{ titulo }}
                    </h1>
                    <p class="text-muted mb-0">Control y seguimiento de equipos en servicio</p>
                </div>
                <div class="d-flex gap-2">
                    {% if tipo == 'activas' %}
                        <a href="{% url 'servicio_tecnico:lista_finalizadas' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-check-circle"></i> Ver Cerrados
                        </a>
                        <form method="post" action="{% url 'servicio_tecnico:cerrar_todas' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success" 
                                    onclick="return confirm('¿Cerrar todas las órdenes finalizadas?')">
                                <i class="bi bi-check-all"></i> Cerrar Finalizados
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-outline-primary">
                            <i class="bi bi-hourglass-split"></i> Ver Activos
                        </a>
                    {% endif %}
                    <a href="{% url 'servicio_tecnico:crear_orden' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Orden
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de búsqueda y filtros -->
    <div class="search-box">
        <form method="get" class="row g-3">
            <div class="col-md-9">
                <label for="busqueda" class="form-label">
                    <i class="bi bi-search"></i> Buscar por N° de Serie u Orden
                </label>
                <input type="text" 
                       class="form-control" 
                       id="busqueda" 
                       name="busqueda" 
                       value="{{ busqueda }}"
                       placeholder="Escribe el número de serie o la orden...">
                <small class="text-muted">Presiona ESC para limpiar la búsqueda</small>
            </div>
            <div class="col-md-3 d-flex flex-column">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if busqueda %}
                    <a href="?" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </a>
                {% endif %}
            </div>
        </form>
        <div class="mt-3">
            <span class="badge bg-primary">{{ total }} resultado(s)</span>
            {% if busqueda %}
                <span class="badge bg-info ms-2">
                    <i class="bi bi-funnel"></i> Búsqueda activa: "{{ busqueda }}"
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Cuadro informativo: Estadísticas por técnico (solo en vista activas) -->
    {% if mostrar_estadisticas %}
        <!-- Banner informativo sobre las estadísticas -->
        <div class="alert alert-info mt-4 mb-3" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <h6 class="alert-heading mb-1">
                        <i class="bi bi-bar-chart-line"></i> Vista General de Estadísticas por Técnico
                    </h6>
                    <p class="mb-0">
                        <strong>"Equipos No Enciende":</strong> <span class="badge bg-warning text-dark">Activos</span> (solo "No Enciende" en proceso) vs <span class="badge bg-info">Histórico</span> (desglose: sí enciende / no enciende / total).
                        <br>
                        <strong>"Equipos por Gama":</strong> <span class="badge bg-warning text-dark">Activos</span> (carga actual por gama) vs <span class="badge bg-info">Histórico Total</span> (desempeño acumulado por gama).
                        {% if busqueda %}
                            <br><small class="text-muted">(Estadísticas independientes de la búsqueda activa)</small>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="row mt-4 g-4 estadisticas-tecnico-row">
        <!-- Equipos "No enciende" por técnico (ACTIVOS + HISTÓRICO) -->
        {% if equipos_no_enciende_por_tecnico %}
            <div class="col-lg-12">
                <div class="card border-warning h-100">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Equipos "No Enciende" por Técnico - Activos vs Histórico
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%;">Técnico</th>
                                        <th class="text-center" style="background-color: #fff3cd; width: 35%;">
                                            <i class="bi bi-hourglass-split"></i> Activos (Carga Actual)
                                        </th>
                                        <th class="text-center" style="background-color: #d1ecf1; width: 35%;">
                                            <i class="bi bi-clock-history"></i> Histórico Total
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tecnico in equipos_no_enciende_por_tecnico %}
                                        <tr>
                                            <!-- Columna: Técnico con foto/iniciales -->
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="tecnico-avatar me-2">
                                                        {% if tecnico.foto_url %}
                                                            <img src="{{ tecnico.foto_url }}" 
                                                                 alt="Foto de {{ tecnico.nombre }}"
                                                                 class="tecnico-foto"
                                                                 style="width: 46px; height: 46px; border-radius: 50%; object-fit: cover;">
                                                        {% else %}
                                                            <div class="tecnico-iniciales" 
                                                                 style="width: 46px; height: 46px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: bold;">
                                                                {{ tecnico.iniciales }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold" style="font-size: 0.9rem;">{{ tecnico.nombre }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            
                                            <!-- SECCIÓN: ACTIVOS -->
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos > 0 %}
                                                    <span class="badge bg-danger fs-6 px-3 py-2">
                                                        <i class="bi bi-exclamation-triangle-fill"></i> {{ tecnico.activos }}
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">equipo(s) en proceso</small>
                                                {% else %}
                                                    <span class="text-muted">Sin equipos activos</span>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- SECCIÓN: HISTÓRICO CON DESGLOSE -->
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                <div class="d-flex justify-content-around align-items-center">
                                                    <!-- Sí Enciende -->
                                                    <div class="text-center">
                                                        <span class="badge bg-success fs-6 px-2 py-1">
                                                            <i class="bi bi-power"></i> {{ tecnico.historico.si_enciende }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" style="font-size: 0.75rem;">Sí enciende</small>
                                                    </div>
                                                    
                                                    <!-- No Enciende -->
                                                    <div class="text-center">
                                                        <span class="badge bg-danger fs-6 px-2 py-1">
                                                            <i class="bi bi-x-circle"></i> {{ tecnico.historico.no_enciende }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" style="font-size: 0.75rem;">No enciende</small>
                                                    </div>
                                                    
                                                    <!-- Total -->
                                                    <div class="text-center">
                                                        <span class="badge bg-secondary fs-6 px-2 py-1">
                                                            <i class="bi bi-archive-fill"></i> {{ tecnico.historico.total }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" style="font-size: 0.75rem;">Total</small>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Leyenda explicativa -->
                        <div class="alert alert-light border mt-3 mb-0" role="alert">
                            <small>
                                <strong><i class="bi bi-info-circle"></i> Interpretación:</strong>
                                <ul class="mb-0 mt-1" style="font-size: 0.85rem;">
                                    <li><strong>Activos:</strong> Equipos "No Enciende" actualmente en reparación (carga crítica específica)</li>
                                    <li><strong>Histórico Total:</strong> Desglose completo de todos los equipos manejados - <span class="badge bg-success">Sí enciende</span>, <span class="badge bg-danger">No enciende</span> y <span class="badge bg-secondary">Total</span></li>
                                </ul>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Equipos por gama por técnico (HISTÓRICO COMPLETO) -->
        {% if equipos_por_gama_por_tecnico %}
            <div class="col-lg-12">
                <div class="card border-info h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-bar-chart-line"></i> Equipos por Gama por Técnico - Activos vs Histórico
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 20%;">Técnico</th>
                                        <th class="text-center" colspan="4" style="background-color: #fff3cd;">
                                            <i class="bi bi-hourglass-split"></i> Activos (Carga Actual)
                                        </th>
                                        <th class="text-center" colspan="4" style="background-color: #d1ecf1;">
                                            <i class="bi bi-clock-history"></i> Histórico Total
                                        </th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <!-- Columnas ACTIVOS -->
                                        <th class="text-center" style="background-color: #fff3cd;"><i class="bi bi-star-fill text-success"></i> Alta</th>
                                        <th class="text-center" style="background-color: #fff3cd;"><i class="bi bi-dash-circle-fill text-warning"></i> Media</th>
                                        <th class="text-center" style="background-color: #fff3cd;"><i class="bi bi-circle-fill text-secondary"></i> Baja</th>
                                        <th class="text-center" style="background-color: #fff3cd;"><strong>Total</strong></th>
                                        <!-- Columnas HISTÓRICO -->
                                        <th class="text-center" style="background-color: #d1ecf1;"><i class="bi bi-star-fill text-success"></i> Alta</th>
                                        <th class="text-center" style="background-color: #d1ecf1;"><i class="bi bi-dash-circle-fill text-warning"></i> Media</th>
                                        <th class="text-center" style="background-color: #d1ecf1;"><i class="bi bi-circle-fill text-secondary"></i> Baja</th>
                                        <th class="text-center" style="background-color: #d1ecf1;"><strong>Total</strong></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tecnico in equipos_por_gama_por_tecnico %}
                                        <tr>
                                            <!-- Columna: Técnico con foto/iniciales -->
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="tecnico-avatar me-2">
                                                        {% if tecnico.foto_url %}
                                                            <img src="{{ tecnico.foto_url }}" 
                                                                 alt="Foto de {{ tecnico.nombre }}"
                                                                 class="tecnico-foto"
                                                                 style="width: 46px; height: 46px; border-radius: 50%; object-fit: cover;">
                                                        {% else %}
                                                            <div class="tecnico-iniciales" 
                                                                 style="width: 46px; height: 46px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: bold;">
                                                                {{ tecnico.iniciales }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold" style="font-size: 0.9rem;">{{ tecnico.nombre }}</div>
                                                    </div>
                                                </div>
                                            </td>

                                            <!-- SECCIÓN: ACTIVOS -->
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos.alta > 0 %}
                                                    <span class="badge bg-success">{{ tecnico.activos.alta }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos.media > 0 %}
                                                    <span class="badge bg-warning">{{ tecnico.activos.media }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos.baja > 0 %}
                                                    <span class="badge bg-secondary">{{ tecnico.activos.baja }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center fw-bold" style="background-color: #fff3cd;">
                                                {{ tecnico.activos.total }}
                                            </td>
                                            
                                            <!-- SECCIÓN: HISTÓRICO -->
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                {% if tecnico.historico.alta > 0 %}
                                                    <span class="badge bg-success">{{ tecnico.historico.alta }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                {% if tecnico.historico.media > 0 %}
                                                    <span class="badge bg-warning">{{ tecnico.historico.media }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                {% if tecnico.historico.baja > 0 %}
                                                    <span class="badge bg-secondary">{{ tecnico.historico.baja }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center fw-bold" style="background-color: #d1ecf1;">
                                                {{ tecnico.historico.total }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Leyenda explicativa -->
                        <div class="alert alert-light border mt-3 mb-0" role="alert">
                            <small>
                                <strong><i class="bi bi-info-circle"></i> Interpretación:</strong>
                                <ul class="mb-0 mt-1" style="font-size: 0.85rem;">
                                    <li><strong>Activos:</strong> Equipos actualmente en proceso (carga de trabajo presente)</li>
                                    <li><strong>Histórico:</strong> Total de equipos manejados incluyendo cerrados (desempeño acumulado)</li>
                                </ul>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}  <!-- Fin de mostrar_estadisticas -->

    <!-- Grid de cards -->
    {% if ordenes %}
        <div class="row g-2">
            {% for orden in ordenes %}
                <div class="col-lg-5-cols col-md-6 col-sm-6">
                    <div class="service-card {% if orden.detalle_equipo.orden_cliente|slice:":3" == "FL-" %}orden-fl{% elif orden.detalle_equipo.orden_cliente|slice:":4" == "OOW-" %}orden-oow{% elif orden.detalle_equipo.orden_cliente|slice:":10" == "MX_CIS_MX_" %}orden-mx-cis{% endif %}">
                        <!-- Header: Estado y fecha -->
                        <div class="service-card-header">
                            <span class="badge badge-estado badge-{{ orden.estado }}">
                                {{ orden.get_estado_display }}
                            </span>
                            {% if orden.es_candidato_rhitso %}
                                <span class="badge badge-rhitso">RHITSO</span>
                            {% endif %}
                            
                            <!-- NUEVO: Indicador de días sin actualización -->
                            <span class="badge badge-dias-sin-actualizacion bg-{{ orden.color_dias_sin_actualizacion }}" 
                                  title="Días hábiles sin actualización de estado">
                                <i class="bi bi-clock-history"></i> {{ orden.dias_sin_actualizacion_estado }}d
                            </span>
                            
                            <small class="text-muted">
                                {{ orden.fecha_ingreso|date:"d/m/Y" }}
                            </small>
                        </div>

                        <!-- Body: Información principal -->
                        <div class="service-card-body">
                            <!-- Marca en grande -->
                            <h3 class="marca-principal">{{ orden.detalle_equipo.marca|upper }}</h3>
                            <p class="text-muted mb-3">
                                {{ orden.detalle_equipo.get_tipo_equipo_display }}
                                {% if orden.detalle_equipo.modelo %}
                                    <span class="text-primary"> | {{ orden.detalle_equipo.modelo }}</span>
                                {% endif %}
                            </p>

                            <!-- Información detallada -->
                            <div class="info-item">
                                <i class="bi bi-upc-scan"></i>
                                <strong>N° Serie:</strong>
                                <span>{{ orden.detalle_equipo.numero_serie }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-receipt"></i>
                                <strong>Orden SIC:</strong>
                                <span>{{ orden.detalle_equipo.orden_cliente }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-building"></i>
                                <strong>Centro:</strong>
                                <span>{{ orden.sucursal.nombre }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-hash"></i>
                                <strong>Orden:</strong>
                                <span class="text-primary fw-bold">{{ orden.numero_orden_interno }}</span>
                            </div>

                            <!-- Indicadores visuales -->
                            <div class="indicadores">
                                <!-- Indicador de imágenes -->
                                {% with imagenes_count=orden.imagenes.count %}
                                <div class="indicador">
                                    <div class="indicador-icon {% if imagenes_count > 0 %}has-images{% else %}no-images{% endif %}">
                                        {{ imagenes_count }}
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">IMÁGENES</small>
                                        <strong style="font-size: 0.75rem;">{{ imagenes_count }} foto(s)</strong>
                                    </div>
                                </div>
                                {% endwith %}

                                <!-- Indicador de cargador -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.detalle_equipo.tiene_cargador %}has-charger{% else %}no-charger{% endif %}">
                                        <i class="bi bi-{% if orden.detalle_equipo.tiene_cargador %}check{% else %}x{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">CARGADOR</small>
                                        <strong style="font-size: 0.75rem;">{{ orden.detalle_equipo.tiene_cargador|yesno:"Sí,No" }}</strong>
                                    </div>
                                </div>

                                <!-- Indicador de técnico asignado -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.tecnico_asignado_actual %}has-technician{% else %}no-technician{% endif %}">
                                        <i class="bi bi-{% if orden.tecnico_asignado_actual %}person-check{% else %}person-x{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">TÉCNICO</small>
                                        <strong style="font-size: 0.75rem;">
                                            {% if orden.tecnico_asignado_actual %}
                                                {{ orden.tecnico_asignado_actual.nombre_completo|truncatechars:12 }}
                                            {% else %}
                                                Sin asignar
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>

                                <!-- Indicador de responsable del seguimiento -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.responsable_seguimiento %}has-responsible{% else %}no-responsible{% endif %}">
                                        <i class="bi bi-{% if orden.responsable_seguimiento %}person-badge{% else %}person-dash{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">RESPONSABLE</small>
                                        <strong style="font-size: 0.75rem;">
                                            {% if orden.responsable_seguimiento %}
                                                {{ orden.responsable_seguimiento.nombre_completo|truncatechars:12 }}
                                            {% else %}
                                                Sin asignar
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>

                                <!-- Indicador de cotización -->
                                <div class="indicador">
                                    {% if orden.cotizacion %}
                                        <div class="indicador-icon has-quotation" title="Tiene cotización creada">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">COTIZACIÓN</small>
                                            <strong style="font-size: 0.75rem;">Creada</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-quotation" title="Sin cotización">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">COTIZACIÓN</small>
                                            <strong style="font-size: 0.75rem;">Pendiente</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de venta mostrador -->
                                <div class="indicador">
                                    {% if orden.venta_mostrador %}
                                        <div class="indicador-icon has-sale" title="Tiene venta mostrador registrada">
                                            <i class="bi bi-cart-check"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">VENTA</small>
                                            <strong style="font-size: 0.75rem;">Registrada</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-sale" title="Sin venta mostrador">
                                            <i class="bi bi-cart-x"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">VENTA</small>
                                            <strong style="font-size: 0.75rem;">Sin venta</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de diagnóstico SIC -->
                                <div class="indicador">
                                    {% if orden.detalle_equipo.diagnostico_sic and orden.detalle_equipo.fecha_fin_diagnostico %}
                                        <div class="indicador-icon has-diagnostic" title="Diagnóstico SIC completado con texto y fecha de finalización">
                                            <i class="bi bi-clipboard2-pulse-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">DIAGNÓSTICO SIC</small>
                                            <strong style="font-size: 0.75rem;">Completado</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-diagnostic" title="Diagnóstico SIC pendiente (requiere texto y fecha de finalización)">
                                            <i class="bi bi-clipboard2-pulse"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">DIAGNÓSTICO SIC</small>
                                            <strong style="font-size: 0.75rem;">Pendiente</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de gama del equipo -->
                                <div class="indicador">
                                    {% if orden.detalle_equipo.gama == 'alta' %}
                                        <div class="indicador-icon gama-alta" title="Gama Alta">
                                            <i class="bi bi-star-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Alta</strong>
                                        </div>
                                    {% elif orden.detalle_equipo.gama == 'media' %}
                                        <div class="indicador-icon gama-media" title="Gama Media">
                                            <i class="bi bi-dash-circle-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Media</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon gama-baja" title="Gama Baja">
                                            <i class="bi bi-circle-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Baja</strong>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Footer: Botones de acción -->
                        <div class="service-card-footer">
                            {% if tipo == 'activas' and orden.estado == 'finalizado' %}
                                <form method="post" action="{% url 'servicio_tecnico:cerrar_orden' orden.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-cerrar-orden btn-ver-detalles mb-2"
                                            onclick="return confirm('¿Marcar orden {{ orden.numero_orden_interno }} como entregada?')">
                                        <i class="bi bi-check-circle"></i> Cerrar Orden
                                    </button>
                                </form>
                            {% endif %}
                            <a href="{% url 'servicio_tecnico:detalle_orden' orden.pk %}" class="btn btn-primary btn-ver-detalles">
                                <i class="bi bi-eye"></i> Ver Detalles
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Mensaje cuando no hay resultados -->
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <h4 class="mt-3">No se encontraron órdenes</h4>
            {% if busqueda %}
                <p>No hay resultados para la búsqueda: <strong>"{{ busqueda }}"</strong></p>
                <a href="?" class="btn btn-primary">Ver todas las órdenes</a>
            {% else %}
                <p>No hay órdenes {{ tipo }} registradas.</p>
                <a href="{% url 'servicio_tecnico:crear_orden' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Crear primera orden
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Limpiar búsqueda con ESC
document.addEventListener('DOMContentLoaded', function() {
    const busquedaInput = document.getElementById('busqueda');
    if (busquedaInput) {
        busquedaInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                this.form.submit();
            }
        });
        
        // Auto-focus en el campo de búsqueda
        busquedaInput.focus();
    }
});
</script>
{% endblock %}
