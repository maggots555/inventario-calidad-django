{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- Cargar estilos espec√≠ficos de servicio t√©cnico -->
<link rel="stylesheet" href="{% static 'css/servicio_tecnico.css' %}?v=6.6">
<style>
    /* Estilos mejorados para la tabla de estad√≠sticas */
    .table-hover tbody tr:hover {
        background-color: rgba(103, 126, 234, 0.05);
        transition: background-color 0.2s ease;
    }
    
    .area-grupo {
        border-bottom: 1px solid #e9ecef;
    }
    
    .area-grupo:last-child {
        border-bottom: none;
    }
    
    /* Mejoras responsive para m√≥viles */
    @media (max-width: 768px) {
        .sucursal-header h5 {
            font-size: 1rem !important;
        }
        
        .area-header h6 {
            font-size: 0.85rem !important;
        }
        
        .table {
            font-size: 0.8rem !important;
        }
        
        .badge {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.4rem !important;
        }
        
        .tecnico-avatar-wrapper img,
        .tecnico-avatar-wrapper div {
            width: 38px !important;
            height: 38px !important;
            font-size: 0.8rem !important;
        }
        
        /* Hacer el scroll horizontal m√°s visible en m√≥vil */
        .table-responsive {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        
        /* Alerta de deslizar en m√≥vil */
        .table-responsive::after {
            content: "‚Üê Desliza para ver m√°s ‚Üí";
            display: block;
            text-align: center;
            padding: 0.5rem;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.75rem;
            border-top: 1px solid #dee2e6;
        }
    }
    
    @media (min-width: 769px) {
        .table-responsive::after {
            display: none;
        }
    }
    
    /* Animaci√≥n suave para badges */
    .badge {
        transition: all 0.2s ease;
    }
    
    .badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Estilos para las filas de "siguiente en rotaci√≥n" */
    .table-success {
        background-color: rgba(40, 167, 69, 0.08) !important;
        border-left: 3px solid #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header con t√≠tulo y botones de acci√≥n -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-laptop"></i> {{ titulo }}
                    </h1>
                    <p class="text-muted mb-0">Control y seguimiento de equipos en servicio</p>
                </div>
                <div class="d-flex gap-2">
                    {% if tipo == 'activas' %}
                        <a href="{% url 'servicio_tecnico:lista_finalizadas' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-check-circle"></i> Ver Cerrados
                        </a>
                        <form method="post" action="{% url 'servicio_tecnico:cerrar_todas' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success" 
                                    onclick="return confirm('¬øCerrar todas las √≥rdenes finalizadas?')">
                                <i class="bi bi-check-all"></i> Cerrar Finalizados
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-outline-primary">
                            <i class="bi bi-hourglass-split"></i> Ver Activos
                        </a>
                    {% endif %}
                    <a href="{% url 'servicio_tecnico:seleccionar_tipo_orden' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Orden
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de b√∫squeda y filtros -->
    <div class="search-box">
        <form method="get" class="row g-3">
            <div class="col-md-9">
                <label for="busqueda" class="form-label">
                    <i class="bi bi-search"></i> Buscar por N¬∞ de Serie u Orden
                </label>
                <input type="text" 
                       class="form-control" 
                       id="busqueda" 
                       name="busqueda" 
                       value="{{ busqueda }}"
                       placeholder="Escribe el n√∫mero de serie o la orden...">
                <small class="text-muted">Presiona ESC para limpiar la b√∫squeda</small>
            </div>
            <div class="col-md-3 d-flex flex-column">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if busqueda %}
                    <a href="?" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </a>
                {% endif %}
            </div>
        </form>
        <div class="mt-3">
            <span class="badge bg-primary">{{ total }} resultado(s)</span>
            {% if busqueda %}
                <span class="badge bg-info ms-2">
                    <i class="bi bi-funnel"></i> B√∫squeda activa: "{{ busqueda }}"
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Cuadro informativo: Estad√≠sticas por t√©cnico (solo en vista activas) -->
    {% if mostrar_estadisticas %}
        <!-- Banner informativo simplificado -->
        <div class="alert alert-info mt-4 mb-3" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <h6 class="alert-heading mb-1">
                        <i class="bi bi-bar-chart-line"></i> Estad√≠sticas de Carga de Trabajo por T√©cnico
                    </h6>
                    <p class="mb-0">
                        Vista unificada con toda la informaci√≥n de carga actual agrupada por sucursal. 
                        Las columnas "Hoy" y "Semana" muestran asignaciones <strong>netas</strong> (entradas - reasignaciones salientes).
                        {% if busqueda %}
                            <br><small class="text-muted">(Estad√≠sticas independientes de la b√∫squeda activa)</small>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="row mt-4 g-4 estadisticas-tecnico-row">
        
        <!-- ========================================================================
             TABLA UNIFICADA DE ESTAD√çSTICAS POR T√âCNICO (AGRUPADA POR SUCURSAL)
             ======================================================================== -->
        {% if tecnicos_por_sucursal %}
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white d-flex justify-content-between align-items-center flex-wrap gap-3" 
                     style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 1rem 1.5rem;">
                    <div>
                        <h6 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">
                            <i class="bi bi-people-fill" style="font-size: 1.3rem;"></i> Estad√≠sticas Unificadas por T√©cnico
                        </h6>
                        <small class="text-white opacity-90">Vista completa de carga de trabajo agrupada por sucursal</small>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <!-- Filtro temporal -->
                        <form method="get" id="filtroTemporalForm" class="d-flex gap-2">
                            {% if busqueda %}
                                <input type="hidden" name="busqueda" value="{{ busqueda }}">
                            {% endif %}
                            <select name="filtro_temporal" class="form-select form-select-sm bg-white" style="min-width: 150px;" onchange="this.form.submit()">
                                <option value="hoy" {% if filtro_temporal == 'hoy' %}selected{% endif %}>üìÖ Hoy</option>
                                <option value="semana" {% if filtro_temporal == 'semana' %}selected{% endif %}>üìä Esta Semana</option>
                                <option value="historico" {% if filtro_temporal == 'historico' %}selected{% endif %}>üìú Hist√≥rico Total</option>
                            </select>
                        </form>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Iterar por cada sucursal -->
                    {% for sucursal_grupo in tecnicos_por_sucursal %}
                    <div class="sucursal-grupo">
                        <!-- Encabezado de sucursal mejorado con SVG personalizado -->
                        <div class="sucursal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.2rem 2rem; border-bottom: 4px solid #5a67d8; box-shadow: 0 3px 8px rgba(102,126,234,0.25);">
                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                <h5 class="mb-0 text-white d-flex align-items-center gap-3" style="font-weight: 800; font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                    <!-- SVG personalizado seg√∫n sucursal -->
                                    {% if 'SATELITE' in sucursal_grupo.sucursal_nombre|upper or 'SAT√âLITE' in sucursal_grupo.sucursal_nombre|upper %}
                                        <img src="{% static 'images/utilitys/sucursal_satelite.svg' %}" alt="Sat√©lite" style="width: 48px; height: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                                    {% elif 'MONTERREY' in sucursal_grupo.sucursal_nombre|upper or 'MTY' in sucursal_grupo.sucursal_nombre|upper %}
                                        <img src="{% static 'images/utilitys/sucursal_monterrey.svg' %}" alt="Monterrey" style="width: 48px; height: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                                    {% elif 'GUADALAJARA' in sucursal_grupo.sucursal_nombre|upper or 'GDL' in sucursal_grupo.sucursal_nombre|upper %}
                                        <img src="{% static 'images/utilitys/sucursal_guadalajara.svg' %}" alt="Guadalajara" style="width: 48px; height: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                                    {% else %}
                                        <!-- Icono gen√©rico para otras sucursales -->
                                        <i class="bi bi-geo-alt-fill" style="font-size: 1.5rem;"></i>
                                    {% endif %}
                                    <span style="letter-spacing: 0.5px;">{{ sucursal_grupo.sucursal_nombre|upper }}</span>
                                </h5>
                                <span class="badge bg-white text-primary px-3 py-2" style="font-size: 0.85rem; font-weight: 700;">
                                    <i class="bi bi-people-fill me-1"></i>
                                    {{ sucursal_grupo.areas|length }} √°rea{{ sucursal_grupo.areas|length|pluralize }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Iterar por cada √°rea dentro de la sucursal -->
                        {% for area_grupo in sucursal_grupo.areas %}
                        <div class="area-grupo">
                            <!-- Sub-encabezado de √°rea con colores corporativos -->
                            {% if 'DELL' in area_grupo.area_nombre %}
                                <!-- DELL: Azul y amarillo -->
                                <div class="area-header" style="background: linear-gradient(135deg, #0076CE 0%, #FFD200 100%); padding: 0.75rem 1.5rem 0.75rem 2.5rem; border-bottom: 3px solid #0076CE; box-shadow: 0 2px 4px rgba(0,118,206,0.15);">
                                    <h6 class="mb-0 text-white" style="font-weight: 700; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        <i class="bi bi-laptop me-2"></i>{{ area_grupo.area_nombre }}
                                        <span class="badge bg-white text-primary ms-2" style="font-size: 0.75rem; font-weight: 600;">
                                            {{ area_grupo.tecnicos|length }} t√©cnico{{ area_grupo.tecnicos|length|pluralize }}
                                        </span>
                                    </h6>
                                </div>
                            {% elif 'LENOVO' in area_grupo.area_nombre %}
                                <!-- LENOVO: Naranja y verde -->
                                <div class="area-header" style="background: linear-gradient(135deg, #E2231A 0%, #00B140 100%); padding: 0.75rem 1.5rem 0.75rem 2.5rem; border-bottom: 3px solid #E2231A; box-shadow: 0 2px 4px rgba(226,35,26,0.15);">
                                    <h6 class="mb-0 text-white" style="font-weight: 700; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        <i class="bi bi-laptop me-2"></i>{{ area_grupo.area_nombre }}
                                        <span class="badge bg-white text-danger ms-2" style="font-size: 0.75rem; font-weight: 600;">
                                            {{ area_grupo.tecnicos|length }} t√©cnico{{ area_grupo.tecnicos|length|pluralize }}
                                        </span>
                                    </h6>
                                </div>
                            {% elif 'OOW' in area_grupo.area_nombre %}
                                <!-- OOW: Rosa/Magenta -->
                                <div class="area-header" style="background: linear-gradient(135deg, #E91E63 0%, #FF6090 100%); padding: 0.75rem 1.5rem 0.75rem 2.5rem; border-bottom: 3px solid #C2185B; box-shadow: 0 2px 4px rgba(233,30,99,0.15);">
                                    <h6 class="mb-0 text-white" style="font-weight: 700; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        <i class="bi bi-tools me-2"></i>{{ area_grupo.area_nombre }}
                                        <span class="badge bg-white text-danger ms-2" style="font-size: 0.75rem; font-weight: 600;">
                                            {{ area_grupo.tecnicos|length }} t√©cnico{{ area_grupo.tecnicos|length|pluralize }}
                                        </span>
                                    </h6>
                                </div>
                            {% else %}
                                <!-- Otras √°reas: Gris por defecto -->
                                <div class="area-header" style="background: linear-gradient(90deg, #6c757d 0%, #95a5a6 100%); padding: 0.75rem 1.5rem 0.75rem 2.5rem; border-bottom: 3px solid #6c757d;">
                                    <h6 class="mb-0 text-white" style="font-weight: 700; font-size: 1rem;">
                                        <i class="bi bi-tag-fill me-2"></i>{{ area_grupo.area_nombre }}
                                        <span class="badge bg-white text-dark ms-2" style="font-size: 0.75rem; font-weight: 600;">
                                            {{ area_grupo.tecnicos|length }} t√©cnico{{ area_grupo.tecnicos|length|pluralize }}
                                        </span>
                                    </h6>
                                </div>
                            {% endif %}
                            
                            <!-- Tabla de t√©cnicos de esta √°rea -->
                            <div class="table-responsive" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                                <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem; min-width: 700px;">
                                    <thead class="table-light" style="font-size: 0.8rem; position: sticky; top: 0; z-index: 10;">
                                        <tr>
                                            <th style="min-width: 160px; width: 25%;">
                                                <i class="bi bi-person-badge"></i> 
                                                <span class="d-none d-md-inline">T√©cnico</span>
                                            </th>
                                            <th class="text-center" style="min-width: 80px; width: 10%;" title="√ìrdenes activas totales">
                                                <i class="bi bi-hourglass-split"></i><br>
                                                <small class="d-none d-sm-inline">Activas</small>
                                            </th>
                                            <th class="text-center" style="min-width: 80px; width: 10%;" title="Equipos que no encienden (activos)">
                                                <i class="bi bi-exclamation-triangle"></i><br>
                                                <small class="d-none d-sm-inline">No Enc.</small>
                                            </th>
                                            <th class="text-center" style="min-width: 90px; width: 10%;" title="Gama Alta (activos) - Se pagan mejor">
                                                <i class="bi bi-star-fill text-success"></i><br>
                                                <small class="d-none d-sm-inline">Gama Alta</small>
                                            </th>
                                            <th class="text-center" style="min-width: 80px; width: 10%;" title="Folios FL- (activos)">
                                                <i class="bi bi-receipt"></i><br>
                                                <small class="d-none d-sm-inline">FL</small>
                                            </th>
                                            <th class="text-center" style="min-width: 80px; width: 10%;" title="Asignaciones netas de hoy">
                                                <i class="bi bi-calendar-day"></i><br>
                                                <small class="d-none d-sm-inline">Hoy</small>
                                            </th>
                                            <th class="text-center" style="min-width: 90px; width: 12%;" title="Asignaciones netas del per√≠odo">
                                                <i class="bi bi-calendar-week"></i><br>
                                                <small class="d-none d-sm-inline">{% if filtro_temporal == 'hoy' %}N/A{% elif filtro_temporal == 'semana' %}Semana{% else %}Hist.{% endif %}</small>
                                            </th>
                                            <th class="text-center" style="min-width: 110px; width: 13%;" title="Tiempo desde √∫ltima asignaci√≥n">
                                                <i class="bi bi-clock-history"></i><br>
                                                <small class="d-none d-sm-inline">√öltima</small>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tecnico in area_grupo.tecnicos %}
                                    <tr class="{% if tecnico.es_siguiente_rotacion %}table-success bg-success bg-opacity-10{% endif %}">
                                        <!-- Columna: T√©cnico -->
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="tecnico-avatar-wrapper position-relative">
                                                    {% if tecnico.foto_url %}
                                                        <img src="{{ tecnico.foto_url }}" 
                                                             alt="{{ tecnico.tecnico_nombre }}"
                                                             class="rounded-circle"
                                                             style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #e5e7eb;">
                                                    {% else %}
                                                        <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                                             style="width: 48px; height: 48px; background-color: #6b7280; font-size: 1rem; border: 2px solid #e5e7eb;">
                                                            {{ tecnico.iniciales }}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    <!-- Badge de rotaci√≥n sugerida -->
                                                    {% if tecnico.es_siguiente_rotacion %}
                                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" 
                                                              style="font-size: 0.6rem; padding: 0.25rem 0.4rem;"
                                                              title="Siguiente en rotaci√≥n para {{ tecnico.area }}">
                                                            ‚òÖ
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div class="fw-bold" style="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                        {{ tecnico.tecnico_nombre }}
                                                    </div>
                                                    {% if tecnico.es_siguiente_rotacion %}
                                                        <small class="badge bg-success mt-1" style="font-size: 0.65rem;">
                                                            ‚òÖ SIGUIENTE
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <!-- Columna: √ìrdenes Activas -->
                                        <td class="text-center">
                                            {% if tecnico.ordenes_actuales > 0 %}
                                                <span class="badge rounded-pill bg-primary px-3 py-2" style="font-size: 0.95rem; font-weight: 600; min-width: 45px;">
                                                    {{ tecnico.ordenes_actuales }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.9rem;">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Columna: No Enciende -->
                                        <td class="text-center">
                                            {% if tecnico.equipos_no_encienden > 0 %}
                                                <span class="badge rounded-pill bg-danger px-3 py-2" style="font-size: 0.9rem; font-weight: 600; min-width: 40px;">
                                                    {{ tecnico.equipos_no_encienden }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.9rem;">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Columna: Gama Alta -->
                                        <td class="text-center">
                                            {% if tecnico.gama_alta > 0 %}
                                                <span class="badge rounded-pill bg-success px-3 py-2" style="font-size: 0.9rem; font-weight: 600; min-width: 40px;">{{ tecnico.gama_alta }}</span>
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.85rem;">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Columna: Folios FL -->
                                        <td class="text-center">
                                            {% if tecnico.folios_fl > 0 %}
                                                <span class="badge rounded-pill bg-info text-white px-2 py-1" style="font-size: 0.85rem; font-weight: 600; min-width: 35px;">{{ tecnico.folios_fl }}</span>
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.85rem;">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Columna: Asignaciones Hoy (netas) -->
                                        <td class="text-center">
                                            {% if tecnico.asignaciones_hoy_netas > 0 %}
                                                <span class="badge rounded-pill bg-success px-2 py-1" style="font-size: 0.85rem; font-weight: 600; min-width: 40px;">
                                                    +{{ tecnico.asignaciones_hoy_netas }}
                                                </span>
                                            {% elif tecnico.asignaciones_hoy_netas < 0 %}
                                                <span class="badge rounded-pill bg-danger px-2 py-1" style="font-size: 0.85rem; font-weight: 600; min-width: 40px;">
                                                    {{ tecnico.asignaciones_hoy_netas }}
                                                </span>
                                            {% else %}
                                                <span class="badge rounded-pill bg-light text-dark border px-2 py-1" style="font-size: 0.85rem; min-width: 40px;">0</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Columna: Asignaciones Semana/Hist√≥rico (netas) -->
                                        <td class="text-center">
                                            {% if filtro_temporal != 'hoy' %}
                                                {% if tecnico.asignaciones_semana_netas > 0 %}
                                                    <span class="badge rounded-pill bg-primary px-2 py-1" style="font-size: 0.85rem; font-weight: 600; min-width: 40px;">
                                                        +{{ tecnico.asignaciones_semana_netas }}
                                                    </span>
                                                {% elif tecnico.asignaciones_semana_netas < 0 %}
                                                    <span class="badge rounded-pill bg-danger px-2 py-1" style="font-size: 0.85rem; font-weight: 600; min-width: 40px;">
                                                        {{ tecnico.asignaciones_semana_netas }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge rounded-pill bg-light text-dark border px-2 py-1" style="font-size: 0.85rem; min-width: 40px;">0</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.75rem;">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Columna: √öltima Asignaci√≥n -->
                                        <td class="text-center">
                                            <span class="badge rounded-pill bg-light text-dark border" style="font-size: 0.75rem; padding: 0.35rem 0.6rem;">
                                                <i class="bi bi-clock"></i> {{ tecnico.tiempo_sin_asignar }}
                                            </span>
                                        </td>
                                    </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                        <!-- Fin de iteraci√≥n de √°reas -->
                    </div>
                    {% if not forloop.last %}
                        <hr class="m-0" style="border-color: #5a67d8; border-width: 2px;">
                    {% endif %}
                    {% endfor %}
                    
                    <!-- Leyenda explicativa -->
                    <div class="alert alert-light border-top border-0 rounded-0 mb-0 mt-0" role="alert" style="background-color: #f8f9fa; font-size: 0.85rem;">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <strong><i class="bi bi-info-circle text-primary"></i> Columnas de carga:</strong>
                                <ul class="mb-0" style="font-size: 0.8rem; line-height: 1.6;">
                                    <li><strong>Activas:</strong> Total √≥rdenes asignadas actualmente</li>
                                    <li><strong>No Enc.:</strong> Equipos "No Enciende" activos</li>
                                    <li><strong>Gama Alta:</strong> Equipos de gama alta (mejor remunerados)</li>
                                    <li><strong>Folios FL:</strong> √ìrdenes FL- activas</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong><i class="bi bi-calendar-check text-success"></i> Asignaciones netas:</strong>
                                <ul class="mb-0" style="font-size: 0.8rem; line-height: 1.6;">
                                    <li><strong>Hoy (netas):</strong> Asignaciones recibidas - reasignadas salientes hoy</li>
                                    <li><strong>Semana/Hist√≥rico (netas):</strong> Balance neto del per√≠odo seleccionado</li>
                                    <li><em>Valores negativos indican m√°s reasignaciones salientes que entrantes</em></li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong><i class="bi bi-star text-warning"></i> Rotaci√≥n (solo Sat√©lite > OOW):</strong>
                                <ul class="mb-0" style="font-size: 0.8rem; line-height: 1.6;">
                                    <li><span class="badge bg-success" style="font-size: 0.7rem;">‚òÖ SIGUIENTE</span> T√©cnico sugerido para pr√≥xima asignaci√≥n</li>
                                    <li><em>Solo visible en Laboratorio OOW de Sat√©lite</em></li>
                                    <li><em>Criterio:</em> Menor carga + M√°s tiempo sin asignar + Menos asignaciones hoy</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ========================================================================
             HISTORIAL DE REASIGNACIONES DEL D√çA
             ======================================================================== -->
        {% if reasignaciones_hoy %}
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white d-flex justify-content-between align-items-center clickable-header" 
                     data-bs-toggle="collapse" 
                     data-bs-target="#collapseReasignaciones" 
                     aria-expanded="false" 
                     aria-controls="collapseReasignaciones"
                     role="button"
                     style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; padding: 1rem 1.5rem; cursor: pointer;">
                    <h6 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">
                        <i class="bi bi-arrow-left-right" style="font-size: 1.3rem;"></i> Historial de Reasignaciones del D√≠a
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-white text-dark" style="padding: 0.4rem 0.8rem; font-weight: 600;">
                            {{ reasignaciones_hoy|length }} reasignacion{{ reasignaciones_hoy|length|pluralize:"es" }}
                        </span>
                        <div class="toggle-collapse-icon">
                            <i class="bi bi-chevron-down collapse-icon" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                </div>
                <div class="collapse" id="collapseReasignaciones">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 10%;"><i class="bi bi-clock"></i> Hora</th>
                                        <th style="width: 15%;"><i class="bi bi-hash"></i> Orden</th>
                                        <th style="width: 25%;"><i class="bi bi-arrow-left-right"></i> Reasignaci√≥n</th>
                                        <th style="width: 35%;"><i class="bi bi-chat-left-text"></i> Motivo / Comentario</th>
                                        <th style="width: 15%;"><i class="bi bi-person"></i> Realizado por</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reasignacion in reasignaciones_hoy %}
                                    <tr>
                                        <!-- Hora -->
                                        <td>
                                            <span class="badge bg-light text-dark border">
                                                {{ reasignacion.fecha_evento|date:"H:i" }}
                                            </span>
                                        </td>
                                        
                                        <!-- Orden -->
                                        <td>
                                            <a href="{% url 'servicio_tecnico:detalle_orden' reasignacion.orden.id %}" 
                                               class="text-decoration-none fw-bold text-primary"
                                               title="Ver detalles de la orden">
                                                {{ reasignacion.orden.detalle_equipo.orden_cliente }}
                                            </a>
                                            <br>
                                            <small class="text-muted">{{ reasignacion.orden.detalle_equipo.marca }} | {{ reasignacion.orden.numero_orden_interno }}</small>
                                        </td>
                                        
                                        <!-- Reasignaci√≥n (De ‚Üí A) -->
                                        <td>
                                            <div class="d-flex align-items-center gap-2" style="font-size: 0.85rem;">
                                                {% if reasignacion.tecnico_anterior %}
                                                    <span class="badge bg-secondary text-white px-2 py-1">
                                                        {{ reasignacion.tecnico_anterior.nombre_completo|truncatechars:15 }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-light text-muted px-2 py-1">Sin asignar</span>
                                                {% endif %}
                                                
                                                <i class="bi bi-arrow-right text-primary"></i>
                                                
                                                {% if reasignacion.tecnico_nuevo %}
                                                    <span class="badge bg-primary text-white px-2 py-1">
                                                        {{ reasignacion.tecnico_nuevo.nombre_completo|truncatechars:15 }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-light text-muted px-2 py-1">Sin asignar</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        
                                        <!-- Comentario / Motivo -->
                                        <td>
                                            {% if reasignacion.comentario %}
                                                <small class="text-dark">{{ reasignacion.comentario|truncatechars:60 }}</small>
                                            {% else %}
                                                <small class="text-muted fst-italic">Sin comentario</small>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Usuario que realiz√≥ el cambio -->
                                        <td>
                                            {% if reasignacion.usuario %}
                                                <small class="text-muted">
                                                    <i class="bi bi-person-circle"></i> {{ reasignacion.usuario.nombre_completo }}
                                                </small>
                                            {% elif reasignacion.es_sistema %}
                                                <small class="text-muted fst-italic">
                                                    <i class="bi bi-gear"></i> Sistema
                                                </small>
                                            {% else %}
                                                <small class="text-muted fst-italic">N/A</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Nota informativa -->
                        <div class="alert alert-light border-top border-0 rounded-0 mb-0" role="alert" style="font-size: 0.85rem;">
                            <i class="bi bi-info-circle text-info"></i> 
                            <strong>Uso:</strong> Monitorea c√≥mo se redistribuyen los equipos durante el d√≠a. 
                            Detecta patrones de reasignaci√≥n excesiva que puedan indicar problemas de balance de carga o disponibilidad de t√©cnicos.
                            <em class="text-muted">(Mostrando √∫ltimas 20 reasignaciones)</em>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}  <!-- Fin de mostrar_estadisticas -->

    <!-- Grid de cards -->
    {% if ordenes %}
        <div class="row g-2">
            {% for orden in ordenes %}
                <div class="col-lg-5-cols col-md-6 col-sm-6">
                    <div class="service-card {% if orden.detalle_equipo.orden_cliente|slice:":3" == "FL-" %}orden-fl{% elif orden.detalle_equipo.orden_cliente|slice:":4" == "OOW-" %}orden-oow{% elif orden.detalle_equipo.orden_cliente|slice:":10" == "MX_CIS_MX_" %}orden-mx-cis{% endif %}">
                        <!-- Header: Estado y fecha -->
                        <div class="service-card-header">
                            <span class="badge badge-estado badge-{{ orden.estado }}">
                                {{ orden.get_estado_display }}
                            </span>
                            {% if orden.es_candidato_rhitso %}
                                <span class="badge badge-rhitso">RHITSO</span>
                            {% endif %}
                            
                            <!-- NUEVO: Indicador de d√≠as sin actualizaci√≥n -->
                            <span class="badge badge-dias-sin-actualizacion bg-{{ orden.color_dias_sin_actualizacion }}" 
                                  title="D√≠as h√°biles sin actualizaci√≥n de estado">
                                <i class="bi bi-clock-history"></i> {{ orden.dias_sin_actualizacion_estado }}d
                            </span>
                            
                            <small class="text-muted">
                                {{ orden.fecha_ingreso|date:"d/m/Y" }}
                            </small>
                        </div>

                        <!-- Body: Informaci√≥n principal -->
                        <div class="service-card-body">
                            <!-- Marca en grande -->
                            <h3 class="marca-principal">{{ orden.detalle_equipo.marca|upper }}</h3>
                            <p class="text-muted mb-3">
                                {{ orden.detalle_equipo.get_tipo_equipo_display }}
                                {% if orden.detalle_equipo.modelo %}
                                    <span class="text-primary"> | {{ orden.detalle_equipo.modelo }}</span>
                                {% endif %}
                            </p>

                            <!-- Informaci√≥n detallada -->
                            <div class="info-item">
                                <i class="bi bi-upc-scan"></i>
                                <strong>N¬∞ Serie:</strong>
                                <span>{{ orden.detalle_equipo.numero_serie }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-receipt"></i>
                                <strong>Orden SIC:</strong>
                                <span>{{ orden.detalle_equipo.orden_cliente }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-building"></i>
                                <strong>Centro:</strong>
                                <span>{{ orden.sucursal.nombre }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-hash"></i>
                                <strong>Orden:</strong>
                                <span class="text-primary fw-bold">{{ orden.numero_orden_interno }}</span>
                            </div>

                            <!-- Indicadores visuales -->
                            <div class="indicadores">
                                <!-- Indicador de im√°genes -->
                                {% with imagenes_count=orden.imagenes.count %}
                                <div class="indicador">
                                    <div class="indicador-icon {% if imagenes_count > 0 %}has-images{% else %}no-images{% endif %}">
                                        {{ imagenes_count }}
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">IM√ÅGENES</small>
                                        <strong style="font-size: 0.75rem;">{{ imagenes_count }} foto(s)</strong>
                                    </div>
                                </div>
                                {% endwith %}

                                <!-- Indicador de cargador -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.detalle_equipo.tiene_cargador %}has-charger{% else %}no-charger{% endif %}">
                                        <i class="bi bi-{% if orden.detalle_equipo.tiene_cargador %}check{% else %}x{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">CARGADOR</small>
                                        <strong style="font-size: 0.75rem;">{{ orden.detalle_equipo.tiene_cargador|yesno:"S√≠,No" }}</strong>
                                    </div>
                                </div>

                                <!-- Indicador de t√©cnico asignado -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.tecnico_asignado_actual %}has-technician{% else %}no-technician{% endif %}">
                                        <i class="bi bi-{% if orden.tecnico_asignado_actual %}person-check{% else %}person-x{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">T√âCNICO</small>
                                        <strong style="font-size: 0.75rem;">
                                            {% if orden.tecnico_asignado_actual %}
                                                {{ orden.tecnico_asignado_actual.nombre_completo|truncatechars:12 }}
                                            {% else %}
                                                Sin asignar
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>

                                <!-- Indicador de responsable del seguimiento -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.responsable_seguimiento %}has-responsible{% else %}no-responsible{% endif %}">
                                        <i class="bi bi-{% if orden.responsable_seguimiento %}person-badge{% else %}person-dash{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">RESPONSABLE</small>
                                        <strong style="font-size: 0.75rem;">
                                            {% if orden.responsable_seguimiento %}
                                                {{ orden.responsable_seguimiento.nombre_completo|truncatechars:12 }}
                                            {% else %}
                                                Sin asignar
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>

                                <!-- Indicador de cotizaci√≥n -->
                                <div class="indicador">
                                    {% if orden.cotizacion %}
                                        <div class="indicador-icon has-quotation" title="Tiene cotizaci√≥n creada">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">COTIZACI√ìN</small>
                                            <strong style="font-size: 0.75rem;">Creada</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-quotation" title="Sin cotizaci√≥n">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">COTIZACI√ìN</small>
                                            <strong style="font-size: 0.75rem;">Pendiente</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de venta mostrador -->
                                <div class="indicador">
                                    {% if orden.venta_mostrador %}
                                        <div class="indicador-icon has-sale" title="Tiene venta mostrador registrada">
                                            <i class="bi bi-cart-check"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">VENTA</small>
                                            <strong style="font-size: 0.75rem;">Registrada</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-sale" title="Sin venta mostrador">
                                            <i class="bi bi-cart-x"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">VENTA</small>
                                            <strong style="font-size: 0.75rem;">Sin venta</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de diagn√≥stico SIC -->
                                <div class="indicador">
                                    {% if orden.detalle_equipo.diagnostico_sic and orden.detalle_equipo.fecha_fin_diagnostico %}
                                        <div class="indicador-icon has-diagnostic" title="Diagn√≥stico SIC completado con texto y fecha de finalizaci√≥n">
                                            <i class="bi bi-clipboard2-pulse-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">DIAGN√ìSTICO SIC</small>
                                            <strong style="font-size: 0.75rem;">Completado</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-diagnostic" title="Diagn√≥stico SIC pendiente (requiere texto y fecha de finalizaci√≥n)">
                                            <i class="bi bi-clipboard2-pulse"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">DIAGN√ìSTICO SIC</small>
                                            <strong style="font-size: 0.75rem;">Pendiente</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de gama del equipo -->
                                <div class="indicador">
                                    {% if orden.detalle_equipo.gama == 'alta' %}
                                        <div class="indicador-icon gama-alta" title="Gama Alta">
                                            <i class="bi bi-star-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Alta</strong>
                                        </div>
                                    {% elif orden.detalle_equipo.gama == 'media' %}
                                        <div class="indicador-icon gama-media" title="Gama Media">
                                            <i class="bi bi-dash-circle-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Media</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon gama-baja" title="Gama Baja">
                                            <i class="bi bi-circle-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Baja</strong>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Footer: Botones de acci√≥n -->
                        <div class="service-card-footer">
                            {% if tipo == 'activas' and orden.estado == 'finalizado' %}
                                <form method="post" action="{% url 'servicio_tecnico:cerrar_orden' orden.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-cerrar-orden btn-ver-detalles mb-2"
                                            onclick="return confirm('¬øMarcar orden {{ orden.numero_orden_interno }} como entregada?')">
                                        <i class="bi bi-check-circle"></i> Cerrar Orden
                                    </button>
                                </form>
                            {% endif %}
                            <a href="{% url 'servicio_tecnico:detalle_orden' orden.pk %}" class="btn btn-primary btn-ver-detalles">
                                <i class="bi bi-eye"></i> Ver Detalles
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Mensaje cuando no hay resultados -->
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <h4 class="mt-3">No se encontraron √≥rdenes</h4>
            {% if busqueda %}
                <p>No hay resultados para la b√∫squeda: <strong>"{{ busqueda }}"</strong></p>
                <a href="?" class="btn btn-primary">Ver todas las √≥rdenes</a>
            {% else %}
                <p>No hay √≥rdenes {{ tipo }} registradas.</p>
                <a href="{% url 'servicio_tecnico:crear_orden' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Crear primera orden
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Limpiar b√∫squeda con ESC
document.addEventListener('DOMContentLoaded', function() {
    const busquedaInput = document.getElementById('busqueda');
    if (busquedaInput) {
        busquedaInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                this.form.submit();
            }
        });
        
        // Auto-focus en el campo de b√∫squeda
        busquedaInput.focus();
    }

    // ============================================
    // MANEJO DE COLLAPSE/EXPAND DE TABLA DE REASIGNACIONES
    // ============================================
    
    const collapseReasignaciones = document.getElementById('collapseReasignaciones');
    
    // Verificar el estado guardado en localStorage
    if (collapseReasignaciones) {
        const savedStateReasignaciones = localStorage.getItem('collapseReasignaciones');
        if (savedStateReasignaciones === 'visible') {
            const bsCollapse = new bootstrap.Collapse(collapseReasignaciones, { toggle: false });
            bsCollapse.show();
        }
    }
    
    // Manejar cambio de iconos y guardar estado
    function setupCollapseToggle(collapseElement, storageKey) {
        if (!collapseElement) return;
        
        const header = document.querySelector(`[data-bs-target="#${collapseElement.id}"]`);
        if (!header) return;
        
        const icon = header.querySelector('.collapse-icon');
        
        collapseElement.addEventListener('show.bs.collapse', function() {
            if (icon) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            }
            header.setAttribute('aria-expanded', 'true');
            localStorage.setItem(storageKey, 'visible');
        });
        
        collapseElement.addEventListener('hide.bs.collapse', function() {
            if (icon) {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
            header.setAttribute('aria-expanded', 'false');
            localStorage.setItem(storageKey, 'hidden');
        });
        
        // Sincronizar icono con estado actual al cargar
        if (collapseElement.classList.contains('show')) {
            if (icon) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            }
            header.setAttribute('aria-expanded', 'true');
        } else {
            if (icon) {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
            header.setAttribute('aria-expanded', 'false');
        }
    }
    
    setupCollapseToggle(collapseReasignaciones, 'collapseReasignaciones');
});
</script>
{% endblock %}
