{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- Cargar estilos espec√≠ficos de servicio t√©cnico -->
<link rel="stylesheet" href="{% static 'css/servicio_tecnico.css' %}?v=6.6">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header con t√≠tulo y botones de acci√≥n -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-laptop"></i> {{ titulo }}
                    </h1>
                    <p class="text-muted mb-0">Control y seguimiento de equipos en servicio</p>
                </div>
                <div class="d-flex gap-2">
                    {% if tipo == 'activas' %}
                        <a href="{% url 'servicio_tecnico:lista_finalizadas' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-check-circle"></i> Ver Cerrados
                        </a>
                        <form method="post" action="{% url 'servicio_tecnico:cerrar_todas' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success" 
                                    onclick="return confirm('¬øCerrar todas las √≥rdenes finalizadas?')">
                                <i class="bi bi-check-all"></i> Cerrar Finalizados
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-outline-primary">
                            <i class="bi bi-hourglass-split"></i> Ver Activos
                        </a>
                    {% endif %}
                    <a href="{% url 'servicio_tecnico:seleccionar_tipo_orden' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Orden
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de b√∫squeda y filtros -->
    <div class="search-box">
        <form method="get" class="row g-3">
            <div class="col-md-9">
                <label for="busqueda" class="form-label">
                    <i class="bi bi-search"></i> Buscar por N¬∞ de Serie u Orden
                </label>
                <input type="text" 
                       class="form-control" 
                       id="busqueda" 
                       name="busqueda" 
                       value="{{ busqueda }}"
                       placeholder="Escribe el n√∫mero de serie o la orden...">
                <small class="text-muted">Presiona ESC para limpiar la b√∫squeda</small>
            </div>
            <div class="col-md-3 d-flex flex-column">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if busqueda %}
                    <a href="?" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </a>
                {% endif %}
            </div>
        </form>
        <div class="mt-3">
            <span class="badge bg-primary">{{ total }} resultado(s)</span>
            {% if busqueda %}
                <span class="badge bg-info ms-2">
                    <i class="bi bi-funnel"></i> B√∫squeda activa: "{{ busqueda }}"
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Cuadro informativo: Estad√≠sticas por t√©cnico (solo en vista activas) -->
    {% if mostrar_estadisticas %}
        <!-- Banner informativo sobre las estad√≠sticas -->
        <div class="alert alert-info mt-4 mb-3" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <h6 class="alert-heading mb-1">
                        <i class="bi bi-bar-chart-line"></i> Vista General de Estad√≠sticas por T√©cnico
                    </h6>
                    <p class="mb-0">
                        <strong>"Equipos No Enciende":</strong> <span class="badge bg-warning text-dark">Activos</span> (solo "No Enciende" en proceso) vs <span class="badge bg-info">Hist√≥rico</span> (desglose: s√≠ enciende / no enciende / total).
                        <br>
                        <strong>"Equipos por Gama":</strong> <span class="badge bg-warning text-dark">Activos</span> (carga actual por gama) vs <span class="badge bg-info">Hist√≥rico Total</span> (desempe√±o acumulado por gama).
                        {% if busqueda %}
                            <br><small class="text-muted">(Estad√≠sticas independientes de la b√∫squeda activa)</small>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="row mt-4 g-4 estadisticas-tecnico-row">
        
        <!-- ========================================================================
             CARGA DE TRABAJO POR T√âCNICO CON TRACKING TEMPORAL Y ROTACI√ìN
             ======================================================================== -->
        {% if ordenes_por_tecnico %}
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white d-flex justify-content-between align-items-center flex-wrap gap-3" 
                     style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 1rem 1.5rem;">
                    <div>
                        <h6 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">
                            <i class="bi bi-people-fill" style="font-size: 1.3rem;"></i> Carga de Trabajo por T√©cnico - Tracking Temporal
                        </h6>
                        <small class="text-white opacity-90">Monitoreo en tiempo real con sugerencia de rotaci√≥n equitativa</small>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <!-- Filtro temporal -->
                        <form method="get" id="filtroTemporalForm" class="d-flex gap-2">
                            {% if busqueda %}
                                <input type="hidden" name="busqueda" value="{{ busqueda }}">
                            {% endif %}
                            <select name="filtro_temporal" class="form-select form-select-sm bg-white" style="min-width: 150px;" onchange="this.form.submit()">
                                <option value="hoy" {% if filtro_temporal == 'hoy' %}selected{% endif %}>üìÖ Hoy</option>
                                <option value="semana" {% if filtro_temporal == 'semana' %}selected{% endif %}>üìä Esta Semana</option>
                                <option value="historico" {% if filtro_temporal == 'historico' %}selected{% endif %}>üìú Hist√≥rico Total</option>
                            </select>
                        </form>
                        
                        <span class="badge bg-white text-dark" style="padding: 0.5rem 1rem; font-weight: 600;">
                            {{ ordenes_por_tecnico|length }} t√©cnico{{ ordenes_por_tecnico|length|pluralize }}
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 25%;">
                                        <i class="bi bi-person-badge"></i> T√©cnico
                                    </th>
                                    <th class="text-center" style="width: 12%;">
                                        <i class="bi bi-hourglass-split"></i><br>
                                        <small>Activas</small>
                                    </th>
                                    <th class="text-center" style="width: 12%;">
                                        <i class="bi bi-calendar-day"></i><br>
                                        <small>Hoy</small>
                                    </th>
                                    <th class="text-center" style="width: 12%;">
                                        <i class="bi bi-calendar-week"></i><br>
                                        <small>Semana</small>
                                    </th>
                                    <th class="text-center" style="width: 15%;">
                                        <i class="bi bi-clock-history"></i><br>
                                        <small>√öltima</small>
                                    </th>
                                    <th class="text-center" style="width: 24%;">
                                        <i class="bi bi-speedometer2"></i><br>
                                        <small>Estado</small>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tecnico in ordenes_por_tecnico %}
                                <tr class="{% if tecnico.es_siguiente_rotacion %}table-success bg-success bg-opacity-10{% endif %}">
                                    <!-- Columna: T√©cnico -->
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="tecnico-avatar-wrapper position-relative">
                                                {% if tecnico.foto_url %}
                                                    <img src="{{ tecnico.foto_url }}" 
                                                         alt="{{ tecnico.tecnico_nombre }}"
                                                         class="rounded-circle"
                                                         style="width: 46px; height: 46px; object-fit: cover; border: 2px solid #e5e7eb;">
                                                {% else %}
                                                    <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                                                         style="width: 46px; height: 46px; background-color: #6b7280; font-size: 0.9rem; border: 2px solid #e5e7eb;">
                                                        {{ tecnico.iniciales }}
                                                    </div>
                                                {% endif %}
                                                
                                                <!-- Badge de rotaci√≥n sugerida -->
                                                {% if tecnico.es_siguiente_rotacion %}
                                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" 
                                                          style="font-size: 0.6rem; padding: 0.25rem 0.4rem;"
                                                          title="Siguiente en rotaci√≥n sugerida">
                                                        <i class="bi bi-arrow-right-circle-fill"></i>
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-bold" style="font-size: 0.9rem;">
                                                    {{ tecnico.tecnico_nombre }}
                                                    {% if tecnico.es_siguiente_rotacion %}
                                                        <span class="badge bg-success ms-1" style="font-size: 0.65rem;">
                                                            <i class="bi bi-star-fill"></i> SIGUIENTE
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                {% if tecnico.equipos_no_encienden > 0 %}
                                                    <small class="text-muted">
                                                        <i class="bi bi-exclamation-triangle text-warning"></i> 
                                                        {{ tecnico.equipos_no_encienden }} no enciende{{ tecnico.equipos_no_encienden|pluralize }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    
                                    <!-- Columna: √ìrdenes Activas -->
                                    <td class="text-center">
                                        {% if tecnico.ordenes_actuales > 0 %}
                                            <span class="badge bg-primary fs-6 px-3 py-2">
                                                {{ tecnico.ordenes_actuales }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Columna: Asignaciones Hoy -->
                                    <td class="text-center">
                                        {% if tecnico.asignaciones_hoy > 0 %}
                                            <span class="badge bg-info text-dark px-2 py-1">
                                                +{{ tecnico.asignaciones_hoy }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted" style="font-size: 0.85rem;">0</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Columna: Asignaciones Semana -->
                                    <td class="text-center">
                                        {% if filtro_temporal != 'hoy' %}
                                            {% if tecnico.asignaciones_semana > 0 %}
                                                <span class="badge bg-secondary px-2 py-1">
                                                    {{ tecnico.asignaciones_semana }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.85rem;">0</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted" style="font-size: 0.75rem;">N/A</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Columna: √öltima Asignaci√≥n -->
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-clock"></i> {{ tecnico.tiempo_sin_asignar }}
                                        </span>
                                    </td>
                                    
                                    <!-- Columna: Estado / Alertas -->
                                    <td class="text-center">
                                        <div class="d-flex flex-wrap gap-1 justify-content-center">
                                            {% if tecnico.tiene_sobrecarga %}
                                                <span class="badge bg-danger" title="Tiene 3+ equipos que no encienden">
                                                    <i class="bi bi-exclamation-triangle-fill"></i> SOBRECARGA
                                                </span>
                                            {% elif tecnico.necesita_alerta_sin_asignaciones %}
                                                <span class="badge bg-warning text-dark" title="M√°s de 8 horas sin asignaciones">
                                                    <i class="bi bi-clock"></i> SIN ASIGNACIONES
                                                </span>
                                            {% elif tecnico.esta_balanceado %}
                                                <span class="badge bg-success" title="Carga equilibrada (¬±1 del promedio)">
                                                    <i class="bi bi-check-circle-fill"></i> BALANCEADO
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-dash-circle"></i> NORMAL
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Leyenda explicativa -->
                    <div class="alert alert-light border-top border-0 rounded-0 mb-0 mt-3" role="alert" style="background-color: #f8f9fa;">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <strong><i class="bi bi-info-circle text-primary"></i> Columnas:</strong>
                                <ul class="mb-0" style="font-size: 0.8rem;">
                                    <li><strong>Activas:</strong> √ìrdenes actualmente asignadas</li>
                                    <li><strong>Hoy:</strong> Asignaciones recibidas hoy</li>
                                    <li><strong>Semana:</strong> Total de asignaciones esta semana</li>
                                </ul>
                            </div>
                            <div class="col-md-3">
                                <strong><i class="bi bi-speedometer2 text-success"></i> Rotaci√≥n:</strong>
                                <ul class="mb-0" style="font-size: 0.8rem;">
                                    <li><span class="badge bg-success" style="font-size: 0.7rem;">SIGUIENTE</span> T√©cnico sugerido para pr√≥xima asignaci√≥n</li>
                                    <li><em>Criterio:</em> Menor carga + Tiempo sin asignar + Asignaciones del d√≠a</li>
                                </ul>
                            </div>
                            <div class="col-md-3">
                                <strong><i class="bi bi-shield-check text-info"></i> Estados:</strong>
                                <ul class="mb-0" style="font-size: 0.8rem;">
                                    <li><span class="badge bg-danger" style="font-size: 0.7rem;">SOBRECARGA</span> 3+ equipos "No Enciende"</li>
                                    <li><span class="badge bg-warning text-dark" style="font-size: 0.7rem;">SIN ASIGNACIONES</span> +8h sin recibir</li>
                                    <li><span class="badge bg-success" style="font-size: 0.7rem;">BALANCEADO</span> Carga equilibrada</li>
                                </ul>
                            </div>
                            <div class="col-md-3">
                                <strong><i class="bi bi-funnel text-warning"></i> Filtro Temporal:</strong>
                                <ul class="mb-0" style="font-size: 0.8rem;">
                                    <li><strong>Hoy:</strong> Solo asignaciones de hoy</li>
                                    <li><strong>Esta Semana:</strong> Desde el lunes</li>
                                    <li><strong>Hist√≥rico:</strong> Todas las asignaciones</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- ========================================================================
             HISTORIAL DE REASIGNACIONES DEL D√çA
             ======================================================================== -->
        {% if reasignaciones_hoy %}
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white d-flex justify-content-between align-items-center clickable-header" 
                     data-bs-toggle="collapse" 
                     data-bs-target="#collapseReasignaciones" 
                     aria-expanded="false" 
                     aria-controls="collapseReasignaciones"
                     role="button"
                     style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; padding: 1rem 1.5rem; cursor: pointer;">
                    <h6 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">
                        <i class="bi bi-arrow-left-right" style="font-size: 1.3rem;"></i> Historial de Reasignaciones del D√≠a
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-white text-dark" style="padding: 0.4rem 0.8rem; font-weight: 600;">
                            {{ reasignaciones_hoy|length }} reasignacion{{ reasignaciones_hoy|length|pluralize:"es" }}
                        </span>
                        <div class="toggle-collapse-icon">
                            <i class="bi bi-chevron-down collapse-icon" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                </div>
                <div class="collapse" id="collapseReasignaciones">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 10%;"><i class="bi bi-clock"></i> Hora</th>
                                        <th style="width: 15%;"><i class="bi bi-hash"></i> Orden</th>
                                        <th style="width: 25%;"><i class="bi bi-arrow-left-right"></i> Reasignaci√≥n</th>
                                        <th style="width: 35%;"><i class="bi bi-chat-left-text"></i> Motivo / Comentario</th>
                                        <th style="width: 15%;"><i class="bi bi-person"></i> Realizado por</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reasignacion in reasignaciones_hoy %}
                                    <tr>
                                        <!-- Hora -->
                                        <td>
                                            <span class="badge bg-light text-dark border">
                                                {{ reasignacion.fecha_evento|date:"H:i" }}
                                            </span>
                                        </td>
                                        
                                        <!-- Orden -->
                                        <td>
                                            <a href="{% url 'servicio_tecnico:detalle_orden' reasignacion.orden.id %}" 
                                               class="text-decoration-none fw-bold text-primary"
                                               title="Ver detalles de la orden">
                                                {{ reasignacion.orden.detalle_equipo.orden_cliente }}
                                            </a>
                                            <br>
                                            <small class="text-muted">{{ reasignacion.orden.detalle_equipo.marca }} | {{ reasignacion.orden.numero_orden_interno }}</small>
                                        </td>
                                        
                                        <!-- Reasignaci√≥n (De ‚Üí A) -->
                                        <td>
                                            <div class="d-flex align-items-center gap-2" style="font-size: 0.85rem;">
                                                {% if reasignacion.tecnico_anterior %}
                                                    <span class="badge bg-secondary text-white px-2 py-1">
                                                        {{ reasignacion.tecnico_anterior.nombre_completo|truncatechars:15 }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-light text-muted px-2 py-1">Sin asignar</span>
                                                {% endif %}
                                                
                                                <i class="bi bi-arrow-right text-primary"></i>
                                                
                                                {% if reasignacion.tecnico_nuevo %}
                                                    <span class="badge bg-primary text-white px-2 py-1">
                                                        {{ reasignacion.tecnico_nuevo.nombre_completo|truncatechars:15 }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-light text-muted px-2 py-1">Sin asignar</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        
                                        <!-- Comentario / Motivo -->
                                        <td>
                                            {% if reasignacion.comentario %}
                                                <small class="text-dark">{{ reasignacion.comentario|truncatechars:60 }}</small>
                                            {% else %}
                                                <small class="text-muted fst-italic">Sin comentario</small>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Usuario que realiz√≥ el cambio -->
                                        <td>
                                            {% if reasignacion.usuario %}
                                                <small class="text-muted">
                                                    <i class="bi bi-person-circle"></i> {{ reasignacion.usuario.nombre_completo }}
                                                </small>
                                            {% elif reasignacion.es_sistema %}
                                                <small class="text-muted fst-italic">
                                                    <i class="bi bi-gear"></i> Sistema
                                                </small>
                                            {% else %}
                                                <small class="text-muted fst-italic">N/A</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Nota informativa -->
                        <div class="alert alert-light border-top border-0 rounded-0 mb-0" role="alert" style="font-size: 0.85rem;">
                            <i class="bi bi-info-circle text-info"></i> 
                            <strong>Uso:</strong> Monitorea c√≥mo se redistribuyen los equipos durante el d√≠a. 
                            Detecta patrones de reasignaci√≥n excesiva que puedan indicar problemas de balance de carga o disponibilidad de t√©cnicos.
                            <em class="text-muted">(Mostrando √∫ltimas 20 reasignaciones)</em>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Equipos "No enciende" por t√©cnico (ACTIVOS + HIST√ìRICO) -->
        {% if equipos_no_enciende_por_tecnico %}
            <div class="col-lg-12">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header text-white d-flex justify-content-between align-items-center clickable-header" 
                         data-bs-toggle="collapse" 
                         data-bs-target="#collapseNoEnciende" 
                         aria-expanded="false" 
                         aria-controls="collapseNoEnciende"
                         role="button"
                         style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border: none; padding: 1rem 1.5rem; cursor: pointer;">
                        <h6 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">
                            <i class="bi bi-exclamation-triangle" style="font-size: 1.3rem;"></i> Equipos "No Enciende" por T√©cnico - Activos vs Hist√≥rico
                        </h6>
                        <div class="toggle-collapse-icon">
                            <i class="bi bi-chevron-down collapse-icon" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                    <div class="collapse" id="collapseNoEnciende">
                        <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%;">T√©cnico</th>
                                        <th class="text-center" style="background-color: #fff3cd; width: 35%;">
                                            <i class="bi bi-hourglass-split"></i> Activos (Carga Actual)
                                        </th>
                                        <th class="text-center" style="background-color: #d1ecf1; width: 35%;">
                                            <i class="bi bi-clock-history"></i> Hist√≥rico Total
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tecnico in equipos_no_enciende_por_tecnico %}
                                        <tr>
                                            <!-- Columna: T√©cnico con foto/iniciales -->
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="tecnico-avatar me-2">
                                                        {% if tecnico.foto_url %}
                                                            <img src="{{ tecnico.foto_url }}" 
                                                                 alt="Foto de {{ tecnico.nombre }}"
                                                                 class="tecnico-foto"
                                                                 style="width: 46px; height: 46px; border-radius: 50%; object-fit: cover;">
                                                        {% else %}
                                                            <div class="tecnico-iniciales" 
                                                                 style="width: 46px; height: 46px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: bold;">
                                                                {{ tecnico.iniciales }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold" style="font-size: 0.9rem;">{{ tecnico.nombre }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            
                                            <!-- SECCI√ìN: ACTIVOS -->
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos > 0 %}
                                                    <span class="badge bg-danger fs-6 px-3 py-2">
                                                        <i class="bi bi-exclamation-triangle-fill"></i> {{ tecnico.activos }}
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">equipo(s) en proceso</small>
                                                {% else %}
                                                    <span class="text-muted">Sin equipos activos</span>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- SECCI√ìN: HIST√ìRICO CON DESGLOSE -->
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                <div class="d-flex justify-content-around align-items-center">
                                                    <!-- S√≠ Enciende -->
                                                    <div class="text-center">
                                                        <span class="badge bg-success fs-6 px-2 py-1">
                                                            <i class="bi bi-power"></i> {{ tecnico.historico.si_enciende }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" style="font-size: 0.75rem;">S√≠ enciende</small>
                                                    </div>
                                                    
                                                    <!-- No Enciende -->
                                                    <div class="text-center">
                                                        <span class="badge bg-danger fs-6 px-2 py-1">
                                                            <i class="bi bi-x-circle"></i> {{ tecnico.historico.no_enciende }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" style="font-size: 0.75rem;">No enciende</small>
                                                    </div>
                                                    
                                                    <!-- Total -->
                                                    <div class="text-center">
                                                        <span class="badge bg-secondary fs-6 px-2 py-1">
                                                            <i class="bi bi-archive-fill"></i> {{ tecnico.historico.total }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" style="font-size: 0.75rem;">Total</small>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Leyenda explicativa -->
                        <div class="alert alert-light border mt-3 mb-0" role="alert">
                            <small>
                                <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                <ul class="mb-0 mt-1" style="font-size: 0.85rem;">
                                    <li><strong>Activos:</strong> Equipos "No Enciende" actualmente en reparaci√≥n (carga cr√≠tica espec√≠fica)</li>
                                    <li><strong>Hist√≥rico Total:</strong> Desglose completo de todos los equipos manejados - <span class="badge bg-success">S√≠ enciende</span>, <span class="badge bg-danger">No enciende</span> y <span class="badge bg-secondary">Total</span></li>
                                </ul>
                            </small>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Equipos por gama por t√©cnico (HIST√ìRICO COMPLETO) -->
        {% if equipos_por_gama_por_tecnico %}
            <div class="col-lg-12">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header text-white d-flex justify-content-between align-items-center clickable-header" 
                         data-bs-toggle="collapse" 
                         data-bs-target="#collapseGama" 
                         aria-expanded="false" 
                         aria-controls="collapseGama"
                         role="button"
                         style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; padding: 1rem 1.5rem; cursor: pointer;">
                        <h6 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">
                            <i class="bi bi-bar-chart-line" style="font-size: 1.3rem;"></i> Equipos por Gama por T√©cnico - Activos vs Hist√≥rico
                        </h6>
                        <div class="toggle-collapse-icon">
                            <i class="bi bi-chevron-down collapse-icon" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                    <div class="collapse" id="collapseGama">
                        <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 20%;">T√©cnico</th>
                                        <th class="text-center" colspan="4" style="background-color: #fff3cd;">
                                            <i class="bi bi-hourglass-split"></i> Activos (Carga Actual)
                                        </th>
                                        <th class="text-center" colspan="4" style="background-color: #d1ecf1;">
                                            <i class="bi bi-clock-history"></i> Hist√≥rico Total
                                        </th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <!-- Columnas ACTIVOS -->
                                        <th class="text-center" style="background-color: #fff3cd;"><i class="bi bi-star-fill text-success"></i> Alta</th>
                                        <th class="text-center" style="background-color: #fff3cd;"><i class="bi bi-dash-circle-fill text-warning"></i> Media</th>
                                        <th class="text-center" style="background-color: #fff3cd;"><i class="bi bi-circle-fill text-secondary"></i> Baja</th>
                                        <th class="text-center" style="background-color: #fff3cd;"><strong>Total</strong></th>
                                        <!-- Columnas HIST√ìRICO -->
                                        <th class="text-center" style="background-color: #d1ecf1;"><i class="bi bi-star-fill text-success"></i> Alta</th>
                                        <th class="text-center" style="background-color: #d1ecf1;"><i class="bi bi-dash-circle-fill text-warning"></i> Media</th>
                                        <th class="text-center" style="background-color: #d1ecf1;"><i class="bi bi-circle-fill text-secondary"></i> Baja</th>
                                        <th class="text-center" style="background-color: #d1ecf1;"><strong>Total</strong></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tecnico in equipos_por_gama_por_tecnico %}
                                        <tr>
                                            <!-- Columna: T√©cnico con foto/iniciales -->
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="tecnico-avatar me-2">
                                                        {% if tecnico.foto_url %}
                                                            <img src="{{ tecnico.foto_url }}" 
                                                                 alt="Foto de {{ tecnico.nombre }}"
                                                                 class="tecnico-foto"
                                                                 style="width: 46px; height: 46px; border-radius: 50%; object-fit: cover;">
                                                        {% else %}
                                                            <div class="tecnico-iniciales" 
                                                                 style="width: 46px; height: 46px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: bold;">
                                                                {{ tecnico.iniciales }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold" style="font-size: 0.9rem;">{{ tecnico.nombre }}</div>
                                                    </div>
                                                </div>
                                            </td>

                                            <!-- SECCI√ìN: ACTIVOS -->
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos.alta > 0 %}
                                                    <span class="badge bg-success">{{ tecnico.activos.alta }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos.media > 0 %}
                                                    <span class="badge bg-warning">{{ tecnico.activos.media }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #fffbf0;">
                                                {% if tecnico.activos.baja > 0 %}
                                                    <span class="badge bg-secondary">{{ tecnico.activos.baja }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center fw-bold" style="background-color: #fff3cd;">
                                                {{ tecnico.activos.total }}
                                            </td>
                                            
                                            <!-- SECCI√ìN: HIST√ìRICO -->
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                {% if tecnico.historico.alta > 0 %}
                                                    <span class="badge bg-success">{{ tecnico.historico.alta }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                {% if tecnico.historico.media > 0 %}
                                                    <span class="badge bg-warning">{{ tecnico.historico.media }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" style="background-color: #f0f8ff;">
                                                {% if tecnico.historico.baja > 0 %}
                                                    <span class="badge bg-secondary">{{ tecnico.historico.baja }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center fw-bold" style="background-color: #d1ecf1;">
                                                {{ tecnico.historico.total }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Leyenda explicativa -->
                        <div class="alert alert-light border mt-3 mb-0" role="alert">
                            <small>
                                <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                <ul class="mb-0 mt-1" style="font-size: 0.85rem;">
                                    <li><strong>Activos:</strong> Equipos actualmente en proceso (carga de trabajo presente)</li>
                                    <li><strong>Hist√≥rico:</strong> Total de equipos manejados incluyendo cerrados (desempe√±o acumulado)</li>
                                </ul>
                            </small>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}  <!-- Fin de mostrar_estadisticas -->

    <!-- Grid de cards -->
    {% if ordenes %}
        <div class="row g-2">
            {% for orden in ordenes %}
                <div class="col-lg-5-cols col-md-6 col-sm-6">
                    <div class="service-card {% if orden.detalle_equipo.orden_cliente|slice:":3" == "FL-" %}orden-fl{% elif orden.detalle_equipo.orden_cliente|slice:":4" == "OOW-" %}orden-oow{% elif orden.detalle_equipo.orden_cliente|slice:":10" == "MX_CIS_MX_" %}orden-mx-cis{% endif %}">
                        <!-- Header: Estado y fecha -->
                        <div class="service-card-header">
                            <span class="badge badge-estado badge-{{ orden.estado }}">
                                {{ orden.get_estado_display }}
                            </span>
                            {% if orden.es_candidato_rhitso %}
                                <span class="badge badge-rhitso">RHITSO</span>
                            {% endif %}
                            
                            <!-- NUEVO: Indicador de d√≠as sin actualizaci√≥n -->
                            <span class="badge badge-dias-sin-actualizacion bg-{{ orden.color_dias_sin_actualizacion }}" 
                                  title="D√≠as h√°biles sin actualizaci√≥n de estado">
                                <i class="bi bi-clock-history"></i> {{ orden.dias_sin_actualizacion_estado }}d
                            </span>
                            
                            <small class="text-muted">
                                {{ orden.fecha_ingreso|date:"d/m/Y" }}
                            </small>
                        </div>

                        <!-- Body: Informaci√≥n principal -->
                        <div class="service-card-body">
                            <!-- Marca en grande -->
                            <h3 class="marca-principal">{{ orden.detalle_equipo.marca|upper }}</h3>
                            <p class="text-muted mb-3">
                                {{ orden.detalle_equipo.get_tipo_equipo_display }}
                                {% if orden.detalle_equipo.modelo %}
                                    <span class="text-primary"> | {{ orden.detalle_equipo.modelo }}</span>
                                {% endif %}
                            </p>

                            <!-- Informaci√≥n detallada -->
                            <div class="info-item">
                                <i class="bi bi-upc-scan"></i>
                                <strong>N¬∞ Serie:</strong>
                                <span>{{ orden.detalle_equipo.numero_serie }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-receipt"></i>
                                <strong>Orden SIC:</strong>
                                <span>{{ orden.detalle_equipo.orden_cliente }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-building"></i>
                                <strong>Centro:</strong>
                                <span>{{ orden.sucursal.nombre }}</span>
                            </div>

                            <div class="info-item">
                                <i class="bi bi-hash"></i>
                                <strong>Orden:</strong>
                                <span class="text-primary fw-bold">{{ orden.numero_orden_interno }}</span>
                            </div>

                            <!-- Indicadores visuales -->
                            <div class="indicadores">
                                <!-- Indicador de im√°genes -->
                                {% with imagenes_count=orden.imagenes.count %}
                                <div class="indicador">
                                    <div class="indicador-icon {% if imagenes_count > 0 %}has-images{% else %}no-images{% endif %}">
                                        {{ imagenes_count }}
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">IM√ÅGENES</small>
                                        <strong style="font-size: 0.75rem;">{{ imagenes_count }} foto(s)</strong>
                                    </div>
                                </div>
                                {% endwith %}

                                <!-- Indicador de cargador -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.detalle_equipo.tiene_cargador %}has-charger{% else %}no-charger{% endif %}">
                                        <i class="bi bi-{% if orden.detalle_equipo.tiene_cargador %}check{% else %}x{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">CARGADOR</small>
                                        <strong style="font-size: 0.75rem;">{{ orden.detalle_equipo.tiene_cargador|yesno:"S√≠,No" }}</strong>
                                    </div>
                                </div>

                                <!-- Indicador de t√©cnico asignado -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.tecnico_asignado_actual %}has-technician{% else %}no-technician{% endif %}">
                                        <i class="bi bi-{% if orden.tecnico_asignado_actual %}person-check{% else %}person-x{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">T√âCNICO</small>
                                        <strong style="font-size: 0.75rem;">
                                            {% if orden.tecnico_asignado_actual %}
                                                {{ orden.tecnico_asignado_actual.nombre_completo|truncatechars:12 }}
                                            {% else %}
                                                Sin asignar
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>

                                <!-- Indicador de responsable del seguimiento -->
                                <div class="indicador">
                                    <div class="indicador-icon {% if orden.responsable_seguimiento %}has-responsible{% else %}no-responsible{% endif %}">
                                        <i class="bi bi-{% if orden.responsable_seguimiento %}person-badge{% else %}person-dash{% endif %}"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block" style="font-size: 0.6rem;">RESPONSABLE</small>
                                        <strong style="font-size: 0.75rem;">
                                            {% if orden.responsable_seguimiento %}
                                                {{ orden.responsable_seguimiento.nombre_completo|truncatechars:12 }}
                                            {% else %}
                                                Sin asignar
                                            {% endif %}
                                        </strong>
                                    </div>
                                </div>

                                <!-- Indicador de cotizaci√≥n -->
                                <div class="indicador">
                                    {% if orden.cotizacion %}
                                        <div class="indicador-icon has-quotation" title="Tiene cotizaci√≥n creada">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">COTIZACI√ìN</small>
                                            <strong style="font-size: 0.75rem;">Creada</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-quotation" title="Sin cotizaci√≥n">
                                            <i class="bi bi-receipt"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">COTIZACI√ìN</small>
                                            <strong style="font-size: 0.75rem;">Pendiente</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de venta mostrador -->
                                <div class="indicador">
                                    {% if orden.venta_mostrador %}
                                        <div class="indicador-icon has-sale" title="Tiene venta mostrador registrada">
                                            <i class="bi bi-cart-check"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">VENTA</small>
                                            <strong style="font-size: 0.75rem;">Registrada</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-sale" title="Sin venta mostrador">
                                            <i class="bi bi-cart-x"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">VENTA</small>
                                            <strong style="font-size: 0.75rem;">Sin venta</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de diagn√≥stico SIC -->
                                <div class="indicador">
                                    {% if orden.detalle_equipo.diagnostico_sic and orden.detalle_equipo.fecha_fin_diagnostico %}
                                        <div class="indicador-icon has-diagnostic" title="Diagn√≥stico SIC completado con texto y fecha de finalizaci√≥n">
                                            <i class="bi bi-clipboard2-pulse-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">DIAGN√ìSTICO SIC</small>
                                            <strong style="font-size: 0.75rem;">Completado</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon no-diagnostic" title="Diagn√≥stico SIC pendiente (requiere texto y fecha de finalizaci√≥n)">
                                            <i class="bi bi-clipboard2-pulse"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">DIAGN√ìSTICO SIC</small>
                                            <strong style="font-size: 0.75rem;">Pendiente</strong>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Indicador de gama del equipo -->
                                <div class="indicador">
                                    {% if orden.detalle_equipo.gama == 'alta' %}
                                        <div class="indicador-icon gama-alta" title="Gama Alta">
                                            <i class="bi bi-star-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Alta</strong>
                                        </div>
                                    {% elif orden.detalle_equipo.gama == 'media' %}
                                        <div class="indicador-icon gama-media" title="Gama Media">
                                            <i class="bi bi-dash-circle-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Media</strong>
                                        </div>
                                    {% else %}
                                        <div class="indicador-icon gama-baja" title="Gama Baja">
                                            <i class="bi bi-circle-fill"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block" style="font-size: 0.6rem;">GAMA</small>
                                            <strong style="font-size: 0.75rem;">Baja</strong>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Footer: Botones de acci√≥n -->
                        <div class="service-card-footer">
                            {% if tipo == 'activas' and orden.estado == 'finalizado' %}
                                <form method="post" action="{% url 'servicio_tecnico:cerrar_orden' orden.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-cerrar-orden btn-ver-detalles mb-2"
                                            onclick="return confirm('¬øMarcar orden {{ orden.numero_orden_interno }} como entregada?')">
                                        <i class="bi bi-check-circle"></i> Cerrar Orden
                                    </button>
                                </form>
                            {% endif %}
                            <a href="{% url 'servicio_tecnico:detalle_orden' orden.pk %}" class="btn btn-primary btn-ver-detalles">
                                <i class="bi bi-eye"></i> Ver Detalles
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Mensaje cuando no hay resultados -->
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <h4 class="mt-3">No se encontraron √≥rdenes</h4>
            {% if busqueda %}
                <p>No hay resultados para la b√∫squeda: <strong>"{{ busqueda }}"</strong></p>
                <a href="?" class="btn btn-primary">Ver todas las √≥rdenes</a>
            {% else %}
                <p>No hay √≥rdenes {{ tipo }} registradas.</p>
                <a href="{% url 'servicio_tecnico:crear_orden' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Crear primera orden
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Limpiar b√∫squeda con ESC
document.addEventListener('DOMContentLoaded', function() {
    const busquedaInput = document.getElementById('busqueda');
    if (busquedaInput) {
        busquedaInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                this.form.submit();
            }
        });
        
        // Auto-focus en el campo de b√∫squeda
        busquedaInput.focus();
    }

    // ============================================
    // MANEJO DE COLLAPSE/EXPAND DE TABLAS
    // ============================================
    
    const collapseReasignaciones = document.getElementById('collapseReasignaciones');
    const collapseNoEnciende = document.getElementById('collapseNoEnciende');
    const collapseGama = document.getElementById('collapseGama');
    
    // Verificar el estado guardado en localStorage
    // Si el usuario expandi√≥ manualmente, mantener expandido
    if (collapseReasignaciones) {
        const savedStateReasignaciones = localStorage.getItem('collapseReasignaciones');
        if (savedStateReasignaciones === 'visible') {
            const bsCollapse = new bootstrap.Collapse(collapseReasignaciones, { toggle: false });
            bsCollapse.show();
        }
        // Por defecto permanece colapsado (no se hace nada)
    }
    
    if (collapseNoEnciende) {
        const savedStateNoEnciende = localStorage.getItem('collapseNoEnciende');
        if (savedStateNoEnciende === 'visible') {
            const bsCollapse = new bootstrap.Collapse(collapseNoEnciende, { toggle: false });
            bsCollapse.show();
        }
        // Por defecto permanece colapsado (no se hace nada)
    }
    
    if (collapseGama) {
        const savedStateGama = localStorage.getItem('collapseGama');
        if (savedStateGama === 'visible') {
            const bsCollapse = new bootstrap.Collapse(collapseGama, { toggle: false });
            bsCollapse.show();
        }
        // Por defecto permanece colapsado (no se hace nada)
    }
    
    // Manejar cambio de iconos y guardar estado
    function setupCollapseToggle(collapseElement, storageKey) {
        if (!collapseElement) return;
        
        const header = document.querySelector(`[data-bs-target="#${collapseElement.id}"]`);
        if (!header) return;
        
        const icon = header.querySelector('.collapse-icon');
        
        collapseElement.addEventListener('show.bs.collapse', function() {
            if (icon) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            }
            // Actualizar aria-expanded en el header
            header.setAttribute('aria-expanded', 'true');
            localStorage.setItem(storageKey, 'visible');
        });
        
        collapseElement.addEventListener('hide.bs.collapse', function() {
            if (icon) {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
            // Actualizar aria-expanded en el header
            header.setAttribute('aria-expanded', 'false');
            localStorage.setItem(storageKey, 'hidden');
        });
        
        // Sincronizar icono con estado actual al cargar
        if (collapseElement.classList.contains('show')) {
            if (icon) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            }
            header.setAttribute('aria-expanded', 'true');
        } else {
            if (icon) {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
            header.setAttribute('aria-expanded', 'false');
        }
    }
    
    setupCollapseToggle(collapseReasignaciones, 'collapseReasignaciones');
    setupCollapseToggle(collapseNoEnciende, 'collapseNoEnciende');
    setupCollapseToggle(collapseGama, 'collapseGama');
});
</script>
{% endblock %}
