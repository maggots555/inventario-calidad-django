{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Seguimiento de Piezas - Tr√°nsito{% endblock %}

{% block extra_css %}
<!-- Estilos espec√≠ficos del Dashboard de Seguimiento de Piezas -->
<link rel="stylesheet" href="{% static 'css/dashboard_seguimiento_piezas.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- ========================================
         HEADER DEL DASHBOARD
         ======================================== -->
    <div class="dashboard-header fade-in">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>üöö Dashboard de Seguimiento de Piezas</h1>
                    <p class="mb-0">Monitoreo en tiempo real de piezas en tr√°nsito desde proveedores</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <a href="{% url 'servicio_tecnico:exportar_dashboard_seguimiento_piezas' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-exportar">
                        <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         FORMULARIO DE FILTROS
         ======================================== -->
    <div class="filtros-card card fade-in">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros de B√∫squeda</h5>
        </div>
        <div class="card-body">
            <form id="filtros-form" method="get" class="row g-3">
                
                <!-- Rango de Fechas -->
                <div class="col-md-3">
                    <label for="fecha_inicio" class="form-label">
                        <i class="bi bi-calendar-event"></i> Fecha Inicio
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_inicio"
                           name="fecha_inicio" 
                           value="{{ filtros_activos.fecha_inicio }}">
                </div>
                
                <div class="col-md-3">
                    <label for="fecha_fin" class="form-label">
                        <i class="bi bi-calendar-check"></i> Fecha Fin
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_fin"
                           name="fecha_fin" 
                           value="{{ filtros_activos.fecha_fin }}">
                </div>
                
                <!-- Sucursal -->
                <div class="col-md-2">
                    <label for="sucursal" class="form-label">
                        <i class="bi bi-building"></i> Sucursal
                    </label>
                    <select class="form-select" id="sucursal" name="sucursal">
                        <option value="">Todas las sucursales</option>
                        {% for sucursal in sucursales %}
                        <option value="{{ sucursal.id }}" 
                                {% if filtros_activos.sucursal == sucursal.id %}selected{% endif %}>
                            {{ sucursal.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Proveedor -->
                <div class="col-md-2">
                    <label for="proveedor" class="form-label">
                        <i class="bi bi-truck"></i> Proveedor
                    </label>
                    <select class="form-select" id="proveedor" name="proveedor">
                        <option value="">Todos los proveedores</option>
                        {% for prov in proveedores %}
                        <option value="{{ prov }}"
                                {% if filtros_activos.proveedor == prov %}selected{% endif %}>
                            {{ prov }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Estado -->
                <div class="col-md-2">
                    <label for="estado" class="form-label">
                        <i class="bi bi-clipboard-check"></i> Estado
                    </label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos los estados</option>
                        {% for estado_val, estado_label in estados %}
                        <option value="{{ estado_val }}"
                                {% if filtros_activos.estado == estado_val %}selected{% endif %}>
                            {{ estado_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- B√∫squeda Libre -->
                <div class="col-md-12">
                    <label for="busqueda" class="form-label">
                        <i class="bi bi-search"></i> B√∫squeda Libre
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="busqueda"
                           name="busqueda" 
                           placeholder="Buscar por orden, proveedor, descripci√≥n o n√∫mero de pedido..."
                           value="{{ filtros_activos.busqueda }}">
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div class="col-12">
                    <button type="submit" class="btn btn-filtrar">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'servicio_tecnico:dashboard_seguimiento_piezas' %}" 
                       class="btn btn-limpiar">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar Filtros
                    </a>
                    <span class="text-muted ms-3">
                        <i class="bi bi-info-circle"></i> 
                        Mostrando {{ total_seguimientos }} seguimiento{{ total_seguimientos|pluralize:"s" }}
                    </span>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ========================================
         GRID DE KPIs PRINCIPALES
         ======================================== -->
    <div class="kpis-grid fade-in">
        
        <!-- KPI: Total Seguimientos -->
        <div class="kpi-card primary">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-label">Total Seguimientos</div>
            <div class="kpi-value">{{ kpis.total_seguimientos }}</div>
            <div class="kpi-subtext">En el per√≠odo seleccionado</div>
        </div>
        
        <!-- KPI: Activos -->
        <div class="kpi-card info">
            <div class="kpi-icon">üîÑ</div>
            <div class="kpi-label">Activos</div>
            <div class="kpi-value">{{ kpis.total_activos }}</div>
            <div class="kpi-subtext">En pedido o tr√°nsito</div>
        </div>
        
        <!-- KPI: Retrasados -->
        <div class="kpi-card danger">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-label">Retrasados</div>
            <div class="kpi-value">{{ kpis.retrasados }}</div>
            <div class="kpi-subtext">Requieren atenci√≥n urgente</div>
        </div>
        
        <!-- KPI: Pr√≥ximos a Llegar -->
        <div class="kpi-card warning">
            <div class="kpi-icon">üìÖ</div>
            <div class="kpi-label">Pr√≥ximos a Llegar</div>
            <div class="kpi-value">{{ kpis.proximos_llegar }}</div>
            <div class="kpi-subtext">En los siguientes 3 d√≠as</div>
        </div>
        
        <!-- KPI: En Tr√°nsito -->
        <div class="kpi-card success">
            <div class="kpi-icon">üöõ</div>
            <div class="kpi-label">En Tr√°nsito</div>
            <div class="kpi-value">{{ kpis.en_transito }}</div>
            <div class="kpi-subtext">Camino a su destino</div>
        </div>
        
        <!-- KPI: Pedidos -->
        <div class="kpi-card info">
            <div class="kpi-icon">üõí</div>
            <div class="kpi-label">Pedidos</div>
            <div class="kpi-value">{{ kpis.pedidos }}</div>
            <div class="kpi-subtext">Reci√©n solicitados</div>
        </div>
        
        <!-- KPI: Recibidos -->
        <div class="kpi-card success">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">Recibidos</div>
            <div class="kpi-value">{{ kpis.recibidos }}</div>
            <div class="kpi-subtext">Ya en inventario</div>
        </div>
        
        <!-- KPI: Promedio D√≠as Entrega -->
        <div class="kpi-card primary">
            <div class="kpi-icon">‚è±Ô∏è</div>
            <div class="kpi-label">Promedio D√≠as Entrega</div>
            <div class="kpi-value">{{ kpis.promedio_dias_entrega }}</div>
            <div class="kpi-subtext">D√≠as desde pedido hasta recepci√≥n</div>
        </div>
        
    </div>
    
    <!-- ========================================
         ALERTAS CR√çTICAS
         ======================================== -->
    {% if piezas_retrasadas %}
    <div class="row fade-in mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-dashboard alert-permanent">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    ‚ö†Ô∏è Atenci√≥n: {{ piezas_retrasadas|length }} Pieza(s) Retrasada(s)
                </h5>
                <p class="mb-3">
                    Las siguientes piezas han superado su fecha de entrega estimada y requieren seguimiento inmediato:
                </p>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Orden</th>
                                <th>Proveedor</th>
                                <th>Descripci√≥n</th>
                                <th>Fecha Estimada</th>
                                <th>D√≠as Retraso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pieza in piezas_retrasadas|slice:":10" %}
                            <tr>
                                <td>
                                    <span class="fw-bold" title="Sistema: {{ pieza.orden_numero }}">
                                        {{ pieza.orden_cliente }}<br>
                                        <small class="text-muted">{{ pieza.service_tag }}</small>
                                    </span>
                                </td>
                                <td>{{ pieza.proveedor }}</td>
                                <td>{{ pieza.descripcion_piezas|truncatewords:8 }}</td>
                                <td>{{ pieza.fecha_entrega_estimada|date:"d/m/Y" }}</td>
                                <td>
                                    <span class="badge bg-danger">
                                        {{ pieza.dias_retraso }} d√≠a{{ pieza.dias_retraso|pluralize:"s" }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'servicio_tecnico:detalle_orden' pieza.orden_id %}" 
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if piezas_retrasadas|length > 10 %}
                <p class="mb-0 mt-3 text-center">
                    <small class="text-muted">
                        Mostrando las primeras 10 de {{ piezas_retrasadas|length }} piezas retrasadas.
                        Usa los filtros para ver todas.
                    </small>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ========================================
         ALERTA: PIEZAS CON PROBLEMAS DE CALIDAD (WPB/DOA)
         ======================================== -->
    {% if piezas_problematicas %}
    <div class="row fade-in mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dashboard alert-permanent border-warning">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-circle-fill"></i> 
                    üî¥ Atenci√≥n: {{ piezas_problematicas|length }} Pieza(s) con Problemas de Calidad (WPB/DOA)
                </h5>
                <p class="mb-3">
                    Las siguientes piezas llegaron f√≠sicamente pero presentan incidencias de calidad y requieren reorden:
                </p>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Orden</th>
                                <th>Proveedor</th>
                                <th>Descripci√≥n</th>
                                <th>Estado</th>
                                <th>Fecha Llegada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pieza in piezas_problematicas|slice:":10" %}
                            <tr>
                                <td>
                                    <span class="fw-bold" title="Sistema: {{ pieza.orden_numero }}">
                                        {{ pieza.orden_cliente }}<br>
                                        <small class="text-muted">{{ pieza.service_tag }}</small>
                                    </span>
                                </td>
                                <td>{{ pieza.proveedor }}</td>
                                <td>{{ pieza.descripcion_piezas|truncatewords:8 }}</td>
                                <td>
                                    {% if pieza.estado == 'incorrecto' %}
                                    <span class="badge bg-danger" title="Wrong Part Boxed - Pieza Incorrecta">üî¥ WPB</span>
                                    {% elif pieza.estado == 'danado' %}
                                    <span class="badge bg-dark" title="Dead On Arrival - Pieza Da√±ada/No Funcional">‚ö´ DOA</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if pieza.fecha_entrega_real %}
                                    {{ pieza.fecha_entrega_real|date:"d/m/Y" }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'servicio_tecnico:detalle_orden' pieza.orden_id %}" 
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if piezas_problematicas|length > 10 %}
                <p class="mb-0 mt-3 text-center">
                    <small class="text-muted">
                        Mostrando las primeras 10 de {{ piezas_problematicas|length }} piezas con problemas.
                        Usa los filtros para ver todas.
                    </small>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    

    
    <!-- ========================================
         PIEZAS PR√ìXIMAS A LLEGAR
         ======================================== -->
    {% if piezas_proximas %}
    <div class="row fade-in mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dashboard alert-permanent">
                <h5 class="alert-heading">
                    <i class="bi bi-clock-history"></i> 
                    üì¶ Pr√≥ximas a Llegar: {{ piezas_proximas|length }} Pieza(s)
                </h5>
                <p class="mb-2">
                    Estas piezas deber√≠an llegar en los pr√≥ximos 3 d√≠as. Prepara el espacio de recepci√≥n:
                </p>
                <ul class="mb-0">
                    {% for pieza in piezas_proximas|slice:":5" %}
                    <li>
                        <strong>{{ pieza.orden_cliente }}</strong> ({{ pieza.service_tag }}) - {{ pieza.proveedor }}: 
                        {{ pieza.descripcion_piezas|truncatewords:6 }} 
                        <span class="badge bg-info">{{ pieza.fecha_entrega_estimada|date:"d/m/Y" }}</span>
                        <span class="badge bg-secondary">{{ pieza.dias_hasta_entrega }} d√≠a{{ pieza.dias_hasta_entrega|pluralize:"s" }}</span>
                    </li>
                    {% endfor %}
                    {% if piezas_proximas|length > 5 %}
                    <li class="text-muted">
                        <small>Y {{ piezas_proximas|length|add:"-5" }} m√°s...</small>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ========================================
         SISTEMA DE TABS DE NAVEGACI√ìN
         ======================================== -->
    <ul class="nav nav-tabs fade-in" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    id="agrupado-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#agrupado" 
                    type="button" 
                    role="tab">
                <i class="bi bi-collection"></i> Seguimiento de √ìrdenes
                <span class="badge bg-primary ms-2">{{ total_ordenes }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="graficos-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#graficos" 
                    type="button" 
                    role="tab">
                <i class="bi bi-graph-up"></i> Visualizaciones
            </button>
        </li>
    </ul>
    
    <!-- ========================================
         CONTENIDO DE LOS TABS
         ======================================== -->
    <div class="tab-content fade-in" id="dashboardTabContent">
        
        <!-- ========================================
             TAB 1: VISTA AGRUPADA POR ORDEN (NUEVO)
             ======================================== -->
        <div class="tab-pane fade show active" id="agrupado" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-collection"></i> √ìrdenes Agrupadas por Seguimiento
                            </h5>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Cada fila representa una orden con todos sus proveedores integrados
                            </small>
                        </div>
                        <div class="card-body">
                            <!-- Sub-pesta√±as para activas y completadas -->
                            <ul class="nav nav-pills mb-3" id="ordenesAgrupadasTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" 
                                            id="ordenes-activas-tab" 
                                            data-bs-toggle="pill" 
                                            data-bs-target="#ordenes-activas" 
                                            type="button" 
                                            role="tab">
                                        <i class="bi bi-truck"></i> √ìrdenes con Seguimiento Activo
                                        <span class="badge bg-primary ms-2">{{ ordenes_activas|length }}</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" 
                                            id="ordenes-completas-tab" 
                                            data-bs-toggle="pill" 
                                            data-bs-target="#ordenes-completas" 
                                            type="button" 
                                            role="tab">
                                        <i class="bi bi-check-circle"></i> √ìrdenes Completadas
                                        <span class="badge bg-success ms-2">{{ ordenes_recibidas|length }}</span>
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="ordenesAgrupadasTabContent">
                                <!-- Pesta√±a de √≥rdenes activas -->
                                <div class="tab-pane fade show active" id="ordenes-activas" role="tabpanel">
                                    {% if ordenes_activas %}
                                    <div class="table-responsive">
                                <table class="table table-hover" id="tabla-ordenes-agrupadas">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 15%;">Orden</th>
                                            <th style="width: 25%;">Proveedores y Estado</th>
                                            <th style="width: 10%;">Progreso</th>
                                            <th style="width: 15%;">Fechas Clave</th>
                                            <th style="width: 10%;">Prioridad</th>
                                            <th style="width: 10%;">Sucursal</th>
                                            <th style="width: 15%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for orden in ordenes_activas %}
                                        <tr class="orden-row {% if orden.tiene_retrasados %}table-danger{% elif orden.prioridad_maxima == 'alto' %}table-warning{% endif %}"
                                            data-orden-id="{{ orden.orden_id }}">
                                            
                                            <!-- COLUMNA 1: ORDEN -->
                                            <td>
                                                <span class="fw-bold" title="Sistema: {{ orden.orden_numero }}">
                                                    {{ orden.orden_cliente }}<br>
                                                    <small class="text-muted">{{ orden.service_tag }}</small>
                                                </span>
                                                <br>
                                                <small class="text-muted">
                                                    {{ orden.tipo_equipo }} {{ orden.marca_equipo }}
                                                </small>
                                            </td>
                                            
                                            <!-- COLUMNA 2: PROVEEDORES Y ESTADO -->
                                            <td>
                                                <div class="proveedores-container">
                                                    {% for prov in orden.proveedores_activos|slice:":3" %}
                                                    <div class="proveedor-item mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-semibold">{{ prov.proveedor|truncatechars:20 }}</span>
                                                            {% if prov.estado == 'pedido' %}
                                                            <span class="badge bg-info">Pedido</span>
                                                            {% elif prov.estado == 'transito' %}
                                                            <span class="badge bg-warning">En Tr√°nsito</span>
                                                            {% elif prov.estado == 'recibido' %}
                                                            <span class="badge bg-success">Recibido</span>
                                                            {% elif prov.estado == 'incorrecto' %}
                                                            <span class="badge bg-danger" title="Wrong Part Boxed - Pieza Incorrecta">üî¥ WPB</span>
                                                            {% elif prov.estado == 'danado' %}
                                                            <span class="badge bg-dark" title="Dead On Arrival - Pieza Da√±ada/No Funcional">‚ö´ DOA</span>
                                                            {% else %}
                                                            <span class="badge bg-secondary">{{ prov.estado_display }}</span>
                                                            {% endif %}
                                                        </div>
                                                        <small class="text-muted d-block">{{ prov.descripcion|truncatewords:6 }}</small>
                                                        {% if prov.esta_retrasado %}
                                                        <small class="text-danger">
                                                            <i class="bi bi-exclamation-triangle"></i> Retrasado {{ prov.dias_retraso }} d√≠as
                                                        </small>
                                                        {% endif %}
                                                    </div>
                                                    {% endfor %}
                                                    {% if orden.total_proveedores > 3 %}
                                                    <button class="btn btn-sm btn-link p-0 toggle-proveedores" 
                                                            data-orden-id="{{ orden.orden_id }}"
                                                            title="Ver todos los proveedores">
                                                        <i class="bi bi-chevron-down"></i> Ver {{ orden.total_proveedores|add:"-3" }} m√°s
                                                    </button>
                                                    <div class="proveedores-extra d-none" id="proveedores-{{ orden.orden_id }}">
                                                        {% for prov in orden.proveedores_activos|slice:"3:" %}
                                                        <div class="proveedor-item mb-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="fw-semibold">{{ prov.proveedor|truncatechars:20 }}</span>
                                                                {% if prov.estado == 'pedido' %}
                                                                <span class="badge bg-info">Pedido</span>
                                                                {% elif prov.estado == 'transito' %}
                                                                <span class="badge bg-warning">En Tr√°nsito</span>
                                                                {% elif prov.estado == 'recibido' %}
                                                                <span class="badge bg-success">Recibido</span>
                                                                {% elif prov.estado == 'incorrecto' %}
                                                                <span class="badge bg-danger" title="Wrong Part Boxed - Pieza Incorrecta">üî¥ WPB</span>
                                                                {% elif prov.estado == 'danado' %}
                                                                <span class="badge bg-dark" title="Dead On Arrival - Pieza Da√±ada/No Funcional">‚ö´ DOA</span>
                                                                {% else %}
                                                                <span class="badge bg-secondary">{{ prov.estado_display }}</span>
                                                                {% endif %}
                                                            </div>
                                                            <small class="text-muted d-block">{{ prov.descripcion|truncatewords:6 }}</small>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            
                                            <!-- COLUMNA 3: PROGRESO -->
                                            <td>
                                                <div class="text-center">
                                                    <div class="progress mb-2" style="height: 25px;">
                                                        {% widthratio orden.seguimientos_recibidos orden.total_seguimientos 100 as porcentaje %}
                                                        <div class="progress-bar {% if porcentaje == 100 %}bg-success{% elif porcentaje > 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                                             role="progressbar" 
                                                             style="width: {{ porcentaje }}%"
                                                             aria-valuenow="{{ porcentaje }}" 
                                                             aria-valuemin="0" 
                                                             aria-valuemax="100">
                                                            {{ porcentaje }}%
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">
                                                        {{ orden.seguimientos_recibidos }} de {{ orden.total_seguimientos }} recibidos
                                                    </small>
                                                </div>
                                            </td>
                                            
                                            <!-- COLUMNA 4: FECHAS CLAVE -->
                                            <td>
                                                <div>
                                                    <small class="text-muted d-block">Pedido m√°s antiguo:</small>
                                                    <strong>{{ orden.fecha_pedido_mas_antigua|date:"d/m/Y" }}</strong>
                                                </div>
                                                {% if orden.fecha_entrega_mas_proxima %}
                                                <div class="mt-2">
                                                    <small class="text-muted d-block">Pr√≥xima entrega:</small>
                                                    <strong class="{% if orden.tiene_retrasados %}text-danger{% endif %}">
                                                        {{ orden.fecha_entrega_mas_proxima|date:"d/m/Y" }}
                                                    </strong>
                                                </div>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- COLUMNA 5: PRIORIDAD -->
                                            <td class="text-center">
                                                {% if orden.prioridad_maxima == 'critico' %}
                                                <span class="badge bg-danger badge-lg">
                                                    <i class="bi bi-exclamation-circle"></i> CR√çTICO
                                                </span>
                                                {% elif orden.prioridad_maxima == 'alto' %}
                                                <span class="badge bg-warning badge-lg">
                                                    <i class="bi bi-exclamation-triangle"></i> ALTO
                                                </span>
                                                {% elif orden.prioridad_maxima == 'medio' %}
                                                <span class="badge bg-info badge-lg">
                                                    <i class="bi bi-clock"></i> MEDIO
                                                </span>
                                                {% else %}
                                                <span class="badge bg-secondary badge-lg">NORMAL</span>
                                                {% endif %}
                                                {% if orden.tiene_retrasados %}
                                                <br>
                                                <small class="text-danger mt-1 d-block">
                                                    Retraso m√°x: {{ orden.dias_maximo_retraso }} d√≠as
                                                </small>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- COLUMNA 6: SUCURSAL -->
                                            <td>{{ orden.sucursal }}</td>
                                            
                                            <!-- COLUMNA 7: ACCIONES -->
                                            <td>
                                                <div class="btn-group-vertical btn-group-sm">
                                                    <a href="{% url 'servicio_tecnico:detalle_orden' orden.orden_id %}" 
                                                       class="btn btn-outline-primary" 
                                                       title="Ver detalle completo"
                                                       target="_blank">
                                                        <i class="bi bi-eye"></i> Ver Orden
                                                    </a>
                                                    <button class="btn btn-outline-info toggle-detalles" 
                                                            data-orden-id="{{ orden.orden_id }}"
                                                            title="Expandir detalles de seguimiento">
                                                        <i class="bi bi-chevron-down"></i> Detalles
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        
                                        <!-- FILA EXPANDIBLE CON DETALLES COMPLETOS -->
                                        <tr class="detalles-row d-none" id="detalles-{{ orden.orden_id }}">
                                            <td colspan="7">
                                                <div class="card border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <h6 class="card-title mb-3">
                                                            <i class="bi bi-info-circle"></i> 
                                                            Detalles Completos de Seguimiento
                                                        </h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-bordered">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>Proveedor</th>
                                                                        <th>Descripci√≥n</th>
                                                                        <th>Estado</th>
                                                                        <th>Fecha Pedido</th>
                                                                        <th>Fecha Estimada</th>
                                                                        <th>Fecha Entrega Real</th>
                                                                        <th>D√≠as Transcurridos</th>
                                                                        <th>Tracking</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for prov in orden.proveedores_activos %}
                                                                    <tr class="{% if prov.esta_retrasado %}table-danger{% endif %}">
                                                                        <td>{{ prov.proveedor }}</td>
                                                                        <td>{{ prov.descripcion }}</td>
                                                                        <td>
                                                                            {% if prov.estado == 'pedido' %}
                                                                            <span class="badge bg-info">Pedido</span>
                                                                            {% elif prov.estado == 'transito' %}
                                                                            <span class="badge bg-warning">En Tr√°nsito</span>
                                                                            {% elif prov.estado == 'recibido' %}
                                                                            <span class="badge bg-success">Recibido</span>
                                                                            {% elif prov.estado == 'incorrecto' %}
                                                                            <span class="badge bg-danger" title="Wrong Part Boxed - Pieza Incorrecta">üî¥ WPB</span>
                                                                            {% elif prov.estado == 'danado' %}
                                                                            <span class="badge bg-dark" title="Dead On Arrival - Pieza Da√±ada/No Funcional">‚ö´ DOA</span>
                                                                            {% else %}
                                                                            <span class="badge bg-secondary">{{ prov.estado_display }}</span>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>{{ prov.fecha_pedido|date:"d/m/Y" }}</td>
                                                                        <td>{{ prov.fecha_estimada|date:"d/m/Y" }}</td>
                                                                        <td>
                                                                            {% if prov.fecha_real %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bi bi-check-circle-fill"></i> {{ prov.fecha_real|date:"d/m/Y" }}
                                                                            </span>
                                                                            {% else %}
                                                                            <span class="text-muted">
                                                                                <i class="bi bi-hourglass-split"></i> Pendiente
                                                                            </span>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>
                                                                            {% if prov.fecha_real %}
                                                                            <span class="badge bg-success">{{ prov.dias_desde_pedido }} d√≠as</span>
                                                                            {% else %}
                                                                            <span class="badge bg-secondary">{{ prov.dias_desde_pedido }} d√≠as</span>
                                                                            {% endif %}
                                                                            {% if prov.esta_retrasado %}
                                                                            <br><span class="badge bg-danger mt-1">Retraso: {{ prov.dias_retraso }} d√≠as</span>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>
                                                                            {% if prov.numero_pedido %}
                                                                            <code>{{ prov.numero_pedido }}</code>
                                                                            {% else %}
                                                                            <span class="text-muted">-</span>
                                                                            {% endif %}
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info alert-dashboard">
                                <i class="bi bi-info-circle"></i> 
                                No hay √≥rdenes con seguimiento activo con los filtros aplicados.
                            </div>
                            {% endif %}
                                </div>
                                
                                <!-- Pesta√±a de √≥rdenes completadas -->
                                <div class="tab-pane fade" id="ordenes-completas" role="tabpanel">
                                    {% if ordenes_recibidas %}
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="tabla-ordenes-completadas">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Orden</th>
                                                    <th>Proveedores</th>
                                                    <th>Total Seguimientos</th>
                                                    <th>Fecha Pedido</th>
                                                    <th>Tiempo Total</th>
                                                    <th>Sucursal</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for orden in ordenes_recibidas %}
                                                <tr>
                                                    <td>
                                                        <span class="fw-bold" title="Sistema: {{ orden.orden_numero }}">
                                                            {{ orden.orden_cliente }}<br>
                                                            <small class="text-muted">{{ orden.service_tag }}</small>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% for prov in orden.proveedores_activos %}
                                                        <span class="badge bg-success me-1 mb-1">
                                                            {{ prov.proveedor|truncatechars:15 }}
                                                        </span>
                                                        {% endfor %}
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-success badge-lg">
                                                            {{ orden.total_seguimientos }}
                                                        </span>
                                                    </td>
                                                    <td>{{ orden.fecha_pedido_mas_antigua|date:"d/m/Y" }}</td>
                                                    <td>
                                                        {% for prov in orden.proveedores_activos %}
                                                        {% if forloop.first %}
                                                        <span class="badge bg-info">{{ prov.dias_totales_espera }} d√≠as</span>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td>{{ orden.sucursal }}</td>
                                                    <td>
                                                        <a href="{% url 'servicio_tecnico:detalle_orden' orden.orden_id %}" 
                                                           class="btn btn-sm btn-outline-primary" 
                                                           title="Ver detalle completo"
                                                           target="_blank">
                                                            <i class="bi bi-eye"></i> Ver
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info alert-dashboard">
                                        <i class="bi bi-info-circle"></i> 
                                        No hay √≥rdenes completadas con los filtros aplicados.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             TAB 2: GR√ÅFICOS Y VISUALIZACIONES
             ======================================== -->
        <div class="tab-pane fade" id="graficos" role="tabpanel">
            <div class="row">
                
                <!-- Distribuci√≥n por Estado -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-pie-chart"></i> Distribuci√≥n por Estado</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.distribucion_estados %}
                                {{ graficos.distribucion_estados|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos para mostrar la distribuci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Top Proveedores -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-trophy"></i> Top Proveedores</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_proveedores %}
                                {{ graficos.top_proveedores|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de proveedores disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Tiempos de Entrega -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-speedometer"></i> Tiempos de Entrega por Proveedor</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tiempos_entrega_proveedor %}
                                {{ graficos.tiempos_entrega_proveedor|safe }}
                                <div class="alert alert-success alert-dashboard mt-3">
                                    <strong><i class="bi bi-lightbulb"></i> Interpretaci√≥n:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Caja:</strong> Rango t√≠pico de d√≠as de entrega (50% central)</li>
                                        <li><strong>L√≠nea:</strong> Mediana (tiempo m√°s com√∫n)</li>
                                        <li><strong>Puntos:</strong> Valores at√≠picos (muy r√°pidos o muy lentos)</li>
                                        <li><strong>Usa esto para:</strong> Seleccionar proveedores m√°s confiables</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay suficientes datos de entregas completadas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Timeline de Entregas -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-calendar3"></i> Timeline de Entregas Esperadas</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.timeline_entregas %}
                                {{ graficos.timeline_entregas|safe }}
                                <div class="alert alert-warning alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> C√≥mo Leer:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>L√≠nea Azul Vertical:</strong> Hoy</li>
                                        <li><strong>Verde:</strong> Llegada normal, dentro del plazo</li>
                                        <li><strong>Amarillo:</strong> Pr√≥ximo a llegar (< 3 d√≠as)</li>
                                        <li><strong>Naranja:</strong> Retrasado (< 5 d√≠as)</li>
                                        <li><strong>Rojo:</strong> Cr√≠ticamente retrasado (> 5 d√≠as)</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay entregas pendientes para mostrar en timeline.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
    
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border spinner-border-lg text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos del dashboard...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- TypeScript compilado del dashboard -->
<script src="{% static 'js/dashboard_seguimiento_piezas.js' %}" defer></script>
{% endblock %}
