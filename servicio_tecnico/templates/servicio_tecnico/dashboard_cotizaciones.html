{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Cotizaciones - Analytics{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       ESTILOS DEL DASHBOARD DE COTIZACIONES
       Dise√±o moderno tipo Power BI
       ============================================ */
    
    :root {
        --dashboard-bg: #f8f9fa;
        --card-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }
    
    body {
        background-color: var(--dashboard-bg);
    }
    
    /* Header del Dashboard */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }
    
    .dashboard-header h1 {
        font-weight: 700;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .dashboard-header p {
        opacity: 0.95;
        font-size: 1.1rem;
    }
    
    /* Formulario de Filtros */
    .filtros-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        border: none;
        margin-bottom: 2rem;
        transition: var(--transition);
    }
    
    .filtros-card:hover {
        box-shadow: var(--card-hover-shadow);
    }
    
    .filtros-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        padding: 1rem 1.5rem;
        border: none;
    }
    
    .filtros-card .card-body {
        padding: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.625rem 1rem;
        transition: var(--transition);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    
    /* Botones de Acci√≥n */
    .btn-filtrar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.625rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .btn-filtrar:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-limpiar {
        background: #6c757d;
        border: none;
        padding: 0.625rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        color: white;
        transition: var(--transition);
    }
    
    .btn-limpiar:hover {
        background: #5a6268;
        transform: translateY(-2px);
        color: white;
    }
    
    .btn-exportar {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        border: none;
        padding: 0.625rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .btn-exportar:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }
    
    /* Grid de KPIs */
    .kpis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .kpi-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        border-left: 4px solid;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
        border-radius: 50%;
        transform: translate(30%, -30%);
    }
    
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-hover-shadow);
    }
    
    .kpi-card.primary { border-left-color: #667eea; }
    .kpi-card.success { border-left-color: #27ae60; }
    .kpi-card.danger { border-left-color: #e74c3c; }
    .kpi-card.warning { border-left-color: #f39c12; }
    .kpi-card.info { border-left-color: #3498db; }
    
    .kpi-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        opacity: 0.7;
    }
    
    .kpi-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: #212529;
        margin-bottom: 0;
        position: relative;
        z-index: 1;
    }
    
    .kpi-subtext {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    /* Sistema de Tabs */
    .nav-tabs {
        border: none;
        margin-bottom: 2rem;
        background: white;
        padding: 0.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }
    
    .nav-tabs .nav-item {
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: var(--transition);
        margin-right: 0.5rem;
    }
    
    .nav-tabs .nav-link:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    }
    
    /* Cards de Gr√°ficos */
    .grafico-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        border: none;
        transition: var(--transition);
        overflow: hidden;
    }
    
    .grafico-card:hover {
        box-shadow: var(--card-hover-shadow);
    }
    
    .grafico-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #e9ecef;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .grafico-card .card-header h5 {
        margin: 0;
        font-weight: 700;
        color: #212529;
        font-size: 1.1rem;
    }
    
    .grafico-card .card-body {
        padding: 1.5rem;
    }
    
    /* Plotly Graphs */
    .plotly-graph-div {
        border-radius: 8px;
    }
    
    /* Alertas y Mensajes */
    .alert-dashboard {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: var(--card-shadow);
        padding: 1rem 1.5rem;
    }
    
    .alert-dashboard .alert-heading {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    /* Loading State */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
    }
    
    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .spinner-border-lg {
        width: 4rem;
        height: 4rem;
        border-width: 0.4rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 1.75rem;
        }
        
        .kpis-grid {
            grid-template-columns: 1fr;
        }
        
        .nav-tabs {
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        
        .nav-tabs .nav-link {
            white-space: nowrap;
        }
    }
    
    /* Animaciones */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease;
    }
    
    /* Badge personalizado */
    .badge-custom {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    /* Secci√≥n ML especial */
    .ml-insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }
    
    .ml-insight-card h5 {
        color: white;
        margin-bottom: 1rem;
        font-weight: 700;
    }
    
    .ml-accuracy {
        font-size: 4rem;
        font-weight: 700;
        text-align: center;
        margin: 1rem 0;
    }
    
    .ml-sugerencia {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 3px solid white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- ========================================
         HEADER DEL DASHBOARD
         ======================================== -->
    <div class="dashboard-header fade-in">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>üìä Dashboard de Cotizaciones</h1>
                    <p class="mb-0">An√°lisis completo con Machine Learning y visualizaciones interactivas</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <a href="{% url 'servicio_tecnico:exportar_dashboard_cotizaciones' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-exportar">
                        <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         FORMULARIO DE FILTROS
         ======================================== -->
    <div class="filtros-card card fade-in">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros de An√°lisis</h5>
        </div>
        <div class="card-body">
            <form id="filtros-form" method="get" class="row g-3">
                
                <!-- Rango de Fechas -->
                <div class="col-md-3">
                    <label for="fecha_inicio" class="form-label">
                        <i class="bi bi-calendar-event"></i> Fecha Inicio
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_inicio"
                           name="fecha_inicio" 
                           value="{{ filtros_activos.fecha_inicio|default:'' }}">
                </div>
                
                <div class="col-md-3">
                    <label for="fecha_fin" class="form-label">
                        <i class="bi bi-calendar-check"></i> Fecha Fin
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_fin"
                           name="fecha_fin" 
                           value="{{ filtros_activos.fecha_fin|default:'' }}">
                </div>
                
                <!-- Sucursal -->
                <div class="col-md-2">
                    <label for="sucursal" class="form-label">
                        <i class="bi bi-building"></i> Sucursal
                    </label>
                    <select class="form-select" id="sucursal" name="sucursal">
                        <option value="">Todas las sucursales</option>
                        {% for sucursal in sucursales %}
                        <option value="{{ sucursal.id }}" 
                                {% if filtros_activos.sucursal == sucursal.id|stringformat:"s" %}selected{% endif %}>
                            {{ sucursal.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- T√©cnico -->
                <div class="col-md-2">
                    <label for="tecnico" class="form-label">
                        <i class="bi bi-person-badge"></i> T√©cnico
                    </label>
                    <select class="form-select" id="tecnico" name="tecnico">
                        <option value="">Todos los t√©cnicos</option>
                        {% for tecnico in tecnicos %}
                        <option value="{{ tecnico.id }}"
                                {% if filtros_activos.tecnico == tecnico.id|stringformat:"s" %}selected{% endif %}>
                            {{ tecnico.nombre_completo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Gama -->
                <div class="col-md-2">
                    <label for="gama" class="form-label">
                        <i class="bi bi-star"></i> Gama
                    </label>
                    <select class="form-select" id="gama" name="gama">
                        <option value="">Todas las gamas</option>
                        <option value="alta" {% if filtros_activos.gama == 'alta' %}selected{% endif %}>Alta Gama</option>
                        <option value="media" {% if filtros_activos.gama == 'media' %}selected{% endif %}>Media Gama</option>
                        <option value="baja" {% if filtros_activos.gama == 'baja' %}selected{% endif %}>Baja Gama</option>
                    </select>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div class="col-12">
                    <button type="submit" class="btn btn-filtrar">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'servicio_tecnico:dashboard_cotizaciones' %}" 
                       class="btn btn-limpiar">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar Filtros
                    </a>
                    <span class="text-muted ms-3">
                        <i class="bi bi-info-circle"></i> 
                        Mostrando {{ total_cotizaciones }} cotizaci√≥n{{ total_cotizaciones|pluralize:"es" }}
                    </span>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ========================================
         GRID DE KPIs PRINCIPALES
         ======================================== -->
    <div class="kpis-grid fade-in">
        
        <!-- KPI: Total Cotizaciones -->
        <div class="kpi-card primary">
            <div class="kpi-icon">üìã</div>
            <div class="kpi-label">Total Cotizaciones</div>
            <div class="kpi-value">{{ kpis.total_cotizaciones|default:0 }}</div>
            <div class="kpi-subtext">En el per√≠odo seleccionado</div>
        </div>
        
        <!-- KPI: Tasa de Aceptaci√≥n -->
        <div class="kpi-card success">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">Tasa de Aceptaci√≥n</div>
            <div class="kpi-value">{{ kpis.tasa_aceptacion|default:0|floatformat:1 }}%</div>
            <div class="kpi-subtext">{{ kpis.aceptadas|default:0 }} cotizaciones aceptadas</div>
        </div>
        
        <!-- KPI: Tasa de Rechazo -->
        <div class="kpi-card danger">
            <div class="kpi-icon">‚ùå</div>
            <div class="kpi-label">Tasa de Rechazo</div>
            <div class="kpi-value">{{ kpis.tasa_rechazo|default:0|floatformat:1 }}%</div>
            <div class="kpi-subtext">{{ kpis.rechazadas|default:0 }} cotizaciones rechazadas</div>
        </div>
        
        <!-- KPI: Pendientes -->
        <div class="kpi-card warning">
            <div class="kpi-icon">‚è≥</div>
            <div class="kpi-label">Pendientes</div>
            <div class="kpi-value">{{ kpis.pendientes|default:0 }}</div>
            <div class="kpi-subtext">En espera de respuesta</div>
        </div>
        
        <!-- KPI: Valor Total -->
        <div class="kpi-card info">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-label">Valor Total</div>
            <div class="kpi-value">${{ kpis.valor_total_cotizado|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Suma de todas las cotizaciones</div>
        </div>
        
        <!-- KPI: Ingresos Reales -->
        <div class="kpi-card success">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">Ingresos Reales</div>
            <div class="kpi-value">${{ kpis.valor_aceptado|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Solo cotizaciones aceptadas</div>
        </div>
        
        <!-- KPI: Valor Perdido -->
        <div class="kpi-card danger">
            <div class="kpi-icon">üìâ</div>
            <div class="kpi-label">Valor Perdido</div>
            <div class="kpi-value">${{ kpis.valor_rechazado|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Cotizaciones rechazadas</div>
        </div>
        
        <!-- KPI: Ticket Promedio -->
        <div class="kpi-card primary">
            <div class="kpi-icon">üíµ</div>
            <div class="kpi-label">Ticket Promedio</div>
            <div class="kpi-value">${{ kpis.ticket_promedio|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Por cotizaci√≥n</div>
        </div>
        
        <!-- KPI: Tiempo Promedio -->
        <div class="kpi-card info">
            <div class="kpi-icon">‚è±Ô∏è</div>
            <div class="kpi-label">Tiempo Prom. Respuesta</div>
            <div class="kpi-value">{{ kpis.tiempo_respuesta_promedio|default:0|floatformat:1 }}</div>
            <div class="kpi-subtext">D√≠as hasta respuesta</div>
        </div>
        
        <!-- KPI: Total Piezas -->
        <div class="kpi-card warning">
            <div class="kpi-icon">üîß</div>
            <div class="kpi-label">Total Piezas</div>
            <div class="kpi-value">{{ kpis.total_piezas|default:0 }}</div>
            <div class="kpi-subtext">Piezas cotizadas</div>
        </div>
        
    </div>
    
    <!-- ========================================
         SISTEMA DE TABS DE NAVEGACI√ìN
         ======================================== -->
    <ul class="nav nav-tabs fade-in" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    id="overview-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#overview" 
                    type="button" 
                    role="tab">
                <i class="bi bi-graph-up"></i> Visi√≥n General
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="piezas-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#piezas" 
                    type="button" 
                    role="tab">
                <i class="bi bi-gear"></i> An√°lisis de Piezas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="respuestas-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#respuestas" 
                    type="button" 
                    role="tab">
                <i class="bi bi-chat-left-text"></i> An√°lisis de Respuesta
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="proveedores-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#proveedores" 
                    type="button" 
                    role="tab">
                <i class="bi bi-truck"></i> Proveedores
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="tecnicos-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#tecnicos" 
                    type="button" 
                    role="tab">
                <i class="bi bi-people"></i> T√©cnicos & Sucursales
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="responsables-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#responsables" 
                    type="button" 
                    role="tab">
                <i class="bi bi-person-check-fill"></i> Responsables
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="ml-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#ml" 
                    type="button" 
                    role="tab">
                <i class="bi bi-robot"></i> Machine Learning
            </button>
        </li>
    </ul>
    
    <!-- ========================================
         CONTENIDO DE LOS TABS
         ======================================== -->
    <div class="tab-content fade-in" id="dashboardTabContent">
        
        <!-- ========================================
             TAB 1: VISI√ìN GENERAL
             ======================================== -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                
                <!-- Evoluci√≥n Temporal -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up-arrow"></i> Evoluci√≥n Temporal de Cotizaciones</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.evolucion_temporal %}
                                {{ graficos.evolucion_temporal|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para mostrar la evoluci√≥n temporal.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Tasas de Aceptaci√≥n y Distribuci√≥n de Costos -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bar-chart"></i> Tasas de Aceptaci√≥n por Sucursal</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tasas_aceptacion_sucursal %}
                                {{ graficos.tasas_aceptacion_sucursal|safe }}
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No hay datos para mostrar tasas de aceptaci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-currency-dollar"></i> Distribuci√≥n de Costos</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.distribucion_costos %}
                                {{ graficos.distribucion_costos|safe }}
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No hay datos para mostrar distribuci√≥n de costos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Embudo de Conversi√≥n y Comparativo -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-funnel"></i> Embudo de Conversi√≥n</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.funnel_conversion %}
                                {{ graficos.funnel_conversion|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos para mostrar el embudo de conversi√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-person-check"></i> Tasas de Aceptaci√≥n por T√©cnico</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tasas_aceptacion_tecnico %}
                                {{ graficos.tasas_aceptacion_tecnico|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de t√©cnicos disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Gamas de Equipos -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-diagram-3"></i> Distribuci√≥n por Gamas de Equipos</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.gamas_equipos %}
                                {{ graficos.gamas_equipos|safe }}
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No hay datos de equipos disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 2: AN√ÅLISIS DE PIEZAS
             ======================================== -->
        <div class="tab-pane fade" id="piezas" role="tabpanel">
            <div class="row">
                
                <!-- Top Piezas Rechazadas -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-x-circle"></i> Top Piezas Rechazadas</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_piezas_rechazadas %}
                                {{ graficos.top_piezas_rechazadas|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay piezas rechazadas en el per√≠odo.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Top Piezas Aceptadas -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-check-circle"></i> Top Piezas Aceptadas</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_piezas_aceptadas %}
                                {{ graficos.top_piezas_aceptadas|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay piezas aceptadas en el per√≠odo.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Necesarias vs Opcionales -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-toggle-on"></i> Piezas Necesarias vs Opcionales</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.piezas_necesarias_vs_opcionales %}
                                {{ graficos.piezas_necesarias_vs_opcionales|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de clasificaci√≥n de piezas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sugerencias del T√©cnico -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-lightbulb"></i> Flujo de Sugerencias del T√©cnico</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.sugerencias_tecnico %}
                                {{ graficos.sugerencias_tecnico|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de sugerencias de t√©cnicos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 3: AN√ÅLISIS DE RESPUESTA
             ======================================== -->
        <div class="tab-pane fade" id="respuestas" role="tabpanel">
            <div class="row">
                
                <!-- Tiempos de Respuesta -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-clock-history"></i> Tiempos de Respuesta del Cliente</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tiempos_respuesta %}
                                {{ graficos.tiempos_respuesta|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes de tiempos de respuesta.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Motivos de Rechazo -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-x-octagon"></i> Motivos de Rechazo</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.motivos_rechazo %}
                                {{ graficos.motivos_rechazo|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de cotizaciones rechazadas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Motivos de Rechazo vs Costos -->
                <div class="col-lg-6 offset-lg-3">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-cash-coin"></i> An√°lisis de Costos por Motivo de Rechazo</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.motivos_rechazo_vs_costos %}
                                {{ graficos.motivos_rechazo_vs_costos|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> C√≥mo interpretar este gr√°fico:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Caja:</strong> Rango donde est√° el 50% de los costos para ese motivo</li>
                                        <li><strong>L√≠nea central:</strong> Costo mediano (t√≠pico) de ese motivo</li>
                                        <li><strong>Puntos aislados:</strong> Casos extremos (muy baratos o muy caros)</li>
                                        <li><strong>L√≠nea gris punteada:</strong> Costo mediano global de todas las cotizaciones rechazadas</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para el an√°lisis de costos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>>
        
        <!-- ========================================
             TAB 4: AN√ÅLISIS DE PROVEEDORES
             ======================================== -->
        <div class="tab-pane fade" id="proveedores" role="tabpanel">
            <div class="row">
                
                <!-- Top Proveedores -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-trophy"></i> Top Proveedores</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_proveedores %}
                                {{ graficos.top_proveedores|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de proveedores disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Performance de Proveedores -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-speedometer"></i> Performance de Proveedores</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.proveedores_performance %}
                                {{ graficos.proveedores_performance|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay suficientes datos de seguimiento de proveedores.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 5: T√âCNICOS & SUCURSALES
             ======================================== -->
        <div class="tab-pane fade" id="tecnicos" role="tabpanel">
            <div class="row">
                
                <!-- Ranking de T√©cnicos -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-award"></i> Ranking de T√©cnicos</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.ranking_tecnicos %}
                                {{ graficos.ranking_tecnicos|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para generar ranking.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Distribuci√≥n por Sucursales -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-buildings"></i> Distribuci√≥n por Sucursales</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.distribucion_sucursales %}
                                {{ graficos.distribucion_sucursales|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de distribuci√≥n por sucursales.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Rendimiento por T√©cnico -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-person-check"></i> Rendimiento por T√©cnico</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.rendimiento_tecnicos %}
                                {{ graficos.rendimiento_tecnicos|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de rendimiento de t√©cnicos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Heatmap de Sucursales -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-grid"></i> Rendimiento de Sucursales</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.rendimiento_sucursales %}
                                {{ graficos.rendimiento_sucursales|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de m√∫ltiples sucursales.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ========================================
             TAB 6: RESPONSABLES DE SEGUIMIENTO
             ======================================== -->
        <div class="tab-pane fade" id="responsables" role="tabpanel">
            <div class="row">
                
                <!-- Ranking de Responsables -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-trophy-fill"></i> Ranking de Responsables por Volumen</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.ranking_responsables %}
                                {{ graficos.ranking_responsables|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                    Este gr√°fico muestra los responsables m√°s activos en enviar cotizaciones.
                                    El color de las barras indica su tasa de aceptaci√≥n:
                                    <span class="badge bg-success">Verde = Alta aceptaci√≥n</span>
                                    <span class="badge bg-warning">Amarillo = Media aceptaci√≥n</span>
                                    <span class="badge bg-danger">Rojo = Baja aceptaci√≥n</span>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes de responsables.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- An√°lisis de Piezas Promedio -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-scatter-chart"></i> Relaci√≥n: Piezas Promedio vs Efectividad</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.piezas_promedio_responsables %}
                                {{ graficos.piezas_promedio_responsables|safe }}
                                <div class="alert alert-warning alert-dashboard mt-3">
                                    <strong><i class="bi bi-graph-up-arrow"></i> Insights:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Tama√±o de burbuja:</strong> Total de cotizaciones enviadas</li>
                                        <li><strong>Color:</strong> Valor total generado en ingresos</li>
                                        <li><strong>Posici√≥n horizontal:</strong> Cantidad promedio de piezas ofrecidas</li>
                                        <li><strong>Posici√≥n vertical:</strong> Tasa de aceptaci√≥n lograda</li>
                                        <li><strong>An√°lisis:</strong> ¬øM√°s piezas = mejor o peor aceptaci√≥n? Este gr√°fico responde esa pregunta</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para an√°lisis de piezas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Distribuci√≥n de Resultados -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bar-chart-fill"></i> Distribuci√≥n de Resultados</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tasas_aceptacion_responsables %}
                                {{ graficos.tasas_aceptacion_responsables|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de distribuci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Valor Generado -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-cash-coin"></i> Valor Generado por Responsable</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.valor_generado_responsables %}
                                {{ graficos.valor_generado_responsables|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-lightbulb-fill"></i> An√°lisis:</strong>
                                    Compara el valor <strong>cotizado</strong> (potencial total) 
                                    vs los <strong>ingresos reales</strong> (cotizaciones aceptadas). 
                                    La diferencia muestra oportunidades de mejora.
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de valor generado.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 7: MACHINE LEARNING
             ======================================== -->
        <div class="tab-pane fade" id="ml" role="tabpanel">
            <div class="row">
                
                {% if ml_insights.modelo_disponible %}
                
                <!-- Card de Precisi√≥n del Modelo -->
                <div class="col-md-4">
                    <div class="ml-insight-card">
                        <h5><i class="bi bi-cpu"></i> Precisi√≥n del Modelo</h5>
                        <div class="ml-accuracy">{{ ml_insights.accuracy|floatformat:1 }}%</div>
                        <p class="mb-0">
                            El modelo ha sido entrenado con {{ ml_insights.datos_entrenamiento }} cotizaciones 
                            y puede predecir con esta precisi√≥n si una cotizaci√≥n ser√° aceptada o rechazada.
                        </p>
                    </div>
                </div>
                
                <!-- Card de M√©tricas Adicionales -->
                <div class="col-md-4">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up"></i> M√©tricas del Modelo</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Precision:</strong> {{ ml_insights.precision|floatformat:2 }}
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ ml_insights.precision|floatformat:0 }}%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Recall:</strong> {{ ml_insights.recall|floatformat:2 }}
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-info" 
                                         style="width: {{ ml_insights.recall|floatformat:0 }}%"></div>
                                </div>
                            </div>
                            <div>
                                <strong>F1-Score:</strong> {{ ml_insights.f1_score|floatformat:2 }}
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-warning" 
                                         style="width: {{ ml_insights.f1_score|floatformat:0 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Predicci√≥n de Ejemplo -->
                <div class="col-md-4">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bullseye"></i> Ejemplo de Predicci√≥n</h5>
                        </div>
                        <div class="card-body">
                            {% if ml_insights.prediccion_ejemplo %}
                            <p class="text-muted mb-3">
                                <strong>Cotizaci√≥n ID:</strong> {{ ml_insights.prediccion_ejemplo.cotizacion_id }}<br>
                                <strong>Costo:</strong> ${{ ml_insights.prediccion_ejemplo.costo|floatformat:2 }}
                            </p>
                            <div class="mb-3">
                                <strong>Probabilidad de Aceptaci√≥n:</strong>
                                <div class="progress mt-2" style="height: 25px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ ml_insights.prediccion_ejemplo.prob_aceptacion|floatformat:0 }}%">
                                        {{ ml_insights.prediccion_ejemplo.prob_aceptacion|floatformat:1 }}%
                                    </div>
                                </div>
                            </div>
                            <div>
                                <strong>Probabilidad de Rechazo:</strong>
                                <div class="progress mt-2" style="height: 25px;">
                                    <div class="progress-bar bg-danger" 
                                         style="width: {{ ml_insights.prediccion_ejemplo.prob_rechazo|floatformat:0 }}%">
                                        {{ ml_insights.prediccion_ejemplo.prob_rechazo|floatformat:1 }}%
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No hay cotizaciones pendientes para predecir.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Factores M√°s Influyentes -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bar-chart-line"></i> Factores M√°s Influyentes en la Decisi√≥n</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.factores_influyentes %}
                                {{ graficos.factores_influyentes|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                    Los factores con mayor importancia son los que m√°s influyen en la probabilidad 
                                    de que una cotizaci√≥n sea aceptada o rechazada. Utiliza esta informaci√≥n para 
                                    optimizar tus cotizaciones futuras.
                                </div>
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No se pudo generar el gr√°fico de importancia de caracter√≠sticas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sugerencias del Modelo -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-lightbulb"></i> Sugerencias Basadas en Machine Learning</h5>
                        </div>
                        <div class="card-body">
                            {% if ml_insights.sugerencias %}
                            <div class="row">
                                {% for sugerencia in ml_insights.sugerencias %}
                                <div class="col-md-6 mb-3">
                                    <div class="alert alert-{{ sugerencia.color|default:'success' }} alert-dashboard">
                                        <h6 class="alert-heading">
                                            <span style="font-size: 1.2rem;">{{ sugerencia.icono|default:'üí°' }}</span>
                                            <strong>{{ sugerencia.titulo|default:'Sugerencia' }}</strong>
                                        </h6>
                                        <p class="mb-0">{{ sugerencia.mensaje }}</p>
                                        {% if sugerencia.tipo %}
                                        <small class="text-muted d-block mt-2">
                                            <i class="bi bi-tag"></i> Tipo: {{ sugerencia.tipo|title }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info alert-dashboard">
                                <i class="bi bi-info-circle"></i> No hay sugerencias disponibles en este momento.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- ========================================
                     SECCI√ìN ML AVANZADO (Sistema Experto)
                     ======================================== -->
                
                {% if ml_insights_avanzados.disponible %}
                
                <div class="col-12 mt-4">
                    <hr class="my-4">
                    <h4 class="mb-4">
                        <i class="bi bi-stars"></i> Sistema Experto ML - An√°lisis Avanzado
                        <span class="badge bg-success">NUEVO</span>
                    </h4>
                </div>
                
                <!-- Resumen Ejecutivo -->
                <div class="col-12">
                    {% if ml_insights_avanzados.resumen_ejecutivo.estado_general == 'favorable' %}
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                    {% elif ml_insights_avanzados.resumen_ejecutivo.estado_general == 'moderado' %}
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-white">
                    {% else %}
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                    {% endif %}
                            <h5 class="mb-0">
                                <span style="font-size: 1.5rem;">{{ ml_insights_avanzados.resumen_ejecutivo.estado_icono }}</span>
                                Resumen Ejecutivo - {{ ml_insights_avanzados.resumen_ejecutivo.estado_mensaje }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Probabilidad</h6>
                                        <div class="display-4">{{ ml_insights_avanzados.resumen_ejecutivo.prob_aceptacion|floatformat:0 }}%</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Recomendaciones</h6>
                                        <div class="display-4">{{ ml_insights_avanzados.resumen_ejecutivo.total_recomendaciones }}</div>
                                        <small class="text-danger">{{ ml_insights_avanzados.resumen_ejecutivo.recomendaciones_criticas }} cr√≠ticas</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">ROI Estimado</h6>
                                        <div class="display-6">${{ ml_insights_avanzados.resumen_ejecutivo.roi_esperado|floatformat:0 }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Motivo Principal</h6>
                                        <div class="h5">{{ ml_insights_avanzados.resumen_ejecutivo.motivo_principal_rechazo }}</div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="alert alert-info mb-0">
                                <strong><i class="bi bi-info-circle"></i> An√°lisis:</strong>
                                {{ ml_insights_avanzados.resumen_ejecutivo.resumen_1_linea }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Alertas Cr√≠ticas -->
                {% if ml_insights_avanzados.analisis_completo.alertas_criticas %}
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle-fill"></i> 
                                Alertas Cr√≠ticas ({{ ml_insights_avanzados.total_alertas }})
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for alerta in ml_insights_avanzados.analisis_completo.alertas_criticas %}
                                <div class="col-md-6 mb-3">
                                    {% if alerta.severidad == 'critica' %}
                                    <div class="alert alert-danger mb-0">
                                    {% else %}
                                    <div class="alert alert-warning mb-0">
                                    {% endif %}
                                        <h6 class="alert-heading">
                                            <span style="font-size: 1.5rem;">{{ alerta.icono }}</span>
                                            <strong>{{ alerta.titulo }}</strong>
                                        </h6>
                                        <p class="mb-2">{{ alerta.mensaje }}</p>
                                        <hr>
                                        <p class="mb-0">
                                            <strong>Acci√≥n Requerida:</strong> {{ alerta.accion_requerida }}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Plan de Acci√≥n Recomendado -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-list-check"></i> 
                                Plan de Acci√≥n Recomendado ({{ ml_insights_avanzados.total_recomendaciones }} acciones)
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for recom in ml_insights_avanzados.analisis_completo.recomendaciones %}
                            <div class="card mb-3 border-{{ recom.color }}">
                                <div class="card-header bg-{{ recom.color }} bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span style="font-size: 1.2rem;">{{ recom.icono }}</span>
                                            <strong>{{ recom.id }}. {{ recom.titulo }}</strong>
                                        </div>
                                        <span class="badge bg-{{ recom.color }}">{{ recom.etiqueta }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">{{ recom.descripcion }}</p>
                                    
                                    <h6><i class="bi bi-arrow-right-circle"></i> Acciones Espec√≠ficas:</h6>
                                    <ul class="mb-3">
                                        {% for accion in recom.acciones %}
                                        <li>{{ accion }}</li>
                                        {% endfor %}
                                    </ul>
                                    
                                    <div class="alert alert-{{ recom.color }} alert-sm mb-0">
                                        <strong>Impacto Esperado:</strong> {{ recom.impacto }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Predicci√≥n de Motivo de Rechazo -->
                {% if ml_insights_avanzados.motivo_predicho %}
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-search"></i> Motivo Probable de Rechazo</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <h3 class="text-danger">{{ ml_insights_avanzados.motivo_predicho.motivo_nombre }}</h3>
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar bg-danger" 
                                         style="width: {{ ml_insights_avanzados.motivo_predicho.probabilidad }}%">
                                        {{ ml_insights_avanzados.motivo_predicho.probabilidad|floatformat:1 }}% probabilidad
                                    </div>
                                </div>
                                <small class="text-muted">Confianza: {{ ml_insights_avanzados.motivo_predicho.confianza }}</small>
                            </div>
                            
                            <p class="text-muted mb-3">{{ ml_insights_avanzados.motivo_predicho.descripcion }}</p>
                            
                            <h6>Acciones Sugeridas:</h6>
                            <ul>
                                {% for accion in ml_insights_avanzados.motivo_predicho.acciones|slice:":3" %}
                                <li>{{ accion }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Optimizaci√≥n de Precio -->
                {% if ml_insights_avanzados.optimizacion %}
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up-arrow"></i> Optimizaci√≥n de Precio</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <h6 class="text-muted">Costo Actual</h6>
                                    <h4 class="text-danger">${{ ml_insights_avanzados.optimizacion.costo_actual|floatformat:0 }}</h4>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">Costo √ìptimo</h6>
                                    <h4 class="text-success">${{ ml_insights_avanzados.optimizacion.costo_optimo|floatformat:0 }}</h4>
                                </div>
                            </div>
                            
                            <div class="alert alert-success mb-3">
                                <strong><i class="bi bi-arrow-up-circle"></i> Mejora Esperada:</strong><br>
                                +${{ ml_insights_avanzados.optimizacion.mejora_ingreso|floatformat:0 }} en ingreso esperado<br>
                                +{{ ml_insights_avanzados.optimizacion.mejora_probabilidad|floatformat:1 }}% en probabilidad de aceptaci√≥n
                            </div>
                            
                            <h6>Escenario √ìptimo:</h6>
                            <ul class="mb-0">
                                <li>Descuento Mano Obra: {{ ml_insights_avanzados.optimizacion.escenario_optimo.desc_mano_obra_pct|floatformat:0 }}%</li>
                                <li>Descuento Piezas: {{ ml_insights_avanzados.optimizacion.escenario_optimo.desc_piezas_pct|floatformat:0 }}%</li>
                                <li>{{ ml_insights_avanzados.optimizacion.total_escenarios }} escenarios evaluados</li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- An√°lisis Temporal -->
                {% if ml_insights_avanzados.temporal %}
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-calendar-check"></i> Mejor Momento para Enviar</h5>
                        </div>
                        <div class="card-body">
                            {% if ml_insights_avanzados.temporal.es_dia_optimo %}
                            <div class="alert alert-success">
                            {% else %}
                            <div class="alert alert-warning">
                            {% endif %}
                                <h6 class="alert-heading">
                                    {% if ml_insights_avanzados.temporal.es_dia_optimo %}
                                    <i class="bi bi-check-circle-fill"></i> HOY es un buen d√≠a
                                    {% else %}
                                    <i class="bi bi-clock-history"></i> Espera un mejor momento
                                    {% endif %}
                                </h6>
                                <p class="mb-0">{{ ml_insights_avanzados.temporal.mensaje }}</p>
                            </div>
                            
                            <div class="row text-center">
                                <div class="col-6">
                                    <h6 class="text-muted">Hoy ({{ ml_insights_avanzados.temporal.dia_hoy }})</h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar" style="width: 100%">Base</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-muted">{{ ml_insights_avanzados.temporal.mejor_dia }}</h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-success" style="width: 100%">
                                            +{{ ml_insights_avanzados.temporal.mejora_potencial|floatformat:1 }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Cotizaci√≥n Analizada (Info) -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-file-earmark-text"></i> Cotizaci√≥n Analizada</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-5">ID Cotizaci√≥n:</dt>
                                <dd class="col-sm-7">{{ ml_insights_avanzados.cotizacion_analizada.id }}</dd>
                                
                                <dt class="col-sm-5">Orden de Servicio:</dt>
                                <dd class="col-sm-7">{{ ml_insights_avanzados.cotizacion_analizada.orden }}</dd>
                                
                                <dt class="col-sm-5">Costo Total:</dt>
                                <dd class="col-sm-7">${{ ml_insights_avanzados.cotizacion_analizada.costo_actual|floatformat:2 }}</dd>
                                
                                <dt class="col-sm-5">Total Piezas:</dt>
                                <dd class="col-sm-7">{{ ml_insights_avanzados.cotizacion_analizada.total_piezas }}</dd>
                                
                                <dt class="col-sm-5">Gama Equipo:</dt>
                                <dd class="col-sm-7">
                                    {% if ml_insights_avanzados.cotizacion_analizada.gama == 'alta' %}
                                    <span class="badge bg-success">
                                    {% elif ml_insights_avanzados.cotizacion_analizada.gama == 'media' %}
                                    <span class="badge bg-warning">
                                    {% else %}
                                    <span class="badge bg-secondary">
                                    {% endif %}
                                        {{ ml_insights_avanzados.cotizacion_analizada.gama|upper }}
                                    </span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                
                <!-- Visualizaciones ML Avanzadas -->
                <div class="col-12 mt-4">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up"></i> Visualizaciones Anal√≠ticas Avanzadas
                    </h5>
                </div>
                
                <!-- Gr√°fico: Comparaci√≥n de Escenarios de Precio -->
                {% if graficos.ml_escenarios_precio %}
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5>
                                <i class="bi bi-currency-dollar"></i> 
                                Comparaci√≥n de Escenarios de Precio
                            </h5>
                        </div>
                        <div class="card-body">
                            {{ graficos.ml_escenarios_precio|safe }}
                            <div class="alert alert-info alert-sm mt-3">
                                <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                El gr√°fico muestra 4 escenarios diferentes comparando el costo final, probabilidad de aceptaci√≥n
                                e ingreso esperado. El escenario <strong>√ìptimo</strong> maximiza el ingreso considerando ambos factores.
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Gr√°fico: Matriz Riesgo-Beneficio -->
                {% if graficos.ml_matriz_riesgo %}
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5>
                                <i class="bi bi-grid-3x3"></i> 
                                Matriz Riesgo-Beneficio de Recomendaciones
                            </h5>
                        </div>
                        <div class="card-body">
                            {{ graficos.ml_matriz_riesgo|safe }}
                            <div class="alert alert-info alert-sm mt-3">
                                <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                Las recomendaciones en el cuadrante <strong class="text-success">PRIORITARIO</strong> (arriba-derecha) 
                                ofrecen alto beneficio con bajo riesgo. Las del cuadrante <strong class="text-danger">EVITAR</strong> 
                                (abajo-izquierda) tienen bajo beneficio y alto riesgo.
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Gr√°fico: Probabilidad por D√≠a de la Semana -->
                {% if graficos.ml_probabilidad_dia %}
                <div class="col-md-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5>
                                <i class="bi bi-calendar-week"></i> 
                                Probabilidad de Aceptaci√≥n por D√≠a
                            </h5>
                        </div>
                        <div class="card-body">
                            {{ graficos.ml_probabilidad_dia|safe }}
                            <div class="alert alert-info alert-sm mt-3">
                                <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                Los d√≠as <strong class="text-success">Lunes y Martes</strong> tienen las mejores tasas de aceptaci√≥n 
                                hist√≥ricas (+12-15%). Evita enviar cotizaciones los <strong class="text-danger">viernes y fines de semana</strong>.
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% endif %}
                <!-- FIN SECCI√ìN ML AVANZADO -->
                
                {% else %}
                
                <!-- Modelo No Disponible -->
                <div class="col-12">
                    <div class="alert alert-warning alert-dashboard">
                        <h5 class="alert-heading">
                            <i class="bi bi-exclamation-triangle"></i> Machine Learning No Disponible
                        </h5>
                        <p class="mb-0">
                            El modelo de predicci√≥n requiere un m√≠nimo de <strong>20 cotizaciones con respuesta</strong> 
                            (aceptadas o rechazadas) para poder entrenarse. Actualmente hay 
                            <strong>{{ ml_insights.datos_disponibles|default:0 }}</strong> cotizaciones con respuesta.
                        </p>
                        <hr>
                        <p class="mb-0">
                            <i class="bi bi-info-circle"></i> 
                            A medida que se registren m√°s cotizaciones, el modelo se entrenar√° autom√°ticamente 
                            y las predicciones estar√°n disponibles.
                        </p>
                    </div>
                </div>
                
                {% endif %}
                
            </div>
        </div>
        
    </div>
    
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border spinner-border-lg text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos del dashboard...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- TypeScript compilado del dashboard -->
<script src="{% static 'js/dashboard_cotizaciones.js' %}" defer></script>
{% endblock %}
