{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Cotizaciones - Analytics{% endblock %}

{% block extra_css %}
<!-- Estilos espec√≠ficos del Dashboard de Cotizaciones -->
<link rel="stylesheet" href="{% static 'css/dashboard_cotizaciones.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- ========================================
         HEADER DEL DASHBOARD
         ======================================== -->
    <div class="dashboard-header fade-in">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>üìä Dashboard de Cotizaciones</h1>
                    <p class="mb-0">An√°lisis completo con Machine Learning y visualizaciones interactivas</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <a href="{% url 'servicio_tecnico:exportar_dashboard_cotizaciones' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-exportar">
                        <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
                    </a>
                    <a href="{% url 'servicio_tecnico:exportar_analisis_rechazos' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-exportar" style="background: linear-gradient(135deg, #c0392b, #e74c3c); border-color: #c0392b; margin-left: 8px;">
                        <i class="bi bi-file-earmark-excel"></i> Analisis Rechazos
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         FORMULARIO DE FILTROS
         ======================================== -->
    <div class="filtros-card card fade-in">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros de An√°lisis</h5>
        </div>
        <div class="card-body">
            <form id="filtros-form" method="get" class="row g-3">
                
                <!-- Rango de Fechas -->
                <div class="col-md-3">
                    <label for="fecha_inicio" class="form-label">
                        <i class="bi bi-calendar-event"></i> Fecha Inicio
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_inicio"
                           name="fecha_inicio" 
                           value="{{ filtros_activos.fecha_inicio|default:'' }}">
                </div>
                
                <div class="col-md-3">
                    <label for="fecha_fin" class="form-label">
                        <i class="bi bi-calendar-check"></i> Fecha Fin
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_fin"
                           name="fecha_fin" 
                           value="{{ filtros_activos.fecha_fin|default:'' }}">
                </div>
                
                <!-- Sucursal -->
                <div class="col-md-2">
                    <label for="sucursal" class="form-label">
                        <i class="bi bi-building"></i> Sucursal
                    </label>
                    <select class="form-select" id="sucursal" name="sucursal">
                        <option value="">Todas las sucursales</option>
                        {% for sucursal in sucursales %}
                        <option value="{{ sucursal.id }}" 
                                {% if filtros_activos.sucursal == sucursal.id|stringformat:"s" %}selected{% endif %}>
                            {{ sucursal.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- T√©cnico -->
                <div class="col-md-2">
                    <label for="tecnico" class="form-label">
                        <i class="bi bi-person-badge"></i> T√©cnico
                    </label>
                    <select class="form-select" id="tecnico" name="tecnico">
                        <option value="">Todos los t√©cnicos</option>
                        {% for tecnico in tecnicos %}
                        <option value="{{ tecnico.id }}"
                                {% if filtros_activos.tecnico == tecnico.id|stringformat:"s" %}selected{% endif %}>
                            {{ tecnico.nombre_completo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Gama -->
                <div class="col-md-2">
                    <label for="gama" class="form-label">
                        <i class="bi bi-star"></i> Gama
                    </label>
                    <select class="form-select" id="gama" name="gama">
                        <option value="">Todas las gamas</option>
                        <option value="alta" {% if filtros_activos.gama == 'alta' %}selected{% endif %}>Alta Gama</option>
                        <option value="media" {% if filtros_activos.gama == 'media' %}selected{% endif %}>Media Gama</option>
                        <option value="baja" {% if filtros_activos.gama == 'baja' %}selected{% endif %}>Baja Gama</option>
                    </select>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div class="col-12">
                    <button type="submit" class="btn btn-filtrar">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'servicio_tecnico:dashboard_cotizaciones' %}" 
                       class="btn btn-limpiar">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar Filtros
                    </a>
                    <span class="text-muted ms-3">
                        <i class="bi bi-info-circle"></i> 
                        Mostrando {{ total_cotizaciones }} cotizaci√≥n{{ total_cotizaciones|pluralize:"es" }}
                    </span>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ========================================
         GRID DE KPIs PRINCIPALES
         ======================================== -->
    <div class="kpis-grid fade-in">
        
        <!-- KPI: Total Cotizaciones -->
        <div class="kpi-card primary">
            <div class="kpi-icon">üìã</div>
            <div class="kpi-label">Total Cotizaciones</div>
            <div class="kpi-value">{{ kpis.total_cotizaciones|default:0 }}</div>
            <div class="kpi-subtext">En el per√≠odo seleccionado</div>
        </div>
        
        <!-- KPI: Tasa de Aceptaci√≥n -->
        <div class="kpi-card success">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">Tasa de Aceptaci√≥n</div>
            <div class="kpi-value">{{ kpis.tasa_aceptacion|default:0|floatformat:1 }}%</div>
            <div class="kpi-subtext">{{ kpis.aceptadas|default:0 }} cotizaciones aceptadas</div>
        </div>
        
        <!-- KPI: Tasa de Rechazo -->
        <div class="kpi-card danger">
            <div class="kpi-icon">‚ùå</div>
            <div class="kpi-label">Tasa de Rechazo</div>
            <div class="kpi-value">{{ kpis.tasa_rechazo|default:0|floatformat:1 }}%</div>
            <div class="kpi-subtext">{{ kpis.rechazadas|default:0 }} cotizaciones rechazadas</div>
        </div>
        
        <!-- KPI: Pendientes -->
        <div class="kpi-card warning">
            <div class="kpi-icon">‚è≥</div>
            <div class="kpi-label">Pendientes</div>
            <div class="kpi-value">{{ kpis.pendientes|default:0 }}</div>
            <div class="kpi-subtext">En espera de respuesta</div>
        </div>
        
        <!-- KPI: Valor Total -->
        <div class="kpi-card info">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-label">Valor Total</div>
            <div class="kpi-value">${{ kpis.valor_total_cotizado|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Suma de todas las cotizaciones</div>
        </div>
        
        <!-- KPI: Ingresos Reales -->
        <div class="kpi-card success">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">Ingresos Reales</div>
            <div class="kpi-value">${{ kpis.valor_aceptado|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Solo cotizaciones aceptadas</div>
        </div>
        
        <!-- KPI: Cotizaciones no concretadas -->
        <div class="kpi-card danger">
            <div class="kpi-icon">üìâ</div>
            <div class="kpi-label">Cotizaciones no concretadas</div>
            <div class="kpi-value">${{ kpis.valor_rechazado|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Oportunidades de recuperaci√≥n</div>
        </div>
        
        <!-- KPI: Ticket Promedio -->
        <div class="kpi-card primary">
            <div class="kpi-icon">üíµ</div>
            <div class="kpi-label">Ticket Promedio</div>
            <div class="kpi-value">${{ kpis.ticket_promedio|default:0|floatformat:0 }}</div>
            <div class="kpi-subtext">Por cotizaci√≥n</div>
        </div>
        
        <!-- KPI: Tiempo Promedio -->
        <div class="kpi-card info">
            <div class="kpi-icon">‚è±Ô∏è</div>
            <div class="kpi-label">Tiempo Prom. Respuesta</div>
            <div class="kpi-value">{{ kpis.tiempo_respuesta_promedio|default:0|floatformat:1 }}</div>
            <div class="kpi-subtext">D√≠as hasta respuesta</div>
        </div>
        
        <!-- KPI: Total Piezas -->
        <div class="kpi-card warning">
            <div class="kpi-icon">üîß</div>
            <div class="kpi-label">Total Piezas</div>
            <div class="kpi-value">{{ kpis.total_piezas|default:0 }}</div>
            <div class="kpi-subtext">Piezas cotizadas (Esto incluye piezas pendientes)</div>
        </div>
        
    </div>
    
    <!-- ========================================
         SISTEMA DE TABS DE NAVEGACI√ìN
         ======================================== -->
    <ul class="nav nav-tabs fade-in" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    id="overview-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#overview" 
                    type="button" 
                    role="tab">
                <i class="bi bi-graph-up"></i> Visi√≥n General
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="piezas-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#piezas" 
                    type="button" 
                    role="tab">
                <i class="bi bi-gear"></i> An√°lisis de Piezas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="respuestas-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#respuestas" 
                    type="button" 
                    role="tab">
                <i class="bi bi-chat-left-text"></i> An√°lisis de Respuesta
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="proveedores-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#proveedores" 
                    type="button" 
                    role="tab">
                <i class="bi bi-truck"></i> Proveedores
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="tecnicos-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#tecnicos" 
                    type="button" 
                    role="tab">
                <i class="bi bi-people"></i> T√©cnicos & Sucursales
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="responsables-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#responsables" 
                    type="button" 
                    role="tab">
                <i class="bi bi-person-check-fill"></i> Responsables
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="ml-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#ml" 
                    type="button" 
                    role="tab">
                <i class="bi bi-robot"></i> Machine Learning
            </button>
        </li>
    </ul>
    
    <!-- ========================================
         CONTENIDO DE LOS TABS
         ======================================== -->
    <div class="tab-content fade-in" id="dashboardTabContent">
        
        <!-- ========================================
             TAB 1: VISI√ìN GENERAL
             ======================================== -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                
                <!-- Evoluci√≥n Temporal -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up-arrow"></i> Evoluci√≥n Temporal de Cotizaciones</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.evolucion_temporal %}
                                {{ graficos.evolucion_temporal|safe }}
                                <div class="alert alert-secondary alert-dashboard mt-3">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>¬øC√≥mo interpretar este gr√°fico?</strong> Las cotizaciones se agrupan por mes y se muestran 
                                    en la fecha de fin de mes. Por ejemplo, si ves "31 de Diciembre", representa el 
                                    <strong>total acumulado de cotizaciones de todo el mes de diciembre</strong>, 
                                    no solo las del d√≠a 31.
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para mostrar la evoluci√≥n temporal.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Tasas de Aceptaci√≥n y Distribuci√≥n de Costos -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bar-chart"></i> Tasas de Aceptaci√≥n por Sucursal</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tasas_aceptacion_sucursal %}
                                {{ graficos.tasas_aceptacion_sucursal|safe }}
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No hay datos para mostrar tasas de aceptaci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-currency-dollar"></i> Distribuci√≥n de Costos</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.distribucion_costos %}
                                {{ graficos.distribucion_costos|safe }}
                                <div class="alert alert-success alert-dashboard mt-3">
                                    <strong><i class="bi bi-cash-stack"></i> An√°lisis de Precios:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Distribuci√≥n:</strong> Muestra c√≥mo se dispersan los costos de las cotizaciones</li>
                                        <li><strong>Picos altos:</strong> Rangos de precio m√°s comunes</li>
                                        <li><strong>√Åreas amplias:</strong> Gran variabilidad en ese rango (analizar causas)</li>
                                        <li><strong>√ötil para:</strong> Identificar rangos de precio √≥ptimos y detectar valores at√≠picos</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No hay datos para mostrar distribuci√≥n de costos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Embudo de Conversi√≥n y Comparativo -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-funnel"></i> Embudo de Conversi√≥n</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.funnel_conversion %}
                                {{ graficos.funnel_conversion|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-funnel-fill"></i> Interpretaci√≥n del Embudo:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Total Cotizaciones:</strong> Volumen de oportunidades generadas</li>
                                        <li><strong>Con Respuesta:</strong> Cotizaciones donde el cliente dio una respuesta</li>
                                        <li><strong>Aceptadas:</strong> Conversi√≥n final exitosa (ingresos reales)</li>
                                        <li><strong>% de ca√≠da:</strong> Indica oportunidades de mejora en cada etapa</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos para mostrar el embudo de conversi√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-person-check"></i> Tasas de Aceptaci√≥n por T√©cnico</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tasas_aceptacion_tecnico %}
                                {{ graficos.tasas_aceptacion_tecnico|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de t√©cnicos disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Gamas de Equipos -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-diagram-3"></i> Distribuci√≥n por Gamas de Equipos</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.gamas_equipos %}
                                {{ graficos.gamas_equipos|safe }}
                            {% else %}
                                <div class="alert alert-warning alert-dashboard">
                                    <i class="bi bi-exclamation-triangle"></i> No hay datos de equipos disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 2: AN√ÅLISIS DE PIEZAS
             ======================================== -->
        <div class="tab-pane fade" id="piezas" role="tabpanel">
            <div class="row">
                
                <!-- Top Piezas Rechazadas -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-x-circle"></i> Top Piezas Rechazadas</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_piezas_rechazadas %}
                                {{ graficos.top_piezas_rechazadas|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay piezas rechazadas en el per√≠odo.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Top Piezas Aceptadas -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-check-circle"></i> Top Piezas Aceptadas</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_piezas_aceptadas %}
                                {{ graficos.top_piezas_aceptadas|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay piezas aceptadas en el per√≠odo.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Necesarias vs Opcionales -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-toggle-on"></i> Piezas Necesarias vs Opcionales</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.piezas_necesarias_vs_opcionales %}
                                {{ graficos.piezas_necesarias_vs_opcionales|safe }}
                                <div class="alert alert-warning alert-dashboard mt-3">
                                    <strong><i class="bi bi-lightbulb"></i> Insight Clave:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Piezas Necesarias:</strong> Cr√≠ticas para el funcionamiento del equipo</li>
                                        <li><strong>Piezas Opcionales:</strong> Mejoras o preventivas (mayor probabilidad de rechazo)</li>
                                        <li><strong>Estrategia:</strong> Cotizar por separado puede mejorar tasa de aceptaci√≥n</li>
                                        <li><strong>Recomendaci√≥n:</strong> Si hay muchas opcionales rechazadas, considerar presentarlas despu√©s</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de clasificaci√≥n de piezas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sugerencias del T√©cnico -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-lightbulb"></i> Flujo de Sugerencias del T√©cnico</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.sugerencias_tecnico %}
                                {{ graficos.sugerencias_tecnico|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-diagram-3"></i> C√≥mo Leer el Diagrama:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Flujo de decisiones:</strong> Desde la sugerencia del t√©cnico hasta el resultado final</li>
                                        <li><strong>Grosor de l√≠neas:</strong> Proporcional al volumen de casos en cada ruta</li>
                                        <li><strong>Rutas m√°s gruesas:</strong> Patrones m√°s comunes de comportamiento del cliente</li>
                                        <li><strong>Analizar:</strong> ¬øLas sugerencias del t√©cnico influyen en la aceptaci√≥n?</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de sugerencias de t√©cnicos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 3: AN√ÅLISIS DE RESPUESTA
             ======================================== -->
        <div class="tab-pane fade" id="respuestas" role="tabpanel">
            <div class="row">
                
                <!-- Tiempos de Respuesta -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-clock-history"></i> Tiempos de Respuesta del Cliente</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tiempos_respuesta %}
                                {{ graficos.tiempos_respuesta|safe }}
                                <div class="alert alert-success alert-dashboard mt-3">
                                    <strong><i class="bi bi-clock"></i> Rangos de Respuesta √ìptimos:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>0-2 d√≠as:</strong> Respuesta r√°pida - Cliente muy interesado (alta prob. aceptaci√≥n)</li>
                                        <li><strong>3-5 d√≠as:</strong> Respuesta normal - Cliente evaluando opciones</li>
                                        <li><strong>6-10 d√≠as:</strong> Respuesta lenta - Puede indicar dudas o comparando precios</li>
                                        <li><strong>+10 d√≠as:</strong> Alto riesgo de rechazo - Considerar seguimiento proactivo</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes de tiempos de respuesta.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Motivos de Rechazo -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-x-octagon"></i> Motivos de Rechazo</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.motivos_rechazo %}
                                {{ graficos.motivos_rechazo|safe }}
                                <div class="alert alert-danger alert-dashboard mt-3">
                                    <strong><i class="bi bi-shield-exclamation"></i> Acciones Correctivas por Motivo:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Precio Alto:</strong> Revisar m√°rgenes, buscar proveedores alternativos, ofrecer opciones</li>
                                        <li><strong>No tiene presupuesto:</strong> Ofrecer financiamiento o reparaciones parciales</li>
                                        <li><strong>Repar√≥ en otro lugar:</strong> Mejorar seguimiento y tiempos de respuesta</li>
                                        <li><strong>No vale la pena reparar:</strong> Educaci√≥n sobre valor del equipo vs costo</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de cotizaciones rechazadas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Motivos de Rechazo vs Costos -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-cash-coin"></i> An√°lisis de Costos por Motivo de Rechazo</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.motivos_rechazo_vs_costos %}
                                {{ graficos.motivos_rechazo_vs_costos|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> C√≥mo interpretar este gr√°fico:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Caja:</strong> Rango donde est√° el 50% de los costos para ese motivo</li>
                                        <li><strong>L√≠nea central:</strong> Costo mediano (t√≠pico) de ese motivo</li>
                                        <li><strong>Puntos aislados:</strong> Casos extremos (muy baratos o muy caros)</li>
                                        <li><strong>L√≠nea gris punteada:</strong> Costo mediano global de todas las cotizaciones rechazadas</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para el an√°lisis de costos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO: Correlaci√≥n Tiempo de Respuesta vs Resultado -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-clock-history"></i> Correlaci√≥n: Tiempo de Respuesta vs Resultado</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.correlacion_tiempo_resultado %}
                                {{ graficos.correlacion_tiempo_resultado|safe }}
                                <div class="alert alert-success alert-dashboard mt-3">
                                    <strong><i class="bi bi-lightbulb"></i> Insight Estrat√©gico:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Puntos Verdes:</strong> Cotizaciones aceptadas - busca patrones de tiempo √≥ptimo</li>
                                        <li><strong>Puntos Rojos:</strong> Cotizaciones rechazadas - identifica "zonas peligrosas"</li>
                                        <li><strong>L√≠neas de Tendencia:</strong> Muestran si hay correlaci√≥n entre demora y resultado</li>
                                        <li><strong>Tama√±o del punto:</strong> Representa cantidad de piezas cotizadas</li>
                                        <li><strong>Acci√≥n:</strong> Si la l√≠nea verde desciende, responder r√°pido mejora aceptaci√≥n</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para an√°lisis de correlaci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- ========================================
                     SECCI√ìN NUEVA: AN√ÅLISIS DE COMENTARIOS (TEXT MINING)
                     ======================================== -->
                {% if analisis_texto.tiene_datos %}
                <div class="col-12 mt-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="bi bi-chat-quote"></i> An√°lisis Inteligente de Comentarios de Rechazo
                            </h4>
                            <small>Text Mining sobre {{ analisis_texto.total_comentarios }} comentarios analizados</small>
                        </div>
                        <div class="card-body">
                            
                            <!-- Insights Autom√°ticos -->
                            {% if analisis_texto.insights %}
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5><i class="bi bi-lightbulb"></i> Insights Clave</h5>
                                </div>
                                {% for insight in analisis_texto.insights %}
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card h-100 
                                        {% if insight.tipo == 'alerta' %}border-danger{% endif %}
                                        {% if insight.tipo == 'positivo' %}border-success{% endif %}
                                        {% if insight.tipo == 'info' %}border-info{% endif %}
                                        {% if insight.tipo == 'advertencia' %}border-warning{% endif %}
                                    ">
                                        <div class="card-body">
                                            <div style="font-size: 2rem; text-align: center; margin-bottom: 10px;">
                                                {{ insight.icono }}
                                            </div>
                                            <h6 class="card-title fw-bold">{{ insight.titulo }}</h6>
                                            <p class="card-text small">{{ insight.mensaje }}</p>
                                            <div class="alert alert-light alert-sm mb-0 small">
                                                <strong>üí° Acci√≥n:</strong> {{ insight.accion }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Estad√≠sticas de Texto -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-primary">{{ analisis_texto.total_comentarios }}</h3>
                                            <small class="text-muted">Comentarios Analizados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-info">{{ analisis_texto.total_palabras_unicas }}</h3>
                                            <small class="text-muted">Palabras √önicas</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-success">{{ analisis_texto.promedio_palabras_por_comentario|floatformat:0 }}</h3>
                                            <small class="text-muted">Palabras Promedio</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-warning">{{ analisis_texto.frases_comunes|length }}</h3>
                                            <small class="text-muted">Frases Comunes</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gr√°ficos de Text Mining en Grid 2x2 -->
                            <div class="row">
                                
                                <!-- Nube de Palabras (Top Izquierda) -->
                                <div class="col-md-6 mb-4">
                                    <div class="card grafico-card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-cloud"></i> Nube de Palabras Interactiva</h5>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.texto_nube_palabras %}
                                                {{ graficos.texto_nube_palabras|safe }}
                                                <div class="alert alert-info alert-sm mt-2 mb-0">
                                                    <small>
                                                        <i class="bi bi-info-circle"></i> 
                                                        <strong>C√≥mo leerlo:</strong> Tama√±o = frecuencia de aparici√≥n. 
                                                        Palabras m√°s grandes = m√°s mencionadas por clientes.
                                                    </small>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning">No hay datos para nube de palabras</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Palabras M√°s Frecuentes (Top Derecha) -->
                                <div class="col-md-6 mb-4">
                                    <div class="card grafico-card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-bar-chart"></i> Palabras M√°s Frecuentes</h5>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.texto_palabras_frecuentes %}
                                                {{ graficos.texto_palabras_frecuentes|safe }}
                                                <div class="alert alert-info alert-sm mt-2 mb-0">
                                                    <small>
                                                        <i class="bi bi-info-circle"></i> 
                                                        <strong>Utilidad:</strong> Identifica los temas principales por los que rechazan. 
                                                        Enfoca tu an√°lisis en estas palabras clave.
                                                    </small>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning">No hay datos de frecuencia</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Frases Comunes (Bottom Izquierda) -->
                                <div class="col-md-6 mb-4">
                                    <div class="card grafico-card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-chat-square-quote"></i> Frases M√°s Comunes</h5>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.texto_frases_comunes %}
                                                {{ graficos.texto_frases_comunes|safe }}
                                                <div class="alert alert-success alert-sm mt-2 mb-0">
                                                    <small>
                                                        <i class="bi bi-lightbulb"></i> 
                                                        <strong>Insight:</strong> Bigramas (2 palabras juntas) revelan contextos espec√≠ficos. 
                                                        Por ejemplo: "precio alto", "mucho tiempo", "no funciona".
                                                    </small>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning">No hay frases comunes identificadas</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Correlaci√≥n Palabra ‚Üí Resultado (Bottom Derecha) -->
                                <div class="col-md-6 mb-4">
                                    <div class="card grafico-card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-graph-up-arrow"></i> Correlaci√≥n: Palabras vs Resultados</h5>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.texto_correlaciones %}
                                                {{ graficos.texto_correlaciones|safe }}
                                                <div class="alert alert-danger alert-sm mt-2 mb-0">
                                                    <small>
                                                        <i class="bi bi-exclamation-triangle"></i> 
                                                        <strong>CR√çTICO:</strong> Palabras al tope (100% rechazo en rojo) son "se√±ales de alarma". 
                                                        Cuando un cliente las menciona, act√∫a de inmediato para revertir la decisi√≥n.
                                                    </small>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning">No hay correlaciones suficientes para analizar</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <!-- Tabla de Detalle: Top Palabras con Correlaci√≥n -->
                            {% if analisis_texto.correlaciones %}
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5><i class="bi bi-table"></i> Tabla Detallada: An√°lisis de Palabras Clave</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover table-sm">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Ranking</th>
                                                    <th>Palabra Clave</th>
                                                    <th>Menciones</th>
                                                    <th>Tasa Rechazo</th>
                                                    <th>Tasa Aceptaci√≥n</th>
                                                    <th>Nivel de Riesgo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for correlacion in analisis_texto.correlaciones|slice:":10" %}
                                                <tr>
                                                    <td><strong>{{ forloop.counter }}</strong></td>
                                                    <td>
                                                        <span class="badge bg-primary">{{ correlacion.palabra|title }}</span>
                                                    </td>
                                                    <td>{{ correlacion.menciones }}</td>
                                                    <td>
                                                        <span class="badge 
                                                            {% if correlacion.tasa_rechazo >= 75 %}bg-danger
                                                            {% elif correlacion.tasa_rechazo >= 50 %}bg-warning
                                                            {% else %}bg-success{% endif %}
                                                        ">
                                                            {{ correlacion.tasa_rechazo|floatformat:0 }}%
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge 
                                                            {% if correlacion.tasa_aceptacion >= 50 %}bg-success
                                                            {% elif correlacion.tasa_aceptacion >= 25 %}bg-warning
                                                            {% else %}bg-danger{% endif %}
                                                        ">
                                                            {{ correlacion.tasa_aceptacion|floatformat:0 }}%
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% if correlacion.tasa_rechazo >= 75 %}
                                                            <span class="text-danger fw-bold">üî¥ ALTO RIESGO</span>
                                                        {% elif correlacion.tasa_rechazo >= 50 %}
                                                            <span class="text-warning fw-bold">‚ö†Ô∏è RIESGO MEDIO</span>
                                                        {% else %}
                                                            <span class="text-success fw-bold">üü¢ BAJO RIESGO</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="alert alert-light mt-3">
                                        <strong><i class="bi bi-lightbulb"></i> C√≥mo usar esta tabla:</strong>
                                        <ul class="mb-0 small">
                                            <li><strong>Palabras con alto rechazo (>75%):</strong> Se√±ales de alarma - requieren acci√≥n inmediata</li>
                                            <li><strong>Palabras con baja aceptaci√≥n (<25%):</strong> Temas problem√°ticos - analiza y corrige</li>
                                            <li><strong>Muchas menciones + alto rechazo:</strong> Problema sist√©mico - prioriza soluci√≥n</li>
                                            <li><strong>Pocas menciones pero rechazo alto:</strong> Caso espec√≠fico - investiga contexto</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>
                {% endif %}
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 4: AN√ÅLISIS DE PROVEEDORES
             ======================================== -->
        <div class="tab-pane fade" id="proveedores" role="tabpanel">
            <div class="row">
                
                <!-- Top Proveedores (Superior Izquierda) -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-trophy"></i> Top Proveedores por Volumen</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.top_proveedores %}
                                {{ graficos.top_proveedores|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> M√©trica:</strong>
                                    Proveedores ordenados por cantidad de pedidos realizados (volumen).
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de proveedores disponibles.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Performance de Proveedores (Superior Derecha) -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-speedometer"></i> Velocidad de Entrega vs Volumen</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.proveedores_performance %}
                                {{ graficos.proveedores_performance|safe }}
                                <div class="alert alert-primary alert-dashboard mt-3">
                                    <strong><i class="bi bi-graph-up"></i> C√≥mo Leer:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Eje X:</strong> Tiempo promedio de entrega (d√≠as)</li>
                                        <li><strong>Eje Y:</strong> Cantidad de pedidos</li>
                                        <li><strong>Color:</strong> Verde = r√°pido, Rojo = lento</li>
                                        <li><strong>Ideal:</strong> Muchos pedidos + entregas r√°pidas</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay suficientes datos de seguimiento de proveedores.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO: Impacto en Conversi√≥n (Inferior Izquierda) -->
                <div class="col-md-6 mt-3">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bullseye"></i> Impacto en Conversi√≥n de Ventas</h5>
                            <span class="badge bg-success">NUEVO</span>
                        </div>
                        <div class="card-body">
                            {% if graficos.proveedores_impacto_conversion %}
                                {{ graficos.proveedores_impacto_conversion|safe }}
                                <div class="alert alert-success alert-dashboard mt-3">
                                    <strong><i class="bi bi-lightbulb-fill"></i> Insight Estrat√©gico (An√°lisis por Pieza):</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Tasa de Aceptaci√≥n:</strong> % de PIEZAS aceptadas por el cliente (a nivel individual)</li>
                                        <li><strong>Tasa de Rechazo:</strong> % de PIEZAS rechazadas - Menor es mejor</li>
                                        <li><strong>Velocidad de Entrega:</strong> Rapidez normalizada (100 = m√°s r√°pido)</li>
                                        <li><strong>Valor Generado:</strong> Ingresos reales de piezas aceptadas</li>
                                        <li><strong>Verde:</strong> Excelente desempe√±o | <strong>Amarillo:</strong> Regular | <strong>Rojo:</strong> Mejorar</li>
                                        <li><strong>Acci√≥n:</strong> Priorizar proveedores con alta aceptaci√≥n, bajo rechazo y entregas r√°pidas</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay suficientes datos para an√°lisis de conversi√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO: Componentes por Proveedor (Inferior Derecha) -->
                <div class="col-md-6 mt-3">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-diagram-3"></i> Especializaci√≥n por Componente</h5>
                            <span class="badge bg-success">NUEVO</span>
                        </div>
                        <div class="card-body">
                            {% if graficos.componentes_por_proveedor %}
                                {{ graficos.componentes_por_proveedor|safe }}
                                <div class="alert alert-warning alert-dashboard mt-3">
                                    <strong><i class="bi bi-stars"></i> C√≥mo Usar Este Gr√°fico:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Click en segmentos:</strong> Navega por la jerarqu√≠a (Componente ‚Üí Proveedor ‚Üí Resultado)</li>
                                        <li><strong>Centro:</strong> Todas las piezas suministradas</li>
                                        <li><strong>Anillo 1:</strong> Tipo de componente (RAM, Disco, Pantalla, etc.)</li>
                                        <li><strong>Anillo 2:</strong> Proveedores que suministran cada componente</li>
                                        <li><strong>Anillo 3:</strong> Resultado por pieza (Verde=Aceptado, Rojo=Rechazado, Gris=Sin Respuesta)</li>
                                        <li><strong>Anillo 3:</strong> Resultado (Aceptado/Rechazado/Sin Respuesta)</li>
                                        <li><strong>Tama√±o:</strong> Proporcional a cantidad de piezas</li>
                                        <li><strong>Insight:</strong> Identifica especializaci√≥n y diversificaci√≥n de proveedores</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay suficientes datos de componentes por proveedor.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 5: T√âCNICOS & SUCURSALES
             ======================================== -->
        <div class="tab-pane fade" id="tecnicos" role="tabpanel">
            <div class="row">
                
                <!-- Ranking de T√©cnicos -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-award"></i> Ranking de T√©cnicos</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.ranking_tecnicos %}
                                {{ graficos.ranking_tecnicos|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para generar ranking.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Distribuci√≥n por Sucursales -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-buildings"></i> Distribuci√≥n por Sucursales</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.distribucion_sucursales %}
                                {{ graficos.distribucion_sucursales|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de distribuci√≥n por sucursales.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Rendimiento por T√©cnico -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-person-check"></i> Rendimiento por T√©cnico</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.rendimiento_tecnicos %}
                                {{ graficos.rendimiento_tecnicos|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-people"></i> Balance Volumen vs Calidad:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Eje X (Cotizaciones):</strong> Volumen de trabajo del t√©cnico</li>
                                        <li><strong>Eje Y (% Aceptaci√≥n):</strong> Calidad/efectividad de las cotizaciones</li>
                                        <li><strong>Ideal:</strong> Alto volumen + Alta aceptaci√≥n (esquina superior derecha)</li>
                                        <li><strong>Oportunidad:</strong> Alto volumen pero baja aceptaci√≥n = necesita capacitaci√≥n</li>
                                        <li><strong>Potencial:</strong> Baja volumen pero alta aceptaci√≥n = puede manejar m√°s casos</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de rendimiento de t√©cnicos.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Heatmap de Sucursales -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-grid"></i> Rendimiento de Sucursales</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.rendimiento_sucursales %}
                                {{ graficos.rendimiento_sucursales|safe }}
                                <div class="alert alert-warning alert-dashboard mt-3">
                                    <strong><i class="bi bi-thermometer-half"></i> C√≥mo Interpretar el Mapa de Calor:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Colores c√°lidos (rojo/naranja):</strong> Valores altos - Buen rendimiento</li>
                                        <li><strong>Colores fr√≠os (azul/verde):</strong> Valores bajos - √Årea de mejora</li>
                                        <li><strong>Por columna:</strong> Compara m√©tricas de una sucursal (volumen, aceptaci√≥n, valor)</li>
                                        <li><strong>Por fila:</strong> Compara una m√©trica entre todas las sucursales</li>
                                        <li><strong>Patrones:</strong> Busca sucursales consistentemente altas o bajas en todas las m√©tricas</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de m√∫ltiples sucursales.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- ========================================
                     SECCI√ìN NUEVA: AN√ÅLISIS DE DIAGN√ìSTICOS T√âCNICOS
                     ======================================== -->
                {% if analisis_diagnosticos.tiene_datos %}
                <div class="col-12 mt-4">
                    <hr class="my-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="bi bi-clipboard-pulse"></i> An√°lisis de Calidad de Diagn√≥sticos T√©cnicos
                                <span class="badge bg-light text-primary ms-2">NUEVO</span>
                            </h4>
                            <small>Text Mining sobre {{ analisis_diagnosticos.total_diagnosticos }} diagn√≥sticos de {{ analisis_diagnosticos.total_tecnicos }} t√©cnico{{ analisis_diagnosticos.total_tecnicos|pluralize:"s" }}</small>
                        </div>
                        <div class="card-body">
                            
                            <!-- Insights Autom√°ticos -->
                            {% if analisis_diagnosticos.insights %}
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="mb-3"><i class="bi bi-lightbulb"></i> Insights Autom√°ticos</h5>
                                </div>
                                {% for insight in analisis_diagnosticos.insights %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card border-{{ insight.color }} h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="me-3" style="font-size: 2rem;">{{ insight.icono }}</div>
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title text-{{ insight.color }} mb-2">
                                                        {{ insight.titulo }}
                                                    </h6>
                                                    <p class="card-text small mb-2">
                                                        {{ insight.mensaje }}
                                                    </p>
                                                    <div class="small text-muted">
                                                        <strong>Acci√≥n:</strong> {{ insight.accion }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Estad√≠sticas Globales -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="text-primary mb-1">
                                                {{ analisis_diagnosticos.promedios_globales.promedio_palabras|floatformat:0 }}
                                            </h3>
                                            <small class="text-muted">Promedio de Palabras</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="text-success mb-1">
                                                {{ analisis_diagnosticos.promedios_globales.promedio_tecnicidad|floatformat:1 }}%
                                            </h3>
                                            <small class="text-muted">√çndice de Tecnicidad</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="text-info mb-1">
                                                {{ analisis_diagnosticos.promedios_globales.promedio_diagnosticos|floatformat:0 }}
                                            </h3>
                                            <small class="text-muted">Diagn√≥sticos por T√©cnico</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gr√°ficos de An√°lisis en Grid 2x2 -->
                            <div class="row">
                                
                                <!-- Gr√°fico 1: Ranking por Detalle -->
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-bar-chart-fill"></i> Nivel de Detalle por T√©cnico
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.diagnosticos_ranking_detalle %}
                                                {{ graficos.diagnosticos_ranking_detalle|safe }}
                                                <div class="alert alert-info alert-sm mt-3 py-2 px-2 small">
                                                    <strong>Interpretaci√≥n:</strong> T√©cnicos que escriben m√°s palabras tienden a dar diagn√≥sticos m√°s completos y detallados.
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning small">
                                                    No hay datos de ranking de detalle disponibles.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gr√°fico 2: Ranking por Tecnicidad -->
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-mortarboard-fill"></i> √çndice de Tecnicidad por T√©cnico
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.diagnosticos_ranking_tecnicidad %}
                                                {{ graficos.diagnosticos_ranking_tecnicidad|safe }}
                                                <div class="alert alert-success alert-sm mt-3 py-2 px-2 small">
                                                    <strong>Interpretaci√≥n:</strong> Mayor % = Uso de terminolog√≠a t√©cnica especializada. Indica conocimiento profesional.
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning small">
                                                    No hay datos de ranking de tecnicidad disponibles.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gr√°fico 3: Comparativa Scatter -->
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-graph-up-arrow"></i> Comparativa: Detalle vs Tecnicidad
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.diagnosticos_comparativa_scatter %}
                                                {{ graficos.diagnosticos_comparativa_scatter|safe }}
                                                <div class="alert alert-primary alert-sm mt-3 py-2 px-2 small">
                                                    <strong>Objetivo:</strong> T√©cnicos en la esquina superior derecha (‚≠ê IDEAL) son los m√°s completos y t√©cnicos.
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning small">
                                                    No hay datos de comparativa disponibles.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gr√°fico 4: Palabras T√©cnicas Globales -->
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-wrench-adjustable"></i> T√©rminos T√©cnicos M√°s Usados
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if graficos.diagnosticos_palabras_tecnicas %}
                                                {{ graficos.diagnosticos_palabras_tecnicas|safe }}
                                                <div class="alert alert-warning alert-sm mt-3 py-2 px-2 small">
                                                    <strong>Uso:</strong> Identifica componentes m√°s problem√°ticos y necesidades de capacitaci√≥n/stock.
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning small">
                                                    No hay datos de palabras t√©cnicas disponibles.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <!-- Tabla Detallada: An√°lisis por T√©cnico -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="mb-3"><i class="bi bi-table"></i> An√°lisis Detallado por T√©cnico</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>T√©cnico</th>
                                                    <th class="text-center">Diagn√≥sticos</th>
                                                    <th class="text-center">Prom. Palabras</th>
                                                    <th class="text-center">Nivel Detalle</th>
                                                    <th class="text-center">Tecnicidad</th>
                                                    <th class="text-center">Clasificaci√≥n</th>
                                                    <th>Top Palabras T√©cnicas</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tecnico in analisis_diagnosticos.analisis_por_tecnico %}
                                                <tr>
                                                    <td><strong>{{ tecnico.tecnico }}</strong></td>
                                                    <td class="text-center">{{ tecnico.num_diagnosticos }}</td>
                                                    <td class="text-center">{{ tecnico.promedio_palabras|floatformat:0 }}</td>
                                                    <td class="text-center">
                                                        <span class="badge bg-{{ tecnico.color_detalle }}">
                                                            {{ tecnico.nivel_detalle }}
                                                        </span>
                                                    </td>
                                                    <td class="text-center">{{ tecnico.indice_tecnicidad|floatformat:1 }}%</td>
                                                    <td class="text-center">
                                                        <span class="badge bg-{{ tecnico.color_clasificacion }}">
                                                            {{ tecnico.clasificacion }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small>
                                                            {% for palabra in tecnico.top_palabras_tecnicas %}
                                                                <span class="badge bg-secondary me-1">
                                                                    {{ palabra.palabra }} ({{ palabra.frecuencia }})
                                                                </span>
                                                            {% endfor %}
                                                        </small>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                {% endif %}
                
            </div>
        </div>

        <!-- ========================================
             TAB 6: RESPONSABLES DE SEGUIMIENTO
             ======================================== -->
        <div class="tab-pane fade" id="responsables" role="tabpanel">
            <div class="row">
                
                <!-- Ranking de Responsables -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-trophy-fill"></i> Ranking de Responsables por Volumen</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.ranking_responsables %}
                                {{ graficos.ranking_responsables|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-info-circle"></i> Interpretaci√≥n:</strong>
                                    Este gr√°fico muestra los responsables m√°s activos en enviar cotizaciones.
                                    El color de las barras indica su tasa de aceptaci√≥n:
                                    <span class="badge bg-success">Verde = Alta aceptaci√≥n</span>
                                    <span class="badge bg-warning">Amarillo = Media aceptaci√≥n</span>
                                    <span class="badge bg-danger">Rojo = Baja aceptaci√≥n</span>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes de responsables.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- An√°lisis de Piezas Promedio -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-scatter-chart"></i> Relaci√≥n: Piezas Promedio vs Efectividad</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.piezas_promedio_responsables %}
                                {{ graficos.piezas_promedio_responsables|safe }}
                                <div class="alert alert-warning alert-dashboard mt-3">
                                    <strong><i class="bi bi-graph-up-arrow"></i> Insights:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Tama√±o de burbuja:</strong> Total de cotizaciones enviadas</li>
                                        <li><strong>Color:</strong> Valor total generado en ingresos</li>
                                        <li><strong>Posici√≥n horizontal:</strong> Cantidad promedio de piezas ofrecidas</li>
                                        <li><strong>Posici√≥n vertical:</strong> Tasa de aceptaci√≥n lograda</li>
                                        <li><strong>An√°lisis:</strong> ¬øM√°s piezas = mejor o peor aceptaci√≥n? Este gr√°fico responde esa pregunta</li>
                                    </ul>
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos suficientes para an√°lisis de piezas.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Distribuci√≥n de Resultados -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bar-chart-fill"></i> Distribuci√≥n de Resultados</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.tasas_aceptacion_responsables %}
                                {{ graficos.tasas_aceptacion_responsables|safe }}
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de distribuci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Valor Generado -->
                <div class="col-md-6">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-cash-coin"></i> Valor Generado por Responsable</h5>
                        </div>
                        <div class="card-body">
                            {% if graficos.valor_generado_responsables %}
                                {{ graficos.valor_generado_responsables|safe }}
                                <div class="alert alert-info alert-dashboard mt-3">
                                    <strong><i class="bi bi-lightbulb-fill"></i> An√°lisis:</strong>
                                    Compara el valor <strong>cotizado</strong> (potencial total) 
                                    vs los <strong>ingresos reales</strong> (cotizaciones aceptadas). 
                                    La diferencia muestra oportunidades de mejora.
                                </div>
                            {% else %}
                                <div class="alert alert-info alert-dashboard">
                                    <i class="bi bi-info-circle"></i> No hay datos de valor generado.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ========================================
             TAB 7: MACHINE LEARNING
             ======================================== -->
        <div class="tab-pane fade" id="ml" role="tabpanel">
            <div class="row">
                
                {% if ml_insights.modelo_disponible %}
                
                <!-- Card de Precisi√≥n del Modelo -->
                <div class="col-md-4">
                    <div class="ml-insight-card">
                        <h5><i class="bi bi-cpu"></i> Precisi√≥n del Modelo</h5>
                        <div class="ml-accuracy">{{ ml_insights.accuracy|floatformat:1 }}%</div>
                        <p class="mb-0">
                            El modelo ha sido entrenado con {{ ml_insights.datos_entrenamiento }} cotizaciones 
                            y puede predecir con esta precisi√≥n si una cotizaci√≥n ser√° aceptada o rechazada.
                        </p>
                    </div>
                </div>
                
                <!-- Card de M√©tricas Adicionales -->
                <div class="col-md-4">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up"></i> M√©tricas del Modelo</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Precision:</strong> {{ ml_insights.precision|floatformat:2 }}
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ ml_insights.precision|floatformat:0 }}%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Recall:</strong> {{ ml_insights.recall|floatformat:2 }}
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-info" 
                                         style="width: {{ ml_insights.recall|floatformat:0 }}%"></div>
                                </div>
                            </div>
                            <div>
                                <strong>F1-Score:</strong> {{ ml_insights.f1_score|floatformat:2 }}
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-warning" 
                                         style="width: {{ ml_insights.f1_score|floatformat:0 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Predicci√≥n de Ejemplo -->
                <div class="col-md-4">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-bullseye"></i> Ejemplo de Predicci√≥n</h5>
                        </div>
                        <div class="card-body">
                            {% if ml_insights.prediccion_ejemplo %}
                            <p class="text-muted mb-3">
                                <strong>Orden Cliente:</strong> {{ ml_insights.prediccion_ejemplo.orden_cliente|default:"N/A" }}<br>
                                <small class="text-secondary">Cotizaci√≥n ID: {{ ml_insights.prediccion_ejemplo.cotizacion_id }}</small><br>
                                <strong>Costo:</strong> ${{ ml_insights.prediccion_ejemplo.costo|floatformat:2 }}
                            </p>
                            <div class="mb-3">
                                <strong>Probabilidad de Aceptaci√≥n:</strong>
                                <div class="progress mt-2" style="height: 25px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ ml_insights.prediccion_ejemplo.prob_aceptacion|floatformat:0 }}%">
                                        {{ ml_insights.prediccion_ejemplo.prob_aceptacion|floatformat:1 }}%
                                    </div>
                                </div>
                            </div>
                            <div>
                                <strong>Probabilidad de Rechazo:</strong>
                                <div class="progress mt-2" style="height: 25px;">
                                    <div class="progress-bar bg-danger" 
                                         style="width: {{ ml_insights.prediccion_ejemplo.prob_rechazo|floatformat:0 }}%">
                                        {{ ml_insights.prediccion_ejemplo.prob_rechazo|floatformat:1 }}%
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No hay cotizaciones pendientes para predecir.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sugerencias del Modelo -->
                <div class="col-12">
                    <div class="grafico-card card">
                        <div class="card-header">
                            <h5><i class="bi bi-lightbulb"></i> Sugerencias Basadas en Machine Learning</h5>
                        </div>
                        <div class="card-body">
                            {% if ml_insights.sugerencias %}
                            <div class="row">
                                {% for sugerencia in ml_insights.sugerencias %}
                                <div class="col-md-6 mb-3">
                                    <div class="alert alert-{{ sugerencia.color|default:'success' }} alert-dashboard">
                                        <h6 class="alert-heading">
                                            <span style="font-size: 1.2rem;">{{ sugerencia.icono|default:'üí°' }}</span>
                                            <strong>{{ sugerencia.titulo|default:'Sugerencia' }}</strong>
                                        </h6>
                                        <p class="mb-0">{{ sugerencia.mensaje }}</p>
                                        {% if sugerencia.tipo %}
                                        <small class="text-muted d-block mt-2">
                                            <i class="bi bi-tag"></i> Tipo: {{ sugerencia.tipo|title }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info alert-dashboard">
                                <i class="bi bi-info-circle"></i> No hay sugerencias disponibles en este momento.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- ========================================
                     SECCI√ìN ML AVANZADO (Sistema Experto)
                     ======================================== -->
                
                {% if ml_insights_avanzados.disponible %}
                
                <div class="col-12 mt-4">
                    <hr class="my-4">
                    <h4 class="mb-4">
                        <i class="bi bi-stars"></i> Sistema Experto ML - An√°lisis Avanzado
                        <span class="badge bg-success">NUEVO</span>
                    </h4>
                </div>
                
                <!-- Resumen Ejecutivo -->
                <div class="col-12">
                    {% if ml_insights_avanzados.resumen_ejecutivo.estado_general == 'favorable' %}
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                    {% elif ml_insights_avanzados.resumen_ejecutivo.estado_general == 'moderado' %}
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-white">
                    {% else %}
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                    {% endif %}
                            <h5 class="mb-0">
                                <span style="font-size: 1.5rem;">{{ ml_insights_avanzados.resumen_ejecutivo.estado_icono }}</span>
                                Resumen Ejecutivo - {{ ml_insights_avanzados.resumen_ejecutivo.estado_mensaje }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Probabilidad</h6>
                                        <div class="display-4">{{ ml_insights_avanzados.resumen_ejecutivo.prob_aceptacion|floatformat:0 }}%</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Recomendaciones</h6>
                                        <div class="display-4">{{ ml_insights_avanzados.resumen_ejecutivo.total_recomendaciones }}</div>
                                        <small class="text-danger">{{ ml_insights_avanzados.resumen_ejecutivo.recomendaciones_criticas }} cr√≠ticas</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">ROI Estimado</h6>
                                        <div class="display-6">${{ ml_insights_avanzados.resumen_ejecutivo.roi_esperado|floatformat:0 }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h6 class="text-muted">Motivo Principal</h6>
                                        <div class="h5">{{ ml_insights_avanzados.resumen_ejecutivo.motivo_principal_rechazo }}</div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="alert alert-info mb-0">
                                <strong><i class="bi bi-info-circle"></i> An√°lisis:</strong>
                                {{ ml_insights_avanzados.resumen_ejecutivo.resumen_1_linea }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Alertas Cr√≠ticas -->
                {% if ml_insights_avanzados.analisis_completo.alertas_criticas %}
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle-fill"></i> 
                                Alertas Cr√≠ticas ({{ ml_insights_avanzados.total_alertas }})
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for alerta in ml_insights_avanzados.analisis_completo.alertas_criticas %}
                                <div class="col-md-6 mb-3">
                                    {% if alerta.severidad == 'critica' %}
                                    <div class="alert alert-danger mb-0">
                                    {% else %}
                                    <div class="alert alert-warning mb-0">
                                    {% endif %}
                                        <h6 class="alert-heading">
                                            <span style="font-size: 1.5rem;">{{ alerta.icono }}</span>
                                            <strong>{{ alerta.titulo }}</strong>
                                        </h6>
                                        <p class="mb-2">{{ alerta.mensaje }}</p>
                                        <hr>
                                        <p class="mb-0">
                                            <strong>Acci√≥n Requerida:</strong> {{ alerta.accion_requerida }}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Plan de Acci√≥n Recomendado -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-list-check"></i> 
                                Plan de Acci√≥n Recomendado ({{ ml_insights_avanzados.total_recomendaciones }} acciones)
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for recom in ml_insights_avanzados.analisis_completo.recomendaciones %}
                            <div class="card mb-3 border-{{ recom.color }}">
                                <div class="card-header bg-{{ recom.color }} bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span style="font-size: 1.2rem;">{{ recom.icono }}</span>
                                            <strong>{{ recom.id }}. {{ recom.titulo }}</strong>
                                        </div>
                                        <span class="badge bg-{{ recom.color }}">{{ recom.etiqueta }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">{{ recom.descripcion }}</p>
                                    
                                    <h6><i class="bi bi-arrow-right-circle"></i> Acciones Espec√≠ficas:</h6>
                                    <ul class="mb-3">
                                        {% for accion in recom.acciones %}
                                        <li>{{ accion }}</li>
                                        {% endfor %}
                                    </ul>
                                    
                                    <div class="alert alert-{{ recom.color }} alert-sm mb-0">
                                        <strong>Impacto Esperado:</strong> {{ recom.impacto }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- ========================================
                     AN√ÅLISIS DETALLADO (4 CARDS)
                     ======================================== -->
                <div class="col-12 mt-4 mb-3">
                    <h5>
                        <i class="bi bi-clipboard-data"></i> An√°lisis Detallado de la Cotizaci√≥n
                    </h5>
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <!-- Card 1: Cotizaci√≥n Analizada -->
                    <div class="card h-100 border-primary">
                        <div class="card-header bg-primary bg-opacity-10">
                            <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Informaci√≥n General</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0 small">
                                <dt class="col-5">ID:</dt>
                                <dd class="col-7">{{ ml_insights_avanzados.cotizacion_analizada.id }}</dd>
                                
                                <dt class="col-5">Orden Cliente:</dt>
                                <dd class="col-7"><strong>{{ ml_insights_avanzados.cotizacion_analizada.orden_cliente|default:"N/A" }}</strong></dd>
                                
                                <dt class="col-5">Orden:</dt>
                                <dd class="col-7">{{ ml_insights_avanzados.cotizacion_analizada.orden|default:"N/A" }}</dd>
                                
                                <dt class="col-5">Costo:</dt>
                                <dd class="col-7"><strong>${{ ml_insights_avanzados.cotizacion_analizada.costo_actual|floatformat:0 }}</strong></dd>
                                
                                <dt class="col-5">Piezas:</dt>
                                <dd class="col-7">{{ ml_insights_avanzados.cotizacion_analizada.total_piezas }}</dd>
                                
                                <dt class="col-5">Gama:</dt>
                                <dd class="col-7">
                                    {% if ml_insights_avanzados.cotizacion_analizada.gama == 'alta' %}
                                    <span class="badge bg-success">ALTA</span>
                                    {% elif ml_insights_avanzados.cotizacion_analizada.gama == 'media' %}
                                    <span class="badge bg-warning">MEDIA</span>
                                    {% else %}
                                    <span class="badge bg-secondary">BAJA</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                
                {% if ml_insights_avanzados.motivo_predicho %}
                <div class="col-md-6 col-lg-3">
                    <!-- Card 2: Motivo Probable de Rechazo -->
                    <div class="card h-100 border-danger">
                        <div class="card-header bg-danger bg-opacity-10">
                            <h6 class="mb-0"><i class="bi bi-search"></i> Motivo Probable</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <h6 class="text-danger mb-2">
                                    {{ ml_insights_avanzados.motivo_predicho.confianza_icono|default:"‚ùì" }} 
                                    {{ ml_insights_avanzados.motivo_predicho.motivo_nombre }}
                                </h6>
                                <div class="progress mb-2" style="height: 22px;">
                                    <div class="progress-bar bg-danger" 
                                         role="progressbar"
                                         style="width: {{ ml_insights_avanzados.motivo_predicho.probabilidad }}%"
                                         aria-valuenow="{{ ml_insights_avanzados.motivo_predicho.probabilidad }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        {{ ml_insights_avanzados.motivo_predicho.probabilidad|floatformat:1 }}%
                                    </div>
                                </div>
                                <small class="badge 
                                    {% if ml_insights_avanzados.motivo_predicho.confianza == 'alta' %}bg-success
                                    {% elif ml_insights_avanzados.motivo_predicho.confianza == 'media' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    Confianza: {{ ml_insights_avanzados.motivo_predicho.confianza|title }}
                                </small>
                            </div>
                            
                            <p class="small text-muted mb-2">{{ ml_insights_avanzados.motivo_predicho.descripcion|truncatewords:20 }}</p>
                            
                            {% if ml_insights_avanzados.motivo_predicho.acciones %}
                            <div class="small">
                                <strong>üí° Acciones Sugeridas:</strong>
                                <ul class="mb-0 ps-3">
                                    {% for accion in ml_insights_avanzados.motivo_predicho.acciones|slice:":2" %}
                                    <li class="text-muted">{{ accion|truncatewords:12 }}</li>
                                    {% empty %}
                                    <li class="text-muted">Sin acciones espec√≠ficas</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if ml_insights_avanzados.optimizacion %}
                <div class="col-md-6 col-lg-3">
                    <!-- Card 3: Optimizaci√≥n de Precio -->
                    <div class="card h-100 border-success">
                        <div class="card-header bg-success bg-opacity-10">
                            <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Optimizaci√≥n</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Actual</small>
                                    <h6 class="text-danger mb-0">${{ ml_insights_avanzados.optimizacion.costo_actual|floatformat:0 }}</h6>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">√ìptimo</small>
                                    <h6 class="text-success mb-0">${{ ml_insights_avanzados.optimizacion.costo_optimo|floatformat:0 }}</h6>
                                </div>
                            </div>
                            
                            <div class="alert alert-success alert-sm mb-2 py-2 px-2">
                                <small>
                                    <strong>Mejora:</strong><br>
                                    +${{ ml_insights_avanzados.optimizacion.mejora_ingreso|floatformat:0 }} ingreso<br>
                                    +{{ ml_insights_avanzados.optimizacion.mejora_probabilidad|floatformat:1 }}% probabilidad
                                </small>
                            </div>
                            
                            <div class="small">
                                <strong>Escenario:</strong>
                                <ul class="mb-0 ps-3">
                                    <li>M.O.: {{ ml_insights_avanzados.optimizacion.escenario_optimo.desc_mano_obra_pct|floatformat:0 }}% desc.</li>
                                    <li>Piezas: {{ ml_insights_avanzados.optimizacion.escenario_optimo.desc_piezas_pct|floatformat:0 }}% desc.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if ml_insights_avanzados.temporal %}
                <div class="col-md-6 col-lg-3">
                    <!-- Card 4: An√°lisis Temporal -->
                    <div class="card h-100 border-info">
                        <div class="card-header bg-info bg-opacity-10">
                            <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Timing √ìptimo</h6>
                        </div>
                        <div class="card-body">
                            {% if ml_insights_avanzados.temporal.es_dia_optimo %}
                            <div class="alert alert-success alert-sm py-2 px-2 mb-2">
                                <small>
                                    <i class="bi bi-check-circle-fill"></i> <strong>HOY es buen d√≠a</strong>
                                </small>
                            </div>
                            {% else %}
                            <div class="alert alert-warning alert-sm py-2 px-2 mb-2">
                                <small>
                                    <i class="bi bi-clock-history"></i> <strong>Espera mejor momento</strong>
                                </small>
                            </div>
                            {% endif %}
                            
                            <p class="small mb-3">{{ ml_insights_avanzados.temporal.mensaje|truncatewords:12 }}</p>
                            
                            <div class="row text-center">
                                <div class="col-6">
                                    <small class="text-muted d-block">Hoy</small>
                                    <h6 class="mb-1">{{ ml_insights_avanzados.temporal.dia_hoy }}</h6>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Mejor</small>
                                    <h6 class="mb-1">{{ ml_insights_avanzados.temporal.mejor_dia }}</h6>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" style="width: 100%"></div>
                                    </div>
                                    <small class="text-success">+{{ ml_insights_avanzados.temporal.mejora_potencial|floatformat:0 }}%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- ========================================
                     VISUALIZACIONES ML AVANZADAS (GRID 2x2)
                     ======================================== -->
                <div class="col-12 mt-4">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up"></i> Visualizaciones Anal√≠ticas Avanzadas
                    </h5>
                </div>
                
                <!-- Grid 2x2 de Gr√°ficos Principales -->
                <div class="col-md-6">
                    <!-- Gr√°fico 1: Comparaci√≥n de Escenarios de Precio -->
                    {% if graficos.ml_escenarios_precio %}
                    <div class="grafico-card card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-currency-dollar"></i> 
                                Escenarios de Precio
                            </h6>
                        </div>
                        <div class="card-body">
                            {{ graficos.ml_escenarios_precio|safe }}
                        </div>
                    </div>
                    {% else %}
                    <div class="grafico-card card h-100">
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> Gr√°fico no disponible
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <!-- Gr√°fico 2: Matriz Riesgo-Beneficio -->
                    {% if graficos.ml_matriz_riesgo %}
                    <div class="grafico-card card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-grid-3x3"></i> 
                                Matriz Riesgo-Beneficio
                            </h6>
                        </div>
                        <div class="card-body">
                            {{ graficos.ml_matriz_riesgo|safe }}
                        </div>
                    </div>
                    {% else %}
                    <div class="grafico-card card h-100">
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> Gr√°fico no disponible
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mt-3">
                    <!-- Gr√°fico 3: Probabilidad por D√≠a -->
                    {% if graficos.ml_probabilidad_dia %}
                    <div class="grafico-card card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-calendar-week"></i> 
                                Probabilidad por D√≠a
                            </h6>
                        </div>
                        <div class="card-body">
                            {{ graficos.ml_probabilidad_dia|safe }}
                        </div>
                    </div>
                    {% else %}
                    <div class="grafico-card card h-100">
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> Gr√°fico no disponible
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mt-3">
                    <!-- Gr√°fico 4: Factores Influyentes (movido aqu√≠) -->
                    {% if graficos.factores_influyentes %}
                    <div class="grafico-card card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-bar-chart-line"></i> 
                                Factores Influyentes
                            </h6>
                        </div>
                        <div class="card-body">
                            {{ graficos.factores_influyentes|safe }}
                        </div>
                    </div>
                    {% else %}
                    <div class="grafico-card card h-100">
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> Gr√°fico no disponible
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Interpretaciones de los Gr√°ficos -->
                <div class="col-12 mt-3">
                    <div class="card border-info">
                        <div class="card-header bg-info bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="bi bi-lightbulb"></i> Interpretaci√≥n de Visualizaciones
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <strong><i class="bi bi-currency-dollar text-primary"></i> Escenarios de Precio:</strong>
                                    <p class="mb-0 text-muted small">
                                        Compara 4 escenarios de precios. El <strong>√ìptimo</strong> maximiza 
                                        el ingreso esperado balanceando costo y probabilidad de aceptaci√≥n.
                                    </p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong><i class="bi bi-grid-3x3 text-success"></i> Matriz Riesgo-Beneficio:</strong>
                                    <p class="mb-0 text-muted small">
                                        Cuadrante <strong class="text-success">superior-derecho</strong>: alto beneficio, bajo riesgo (PRIORITARIO). 
                                        <strong class="text-danger">Inferior-izquierdo</strong>: evitar.
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <strong><i class="bi bi-calendar-week text-warning"></i> Probabilidad por D√≠a:</strong>
                                    <p class="mb-0 text-muted small">
                                        <strong class="text-success">Lunes-Martes</strong> son los mejores d√≠as (+12-15%). 
                                        Evita <strong class="text-danger">viernes y fin de semana</strong>.
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <strong><i class="bi bi-bar-chart-line text-danger"></i> Factores Influyentes:</strong>
                                    <p class="mb-0 text-muted small">
                                        Los factores con mayor importancia influyen m√°s en la decisi√≥n. 
                                        Usa esta info para optimizar futuras cotizaciones.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% endif %}
                <!-- FIN SECCI√ìN ML AVANZADO -->
                
                {% else %}
                
                <!-- Modelo No Disponible -->
                <div class="col-12">
                    <div class="alert alert-warning alert-dashboard">
                        <h5 class="alert-heading">
                            <i class="bi bi-exclamation-triangle"></i> Machine Learning No Disponible
                        </h5>
                        <p class="mb-0">
                            El modelo de predicci√≥n requiere un m√≠nimo de <strong>20 cotizaciones con respuesta</strong> 
                            (aceptadas o rechazadas) para poder entrenarse. Actualmente hay 
                            <strong>{{ ml_insights.datos_disponibles|default:0 }}</strong> cotizaciones con respuesta.
                        </p>
                        <hr>
                        <p class="mb-0">
                            <i class="bi bi-info-circle"></i> 
                            A medida que se registren m√°s cotizaciones, el modelo se entrenar√° autom√°ticamente 
                            y las predicciones estar√°n disponibles.
                        </p>
                    </div>
                </div>
                
                {% endif %}
                
            </div>
        </div>
        
    </div>
    
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border spinner-border-lg text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos del dashboard...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- TypeScript compilado del dashboard -->
<script src="{% static 'js/dashboard_cotizaciones.js' %}" defer></script>
{% endblock %}
