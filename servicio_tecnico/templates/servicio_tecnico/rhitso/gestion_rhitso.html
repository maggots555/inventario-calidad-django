{% extends 'base.html' %}
{% load static %}
{% load rhitso_filters %}

{% block title %}RHITSO - Orden {{ orden.detalle_equipo.orden_cliente|default:orden.numero_orden_interno }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- CSS Espec√≠fico para el m√≥dulo RHITSO -->
<link rel="stylesheet" href="{% static 'css/servicio_tecnico.css' %}?v=6.6">
<link rel="stylesheet" href="{% static 'css/rhitso.css' %}?v=2.3">
<link rel="stylesheet" href="{% static 'css/lightbox_galeria.css' %}?v=1.0">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <!-- ============================================================ -->
    <!-- ENCABEZADO CON INFORMACI√ìN PRINCIPAL - MEJORADO (FASE 7.2) -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div class="mb-2 mb-md-0">
                            <h2 class="mb-2">
                                <i class="bi bi-gear-wide-connected text-primary"></i> 
                                <strong>Seguimiento RHITSO</strong>
                            </h2>
                            <p class="mb-2">
                                <span class="text-muted">Orden Cliente:</span> 
                                <span class="badge bg-dark fs-6">{{ orden.detalle_equipo.orden_cliente|default:"No especificada" }}</span>
                                <span class="text-muted small">(Interna: {{ orden.numero_orden_interno }})</span>
                                {% if estado_rhitso_info %}
                                    <span class="badge rhitso-badge" style="background-color: {{ estado_rhitso_info.estado|color_estado_especifico }}; color: {{ estado_rhitso_info.estado|color_estado_especifico|text_color_for_bg }};">
                                        {{ estado_rhitso_info.estado_display }}
                                    </span>
                                {% endif %}
                            </p>
                            <p class="text-muted mb-0 small">
                                <i class="bi bi-calendar-event"></i> 
                                <strong>Ingreso:</strong> {{ orden.fecha_ingreso|date:"d/m/Y H:i" }}
                                {% if orden.fecha_envio_rhitso %}
                                    | <i class="bi bi-send"></i> <strong>Env√≠o RHITSO:</strong> {{ orden.fecha_envio_rhitso|date:"d/m/Y H:i" }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <a href="{% url 'servicio_tecnico:detalle_orden' orden.id %}" class="btn btn-outline-primary me-2" title="Ver detalles completos de la orden">
                                <i class="bi bi-eye"></i> Vista General
                            </a>
                            <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-outline-secondary" title="Volver al listado de √≥rdenes">
                                <i class="bi bi-arrow-left"></i> Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 1: INFORMACI√ìN DEL EQUIPO -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header">
                    <i class="bi bi-laptop"></i>
                    <span>Informaci√≥n del Equipo</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2">
                                <strong><i class="bi bi-tag-fill text-primary"></i> Marca:</strong> 
                                <span class="text-dark">{{ equipo_info.marca }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="bi bi-laptop text-primary"></i> Modelo:</strong> 
                                <span class="text-dark">{{ equipo_info.modelo }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="bi bi-upc-scan text-primary"></i> N¬∞ Serie:</strong> 
                                <span class="text-dark">{{ equipo_info.numero_serie }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="bi bi-building text-primary"></i> Sucursal:</strong> 
                                <span class="text-dark">{{ equipo_info.sucursal }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2">
                                <strong><i class="bi bi-calendar-event text-success"></i> Fecha Ingreso:</strong> 
                                <span class="text-dark">{{ equipo_info.fecha_ingreso|date:"d/m/Y H:i" }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="bi bi-info-circle text-info"></i> Estado General:</strong> 
                                <span class="badge bg-info">{{ equipo_info.estado_orden }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="bi bi-receipt text-warning"></i> Orden de Cliente:</strong> 
                                <span class="text-dark">{{ equipo_info.orden_cliente }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="bi bi-plug text-success"></i> N¬∞ Serie Cargador:</strong> 
                                <span class="text-dark">{{ equipo_info.numero_serie_cargador }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 2: ESTADO RHITSO ACTUAL - MEJORADO (FASE 7.4) -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header">
                    <i class="bi bi-activity"></i>
                    <span>Estado RHITSO Actual</span>
                </div>
                <div class="card-body">
                    {% if estado_rhitso_info %}
                        <!-- Barra de Progreso Visual -->
                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted">PROGRESO DEL PROCESO RHITSO</label>
                            <div class="progress" style="height: 35px; border-radius: 10px;">
                                {% with orden_estado=estado_rhitso_info.orden %}
                                    {# Calcular porcentaje real basado en 32 estados totales #}
                                    {% widthratio orden_estado 32 100 as porcentaje %}
                                    
                                    {# Determinar color y fase seg√∫n el n√∫mero de estado #}
                                    {% if orden_estado <= 11 %}
                                        <!-- Fase 1: Estados SIC (1-11) - Azul -->
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ porcentaje }}%;" 
                                             aria-valuenow="{{ porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                                            <strong>Fase SIC: {{ porcentaje }}%</strong> (Estado {{ orden_estado }}/32)
                                        </div>
                                    {% elif orden_estado <= 24 %}
                                        <!-- Fase 2: Estados RHITSO (12-24) - P√∫rpura -->
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ porcentaje }}%; background-color: #6610f2;" 
                                             aria-valuenow="{{ porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                                            <strong>Fase RHITSO: {{ porcentaje }}%</strong> (Estado {{ orden_estado }}/32)
                                        </div>
                                    {% elif orden_estado <= 28 %}
                                        <!-- Fase 3: Estados CLIENTE (25-28) - Amarillo -->
                                        <div class="progress-bar bg-warning text-dark" role="progressbar" 
                                             style="width: {{ porcentaje }}%;" 
                                             aria-valuenow="{{ porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                                            <strong>Esperando Cliente: {{ porcentaje }}%</strong> (Estado {{ orden_estado }}/32)
                                        </div>
                                    {% elif orden_estado <= 31 %}
                                        <!-- Fase 4: Estados COMPRAS (29-31) - Naranja -->
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ porcentaje }}%; background-color: #fd7e14;" 
                                             aria-valuenow="{{ porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                                            <strong>Esperando Compras: {{ porcentaje }}%</strong> (Estado {{ orden_estado }}/32)
                                        </div>
                                    {% else %}
                                        <!-- Fase 5: CERRADO (32) - Verde -->
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: 100%;" 
                                             aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                            <strong>‚úÖ COMPLETADO: 100%</strong> (Estado 32/32)
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-info-circle"></i> 
                                La barra muestra el progreso basado en la numeraci√≥n de estados (1 a 32)
                            </small>
                        </div>
                        
                        <!-- Informaci√≥n del Estado Actual -->
                        <div class="row align-items-center mb-3">
                            <div class="col-md-8">
                                <h4 class="mb-3">
                                    <span class="badge rhitso-badge" style="background-color: {{ estado_rhitso_info.estado|color_estado_especifico }}; color: {{ estado_rhitso_info.estado|color_estado_especifico|text_color_for_bg }}; font-size: 1.1rem;">
                                        {{ estado_rhitso_info.estado_display }}
                                    </span>
                                    <!-- Badge de Responsable (Owner) -->
                                    {% if estado_rhitso_info.owner == 'SIC' %}
                                        <span class="badge bg-info ms-2" title="Responsable actual">
                                            <i class="bi bi-person-fill"></i> En manos de SIC
                                        </span>
                                    {% elif estado_rhitso_info.owner == 'RHITSO' %}
                                        <span class="badge bg-primary ms-2" title="Responsable actual">
                                            <i class="bi bi-building"></i> En manos de RHITSO
                                        </span>
                                    {% elif estado_rhitso_info.owner == 'CLIENTE' %}
                                        <span class="badge bg-warning text-dark ms-2" title="Responsable actual">
                                            <i class="bi bi-person-check"></i> Pendiente de Cliente
                                        </span>
                                    {% endif %}
                                </h4>
                                
                                <!-- Informaci√≥n de Fechas -->
                                <div class="mb-2">
                                    {% if orden.fecha_envio_rhitso %}
                                        <p class="mb-1">
                                            <i class="bi bi-send text-primary"></i>
                                            <strong>Fecha de Env√≠o:</strong> {{ orden.fecha_envio_rhitso|date:"d/m/Y H:i" }}
                                        </p>
                                    {% endif %}
                                    {% if orden.fecha_recepcion_rhitso %}
                                        <p class="mb-1">
                                            <i class="bi bi-box-arrow-in-down text-success"></i>
                                            <strong>Fecha de Recepci√≥n:</strong> {{ orden.fecha_recepcion_rhitso|date:"d/m/Y H:i" }}
                                        </p>
                                    {% endif %}
                                </div>
                                
                                <!-- Observaciones del Estado Actual -->
                                {% if ultimo_seguimiento_rhitso and ultimo_seguimiento_rhitso.observaciones %}
                                    <div class="alert alert-light border-start border-primary border-4 mt-3">
                                        <small class="text-muted fw-bold d-block mb-2">
                                            <i class="bi bi-chat-square-text"></i> OBSERVACIONES DEL ESTADO ACTUAL
                                        </small>
                                        <p class="mb-0">
                                            {{ ultimo_seguimiento_rhitso.observaciones }}
                                        </p>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-event"></i> {{ ultimo_seguimiento_rhitso.fecha_actualizacion|date:"d/m/Y H:i" }}
                                            {% if ultimo_seguimiento_rhitso.usuario_actualizacion %}
                                                - <i class="bi bi-person"></i> {{ ultimo_seguimiento_rhitso.usuario_actualizacion.nombre_completo|default:ultimo_seguimiento_rhitso.usuario_actualizacion }}
                                            {% endif %}
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <!-- D√≠as en RHITSO -->
                                <div class="text-center p-3 bg-light rounded mb-3">
                                    <h2 class="mb-0 text-primary">
                                        {% if estado_rhitso_info.dias %}
                                            {{ estado_rhitso_info.dias }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </h2>
                                    <small class="text-muted">D√çAS EN RHITSO</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alerta de D√≠as -->
                        {% if estado_rhitso_info.tiene_alerta %}
                            <div class="alert {% if estado_rhitso_info.dias > estado_rhitso_info.dias_alerta|add:3 %}alert-dias-rhitso critico{% else %}alert-dias-rhitso{% endif %} mb-3">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <strong>¬°Atenci√≥n!</strong>
                                {% if estado_rhitso_info.dias > estado_rhitso_info.dias_alerta|add:3 %}
                                    La orden lleva <strong>{{ estado_rhitso_info.dias }} d√≠as</strong> en RHITSO. Se ha superado el umbral cr√≠tico de {{ estado_rhitso_info.dias_alerta }} d√≠as.
                                {% else %}
                                    La orden est√° cerca de superar el umbral de {{ estado_rhitso_info.dias_alerta }} d√≠as permitidos en RHITSO.
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <!-- Botones de Acci√≥n -->
                        <div class="mt-4 d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#formCambiarEstado">
                                <i class="bi bi-arrow-repeat"></i> Actualizar Estado RHITSO
                            </button>
                            
                            <button class="btn btn-success btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#modalEnviarRHITSO" title="Enviar correo a RHITSO con datos del equipo">
                                <i class="bi bi-envelope"></i> üìß Enviar correo y formato
                            </button>
                        </div>
                        
                        <!-- Formulario para Cambiar Estado (Collapse) -->
                        <div class="collapse mt-3" id="formCambiarEstado">
                            <div class="card card-body">
                                <form method="post" action="{% url 'servicio_tecnico:actualizar_estado_rhitso' orden.id %}" id="formActualizarEstado">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            {{ form_estado.estado_rhitso.label_tag }}
                                            {{ form_estado.estado_rhitso }}
                                            {% if form_estado.estado_rhitso.help_text %}
                                                <small class="form-text text-muted">{{ form_estado.estado_rhitso.help_text }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            {{ form_estado.notificar_cliente.label_tag }}
                                            <div class="form-check">
                                                {{ form_estado.notificar_cliente }}
                                            </div>
                                            {% if form_estado.notificar_cliente.help_text %}
                                                <small class="form-text text-muted">{{ form_estado.notificar_cliente.help_text }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        {{ form_estado.observaciones.label_tag }}
                                        {{ form_estado.observaciones }}
                                        {% if form_estado.observaciones.help_text %}
                                            <small class="form-text text-muted">{{ form_estado.observaciones.help_text }}</small>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Campos de Fechas RHITSO (EXCLUSIVAMENTE MANUALES) -->
                                    <div class="alert alert-info border-start border-info border-4 mb-3">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Importante:</strong> Las fechas de env√≠o y recepci√≥n son <strong>exclusivamente manuales</strong>. 
                                        Ingresa la fecha exacta cuando ocurra el evento real. No se registran autom√°ticamente al cambiar el estado.
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            {{ form_estado.fecha_envio_rhitso.label_tag }}
                                            {{ form_estado.fecha_envio_rhitso }}
                                            {% if form_estado.fecha_envio_rhitso.help_text %}
                                                <small class="form-text text-muted">{{ form_estado.fecha_envio_rhitso.help_text }}</small>
                                            {% endif %}
                                            {% if orden.fecha_envio_rhitso %}
                                                <small class="text-success d-block mt-1">
                                                    <i class="bi bi-check-circle"></i> Registrada: {{ orden.fecha_envio_rhitso|date:"d/m/Y H:i" }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted d-block mt-1">
                                                    <i class="bi bi-clock-history"></i> A√∫n no registrada - Ingr√©sala manualmente cuando env√≠es el equipo
                                                </small>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            {{ form_estado.fecha_recepcion_rhitso.label_tag }}
                                            {{ form_estado.fecha_recepcion_rhitso }}
                                            {% if form_estado.fecha_recepcion_rhitso.help_text %}
                                                <small class="form-text text-muted">{{ form_estado.fecha_recepcion_rhitso.help_text }}</small>
                                            {% endif %}
                                            {% if orden.fecha_recepcion_rhitso %}
                                                <small class="text-success d-block mt-1">
                                                    <i class="bi bi-check-circle"></i> Registrada: {{ orden.fecha_recepcion_rhitso|date:"d/m/Y H:i" }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted d-block mt-1">
                                                    <i class="bi bi-clock-history"></i> A√∫n no registrada - Ingr√©sala manualmente cuando regrese el equipo
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i> Actualizar Estado
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#formCambiarEstado">
                                        Cancelar
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">No hay informaci√≥n de estado RHITSO disponible.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 3: DIAGN√ìSTICO SIC - MEJORADO (FASE 7.5) -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header">
                    <i class="bi bi-file-medical"></i>
                    <span>Diagn√≥stico SIC (Servicio Interno de Calidad)</span>
                </div>
                <div class="card-body">
                    {% if diagnostico_info %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong><i class="bi bi-person-check text-success"></i> T√©cnico Responsable Orden:</strong> 
                                    {% if orden.tecnico_asignado_actual %}
                                        <span class="badge bg-success">{{ orden.tecnico_asignado_actual.nombre_completo }}</span>
                                    {% else %}
                                        <span class="text-muted">No asignado</span>
                                    {% endif %}
                                </p>
                                <p class="mb-2">
                                    <strong><i class="bi bi-stethoscope text-primary"></i> T√©cnico que Diagnostic√≥ RHITSO:</strong> 
                                    {% if diagnostico_info.tecnico %}
                                        <span class="badge bg-info">{{ diagnostico_info.tecnico.nombre_completo|default:diagnostico_info.tecnico }}</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-exclamation-triangle"></i> Pendiente asignar
                                        </span>
                                    {% endif %}
                                </p>
                                <p class="mb-2">
                                    <strong><i class="bi bi-calendar-check text-info"></i> Fecha Diagn√≥stico:</strong> 
                                    {% if diagnostico_info.fecha_diagnostico %}
                                        {{ diagnostico_info.fecha_diagnostico|date:"d/m/Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">No registrada</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong><i class="bi bi-exclamation-circle text-warning"></i> Motivo RHITSO:</strong> 
                                    <span class="badge bg-warning text-dark">{{ diagnostico_info.motivo_rhitso }}</span>
                                </p>
                                <p class="mb-2">
                                    <strong><i class="bi bi-speedometer2"></i> Complejidad Estimada:</strong> 
                                    <span class="badge" style="background-color: {{ diagnostico_info.complejidad_code|color_complejidad }}; color: {{ diagnostico_info.complejidad_code|color_complejidad|text_color_for_bg }};">
                                        {% if diagnostico_info.complejidad_code == 'BAJA' %}
                                            <i class="bi bi-check-circle"></i>
                                        {% elif diagnostico_info.complejidad_code == 'MEDIA' %}
                                            <i class="bi bi-info-circle"></i>
                                        {% elif diagnostico_info.complejidad_code == 'ALTA' %}
                                            <i class="bi bi-exclamation-triangle"></i>
                                        {% elif diagnostico_info.complejidad_code == 'CRITICA' %}
                                            <i class="bi bi-x-octagon"></i>
                                        {% endif %}
                                        {{ diagnostico_info.complejidad }}
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Info Box: Diferencia entre los t√©cnicos -->
                        <div class="alert alert-light border-start border-info border-4 mb-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                <strong>Nota:</strong> El <em>T√©cnico Responsable</em> gestiona toda la orden. 
                                El <em>T√©cnico que Diagnostic√≥</em> es quien determin√≥ que el equipo necesita RHITSO 
                                (pueden ser la misma persona o diferentes).
                            </small>
                        </div>
                        
                        <!-- Diagn√≥stico SIC Completo -->
                        {% if diagnostico_info.diagnostico_sic %}
                            <div class="mb-3">
                                <strong><i class="bi bi-clipboard-pulse"></i> Diagn√≥stico SIC Completo:</strong>
                                <div class="p-3 mt-2 border rounded bg-light">
                                    {{ diagnostico_info.diagnostico_sic }}
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Descripci√≥n Detallada RHITSO -->
                        {% if diagnostico_info.descripcion_rhitso %}
                            <div class="mb-3">
                                <strong><i class="bi bi-text-paragraph"></i> Descripci√≥n Detallada para RHITSO:</strong>
                                <div class="p-3 mt-2 border-start border-primary border-4 bg-light">
                                    {{ diagnostico_info.descripcion_rhitso }}
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Formulario para Editar Diagn√≥stico SIC -->
                        <div class="mt-4">
                            <button class="btn btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#formEditarDiagnostico">
                                <i class="bi bi-pencil"></i> ‚úèÔ∏è Editar Diagn√≥stico SIC
                            </button>
                            
                            <div class="collapse mt-3" id="formEditarDiagnostico">
                                <div class="card card-body bg-light">
                                    <form method="post" action="{% url 'servicio_tecnico:editar_diagnostico_sic' orden.id %}" id="formEditarDiagnosticoSIC">
                                        {% csrf_token %}
                                        
                                        <!-- Diagn√≥stico SIC (DetalleEquipo) -->
                                        <div class="mb-3">
                                            {{ form_diagnostico.diagnostico_sic.label_tag }}
                                            {{ form_diagnostico.diagnostico_sic }}
                                            {% if form_diagnostico.diagnostico_sic.help_text %}
                                                <small class="form-text text-muted d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> {{ form_diagnostico.diagnostico_sic.help_text }}
                                                </small>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Motivo RHITSO (OrdenServicio) -->
                                        <div class="mb-3">
                                            {{ form_diagnostico.motivo_rhitso.label_tag }}
                                            {{ form_diagnostico.motivo_rhitso }}
                                            {% if form_diagnostico.motivo_rhitso.help_text %}
                                                <small class="form-text text-muted d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> {{ form_diagnostico.motivo_rhitso.help_text }}
                                                </small>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Descripci√≥n Detallada RHITSO (OrdenServicio) -->
                                        <div class="mb-3">
                                            {{ form_diagnostico.descripcion_rhitso.label_tag }}
                                            {{ form_diagnostico.descripcion_rhitso }}
                                            {% if form_diagnostico.descripcion_rhitso.help_text %}
                                                <small class="form-text text-muted d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> {{ form_diagnostico.descripcion_rhitso.help_text }}
                                                </small>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Complejidad y T√©cnico -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                {{ form_diagnostico.complejidad_estimada.label_tag }}
                                                {{ form_diagnostico.complejidad_estimada }}
                                                {% if form_diagnostico.complejidad_estimada.help_text %}
                                                    <small class="form-text text-muted d-block mt-1">
                                                        <i class="bi bi-info-circle"></i> {{ form_diagnostico.complejidad_estimada.help_text }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                {{ form_diagnostico.tecnico_diagnostico.label_tag }}
                                                {{ form_diagnostico.tecnico_diagnostico }}
                                                {% if form_diagnostico.tecnico_diagnostico.help_text %}
                                                    <small class="form-text text-muted d-block mt-1">
                                                        <i class="bi bi-info-circle"></i> {{ form_diagnostico.tecnico_diagnostico.help_text }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-check-circle"></i> Guardar Cambios
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#formEditarDiagnostico">
                                            Cancelar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            No hay diagn√≥stico SIC registrado a√∫n.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 4: HISTORIAL DE SEGUIMIENTO - CON TABS (FASE 8.1-8.3) -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header">
                    <i class="bi bi-clock-history"></i>
                    <span>Historial de Actividad RHITSO</span>
                </div>
                <div class="card-body">
                    <!-- TABS DE BOOTSTRAP -->
                    <ul class="nav nav-tabs mb-3" id="historialTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cambios-manuales-tab" data-bs-toggle="tab" 
                                    data-bs-target="#cambios-manuales" type="button" role="tab">
                                <i class="bi bi-person-check-fill"></i> üë§ Cambios Manuales (Usuario)
                                <span class="badge bg-primary ms-1">{{ seguimientos_manuales.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cambios-sistema-tab" data-bs-toggle="tab" 
                                    data-bs-target="#cambios-sistema" type="button" role="tab">
                                <i class="bi bi-robot"></i> ‚öôÔ∏è Cambios Autom√°ticos (Sistema)
                                <span class="badge bg-secondary ms-1">{{ seguimientos_sistema.count }}</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- CONTENIDO DE LOS TABS -->
                    <div class="tab-content" id="historialTabsContent">
                        
                        <!-- TAB 1: CAMBIOS MANUALES (REGISTRADOS POR USUARIOS) -->
                        <div class="tab-pane fade show active" id="cambios-manuales" role="tabpanel">
                            <div class="alert alert-primary border-start border-primary border-4 mb-3">
                                <i class="bi bi-person-check-fill"></i>
                                <strong>Informaci√≥n:</strong> Esta secci√≥n muestra cambios de estado registrados <strong>manualmente por usuarios</strong> usando el formulario "Actualizar Estado RHITSO". Incluyen observaciones detalladas y contexto adicional.
                            </div>
                            
                            {% if seguimientos_manuales %}
                                <div class="timeline">
                                    {% for seguimiento in seguimientos_manuales %}
                                        <div class="timeline-item">
                                            <div class="timeline-icon manual" style="background-color: {{ seguimiento.estado.estado|color_estado_especifico }};">
                                                <i class="bi bi-person-check-fill"></i>
                                            </div>
                                            <div class="timeline-content">
                                                <div class="card mb-2 border-start border-primary" style="border-left-width: 4px !important;">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div>
                                                                <h6 class="mb-1">
                                                                    <span class="badge" style="background-color: {{ seguimiento.estado.estado|color_estado_especifico }}; color: {{ seguimiento.estado.estado|color_estado_especifico|text_color_for_bg }};">
                                                                        {{ seguimiento.estado.descripcion }}
                                                                    </span>
                                                                    <!-- Badge de Owner -->
                                                                    {% if seguimiento.estado.owner == 'SIC' %}
                                                                        <span class="badge bg-info ms-1">SIC</span>
                                                                    {% elif seguimiento.estado.owner == 'RHITSO' %}
                                                                        <span class="badge bg-primary ms-1">RHITSO</span>
                                                                    {% elif seguimiento.estado.owner == 'CLIENTE' %}
                                                                        <span class="badge bg-warning text-dark ms-1">CLIENTE</span>
                                                                    {% endif %}
                                                                </h6>
                                                                <small class="text-muted">
                                                                    <i class="bi bi-calendar3"></i> {{ seguimiento.fecha_actualizacion|date:"d/m/Y H:i" }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                        
                                                        {% if seguimiento.estado_anterior %}
                                                            <p class="mb-2">
                                                                <strong>Cambio:</strong> 
                                                                <span class="badge bg-secondary">{{ seguimiento.estado_anterior }}</span>
                                                                <i class="bi bi-arrow-right mx-2"></i>
                                                                <span class="badge" style="background-color: {{ seguimiento.estado.estado|color_estado_especifico }}; color: {{ seguimiento.estado.estado|color_estado_especifico|text_color_for_bg }};">{{ seguimiento.estado.estado }}</span>
                                                            </p>
                                                        {% endif %}
                                                        
                                                        {% if seguimiento.observaciones %}
                                                            <div class="alert alert-light mb-2">
                                                                <strong><i class="bi bi-chat-square-text"></i> Observaciones:</strong>
                                                                <p class="mb-0 mt-1">{{ seguimiento.observaciones }}</p>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            {% if seguimiento.usuario_actualizacion %}
                                                                <small class="text-muted">
                                                                    <i class="bi bi-person-fill text-primary"></i> 
                                                                    <strong>{{ seguimiento.usuario_actualizacion.nombre_completo|default:seguimiento.usuario_actualizacion }}</strong>
                                                                </small>
                                                            {% else %}
                                                                <small class="text-muted">
                                                                    <i class="bi bi-person-fill"></i> Usuario no disponible
                                                                </small>
                                                            {% endif %}
                                                            {% if seguimiento.tiempo_en_estado_anterior %}
                                                                <span class="badge bg-info">
                                                                    ‚è±Ô∏è {{ seguimiento.tiempo_en_estado_anterior }} d√≠a{{ seguimiento.tiempo_en_estado_anterior|pluralize }} en estado anterior
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-2 fw-bold">No hay cambios manuales registrados a√∫n.</p>
                                    <p class="small">Los cambios aparecer√°n aqu√≠ cuando un usuario actualice el estado RHITSO usando el formulario "Actualizar Estado RHITSO".</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- TAB 2: CAMBIOS AUTOM√ÅTICOS (SISTEMA) -->
                        <div class="tab-pane fade" id="cambios-sistema" role="tabpanel">
                            <div class="alert alert-secondary border-start border-secondary border-4 mb-3">
                                <i class="bi bi-robot"></i>
                                <strong>Informaci√≥n:</strong> Esta secci√≥n muestra cambios <strong>autom√°ticos detectados por el sistema</strong> mediante signals. Son cambios program√°ticos sin intervenci√≥n directa del usuario.
                            </div>
                            
                            {% if seguimientos_sistema %}
                                <div class="timeline">
                                    {% for seguimiento in seguimientos_sistema %}
                                        <div class="timeline-item">
                                            <div class="timeline-icon sistema" style="background-color: #6c757d;">
                                                <i class="bi bi-robot"></i>
                                            </div>
                                            <div class="timeline-content">
                                                <div class="card mb-2 border-start border-secondary" style="border-left-width: 4px !important;">
                                                    <div class="card-body bg-light">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div>
                                                                <h6 class="mb-1">
                                                                    <span class="badge bg-secondary">
                                                                        {{ seguimiento.estado.descripcion }}
                                                                    </span>
                                                                    <!-- Badge de Owner -->
                                                                    {% if seguimiento.estado.owner == 'SIC' %}
                                                                        <span class="badge bg-info ms-1">SIC</span>
                                                                    {% elif seguimiento.estado.owner == 'RHITSO' %}
                                                                        <span class="badge bg-primary ms-1">RHITSO</span>
                                                                    {% elif seguimiento.estado.owner == 'CLIENTE' %}
                                                                        <span class="badge bg-warning text-dark ms-1">CLIENTE</span>
                                                                    {% endif %}
                                                                </h6>
                                                                <small class="text-muted">
                                                                    <i class="bi bi-calendar3"></i> {{ seguimiento.fecha_actualizacion|date:"d/m/Y H:i" }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                        
                                                        {% if seguimiento.estado_anterior %}
                                                            <p class="mb-2">
                                                                <strong>Cambio:</strong> 
                                                                <span class="badge bg-secondary">{{ seguimiento.estado_anterior }}</span>
                                                                <i class="bi bi-arrow-right mx-2"></i>
                                                                <span class="badge bg-dark">{{ seguimiento.estado.estado }}</span>
                                                            </p>
                                                        {% endif %}
                                                        
                                                        {% if seguimiento.observaciones %}
                                                            <p class="mb-2 text-muted fst-italic small">
                                                                <i class="bi bi-info-circle"></i> {{ seguimiento.observaciones }}
                                                            </p>
                                                        {% endif %}
                                                        
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="text-muted">
                                                                <i class="bi bi-gear-fill"></i> <strong>Sistema Autom√°tico</strong>
                                                            </small>
                                                            {% if seguimiento.tiempo_en_estado_anterior %}
                                                                <span class="badge bg-secondary">
                                                                    ‚è±Ô∏è {{ seguimiento.tiempo_en_estado_anterior }} d√≠a{{ seguimiento.tiempo_en_estado_anterior|pluralize }} en estado anterior
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-2">No hay cambios autom√°ticos del sistema registrados.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 5: GESTI√ìN DE INCIDENCIAS -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header">
                    <i class="bi bi-exclamation-octagon"></i>
                    <span>Gesti√≥n de Incidencias RHITSO</span>
                </div>
                <div class="card-body">
                    <!-- Estad√≠sticas de Incidencias - MEJORADAS (FASE 9.2) -->
                    <div class="row mb-4 g-3">
                        <!-- Card 1: Total -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #0d6efd !important;">
                                <div class="card-body text-center">
                                    <div class="mb-2">
                                        <i class="bi bi-clipboard-data text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h2 class="fw-bold mb-0 text-primary">{{ incidencias_stats.total }}</h2>
                                    <p class="text-uppercase fw-bold mb-0 small text-muted">TOTAL</p>
                                    <small class="text-muted">Incidencias registradas</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 2: Cr√≠ticas (con animaci√≥n si > 0) -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm {% if incidencias_stats.criticas_abiertas > 0 %}pulse-animation{% endif %}" 
                                 style="border-top: 4px solid #dc3545 !important;">
                                <div class="card-body text-center">
                                    <div class="mb-2">
                                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h2 class="fw-bold mb-0 text-danger">{{ incidencias_stats.criticas_abiertas }}</h2>
                                    <p class="text-uppercase fw-bold mb-0 small text-muted">CR√çTICAS</p>
                                    <small class="text-muted">Requieren atenci√≥n inmediata</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 3: Abiertas -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #fd7e14 !important;">
                                <div class="card-body text-center">
                                    <div class="mb-2">
                                        <i class="bi bi-folder2-open text-warning" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h2 class="fw-bold mb-0 text-warning">{{ incidencias_stats.abiertas }}</h2>
                                    <p class="text-uppercase fw-bold mb-0 small text-muted">ABIERTAS</p>
                                    <small class="text-muted">En proceso de resoluci√≥n</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 4: Resueltas -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #28a745 !important;">
                                <div class="card-body text-center">
                                    <div class="mb-2">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h2 class="fw-bold mb-0 text-success">{{ incidencias_stats.resueltas }}</h2>
                                    <p class="text-uppercase fw-bold mb-0 small text-muted">RESUELTAS</p>
                                    <small class="text-muted">Completadas exitosamente</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n para Registrar Nueva Incidencia -->
                    <div class="mb-4">
                        <button class="btn btn-danger" type="button" data-bs-toggle="collapse" data-bs-target="#formNuevaIncidencia">
                            <i class="bi bi-plus-circle"></i> Registrar Nueva Incidencia
                        </button>
                        
                        <div class="collapse mt-3" id="formNuevaIncidencia">
                            <div class="card card-body">
                                <form method="post" action="{% url 'servicio_tecnico:registrar_incidencia' orden.id %}" id="formRegistrarIncidencia">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            {{ form_incidencia.tipo_incidencia.label_tag }}
                                            {{ form_incidencia.tipo_incidencia }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            {{ form_incidencia.prioridad.label_tag }}
                                            {{ form_incidencia.prioridad }}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        {{ form_incidencia.titulo.label_tag }}
                                        {{ form_incidencia.titulo }}
                                    </div>
                                    <div class="mb-3">
                                        {{ form_incidencia.descripcion_detallada.label_tag }}
                                        {{ form_incidencia.descripcion_detallada }}
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            {{ form_incidencia.impacto_cliente.label_tag }}
                                            {{ form_incidencia.impacto_cliente }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            {{ form_incidencia.costo_adicional.label_tag }}
                                            {{ form_incidencia.costo_adicional }}
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="bi bi-exclamation-triangle"></i> Registrar Incidencia
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#formNuevaIncidencia">
                                        Cancelar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Incidencias -->
                    <div class="accordion" id="accordionIncidencias">
                        {% for incidencia in incidencias %}
                            <div class="incidencia-card card {% if incidencia.estado == 'ABIERTA' %}abierta{% elif incidencia.estado == 'EN_REVISION' %}en-revision{% else %}resuelta{% endif %}">
                                <div class="card-header" id="heading{{ incidencia.id }}">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ incidencia.id }}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ incidencia.titulo }}</strong>
                                                    <span class="badge ms-2" style="background-color: {{ incidencia.prioridad|color_prioridad }}; color: {{ incidencia.prioridad|color_prioridad|text_color_for_bg }};">
                                                        {{ incidencia.get_prioridad_display }}
                                                    </span>
                                                    <span class="badge ms-1" style="background-color: {{ incidencia.estado|color_estado_incidencia }}; color: {{ incidencia.estado|color_estado_incidencia|text_color_for_bg }};">
                                                        {{ incidencia.get_estado_display }}
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    {{ incidencia.fecha_ocurrencia|date:"d/m/Y" }}
                                                </small>
                                            </div>
                                        </button>
                                    </h5>
                                </div>
                                <div id="collapse{{ incidencia.id }}" class="collapse" data-bs-parent="#accordionIncidencias">
                                    <div class="card-body">
                                        <p><strong>Tipo:</strong> {{ incidencia.tipo_incidencia.nombre }}</p>
                                        <p><strong>Descripci√≥n:</strong></p>
                                        <p>{{ incidencia.descripcion_detallada }}</p>
                                        <p>
                                            <strong>Impacto al Cliente:</strong> 
                                            <span class="badge" style="background-color: {{ incidencia.impacto_cliente|color_impacto_cliente }}; color: {{ incidencia.impacto_cliente|color_impacto_cliente|text_color_for_bg }};">
                                                {{ incidencia.get_impacto_cliente_display }}
                                            </span>
                                        </p>
                                        {% if incidencia.costo_adicional %}
                                            <p><strong>Costo Adicional:</strong> ${{ incidencia.costo_adicional }}</p>
                                        {% endif %}
                                        <p><strong>Reportado por:</strong> {{ incidencia.usuario_registro.nombre_completo|default:incidencia.usuario_registro }}</p>
                                        
                                        {% if incidencia.estado != 'RESUELTA' and incidencia.estado != 'CERRADA' %}
                                            <button class="btn btn-success btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#formResolver{{ incidencia.id }}">
                                                <i class="bi bi-check-circle"></i> Resolver Incidencia
                                            </button>
                                            
                                            <div class="collapse mt-3" id="formResolver{{ incidencia.id }}">
                                                <div class="card card-body">
                                                    <form method="post" action="{% url 'servicio_tecnico:resolver_incidencia' incidencia.id %}" class="formResolverIncidencia">
                                                        {% csrf_token %}
                                                        <div class="mb-3">
                                                            <label for="accion_tomada_{{ incidencia.id }}" class="form-label">Acci√≥n Correctiva Tomada</label>
                                                            <textarea name="accion_tomada" id="accion_tomada_{{ incidencia.id }}" class="form-control" rows="5" required
                                                                placeholder="Ej: Se reemplaz√≥ el componente da√±ado sin costo para el cliente. RHITSO asumi√≥ la responsabilidad..."></textarea>
                                                            <small class="form-text text-muted">Describe detalladamente c√≥mo se resolvi√≥ la incidencia (m√≠nimo 20 caracteres)</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="costo_adicional_final_{{ incidencia.id }}" class="form-label">Costo Adicional Final (MXN)</label>
                                                            <input type="number" name="costo_adicional_final" id="costo_adicional_final_{{ incidencia.id }}" class="form-control" 
                                                                min="0" step="0.01" placeholder="0.00">
                                                            <small class="form-text text-muted">Costo final si cambi√≥ desde el registro inicial (opcional)</small>
                                                        </div>
                                                        <button type="submit" class="btn btn-success">
                                                            <i class="bi bi-check-circle"></i> Marcar como Resuelta
                                                        </button>
                                                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#formResolver{{ incidencia.id }}">
                                                            Cancelar
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-success mt-3">
                                                <strong><i class="bi bi-check-circle"></i> Incidencia Resuelta</strong>
                                                {% if incidencia.solucion %}
                                                    <p class="mb-0 mt-2">{{ incidencia.solucion }}</p>
                                                {% endif %}
                                                {% if incidencia.fecha_resolucion %}
                                                    <small class="text-muted d-block mt-1">
                                                        Resuelta el {{ incidencia.fecha_resolucion|date:"d/m/Y H:i" }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                No hay incidencias registradas para esta orden.
                            </p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 6: GALER√çA DE IM√ÅGENES RHITSO - MEJORADA CON LIGHTBOX -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header">
                    <i class="bi bi-images"></i>
                    <span>Galer√≠a de Im√°genes RHITSO</span>
                </div>
                <div class="card-body">
                    <!-- Mensaje Informativo -->
                    <div class="alert alert-info border-start border-info border-4 mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>Informaci√≥n:</strong> 
                        Las im√°genes se gestionan desde la <a href="{% url 'servicio_tecnico:detalle_orden' orden.id %}#galeria" class="alert-link">vista principal de la orden</a>. 
                        Aqu√≠ se visualizan con filtros espec√≠ficos de RHITSO. 
                        Las im√°genes de tipo <strong>"Autorizaci√≥n/Pass"</strong> se usar√°n para el correo a RHITSO.
                    </div>
                    
                    <!-- Bot√≥n para Gestionar Im√°genes -->
                    <div class="mb-4">
                        <a href="{% url 'servicio_tecnico:detalle_orden' orden.id %}#galeria" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Gestionar Im√°genes (Subir/Eliminar)
                        </a>
                    </div>
                    
                    <!-- Tabs de categor√≠as de im√°genes -->
                    <ul class="nav nav-pills mb-3" id="imagenesRhitsoTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="todas-rhitso-tab" data-bs-toggle="pill" data-bs-target="#todas-rhitso" type="button">
                                <i class="bi bi-grid-3x3-gap"></i> Todas 
                                <span class="badge bg-secondary">{{ imagenes_rhitso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ingreso-rhitso-tab" data-bs-toggle="pill" data-bs-target="#ingreso-rhitso" type="button">
                                <i class="bi bi-arrow-down-circle"></i> Ingreso 
                                <span class="badge bg-primary">{{ imagenes_por_tipo_rhitso.ingreso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diagnostico-rhitso-tab" data-bs-toggle="pill" data-bs-target="#diagnostico-rhitso" type="button">
                                <i class="bi bi-search"></i> Diagn√≥stico 
                                <span class="badge bg-info">{{ imagenes_por_tipo_rhitso.diagnostico.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reparacion-rhitso-tab" data-bs-toggle="pill" data-bs-target="#reparacion-rhitso" type="button">
                                <i class="bi bi-tools"></i> Reparaci√≥n 
                                <span class="badge bg-warning">{{ imagenes_por_tipo_rhitso.reparacion.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="egreso-rhitso-tab" data-bs-toggle="pill" data-bs-target="#egreso-rhitso" type="button">
                                <i class="bi bi-arrow-up-circle"></i> Egreso 
                                <span class="badge bg-secondary">{{ imagenes_por_tipo_rhitso.egreso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="autorizacion-rhitso-tab" data-bs-toggle="pill" data-bs-target="#autorizacion-rhitso" type="button">
                                <i class="bi bi-shield-check"></i> Autorizaci√≥n/Pass 
                                <span class="badge bg-success">{{ imagenes_por_tipo_rhitso.autorizacion.count }}</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Contenido de los tabs -->
                    <div class="tab-content" id="imagenesRhitsoTabContent">
                        <!-- Tab: TODAS -->
                        <div class="tab-pane fade show active" id="todas-rhitso" role="tabpanel">
                            {% if imagenes_rhitso %}
                            <div class="row g-3">
                                {% for imagen in imagenes_rhitso %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="gallery-image-container"
                                         data-imagen-id="{{ imagen.pk }}"
                                         data-descripcion="{{ imagen.descripcion|default:'Sin descripci√≥n' }}"
                                         data-usuario="{{ imagen.subido_por.nombre_completo }}"
                                         data-fecha="{{ imagen.fecha_subida|date:'d/m/Y H:i' }}"
                                         data-url-descarga="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}">
                                        
                                        <!-- Bot√≥n descarga en miniatura -->
                                        <a href="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}" 
                                           class="btn-descarga-miniatura" 
                                           title="Descargar imagen original"
                                           onclick="event.stopPropagation();">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        
                                        <div class="gallery-image">
                                            <img src="{{ imagen.imagen.url }}" alt="{{ imagen.descripcion }}">
                                            <div class="image-overlay">
                                                <div>{{ imagen.fecha_subida|date:"d/m/Y H:i" }}</div>
                                                <div class="small">
                                                    {% if imagen.tipo == 'ingreso' %}
                                                        <span class="badge bg-primary">Ingreso</span>
                                                    {% elif imagen.tipo == 'diagnostico' %}
                                                        <span class="badge bg-info">Diagn√≥stico</span>
                                                    {% elif imagen.tipo == 'reparacion' %}
                                                        <span class="badge bg-warning">Reparaci√≥n</span>
                                                    {% elif imagen.tipo == 'egreso' %}
                                                        <span class="badge bg-secondary">Egreso</span>
                                                    {% elif imagen.tipo == 'autorizacion' %}
                                                        <span class="badge bg-success">Autorizaci√≥n/Pass</span>
                                                    {% endif %}
                                                </div>
                                                {% if imagen.descripcion %}
                                                    <div class="small mt-1">{{ imagen.descripcion|truncatewords:5 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Pie de imagen con usuario -->
                                        <div class="image-footer">
                                            <small class="text-muted">
                                                <i class="bi bi-person-circle"></i> {{ imagen.subido_por.nombre_completo }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <p class="mt-2">No hay im√°genes cargadas a√∫n.</p>
                                <a href="{% url 'servicio_tecnico:detalle_orden' orden.id %}#galeria" class="btn btn-primary mt-2">
                                    <i class="bi bi-upload"></i> Subir Primera Imagen
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Tab: POR TIPO (Ingreso, Diagn√≥stico, Reparaci√≥n, Egreso, Autorizaci√≥n) -->
                        {% for tipo, imagenes in imagenes_por_tipo_rhitso.items %}
                        <div class="tab-pane fade" id="{{ tipo }}-rhitso" role="tabpanel">
                            {% if imagenes %}
                            <div class="row g-3">
                                {% for imagen in imagenes %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="gallery-image-container"
                                         data-imagen-id="{{ imagen.pk }}"
                                         data-descripcion="{{ imagen.descripcion|default:'Sin descripci√≥n' }}"
                                         data-usuario="{{ imagen.subido_por.nombre_completo }}"
                                         data-fecha="{{ imagen.fecha_subida|date:'d/m/Y H:i' }}"
                                         data-url-descarga="{% url 'servicio_tecnico:descargar_imagen' imagen.pk }}">
                                        
                                        <!-- Bot√≥n descarga en miniatura -->
                                        <a href="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}" 
                                           class="btn-descarga-miniatura" 
                                           title="Descargar imagen original"
                                           onclick="event.stopPropagation();">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        
                                        <div class="gallery-image">
                                            <img src="{{ imagen.imagen.url }}" alt="{{ imagen.descripcion }}">
                                            <div class="image-overlay">
                                                <div>{{ imagen.fecha_subida|date:"d/m/Y H:i" }}</div>
                                                {% if imagen.descripcion %}
                                                    <div class="small">{{ imagen.descripcion|truncatewords:5 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Pie de imagen con usuario -->
                                        <div class="image-footer">
                                            <small class="text-muted">
                                                <i class="bi bi-person-circle"></i> {{ imagen.subido_por.nombre_completo }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <p class="mt-2">No hay im√°genes de {{ tipo }} a√∫n.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- ============================================================================ -->
<!-- MODAL: ENVIAR CORREO Y FORMATO RHITSO - FASE 10 -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalEnviarRHITSO" tabindex="-1" aria-labelledby="modalEnviarRHITSOLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <!-- Encabezado del Modal -->
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalEnviarRHITSOLabel">
                    <i class="bi bi-envelope"></i> ‚úâÔ∏è Enviar correo y formato RHITSO
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Cuerpo del Modal -->
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="formEnviarRHITSO" method="post" action="{% url 'servicio_tecnico:enviar_correo_rhitso' orden.id %}">
                    {% csrf_token %}
                    
                    <!-- SECCI√ìN 1: DESTINATARIOS PRINCIPALES -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-people-fill text-primary fs-5 me-2"></i>
                            <h6 class="mb-0 text-primary fw-bold">Para: (Destinatarios principales)</h6>
                        </div>
                        
                        {% if destinatarios_rhitso %}
                        <div class="row g-2">
                            {% for destinatario in destinatarios_rhitso %}
                            <div class="col-lg-6 col-md-12">
                                <label class="destinatario-card p-3 border rounded bg-light hover-shadow d-block mb-0 cursor-pointer" for="dest_{{ forloop.counter }}">
                                    <div class="d-flex align-items-center">
                                        <input 
                                            class="form-check-input me-3 flex-shrink-0" 
                                            type="checkbox" 
                                            name="destinatarios_principales" 
                                            value="{{ destinatario.email }}" 
                                            id="dest_{{ forloop.counter }}"
                                            checked>
                                        <i class="bi bi-person-circle text-primary fs-3 me-2 flex-shrink-0"></i>
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <div class="fw-bold text-truncate">{{ destinatario.nombre }}</div>
                                            <small class="text-muted d-block text-truncate">{{ destinatario.email }}</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Sin destinatarios:</strong> No hay destinatarios RHITSO configurados. Revisa la configuraci√≥n en .env
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 2: CON COPIA A (EMPLEADOS) -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-file-earmark-text-fill text-info fs-5 me-2"></i>
                            <h6 class="mb-0 text-info fw-bold">Con copia a: (Empleados internos)</h6>
                        </div>
                        
                        {% if empleados_copia %}
                        <div class="row g-2">
                            {% for empleado in empleados_copia %}
                            <div class="col-lg-6 col-md-12">
                                <label class="destinatario-card p-3 border rounded bg-light hover-shadow d-block mb-0 cursor-pointer" for="emp_{{ empleado.id }}">
                                    <div class="d-flex align-items-center">
                                        <input 
                                            class="form-check-input me-3 flex-shrink-0" 
                                            type="checkbox" 
                                            name="copia_empleados" 
                                            value="{{ empleado.email }}" 
                                            id="emp_{{ empleado.id }}">
                                        
                                        <!-- Mostrar foto del empleado si existe, sino mostrar icono -->
                                        {% if empleado.foto_perfil %}
                                            <img src="{{ empleado.foto_perfil.url }}" 
                                                 alt="{{ empleado.nombre_completo }}" 
                                                 class="rounded-circle me-2 flex-shrink-0 empleado-foto"
                                                 style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #17a2b8;">
                                        {% else %}
                                            <i class="bi bi-person-badge text-info fs-3 me-2 flex-shrink-0"></i>
                                        {% endif %}
                                        
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <div class="fw-bold text-truncate">{{ empleado.nombre_completo }}</div>
                                            <small class="text-muted d-block">
                                                <span class="badge bg-secondary me-1">{{ empleado.area }}</span>
                                                <span class="text-truncate d-inline-block" style="max-width: 180px; vertical-align: middle;">{{ empleado.email }}</span>
                                            </small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            <strong>Sin empleados:</strong> No hay empleados de las √°reas CALIDAD, FRONTDESK o COMPRAS con email configurado.
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 3: INFORMACI√ìN QUE SE ENVIAR√Å -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-info-circle"></i> Informaci√≥n que se enviar√°:
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Orden:</strong> <span class="badge bg-primary">{{ datos_correo.orden }}</span></p>
                                <p class="mb-2"><strong>Serie:</strong> {{ datos_correo.serie }}</p>
                                <p class="mb-2"><strong>Modelo:</strong> {{ datos_correo.modelo }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Motivo RHITSO:</strong> {{ datos_correo.motivo_rhitso }}</p>
                                <p class="mb-2"><strong>Cargador:</strong> 
                                    {% if 'SIN CARGADOR' in datos_correo.cargador %}
                                        <span class="badge bg-secondary">{{ datos_correo.cargador }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ datos_correo.cargador }}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- SECCI√ìN 4: ARCHIVOS QUE SE ADJUNTAR√ÅN -->
                    <div class="mb-4">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-paperclip"></i> Archivos que se adjuntar√°n:
                        </h6>
                        
                        <!-- PDF Formato RHITSO -->
                        <div class="d-flex align-items-center mb-3 p-3 border rounded bg-light">
                            <i class="bi bi-file-pdf text-danger fs-2 me-3"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    üìÑ PDF Formato RHITSO 
                                    <span class="badge bg-success ms-2">Generado autom√°ticamente</span>
                                </h6>
                                <small class="text-muted">
                                    Incluye datos del equipo + 
                                    {% if archivos_adjuntos.tiene_imagenes_autorizacion %}
                                        {{ archivos_adjuntos.cantidad_autorizacion }} imagen(es) de Autorizaci√≥n/Pass
                                    {% else %}
                                        <span class="text-warning">‚ö†Ô∏è Sin im√°genes de autorizaci√≥n</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        <!-- Im√°genes de Env√≠o -->
                        <div class="d-flex align-items-center mb-3 p-3 border rounded bg-light">
                            <i class="bi bi-images text-primary fs-2 me-3"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    üñºÔ∏è Im√°genes de Env√≠o 
                                    <span class="badge bg-primary ms-2">{{ archivos_adjuntos.cantidad_imagenes_ingreso }} im√°genes</span>
                                </h6>
                                <small class="text-muted">Se adjuntan como archivos separados (comprimidas autom√°ticamente)</small>
                            </div>
                        </div>
                        
                        {% if archivos_adjuntos.cantidad_imagenes_ingreso == 0 %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Advertencia:</strong> No hay im√°genes de tipo "Ingreso" para adjuntar. 
                            Se recomienda subir al menos una imagen antes de enviar el correo.
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 5: PREVISUALIZACI√ìN DEL CORREO -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-eye-fill text-success fs-5 me-2"></i>
                            <h6 class="mb-0 text-success fw-bold">Previsualizaci√≥n del correo</h6>
                        </div>
                        
                        <div class="alert alert-info border-start border-info border-4 mb-3">
                            <i class="bi bi-info-circle"></i>
                            <small><strong>Vista previa:</strong> As√≠ se ver√° el correo que recibir√°n los destinatarios.</small>
                        </div>
                        
                        <!-- Simulaci√≥n de cliente de correo -->
                        <div class="border rounded overflow-hidden shadow-sm">
                            <!-- Encabezado del correo (estilo email) -->
                            <div class="bg-light border-bottom p-3">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <small class="text-muted d-block mb-1"><strong>De:</strong></small>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-building text-primary fs-5 me-2"></i>
                                            <span>{{ request.user.empleado.nombre_completo|default:"Sistema SIC" }}</span>
                                            <small class="text-muted ms-2">&lt;{{ request.user.email }}&gt;</small>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <small class="text-muted d-block mb-1"><strong>Para:</strong></small>
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for dest in destinatarios_rhitso %}
                                                <span class="badge bg-primary">{{ dest.nombre }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% if empleados_copia %}
                                    <div class="col-12">
                                        <small class="text-muted d-block mb-1"><strong>CC:</strong></small>
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for emp in empleados_copia %}
                                                <span class="badge bg-secondary">{{ emp.nombre_completo }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="col-12 mt-2">
                                        <small class="text-muted d-block mb-1"><strong>Asunto:</strong></small>
                                        <div class="p-2 bg-white border rounded">
                                            <strong class="text-dark">{{ previsualizacion_correo.asunto }}</strong>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <small class="text-muted d-block mb-1"><strong>Archivos adjuntos:</strong></small>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-danger d-flex align-items-center">
                                                <i class="bi bi-file-pdf me-1"></i>
                                                formato_rhitso_{{ orden.numero_orden_interno }}.pdf
                                            </span>
                                            {% if archivos_adjuntos.cantidad_imagenes_ingreso > 0 %}
                                                <span class="badge bg-info d-flex align-items-center">
                                                    <i class="bi bi-images me-1"></i>
                                                    {{ archivos_adjuntos.cantidad_imagenes_ingreso }} imagen(es)
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cuerpo del correo -->
                            <div class="p-4 bg-white">
                                <div class="correo-preview">
                                    {{ previsualizacion_correo.cuerpo|linebreaks }}
                                </div>
                                
                                <!-- Firma del correo -->
                                <div class="mt-4 pt-3 border-top">
                                    <small class="text-muted">
                                        <strong>{{ request.user.empleado.nombre_completo|default:"Sistema Integral SIC" }}</strong><br>
                                        {% if request.user.empleado %}
                                            {{ request.user.empleado.cargo }}<br>
                                            {{ request.user.empleado.area }}<br>
                                        {% endif %}
                                        {{ request.user.email }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </form>
            </div>
            
            <!-- Footer del Modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" form="formEnviarRHITSO" class="btn btn-success btn-lg">
                    <i class="bi bi-send-fill"></i> Enviar Correo
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    /**
     * JAVASCRIPT PARA GESTI√ìN RHITSO - FASE 5
     * 
     * EXPLICACI√ìN PARA PRINCIPIANTES:
     * ================================
     * Este JavaScript maneja el env√≠o de formularios mediante AJAX.
     * 
     * ¬øQu√© es AJAX?
     * Es una t√©cnica que permite enviar y recibir datos del servidor
     * SIN recargar toda la p√°gina. Solo se actualiza la parte que cambi√≥.
     * 
     * BENEFICIOS:
     * - Mejor experiencia de usuario (no se pierde el scroll)
     * - M√°s r√°pido (no recarga toda la p√°gina)
     * - Respuesta inmediata con mensajes de √©xito/error
     * - Actualizaci√≥n din√°mica de la UI
     * 
     * FLUJO COMPLETO:
     * 1. Usuario llena formulario y hace clic en "Enviar"
     * 2. JavaScript intercepta el submit (preventDefault)
     * 3. JavaScript recopila datos del formulario
     * 4. Env√≠a datos al servidor mediante fetch() AJAX
     * 5. Servidor procesa y retorna JSON con resultado
     * 6. JavaScript muestra mensaje de √©xito/error
     * 7. Si √©xito: actualiza UI y cierra formulario
     * 8. Si error: muestra errores espec√≠ficos de cada campo
     */
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîß Inicializando sistema RHITSO...');
        
        // ====================================================================
        // FUNCI√ìN AUXILIAR: Obtener CSRF Token de Django
        // ====================================================================
        // EXPLICACI√ìN: Django requiere un token de seguridad (CSRF) en todas
        // las peticiones POST para prevenir ataques. Esta funci√≥n lo obtiene
        // de las cookies del navegador.
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // ====================================================================
        // FUNCI√ìN AUXILIAR: Mostrar Mensajes de Alerta
        // ====================================================================
        // EXPLICACI√ìN: Crea y muestra alertas de Bootstrap al usuario
        function mostrarMensaje(tipo, mensaje) {
            const alertContainer = document.querySelector('.alert-container');
            if (!alertContainer) {
                // Si no existe contenedor de alertas, crear uno
                const container = document.createElement('div');
                container.className = 'alert-container position-fixed top-0 start-50 translate-middle-x p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} alert-dismissible fade show`;
            alert.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.alert-container');
            container.appendChild(alert);
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // ====================================================================
        // FORMULARIO 1: ACTUALIZAR ESTADO RHITSO (AJAX)
        // ====================================================================
        const formActualizarEstado = document.getElementById('formActualizarEstado');
        if (formActualizarEstado) {
            formActualizarEstado.addEventListener('submit', async function(e) {
                e.preventDefault();  // Prevenir submit normal
                
                // Confirmaci√≥n antes de enviar
                if (!confirm('¬øEst√°s seguro de cambiar el estado RHITSO? Esta acci√≥n quedar√° registrada en el historial.')) {
                    return;
                }
                
                const formData = new FormData(this);
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                
                // Deshabilitar bot√≥n y mostrar spinner
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';
                
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        mostrarMensaje('success', data.mensaje);
                        // Recargar p√°gina para mostrar cambios
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        mostrarMensaje('danger', data.mensaje);
                        if (data.errores) {
                            data.errores.forEach(error => {
                                mostrarMensaje('warning', error);
                            });
                        }
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensaje('danger', '‚ùå Error de conexi√≥n. Int√©ntalo de nuevo.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        }
        
        // ====================================================================
        // FORMULARIO 2: REGISTRAR INCIDENCIA (AJAX)
        // ====================================================================
        const formRegistrarIncidencia = document.getElementById('formRegistrarIncidencia');
        if (formRegistrarIncidencia) {
            formRegistrarIncidencia.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const prioridad = formData.get('prioridad');
                
                // Confirmaci√≥n especial para incidencias cr√≠ticas
                if (prioridad === 'CRITICA') {
                    if (!confirm('Est√°s registrando una incidencia CR√çTICA. Esto generar√° alertas autom√°ticas. ¬øContinuar?')) {
                        return;
                    }
                }
                
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registrando...';
                
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        mostrarMensaje('success', data.mensaje);
                        // Recargar p√°gina para mostrar nueva incidencia
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        mostrarMensaje('danger', data.mensaje);
                        if (data.errores) {
                            data.errores.forEach(error => {
                                mostrarMensaje('warning', error);
                            });
                        }
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensaje('danger', '‚ùå Error de conexi√≥n. Int√©ntalo de nuevo.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        }
        
        // ====================================================================
        // FORMULARIO 3: RESOLVER INCIDENCIA (AJAX) - M√∫ltiples instancias
        // ====================================================================
        const formsResolverIncidencia = document.querySelectorAll('.formResolverIncidencia');
        formsResolverIncidencia.forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!confirm('¬øEst√°s seguro de marcar esta incidencia como resuelta?')) {
                    return;
                }
                
                const formData = new FormData(this);
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resolviendo...';
                
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        mostrarMensaje('success', data.mensaje);
                        // Recargar p√°gina para actualizar estado de incidencia
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        mostrarMensaje('danger', data.mensaje);
                        if (data.errores) {
                            data.errores.forEach(error => {
                                mostrarMensaje('warning', error);
                            });
                        }
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensaje('danger', '‚ùå Error de conexi√≥n. Int√©ntalo de nuevo.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        });
        
        // ====================================================================
        // FORMULARIO 4: EDITAR DIAGN√ìSTICO SIC (POST normal o AJAX)
        // ====================================================================
        const formEditarDiagnostico = document.getElementById('formEditarDiagnosticoSIC');
        if (formEditarDiagnostico) {
            formEditarDiagnostico.addEventListener('submit', function(e) {
                if (!confirm('¬øEst√°s seguro de actualizar el diagn√≥stico SIC y datos RHITSO?')) {
                    e.preventDefault();
                }
                // Este formulario usa POST normal (no AJAX) porque la vista
                // puede retornar redirect o JSON seg√∫n sea necesario
            });
        }
        
        // ====================================================================
        // AUTO-COLAPSAR FORMULARIOS
        // ====================================================================
        // EXPLICACI√ìN: Cuando se abre un formulario, cierra los dem√°s
        // autom√°ticamente para evitar confusi√≥n visual
        const collapseElements = document.querySelectorAll('.collapse');
        collapseElements.forEach(function(collapseEl) {
            collapseEl.addEventListener('show.bs.collapse', function() {
                const parent = collapseEl.closest('.card-body');
                if (parent) {
                    parent.querySelectorAll('.collapse.show').forEach(function(otherCollapse) {
                        if (otherCollapse !== collapseEl) {
                            const bsCollapse = bootstrap.Collapse.getInstance(otherCollapse);
                            if (bsCollapse) {
                                bsCollapse.hide();
                            }
                        }
                    });
                }
            });
        });
        
        // ====================================================================
        // FORMULARIO 5: ENVIAR CORREO RHITSO (AJAX) - FASE 10
        // ====================================================================
        const formEnviarRHITSO = document.getElementById('formEnviarRHITSO');
        if (formEnviarRHITSO) {
            formEnviarRHITSO.addEventListener('submit', async function(e) {
                e.preventDefault();  // Prevenir submit normal
                
                // Validar que haya al menos un destinatario seleccionado
                const destinatarios = document.querySelectorAll('input[name="destinatarios_principales"]:checked');
                if (destinatarios.length === 0) {
                    mostrarMensaje('warning', '‚ö†Ô∏è Debe seleccionar al menos un destinatario principal.');
                    return;
                }
                
                // Confirmaci√≥n antes de enviar
                const numDestinatarios = destinatarios.length;
                const copias = document.querySelectorAll('input[name="copia_empleados"]:checked').length;
                const mensaje = `¬øEst√°s seguro de enviar el correo a RHITSO?\n\n` +
                               `‚Ä¢ ${numDestinatarios} destinatario(s) principal(es)\n` +
                               `‚Ä¢ ${copias} copia(s)\n\n` +
                               `Se adjuntar√°n el PDF y las im√°genes de ingreso.`;
                
                if (!confirm(mensaje)) {
                    return;
                }
                
                const formData = new FormData(this);
                
                // Buscar el bot√≥n de submit que est√° en el modal-footer con form="formEnviarRHITSO"
                const submitButton = document.querySelector('button[form="formEnviarRHITSO"]');
                const originalText = submitButton ? submitButton.innerHTML : '';
                
                // Deshabilitar bot√≥n y mostrar spinner
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando correo...';
                }
                
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Construir mensaje HTML detallado con la informaci√≥n del correo
                        let mensajeHTML = `
                            <div class="text-center mb-3">
                                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="text-center mb-3">${data.mensaje}</h5>
                        `;
                        
                        if (data.data && data.data.correo) {
                            mensajeHTML += `
                                <div class="alert alert-info mb-0">
                                    <h6 class="mb-3"><i class="bi bi-info-circle"></i> üìä Detalles del env√≠o:</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <strong>üìÑ PDF:</strong> ${data.data.pdf.tama√±o_mb} MB
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <strong>üñºÔ∏è Im√°genes:</strong> ${data.data.imagenes.adjuntas} adjunta(s)
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <strong>‚Ä¢ Tama√±o original:</strong> ${data.data.imagenes.tama√±o_original_mb} MB
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <strong>‚Ä¢ Comprimido:</strong> ${data.data.imagenes.tama√±o_comprimido_mb} MB
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <strong>‚Ä¢ Ahorro:</strong> <span class="text-success">${data.data.imagenes.reduccion_mb} MB</span>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <strong>üì¶ Total:</strong> ${data.data.correo.tama√±o_total_mb} MB (${data.data.correo.porcentaje_usado}%)
                                        </div>
                                    </div>
                            `;
                            
                            if (data.data.imagenes.excluidas > 0) {
                                mensajeHTML += `
                                    <div class="alert alert-warning mt-3 mb-0">
                                        <i class="bi bi-exclamation-triangle"></i> 
                                        <strong>Nota:</strong> ${data.data.imagenes.excluidas} imagen(es) fueron excluidas por tama√±o excesivo.
                                    </div>
                                `;
                            }
                            
                            mensajeHTML += `</div>`;
                        }
                        
                        // Cerrar modal de env√≠o
                        const modalEnviar = bootstrap.Modal.getInstance(document.getElementById('modalEnviarRHITSO'));
                        if (modalEnviar) {
                            modalEnviar.hide();
                        }
                        
                        // Mostrar modal de confirmaci√≥n personalizado con SweetAlert2 o alert nativo mejorado
                        // Usaremos un modal de Bootstrap personalizado
                        const modalConfirmacionHTML = `
                            <div class="modal fade" id="modalConfirmacionEnvio" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header bg-success text-white">
                                            <h5 class="modal-title">
                                                <i class="bi bi-envelope-check"></i> Correo Enviado
                                            </h5>
                                        </div>
                                        <div class="modal-body">
                                            ${mensajeHTML}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-primary" onclick="location.reload()">
                                                <i class="bi bi-check-lg"></i> Aceptar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Agregar modal al DOM si no existe
                        let modalConfirmacion = document.getElementById('modalConfirmacionEnvio');
                        if (modalConfirmacion) {
                            modalConfirmacion.remove();
                        }
                        document.body.insertAdjacentHTML('beforeend', modalConfirmacionHTML);
                        
                        // Mostrar modal de confirmaci√≥n
                        modalConfirmacion = new bootstrap.Modal(document.getElementById('modalConfirmacionEnvio'));
                        modalConfirmacion.show();
                        
                    } else {
                        mostrarMensaje('danger', data.mensaje);
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalText;
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensaje('danger', '‚ùå Error de conexi√≥n. Int√©ntalo de nuevo.');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                }
            });
        }
        
        console.log('‚úÖ Sistema RHITSO cargado correctamente - FASE 10 ACTIVA');
    });
</script>

<!-- Lightbox personalizado para galer√≠a RHITSO -->
<script src="{% static 'js/lightbox_galeria.js' %}?v=1.0"></script>
{% endblock %}
