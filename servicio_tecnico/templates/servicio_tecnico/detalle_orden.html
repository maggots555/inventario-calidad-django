{% extends 'base.html' %}
{% load static %}

{% block title %}Orden {{ orden.numero_orden_interno }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/servicio_tecnico.css' %}?v=4.4">
<link rel="stylesheet" href="{% static 'css/lightbox_galeria.css' %}?v=1.0">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <!-- ============================================================ -->
    <!-- ENCABEZADO CON INFORMACIÓN PRINCIPAL -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="bi bi-tools"></i> 
                        {{ orden.numero_orden_interno }}
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="bi bi-calendar"></i> 
                        Ingreso: {{ orden.fecha_ingreso|date:"d/m/Y H:i" }}
                    </p>
                </div>
                <div class="text-end">
                    <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCIÓN 1: INFORMACIÓN PRINCIPAL (Solo Lectura) -->
    <!-- ============================================================ -->
    
    <div class="row">
        <!-- Panel Principal Izquierdo (8 columnas) -->
        <div class="col-lg-8">
            <div class="card section-card">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle-fill"></i>
                        Información Principal
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalEditarInfoEquipo">
                        <i class="bi bi-pencil-square"></i> Editar información
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Estado y Días en Servicio -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Estado Actual</label>
                            <div>
                                <span class="estado-badge bg-{{ orden.estado|yesno:'success,warning,danger' }}">
                                    {{ orden.get_estado_display }}
                                </span>
                                {% if orden.esta_retrasada %}
                                <span class="badge bg-danger ms-2">
                                    <i class="bi bi-exclamation-triangle"></i> Retrasada
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Días en Servicio</label>
                            <div class="dias-servicio">{{ dias_en_servicio }} días</div>
                        </div>
                        
                        <!-- Información del Equipo -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Tipo de Equipo</label>
                            <p class="mb-0"><strong>{{ detalle.get_tipo_equipo_display|upper }}</strong></p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Marca y Modelo</label>
                            <p class="mb-0"><strong>{{ detalle.marca }} {{ detalle.modelo }}</strong></p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Número de Serie (Service Tag)</label>
                            <p class="mb-0"><code>{{ detalle.numero_serie }}</code></p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Orden del Cliente</label>
                            <p class="mb-0"><code>{{ detalle.orden_cliente|default:"N/A" }}</code></p>
                        </div>
                        
                        <!-- Gama y Accesorios -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Gama del Equipo</label>
                            <p class="mb-0">
                                <span class="badge bg-{% if detalle.gama == 'alta' %}success{% elif detalle.gama == 'media' %}warning{% else %}secondary{% endif %}">
                                    {{ detalle.get_gama_display }}
                                </span>
                            </p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Accesorios</label>
                            <p class="mb-0">
                                {% if detalle.tiene_cargador %}
                                    <i class="bi bi-check-circle text-success"></i> Incluye cargador
                                    {% if detalle.numero_serie_cargador %}
                                        <br><small class="text-muted">S/N: {{ detalle.numero_serie_cargador }}</small>
                                    {% endif %}
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i> Sin cargador
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- Ubicación y Responsables -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Sucursal</label>
                            <p class="mb-0">
                                <i class="bi bi-building"></i> {{ orden.sucursal.nombre }}
                            </p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Técnico Asignado</label>
                            <p class="mb-0">
                                <i class="bi bi-person-badge"></i> {{ orden.tecnico_asignado_actual.nombre_completo }}
                            </p>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label class="form-label text-muted small">Responsable de Seguimiento</label>
                            <p class="mb-0">
                                <i class="bi bi-person-check"></i> {{ orden.responsable_seguimiento.nombre_completo }}
                            </p>
                        </div>
                        
                        <!-- Equipo Enciende -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label text-muted small">¿El equipo enciende?</label>
                            <p class="mb-0">
                                {% if detalle.equipo_enciende %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-power"></i> SÍ ENCIENDE
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-power"></i> NO ENCIENDE
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel Lateral Derecho (4 columnas) - Configuración Adicional -->
        <div class="col-lg-4">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-gear-fill"></i>
                    Configuración Adicional
                </div>
                <div class="card-body">
                    <form method="post" id="formConfiguracion">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="configuracion">
                        
                        {{ form_config.falla_principal.errors }}
                        <div class="mb-3">
                            <label for="{{ form_config.falla_principal.id_for_label }}" class="form-label">
                                {{ form_config.falla_principal.label }}
                            </label>
                            {{ form_config.falla_principal }}
                            <small class="text-muted">{{ form_config.falla_principal.help_text }}</small>
                        </div>
                        
                        {{ form_config.diagnostico_sic.errors }}
                        <div class="mb-3">
                            <label for="{{ form_config.diagnostico_sic.id_for_label }}" class="form-label">
                                {{ form_config.diagnostico_sic.label }}
                            </label>
                            {{ form_config.diagnostico_sic }}
                            <small class="text-muted">{{ form_config.diagnostico_sic.help_text }}</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                {{ form_config.fecha_inicio_diagnostico.errors }}
                                <label for="{{ form_config.fecha_inicio_diagnostico.id_for_label }}" class="form-label small">
                                    {{ form_config.fecha_inicio_diagnostico.label }}
                                </label>
                                {{ form_config.fecha_inicio_diagnostico }}
                            </div>
                            <div class="col-6 mb-3">
                                {{ form_config.fecha_fin_diagnostico.errors }}
                                <label for="{{ form_config.fecha_fin_diagnostico.id_for_label }}" class="form-label small">
                                    {{ form_config.fecha_fin_diagnostico.label }}
                                </label>
                                {{ form_config.fecha_fin_diagnostico }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                {{ form_config.fecha_inicio_reparacion.errors }}
                                <label for="{{ form_config.fecha_inicio_reparacion.id_for_label }}" class="form-label small">
                                    {{ form_config.fecha_inicio_reparacion.label }}
                                </label>
                                {{ form_config.fecha_inicio_reparacion }}
                            </div>
                            <div class="col-6 mb-3">
                                {{ form_config.fecha_fin_reparacion.errors }}
                                <label for="{{ form_config.fecha_fin_reparacion.id_for_label }}" class="form-label small">
                                    {{ form_config.fecha_fin_reparacion.label }}
                                </label>
                                {{ form_config.fecha_fin_reparacion }}
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Guardar Configuración
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCIÓN 2: REINGRESO Y RHITSO -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <i class="bi bi-arrow-repeat"></i>
                    Reingreso y RHITSO (Reparación Especializada)
                </div>
                <div class="card-body">
                    <form method="post" id="formReingresoRHITSO">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="reingreso_rhitso">
                        
                        <div class="row">
                            <!-- Reingreso -->
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="text-danger mb-3">
                                        <i class="bi bi-arrow-clockwise"></i> Reingreso
                                    </h6>
                                    
                                    <div class="form-check mb-3">
                                        {{ form_reingreso.es_reingreso }}
                                        <label class="form-check-label" for="{{ form_reingreso.es_reingreso.id_for_label }}">
                                            {{ form_reingreso.es_reingreso.label }}
                                        </label>
                                    </div>
                                    
                                    {% if orden.es_reingreso %}
                                        <div class="alert alert-danger mb-3">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <strong>Esta orden es un REINGRESO</strong>
                                            {% if orden.incidencia_scorecard %}
                                                <br><small>Incidencia: {{ orden.incidencia_scorecard.folio }}</small>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        {{ form_reingreso.orden_original.errors }}
                                        <label for="{{ form_reingreso.orden_original.id_for_label }}" class="form-label small">
                                            {{ form_reingreso.orden_original.label }}
                                        </label>
                                        {{ form_reingreso.orden_original }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RHITSO -->
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="text-warning mb-3">
                                        <i class="bi bi-tools"></i> RHITSO (Reparación Especializada)
                                    </h6>
                                    
                                    <div class="form-check mb-3">
                                        {{ form_reingreso.es_candidato_rhitso }}
                                        <label class="form-check-label" for="{{ form_reingreso.es_candidato_rhitso.id_for_label }}">
                                            {{ form_reingreso.es_candidato_rhitso.label }}
                                        </label>
                                    </div>
                                    
                                    {% if orden.es_candidato_rhitso %}
                                        <div class="alert alert-warning mb-3">
                                            <i class="bi bi-tools"></i>
                                            <strong>Candidato a RHITSO</strong>
                                            <br><small>{{ orden.get_motivo_rhitso_display }}</small>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        {{ form_reingreso.motivo_rhitso.errors }}
                                        <label for="{{ form_reingreso.motivo_rhitso.id_for_label }}" class="form-label small">
                                            {{ form_reingreso.motivo_rhitso.label }}
                                        </label>
                                        {{ form_reingreso.motivo_rhitso }}
                                    </div>
                                    
                                    <div class="mb-3">
                                        {{ form_reingreso.descripcion_rhitso.errors }}
                                        <label for="{{ form_reingreso.descripcion_rhitso.id_for_label }}" class="form-label small">
                                            {{ form_reingreso.descripcion_rhitso.label }}
                                        </label>
                                        {{ form_reingreso.descripcion_rhitso }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-save"></i> Actualizar Reingreso/RHITSO
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCIÓN 3: GESTIÓN DE COTIZACIÓN -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-currency-dollar"></i>
                    Gestión de Cotización
                </div>
                <div class="card-body">
                    
                    {% if not cotizacion %}
                        <!-- ========================================== -->
                        <!-- NO EXISTE COTIZACIÓN - Mostrar botón crear -->
                        <!-- ========================================== -->
                        <div class="alert alert-info d-flex align-items-center mb-4">
                            <i class="bi bi-info-circle-fill fs-3 me-3"></i>
                            <div>
                                <h6 class="mb-1">No hay cotización para esta orden</h6>
                                <p class="mb-0 small">Crea una cotización para enviar al cliente con el costo de mano de obra. Después agrega las piezas necesarias desde el admin.</p>
                            </div>
                        </div>
                        
                        <form method="post" id="formCrearCotizacion">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="crear_cotizacion">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_crear_cotizacion.costo_mano_obra.errors }}
                                    <label for="{{ form_crear_cotizacion.costo_mano_obra.id_for_label }}" class="form-label">
                                        <i class="bi bi-tools"></i> {{ form_crear_cotizacion.costo_mano_obra.label }}
                                    </label>
                                    {{ form_crear_cotizacion.costo_mano_obra }}
                                    <small class="text-muted">{{ form_crear_cotizacion.costo_mano_obra.help_text }}</small>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="bi bi-plus-circle"></i> Crear Cotización
                                    </button>
                                </div>
                            </div>
                        </form>
                    
                    {% else %}
                        <!-- ========================================== -->
                        <!-- EXISTE COTIZACIÓN - Mostrar información -->
                        <!-- ========================================== -->
                        
                        <div class="row mb-4">
                            <!-- Panel Izquierdo: Estado y Decisión -->
                            <div class="col-lg-6">
                                <div class="card h-100" style="border-left: 4px solid #f093fb;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-clipboard-check"></i> Estado de la Cotización
                                        </h6>
                                        
                                        <!-- Estado Actual -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Decisión del Cliente:</label>
                                            <div>
                                                {% if cotizacion.usuario_acepto is None %}
                                                    <span class="badge bg-warning text-dark" style="font-size: 1rem;">
                                                        <i class="bi bi-hourglass-split"></i> Sin Respuesta
                                                    </span>
                                                {% elif cotizacion.usuario_acepto %}
                                                    <span class="badge bg-success" style="font-size: 1rem;">
                                                        <i class="bi bi-check-circle-fill"></i> ACEPTADA
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-danger" style="font-size: 1rem;">
                                                        <i class="bi bi-x-circle-fill"></i> RECHAZADA
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Fechas -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Fecha de Envío:</label>
                                            <p class="mb-0"><strong>{{ cotizacion.fecha_envio|date:"d/m/Y H:i" }}</strong></p>
                                        </div>
                                        
                                        {% if cotizacion.fecha_respuesta %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Fecha de Respuesta:</label>
                                                <p class="mb-0"><strong>{{ cotizacion.fecha_respuesta|date:"d/m/Y H:i" }}</strong></p>
                                            </div>
                                        {% else %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Días sin Respuesta:</label>
                                                <p class="mb-0">
                                                    <span class="badge {% if cotizacion.dias_sin_respuesta > 7 %}bg-danger{% elif cotizacion.dias_sin_respuesta > 3 %}bg-warning{% else %}bg-info{% endif %}">
                                                        {{ cotizacion.dias_sin_respuesta }} día{{ cotizacion.dias_sin_respuesta|pluralize }}
                                                    </span>
                                                </p>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Información de Rechazo (si aplica) -->
                                        {% if not cotizacion.usuario_acepto and cotizacion.usuario_acepto is not None %}
                                            <div class="alert alert-danger mt-3">
                                                <strong><i class="bi bi-exclamation-triangle"></i> Motivo del Rechazo:</strong><br>
                                                {{ cotizacion.get_motivo_rechazo_display }}
                                                {% if cotizacion.detalle_rechazo %}
                                                    <br><small>{{ cotizacion.detalle_rechazo }}</small>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Formulario de Gestión (Solo si sin respuesta) -->
                                        {% if cotizacion.usuario_acepto is None and form_gestionar_cotizacion %}
                                            <hr>
                                            <h6 class="mb-3"><i class="bi bi-hand-index"></i> Registrar Decisión del Cliente</h6>
                                            
                                            <form method="post" id="formGestionarCotizacion">
                                                {% csrf_token %}
                                                <input type="hidden" name="form_type" value="gestionar_cotizacion">
                                                
                                                <!-- Acción: Aceptar o Rechazar -->
                                                <div class="mb-3">
                                                    {{ form_gestionar_cotizacion.accion.errors }}
                                                    <label class="form-label">{{ form_gestionar_cotizacion.accion.label }}</label>
                                                    <div class="d-flex gap-3">
                                                        {% for radio in form_gestionar_cotizacion.accion %}
                                                            <div class="form-check">
                                                                {{ radio.tag }}
                                                                <label class="form-check-label" for="{{ radio.id_for_label }}">
                                                                    {% if 'aceptar' in radio.choice_value %}
                                                                        <i class="bi bi-check-circle text-success"></i> {{ radio.choice_label }}
                                                                    {% else %}
                                                                        <i class="bi bi-x-circle text-danger"></i> {{ radio.choice_label }}
                                                                    {% endif %}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                
                                                <!-- Campos de Rechazo (solo visibles si rechaza) -->
                                                <div id="camposRechazo" style="display: none;">
                                                    <div class="mb-3">
                                                        {{ form_gestionar_cotizacion.motivo_rechazo.errors }}
                                                        <label for="{{ form_gestionar_cotizacion.motivo_rechazo.id_for_label }}" class="form-label">
                                                            {{ form_gestionar_cotizacion.motivo_rechazo.label }}
                                                        </label>
                                                        {{ form_gestionar_cotizacion.motivo_rechazo }}
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        {{ form_gestionar_cotizacion.detalle_rechazo.errors }}
                                                        <label for="{{ form_gestionar_cotizacion.detalle_rechazo.id_for_label }}" class="form-label">
                                                            {{ form_gestionar_cotizacion.detalle_rechazo.label }}
                                                        </label>
                                                        {{ form_gestionar_cotizacion.detalle_rechazo }}
                                                    </div>
                                                </div>
                                                
                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="bi bi-save"></i> Guardar Decisión
                                                    </button>
                                                </div>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel Derecho: Resumen Financiero -->
                            <div class="col-lg-6">
                                <div class="card h-100" style="border-left: 4px solid #4facfe;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-cash-stack"></i> Resumen Financiero
                                        </h6>
                                        
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="text-muted">Mano de Obra:</td>
                                                <td class="text-end"><strong>${{ cotizacion.costo_mano_obra|floatformat:2 }}</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Total Piezas Cotizadas:</td>
                                                <td class="text-end"><strong>${{ cotizacion.costo_total_piezas|floatformat:2 }}</strong></td>
                                            </tr>
                                            {% if cotizacion.costo_piezas_aceptadas != cotizacion.costo_total_piezas %}
                                                <tr>
                                                    <td class="text-muted">Piezas Aceptadas:</td>
                                                    <td class="text-end text-success"><strong>${{ cotizacion.costo_piezas_aceptadas|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            <tr style="border-top: 2px solid #dee2e6;">
                                                <td class="text-muted"><strong>TOTAL COTIZACIÓN:</strong></td>
                                                <td class="text-end"><h5 class="mb-0 text-primary">${{ cotizacion.costo_total|floatformat:2 }}</h5></td>
                                            </tr>
                                            {% if cotizacion.usuario_acepto and cotizacion.costo_piezas_aceptadas != cotizacion.costo_total_piezas %}
                                                <tr style="border-top: 2px solid #28a745;">
                                                    <td class="text-success"><strong>TOTAL A PAGAR:</strong></td>
                                                    <td class="text-end">
                                                        <h5 class="mb-0 text-success">
                                                            ${{ cotizacion.costo_piezas_aceptadas|add:cotizacion.costo_mano_obra|floatformat:2 }}
                                                        </h5>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        </table>
                                        
                                        <div class="alert alert-info mt-3">
                                            <small>
                                                <i class="bi bi-info-circle"></i>
                                                <strong>Nota:</strong> Para agregar o editar piezas, ve al 
                                                <a href="/admin/servicio_tecnico/cotizacion/{{ orden.pk }}/change/" target="_blank" class="alert-link">
                                                    admin de Django <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de Piezas Cotizadas -->
                        {% if piezas_cotizadas %}
                            <div class="card mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-tools"></i> Piezas Cotizadas 
                                        <span class="badge bg-secondary">{{ piezas_cotizadas.count }}</span>
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="abrirModalPieza()">
                                        <i class="bi bi-plus-circle"></i> Agregar Pieza
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" id="tablaPiezas">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Prioridad</th>
                                                    <th>Componente</th>
                                                    <th>Descripción</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-end">Precio Unit.</th>
                                                    <th class="text-end">Total</th>
                                                    <th class="text-center">Necesaria</th>
                                                    <th class="text-center">Cliente</th>
                                                    <th class="text-center">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pieza in piezas_cotizadas %}
                                                    <tr data-pieza-id="{{ pieza.id }}">
                                                        <td>
                                                            <span class="badge bg-secondary">{{ pieza.orden_prioridad }}</span>
                                                        </td>
                                                        <td><strong>{{ pieza.componente.nombre }}</strong></td>
                                                        <td>
                                                            <small class="text-muted">
                                                                {{ pieza.descripcion_adicional|default:"—" }}
                                                            </small>
                                                        </td>
                                                        <td class="text-center">{{ pieza.cantidad }}</td>
                                                        <td class="text-end">${{ pieza.costo_unitario|floatformat:2 }}</td>
                                                        <td class="text-end"><strong>${{ pieza.costo_total|floatformat:2 }}</strong></td>
                                                        <td class="text-center">
                                                            {% if pieza.es_necesaria %}
                                                                <span class="badge bg-danger">Sí</span>
                                                            {% else %}
                                                                <span class="badge bg-info">Mejora</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if pieza.aceptada_por_cliente is None %}
                                                                <span class="badge bg-warning text-dark">⏳ Sin resp.</span>
                                                            {% elif pieza.aceptada_por_cliente %}
                                                                <span class="badge bg-success">✅ Aceptada</span>
                                                            {% else %}
                                                                <span class="badge bg-danger">❌ Rechazada</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                                    onclick="editarPieza({{ pieza.id }})" title="Editar">
                                                                📝
                                                            </button>
                                                            {% if cotizacion.usuario_acepto %}
                                                                <span class="text-muted" title="No se puede eliminar (cotización aceptada)">
                                                                    🔒
                                                                </span>
                                                            {% else %}
                                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                        onclick="eliminarPieza({{ pieza.id }})" title="Eliminar">
                                                                    🗑️
                                                                </button>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="card mb-4">
                                <div class="card-body text-center py-4">
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-tools" style="font-size: 3rem;"></i><br>
                                        No hay piezas cotizadas aún
                                    </p>
                                    <button type="button" class="btn btn-primary" onclick="abrirModalPieza()">
                                        <i class="bi bi-plus-circle"></i> Agregar Primera Pieza
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Seguimiento de Proveedores -->
                        {% if seguimientos_piezas %}
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <h6 class="mb-0">
                                            <i class="bi bi-truck"></i> Seguimiento de Pedidos a Proveedores
                                            <span class="badge bg-secondary">{{ seguimientos_piezas.count }}</span>
                                        </h6>
                                        {% if seguimientos_retrasados_count > 0 %}
                                            <span class="badge badge-retraso-global">
                                                ⚠️ {{ seguimientos_retrasados_count }} Pedido{{ seguimientos_retrasados_count|pluralize }} con Retraso
                                            </span>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-info text-white" onclick="abrirModalSeguimiento()">
                                        <i class="bi bi-plus-circle"></i> Agregar Seguimiento
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3" id="contenedorSeguimientos">
                                        {% for seguimiento in seguimientos_piezas %}
                                            <div class="col-md-6">
                                                <div class="card h-100 border-start border-4 seguimiento-card
                                                    {% if seguimiento.estado == 'recibido' %}border-success
                                                    {% elif seguimiento.esta_retrasado %}border-danger
                                                    {% elif seguimiento.estado == 'transito' %}border-info
                                                    {% else %}border-warning{% endif %}" 
                                                    data-seguimiento-id="{{ seguimiento.id }}">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <h6 class="card-title mb-0">
                                                                <i class="bi bi-building"></i> {{ seguimiento.proveedor }}
                                                            </h6>
                                                            <span class="badge 
                                                                {% if seguimiento.estado == 'recibido' %}bg-success
                                                                {% elif seguimiento.esta_retrasado %}bg-danger
                                                                {% elif seguimiento.estado == 'transito' %}bg-info
                                                                {% elif seguimiento.estado == 'confirmado' %}bg-primary
                                                                {% else %}bg-warning text-dark{% endif %}">
                                                                {{ seguimiento.get_estado_display }}
                                                            </span>
                                                        </div>
                                                        
                                                        <p class="card-text small mb-2">
                                                            <strong>Pedido:</strong> {{ seguimiento.numero_pedido|default:"Sin número" }}<br>
                                                            <strong>Piezas:</strong> {{ seguimiento.descripcion_piezas|truncatewords:10 }}
                                                        </p>
                                                        
                                                        <div class="small">
                                                            <div class="row">
                                                                <div class="col-6">
                                                                    <strong>Pedido:</strong><br>
                                                                    <small>{{ seguimiento.fecha_pedido|date:"d/m/Y" }}</small>
                                                                </div>
                                                                <div class="col-6">
                                                                    <strong>Estimado:</strong><br>
                                                                    <small>{{ seguimiento.fecha_entrega_estimada|date:"d/m/Y" }}</small>
                                                                </div>
                                                            </div>
                                                            {% if seguimiento.fecha_entrega_real %}
                                                                <div class="mt-2">
                                                                    <strong>Entregado:</strong> <small>{{ seguimiento.fecha_entrega_real|date:"d/m/Y" }}</small>
                                                                </div>
                                                            {% elif seguimiento.esta_retrasado %}
                                                                <div class="alert alert-danger p-2 mt-2 mb-0">
                                                                    <small><i class="bi bi-exclamation-triangle"></i> <strong>⚠️ RETRASO: {{ seguimiento.dias_retraso }} día{{ seguimiento.dias_retraso|pluralize }}</strong></small>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        {% if seguimiento.notas_seguimiento %}
                                                            <div class="mt-2 pt-2 border-top">
                                                                <small class="text-muted">
                                                                    <i class="bi bi-sticky"></i> {{ seguimiento.notas_seguimiento|truncatewords:20 }}
                                                                </small>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <!-- Botones de acción -->
                                                        <div class="btn-group btn-group-sm mt-3 w-100" role="group">
                                                            <button type="button" class="btn btn-outline-primary" 
                                                                    onclick="editarSeguimiento({{ seguimiento.id }})" 
                                                                    title="Editar">
                                                                📝 Editar
                                                            </button>
                                                            {% if seguimiento.estado != 'recibido' %}
                                                                <button type="button" class="btn btn-outline-success" 
                                                                        onclick="marcarRecibido({{ seguimiento.id }})" 
                                                                        title="Marcar como recibido">
                                                                    📬 Recibido
                                                                </button>
                                                            {% endif %}
                                                            <button type="button" class="btn btn-outline-danger" 
                                                                    onclick="eliminarSeguimiento({{ seguimiento.id }})" 
                                                                    title="Eliminar">
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="card">
                                <div class="card-body text-center py-4">
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-truck" style="font-size: 3rem;"></i><br>
                                        No hay seguimientos de proveedores aún
                                    </p>
                                    <button type="button" class="btn btn-info text-white" onclick="abrirModalSeguimiento()">
                                        <i class="bi bi-plus-circle"></i> Agregar Primer Seguimiento
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    
                    {% endif %}
                    
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCIÓN 4: CAMBIAR ESTADO Y ASIGNAR RESPONSABLES -->
    <!-- ============================================================ -->
    
    <div class="row">
        <!-- SUBSECCIÓN 4.1: Cambiar Estado -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <i class="bi bi-activity"></i>
                    Cambiar Estado de la Orden
                </div>
                <div class="card-body">
                    <form method="post" id="formCambioEstado">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="cambio_estado">
                        
                        <div class="row align-items-end">
                            <div class="col-md-8 mb-3">
                                {{ form_estado.estado.errors }}
                                <label for="{{ form_estado.estado.id_for_label }}" class="form-label">
                                    <i class="bi bi-arrow-repeat"></i> {{ form_estado.estado.label }}
                                </label>
                                {{ form_estado.estado }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check-circle"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                {{ form_estado.comentario_cambio.errors }}
                                <label for="{{ form_estado.comentario_cambio.id_for_label }}" class="form-label">
                                    <i class="bi bi-chat-text"></i> {{ form_estado.comentario_cambio.label }}
                                </label>
                                {{ form_estado.comentario_cambio }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- SUBSECCIÓN 4.2: Asignar Responsables -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-people-fill"></i>
                    Responsables de la Orden
                </div>
                <div class="card-body">
                    <!-- Cuadro informativo con responsables actuales -->
                    <div class="alert alert-info d-flex align-items-start mb-3" style="background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border: none;">
                        <i class="bi bi-info-circle-fill fs-4 me-3" style="color: #0288d1;"></i>
                        <div>
                            <h6 class="mb-2" style="color: #01579b;">Configuración Actual:</h6>
                            <p class="mb-1">
                                <strong>Técnico:</strong> 
                                <span class="badge bg-primary">{{ orden.tecnico_asignado_actual.nombre_completo }}</span>
                            </p>
                            <p class="mb-0">
                                <strong>Responsable:</strong> 
                                <span class="badge bg-secondary">{{ orden.responsable_seguimiento.nombre_completo }}</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Formulario para cambiar responsables -->
                    <form method="post" id="formAsignarResponsables">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="asignar_responsables">
                        
                        <div class="mb-3">
                            {{ form_responsables.tecnico_asignado_actual.errors }}
                            <label for="{{ form_responsables.tecnico_asignado_actual.id_for_label }}" class="form-label">
                                <i class="bi bi-person-badge"></i> {{ form_responsables.tecnico_asignado_actual.label }}
                            </label>
                            {{ form_responsables.tecnico_asignado_actual }}
                            <small class="text-muted">{{ form_responsables.tecnico_asignado_actual.help_text }}</small>
                            
                            <!-- Alerta de carga de trabajo del técnico seleccionado -->
                            <div id="alertaTecnico" class="mt-2" style="display: none;">
                                <!-- Se llena dinámicamente con JavaScript -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form_responsables.responsable_seguimiento.errors }}
                            <label for="{{ form_responsables.responsable_seguimiento.id_for_label }}" class="form-label">
                                <i class="bi bi-person-check"></i> {{ form_responsables.responsable_seguimiento.label }}
                            </label>
                            {{ form_responsables.responsable_seguimiento }}
                            <small class="text-muted">{{ form_responsables.responsable_seguimiento.help_text }}</small>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Actualizar Responsables
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCIÓN 5: HISTORIAL Y COMENTARIOS (2 columnas) -->
    <!-- ============================================================ -->
    
    <div class="row">
        <!-- Historial Automático (Izquierda) -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="bi bi-clock-history"></i>
                    Historial Automático
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if historial_automatico %}
                        <div class="timeline">
                            {% for evento in historial_automatico %}
                            <div class="timeline-item">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <span class="badge bg-secondary">{{ evento.get_tipo_evento_display }}</span>
                                    <small class="text-muted">{{ evento.fecha_evento|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ evento.comentario }}</p>
                                {% if evento.usuario %}
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> {{ evento.usuario.nombre_completo }}
                                    </small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No hay eventos en el historial.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Comentarios (Derecha) -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                    <i class="bi bi-chat-dots"></i>
                    Comentarios
                </div>
                <div class="card-body">
                    <!-- Formulario para agregar comentario -->
                    <form method="post" id="formComentario" class="mb-4">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="comentario">
                        
                        {{ form_comentario.comentario.errors }}
                        <label for="{{ form_comentario.comentario.id_for_label }}" class="form-label">
                            <i class="bi bi-plus-circle"></i> Agregar Comentario
                        </label>
                        {{ form_comentario.comentario }}
                        
                        <div class="d-grid mt-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Publicar Comentario
                            </button>
                        </div>
                    </form>
                    
                    <hr>
                    
                    <!-- Lista de comentarios -->
                    <div style="max-height: 350px; overflow-y: auto;">
                        {% if comentarios %}
                            {% for comentario in comentarios %}
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <strong>
                                        <i class="bi bi-person-circle"></i>
                                        {{ comentario.usuario.nombre_completo|default:"Sistema" }}
                                    </strong>
                                    <small class="text-muted">{{ comentario.fecha_evento|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-0">{{ comentario.comentario }}</p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center">No hay comentarios aún.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCIÓN 6: GALERÍA DE IMÁGENES -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); color: #333;">
                    <i class="bi bi-images"></i>
                    Galería de Imágenes del Equipo
                    <span class="badge bg-dark ms-2">{{ total_imagenes }} imagen{{ total_imagenes|pluralize:"es" }}</span>
                </div>
                <div class="card-body">
                    
                    <!-- Formulario para subir imágenes -->
                    <div class="border rounded p-3 mb-4 bg-light">
                        <h6 class="mb-3">
                            <i class="bi bi-cloud-upload"></i> Subir Nuevas Imágenes
                            <span id="archivosSeleccionados" class="badge bg-info ms-2" style="display: none;">0 archivos</span>
                        </h6>
                        
                        <form method="post" enctype="multipart/form-data" id="formSubirImagenes">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="subir_imagenes">
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    {{ form_imagenes.tipo.errors }}
                                    <label for="{{ form_imagenes.tipo.id_for_label }}" class="form-label">
                                        {{ form_imagenes.tipo.label }}
                                    </label>
                                    {{ form_imagenes.tipo }}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    {{ form_imagenes.imagenes.errors }}
                                    <label for="{{ form_imagenes.imagenes.id_for_label }}" class="form-label">
                                        {{ form_imagenes.imagenes.label }}
                                    </label>
                                    <input type="file" 
                                           name="imagenes" 
                                           class="form-control" 
                                           id="{{ form_imagenes.imagenes.id_for_label }}"
                                           accept="image/jpeg,image/jpg,image/png,image/gif"
                                           multiple>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-info-circle"></i> Máximo 6MB por imagen. Formatos: JPG, PNG, GIF
                                    </small>
                                </div>
                                
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100" id="btnSubirImagenes">
                                        <i class="bi bi-upload"></i> Subir
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Barra de progreso (oculta por defecto) -->
                            <div class="row mb-3" id="progresoUpload" style="display: none;">
                                <div class="col-12">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 me-3">
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                     role="progressbar" 
                                                     id="barraProgreso"
                                                     style="width: 0%">
                                                    <span id="textoProgreso">Subiendo...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="badge bg-primary" id="porcentajeProgreso">0%</span>
                                    </div>
                                    <small class="text-muted d-block mt-1" id="infoArchivos">
                                        <i class="bi bi-hourglass-split"></i> Procesando imágenes, por favor espere...
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    {{ form_imagenes.descripcion.errors }}
                                    <label for="{{ form_imagenes.descripcion.id_for_label }}" class="form-label">
                                        {{ form_imagenes.descripcion.label }}
                                    </label>
                                    {{ form_imagenes.descripcion }}
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabs de categorías de imágenes -->
                    <ul class="nav nav-pills mb-3" id="imagenesTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ingreso-tab" data-bs-toggle="pill" data-bs-target="#ingreso" type="button">
                                <i class="bi bi-arrow-down-circle"></i> Ingreso 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.ingreso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diagnostico-tab" data-bs-toggle="pill" data-bs-target="#diagnostico" type="button">
                                <i class="bi bi-search"></i> Diagnóstico 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.diagnostico.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reparacion-tab" data-bs-toggle="pill" data-bs-target="#reparacion" type="button">
                                <i class="bi bi-tools"></i> Reparación 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.reparacion.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="egreso-tab" data-bs-toggle="pill" data-bs-target="#egreso" type="button">
                                <i class="bi bi-arrow-up-circle"></i> Egreso 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.egreso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="otras-tab" data-bs-toggle="pill" data-bs-target="#otras" type="button">
                                <i class="bi bi-image"></i> Otras 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.otras.count }}</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Contenido de los tabs -->
                    <div class="tab-content" id="imagenesTabContent">
                        {% for tipo, imagenes in imagenes_por_tipo.items %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ tipo }}" role="tabpanel">
                            {% if imagenes %}
                            <div class="row g-3">
                                {% for imagen in imagenes %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="gallery-image-container"
                                         data-descripcion="{{ imagen.descripcion|default:'Sin descripción' }}"
                                         data-usuario="{{ imagen.subido_por.nombre_completo }}"
                                         data-fecha="{{ imagen.fecha_subida|date:'d/m/Y H:i' }}"
                                         data-url-descarga="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}">
                                        
                                        <!-- Botón descarga en miniatura -->
                                        <a href="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}" 
                                           class="btn-descarga-miniatura" 
                                           title="Descargar imagen original"
                                           onclick="event.stopPropagation();">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        
                                        <div class="gallery-image">
                                            <img src="{{ imagen.imagen.url }}" alt="{{ imagen.descripcion }}">
                                            <div class="image-overlay">
                                                <div>{{ imagen.fecha_subida|date:"d/m/Y H:i" }}</div>
                                                {% if imagen.descripcion %}
                                                    <div class="small">{{ imagen.descripcion|truncatewords:5 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Pie de imagen con usuario -->
                                        <div class="image-footer">
                                            <small class="text-muted">
                                                <i class="bi bi-person-circle"></i> {{ imagen.subido_por.nombre_completo }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <p class="mt-2">No hay imágenes de {{ tipo }} aún.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- ============================================================ -->
<!-- MODAL: EDITAR INFORMACIÓN PRINCIPAL DEL EQUIPO -->
<!-- ============================================================ -->
<div class="modal fade" id="modalEditarInfoEquipo" tabindex="-1" aria-labelledby="modalEditarInfoEquipoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEditarInfoEquipoLabel">
                    <i class="bi bi-pencil-square"></i> Editar Información del Equipo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <form method="post" id="formEditarInfoEquipo">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="editar_info_equipo">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Importante:</strong> Puedes actualizar cualquier información del equipo que haya sido omitida o necesite corrección.
                    </div>
                    
                    <div class="row">
                        <!-- Tipo de Equipo -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.tipo_equipo.errors }}
                            <label for="{{ form_editar_info.tipo_equipo.id_for_label }}" class="form-label">
                                {{ form_editar_info.tipo_equipo.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.tipo_equipo }}
                            {% if form_editar_info.tipo_equipo.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.tipo_equipo.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Gama -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.gama.errors }}
                            <label for="{{ form_editar_info.gama.id_for_label }}" class="form-label">
                                {{ form_editar_info.gama.label }}
                            </label>
                            {{ form_editar_info.gama }}
                            {% if form_editar_info.gama.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.gama.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Marca -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.marca.errors }}
                            <label for="{{ form_editar_info.marca.id_for_label }}" class="form-label">
                                {{ form_editar_info.marca.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.marca }}
                            {% if form_editar_info.marca.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.marca.help_text }}</small>
                            {% endif %}
                            
                            <!-- Datalist para autocompletar marcas -->
                            <datalist id="marcas-list-modal">
                                <option value="Dell">
                                <option value="HP">
                                <option value="Lenovo">
                                <option value="Acer">
                                <option value="Asus">
                                <option value="Apple">
                                <option value="MSI">
                                <option value="Toshiba">
                                <option value="Samsung">
                                <option value="Sony">
                            </datalist>
                        </div>
                        
                        <!-- Modelo -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.modelo.errors }}
                            <label for="{{ form_editar_info.modelo.id_for_label }}" class="form-label">
                                {{ form_editar_info.modelo.label }}
                            </label>
                            {{ form_editar_info.modelo }}
                            {% if form_editar_info.modelo.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.modelo.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Número de Serie -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.numero_serie.errors }}
                            <label for="{{ form_editar_info.numero_serie.id_for_label }}" class="form-label">
                                {{ form_editar_info.numero_serie.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.numero_serie }}
                            {% if form_editar_info.numero_serie.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.numero_serie.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Orden del Cliente -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.orden_cliente.errors }}
                            <label for="{{ form_editar_info.orden_cliente.id_for_label }}" class="form-label">
                                {{ form_editar_info.orden_cliente.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.orden_cliente }}
                            {% if form_editar_info.orden_cliente.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.orden_cliente.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Equipo Enciende -->
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form_editar_info.equipo_enciende }}
                                <label class="form-check-label" for="{{ form_editar_info.equipo_enciende.id_for_label }}">
                                    {{ form_editar_info.equipo_enciende.label }}
                                </label>
                            </div>
                            {% if form_editar_info.equipo_enciende.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.equipo_enciende.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <hr class="my-3">
                        
                        <!-- Tiene Cargador -->
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form_editar_info.tiene_cargador }}
                                <label class="form-check-label" for="{{ form_editar_info.tiene_cargador.id_for_label }}">
                                    {{ form_editar_info.tiene_cargador.label }}
                                </label>
                            </div>
                            {% if form_editar_info.tiene_cargador.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.tiene_cargador.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Número de Serie del Cargador -->
                        <div class="col-md-12 mb-3" id="divNumeroSerieCargadorModal" style="display: none;">
                            {{ form_editar_info.numero_serie_cargador.errors }}
                            <label for="{{ form_editar_info.numero_serie_cargador.id_for_label }}" class="form-label">
                                {{ form_editar_info.numero_serie_cargador.label }}
                            </label>
                            {{ form_editar_info.numero_serie_cargador }}
                            {% if form_editar_info.numero_serie_cargador.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.numero_serie_cargador.help_text }}</small>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" form="formEditarInfoEquipo" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: GESTIONAR PIEZA COTIZADA (Agregar/Editar) -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalPieza" tabindex="-1" aria-labelledby="modalPiezaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalPiezaLabel">
                    <i class="bi bi-gear"></i> <span id="modalPiezaTitulo">Agregar Pieza</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formPieza">
                {% csrf_token %}
                <input type="hidden" id="piezaId" name="pieza_id" value="">
                
                <div class="modal-body">
                    <!-- Alerta de errores (oculta por defecto) -->
                    <div class="alert alert-danger d-none" id="alertErroresPieza" role="alert">
                        <strong>❌ Errores:</strong>
                        <ul id="listaErroresPieza" class="mb-0"></ul>
                    </div>
                    
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-md-6">
                            <!-- Componente -->
                            <div class="mb-3">
                                <label for="componente" class="form-label">
                                    Componente <span class="text-danger">*</span>
                                </label>
                                <select class="form-control form-select" id="componente" name="componente" required>
                                    <option value="">-- Selecciona un componente --</option>
                                    <!-- Opciones serán cargadas dinámicamente desde el backend -->
                                </select>
                                <small class="form-text text-muted">Selecciona el componente del catálogo</small>
                            </div>
                            
                            <!-- Cantidad -->
                            <div class="mb-3">
                                <label for="cantidad" class="form-label">
                                    Cantidad <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="cantidad" name="cantidad" 
                                       min="1" value="1" required>
                                <small class="form-text text-muted">Número de unidades a cambiar</small>
                            </div>
                            
                            <!-- Costo Unitario -->
                            <div class="mb-3">
                                <label for="costo_unitario" class="form-label">
                                    Costo Unitario ($) <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="costo_unitario" name="costo_unitario" 
                                       step="0.01" min="0" placeholder="0.00" required>
                                <small class="form-text text-muted">Precio por unidad</small>
                            </div>
                        </div>
                        
                        <!-- Columna derecha -->
                        <div class="col-md-6">
                            <!-- Orden de Prioridad -->
                            <div class="mb-3">
                                <label for="orden_prioridad" class="form-label">
                                    Prioridad <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="orden_prioridad" name="orden_prioridad" 
                                       min="1" value="1" required>
                                <small class="form-text text-muted">1 = más importante</small>
                            </div>
                            
                            <!-- Es Necesaria -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="es_necesaria" name="es_necesaria">
                                    <label class="form-check-label" for="es_necesaria">
                                        ¿Es necesaria para el funcionamiento?
                                    </label>
                                </div>
                                <small class="form-text text-muted">Marca si es necesaria (vs mejora estética/rendimiento)</small>
                            </div>
                            
                            <!-- Sugerida por Técnico -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sugerida_por_tecnico" name="sugerida_por_tecnico">
                                    <label class="form-check-label" for="sugerida_por_tecnico">
                                        ¿Sugerida por el técnico?
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Descripción Adicional (full width) -->
                    <div class="mb-3">
                        <label for="descripcion_adicional" class="form-label">
                            Descripción Adicional
                        </label>
                        <textarea class="form-control" id="descripcion_adicional" name="descripcion_adicional" 
                                  rows="2" placeholder="Descripción específica de la pieza (opcional)"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> <span id="btnPiezaTexto">Agregar Pieza</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: GESTIONAR SEGUIMIENTO DE PIEZA (Agregar/Editar) -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalSeguimiento" tabindex="-1" aria-labelledby="modalSeguimientoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalSeguimientoLabel">
                    <i class="bi bi-truck"></i> <span id="modalSeguimientoTitulo">Agregar Seguimiento</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formSeguimiento">
                {% csrf_token %}
                <input type="hidden" id="seguimientoId" name="seguimiento_id" value="">
                
                <div class="modal-body">
                    <!-- Alerta de errores (oculta por defecto) -->
                    <div class="alert alert-danger d-none" id="alertErroresSeguimiento" role="alert">
                        <strong>❌ Errores:</strong>
                        <ul id="listaErroresSeguimiento" class="mb-0"></ul>
                    </div>
                    
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-md-6">
                            <!-- Proveedor -->
                            <div class="mb-3">
                                <label for="proveedor" class="form-label">
                                    Proveedor <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="proveedor" name="proveedor" 
                                       placeholder="Ej: STEREN, CompuMarket, Amazon" required 
                                       list="proveedores-list">
                                <datalist id="proveedores-list">
                                    <option value="STEREN">
                                    <option value="CompuMarket">
                                    <option value="Amazon">
                                    <option value="MercadoLibre">
                                </datalist>
                                <small class="form-text text-muted">Nombre del proveedor donde se pidió</small>
                            </div>
                            
                            <!-- Descripción de Piezas -->
                            <div class="mb-3">
                                <label for="descripcion_piezas" class="form-label">
                                    Descripción de Piezas <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="descripcion_piezas" name="descripcion_piezas" 
                                          rows="2" placeholder="Describe las piezas incluidas en este pedido" required></textarea>
                                <small class="form-text text-muted">Lista de piezas incluidas en este pedido</small>
                            </div>
                            
                            <!-- Número de Pedido -->
                            <div class="mb-3">
                                <label for="numero_pedido" class="form-label">
                                    Número de Pedido / Tracking
                                </label>
                                <input type="text" class="form-control" id="numero_pedido" name="numero_pedido" 
                                       placeholder="Número de pedido o tracking">
                                <small class="form-text text-muted">Número de orden o tracking del proveedor (opcional)</small>
                            </div>
                        </div>
                        
                        <!-- Columna derecha -->
                        <div class="col-md-6">
                            <!-- Fecha de Pedido -->
                            <div class="mb-3">
                                <label for="fecha_pedido" class="form-label">
                                    Fecha de Pedido <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="fecha_pedido" name="fecha_pedido" required>
                            </div>
                            
                            <!-- Fecha Estimada de Entrega -->
                            <div class="mb-3">
                                <label for="fecha_entrega_estimada" class="form-label">
                                    Fecha Estimada de Entrega <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="fecha_entrega_estimada" name="fecha_entrega_estimada" required>
                                <small class="form-text text-muted">Fecha comprometida por el proveedor</small>
                            </div>
                            
                            <!-- Fecha Real de Entrega -->
                            <div class="mb-3">
                                <label for="fecha_entrega_real" class="form-label">
                                    Fecha Real de Entrega
                                </label>
                                <input type="date" class="form-control" id="fecha_entrega_real" name="fecha_entrega_real">
                                <small class="form-text text-muted">Dejar vacío si aún no llega</small>
                            </div>
                            
                            <!-- Estado -->
                            <div class="mb-3">
                                <label for="estado" class="form-label">
                                    Estado del Pedido <span class="text-danger">*</span>
                                </label>
                                <select class="form-control form-select" id="estado" name="estado" required>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="en_transito">En Tránsito</option>
                                    <option value="recibido">Recibido</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                                <small class="form-text text-muted">Estado actual del pedido</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notas de Seguimiento (full width) -->
                    <div class="mb-3">
                        <label for="notas_seguimiento" class="form-label">
                            Notas de Seguimiento
                        </label>
                        <textarea class="form-control" id="notas_seguimiento" name="notas_seguimiento" 
                                  rows="2" placeholder="Notas adicionales sobre el seguimiento (opcional)"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="bi bi-check-circle"></i> <span id="btnSeguimientoTexto">Agregar Seguimiento</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Lightbox personalizado para galería -->
<script src="{% static 'js/lightbox_galeria.js' %}?v=1.0"></script>

<script>
// ============================================================================
// ESTADÍSTICAS DE TÉCNICOS (Datos del servidor)
// ============================================================================
// Convertir las estadísticas de técnicos de Django a JavaScript
const estadisticasTecnicos = {{ estadisticas_tecnicos|safe }};

// ============================================================================
// ALERTA DINÁMICA DE CARGA DE TRABAJO DEL TÉCNICO
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    const selectTecnico = document.getElementById('id_tecnico_select');
    const divAlerta = document.getElementById('alertaTecnico');
    
    if (selectTecnico && divAlerta) {
        // Función para mostrar la alerta según el técnico seleccionado
        function mostrarAlertaTecnico() {
            const tecnicoId = selectTecnico.value;
            
            if (!tecnicoId || !estadisticasTecnicos[tecnicoId]) {
                divAlerta.style.display = 'none';
                return;
            }
            
            const stats = estadisticasTecnicos[tecnicoId];
            const ordenesActivas = stats.ordenes_activas;
            const equiposNoEncienden = stats.equipos_no_encienden;
            const tieneSobrecarga = stats.tiene_sobrecarga;
            const porcentaje = stats.porcentaje_no_encienden;
            
            // Si no tiene órdenes activas, no mostrar nada
            if (ordenesActivas === 0) {
                divAlerta.style.display = 'none';
                return;
            }
            
            // Determinar el tipo de alerta y mensaje
            let tipoAlerta = 'info';
            let icono = 'info-circle';
            let mensaje = '';
            
            if (tieneSobrecarga) {
                // ALERTA ROJA: 3 o más equipos que no encienden
                tipoAlerta = 'danger';
                icono = 'exclamation-triangle-fill';
                mensaje = `
                    <strong>⚠️ ALTA CARGA DE TRABAJO</strong><br>
                    Este técnico tiene <strong>${equiposNoEncienden}</strong> equipos que NO encienden 
                    de un total de <strong>${ordenesActivas}</strong> órdenes activas (${porcentaje}%).<br>
                    <small>Considera asignar a otro técnico con menos carga.</small>
                `;
            } else if (equiposNoEncienden > 0) {
                // ALERTA AMARILLA: Tiene equipos que no encienden pero no sobrecarga
                tipoAlerta = 'warning';
                icono = 'exclamation-circle-fill';
                mensaje = `
                    <strong>⚡ Equipos complejos asignados</strong><br>
                    Este técnico tiene <strong>${equiposNoEncienden}</strong> equipos que NO encienden 
                    de <strong>${ordenesActivas}</strong> órdenes activas (${porcentaje}%).<br>
                    <small>Aún tiene capacidad, pero monitorea su carga de trabajo.</small>
                `;
            } else {
                // ALERTA AZUL: Tiene órdenes pero todas encienden
                tipoAlerta = 'info';
                icono = 'info-circle-fill';
                mensaje = `
                    <strong>✓ Carga normal</strong><br>
                    Este técnico tiene <strong>${ordenesActivas}</strong> órdenes activas, 
                    todos los equipos encienden.<br>
                    <small>Buena disponibilidad para nuevas asignaciones.</small>
                `;
            }
            
            // Mostrar la alerta
            divAlerta.className = `alert alert-${tipoAlerta} d-flex align-items-start`;
            divAlerta.innerHTML = `
                <i class="bi bi-${icono} me-2 mt-1"></i>
                <div style="font-size: 0.9rem;">${mensaje}</div>
            `;
            divAlerta.style.display = 'flex';
        }
        
        // Mostrar alerta al cargar la página (técnico actual)
        mostrarAlertaTecnico();
        
        // Actualizar alerta al cambiar el técnico
        selectTecnico.addEventListener('change', mostrarAlertaTecnico);
    }
});

// ============================================================================
// CONFIRMACIONES ANTES DE ENVIAR FORMULARIOS
// ============================================================================
document.getElementById('formCambioEstado').addEventListener('submit', function(e) {
    if (!confirm('¿Estás seguro de cambiar el estado de la orden?')) {
        e.preventDefault();
    }
});

// ============================================================================
// SISTEMA DE CARGA DE IMÁGENES CON FEEDBACK VISUAL
// ============================================================================

// Mostrar contador de archivos seleccionados
const inputImagenes = document.querySelector('input[name="imagenes"]');
const badgeArchivos = document.getElementById('archivosSeleccionados');

inputImagenes.addEventListener('change', function(e) {
    const files = e.target.files;
    const numArchivos = files.length;
    
    if (numArchivos > 0) {
        badgeArchivos.textContent = `${numArchivos} archivo${numArchivos !== 1 ? 's' : ''}`;
        badgeArchivos.style.display = 'inline-block';
        
        // Calcular tamaño total
        let tamanioTotal = 0;
        for (let i = 0; i < files.length; i++) {
            tamanioTotal += files[i].size;
        }
        const tamanioMB = (tamanioTotal / (1024 * 1024)).toFixed(2);
        
        console.log(`${numArchivos} imagen(es) seleccionada(s) - Tamaño total: ${tamanioMB} MB`);
    } else {
        badgeArchivos.style.display = 'none';
    }
});

// Manejo del envío del formulario con barra de progreso
const formSubirImagenes = document.getElementById('formSubirImagenes');
const btnSubir = document.getElementById('btnSubirImagenes');
const progresoDiv = document.getElementById('progresoUpload');
const barraProgreso = document.getElementById('barraProgreso');
const textoProgreso = document.getElementById('textoProgreso');
const porcentajeProgreso = document.getElementById('porcentajeProgreso');
const infoArchivos = document.getElementById('infoArchivos');

formSubirImagenes.addEventListener('submit', function(e) {
    e.preventDefault(); // Prevenir envío normal del formulario
    
    const files = inputImagenes.files;
    
    // Validar que haya archivos seleccionados
    if (files.length === 0) {
        alert('Por favor selecciona al menos una imagen para subir.');
        return;
    }
    
    // Preparar FormData con todos los datos del formulario
    const formData = new FormData(formSubirImagenes);
    
    // Mostrar feedback visual: deshabilitar formulario
    btnSubir.disabled = true;
    inputImagenes.disabled = true;
    document.getElementById('{{ form_imagenes.tipo.id_for_label }}').disabled = true;
    document.getElementById('{{ form_imagenes.descripcion.id_for_label }}').disabled = true;
    
    // Cambiar texto del botón
    btnSubir.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...';
    
    // Mostrar barra de progreso
    progresoDiv.style.display = 'block';
    barraProgreso.style.width = '0%';
    textoProgreso.textContent = 'Iniciando subida...';
    porcentajeProgreso.textContent = '0%';
    infoArchivos.innerHTML = `<i class="bi bi-hourglass-split"></i> Subiendo ${files.length} imagen${files.length !== 1 ? 'es' : ''}...`;
    
    // Crear XMLHttpRequest para poder monitorear el progreso
    const xhr = new XMLHttpRequest();
    
    // Monitorear progreso de subida
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const porcentaje = Math.round((e.loaded / e.total) * 100);
            barraProgreso.style.width = porcentaje + '%';
            porcentajeProgreso.textContent = porcentaje + '%';
            
            if (porcentaje < 100) {
                textoProgreso.textContent = `Subiendo... ${porcentaje}%`;
            } else {
                textoProgreso.textContent = 'Procesando imágenes...';
                infoArchivos.innerHTML = '<i class="bi bi-cpu"></i> Comprimiendo y guardando imágenes, por favor espere...';
            }
        }
    });
    
    // Manejar respuesta del servidor
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            // Éxito - mostrar mensaje final
            barraProgreso.classList.remove('progress-bar-animated');
            barraProgreso.classList.add('bg-success');
            textoProgreso.textContent = '¡Completado!';
            porcentajeProgreso.textContent = '100%';
            infoArchivos.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> Imágenes subidas exitosamente. Recargando página...';
            
            // Recargar página después de 1.5 segundos
            setTimeout(function() {
                window.location.reload();
            }, 1500);
        } else {
            // Error del servidor
            mostrarErrorCarga('Error del servidor. Por favor intenta nuevamente.');
        }
    });
    
    // Manejar errores de red
    xhr.addEventListener('error', function() {
        mostrarErrorCarga('Error de conexión. Verifica tu conexión a internet.');
    });
    
    // Manejar timeout
    xhr.addEventListener('timeout', function() {
        mostrarErrorCarga('Tiempo de espera agotado. Las imágenes pueden ser muy grandes.');
    });
    
    // Configurar y enviar la petición
    xhr.open('POST', formSubirImagenes.action || window.location.href);
    xhr.timeout = 120000; // 2 minutos de timeout
    xhr.send(formData);
});

// Función auxiliar para mostrar errores
function mostrarErrorCarga(mensaje) {
    barraProgreso.classList.remove('bg-success', 'progress-bar-animated');
    barraProgreso.classList.add('bg-danger');
    textoProgreso.textContent = 'Error';
    infoArchivos.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i> ${mensaje}`;
    
    // Rehabilitar formulario después de 3 segundos
    setTimeout(function() {
        btnSubir.disabled = false;
        inputImagenes.disabled = false;
        document.getElementById('{{ form_imagenes.tipo.id_for_label }}').disabled = false;
        document.getElementById('{{ form_imagenes.descripcion.id_for_label }}').disabled = false;
        btnSubir.innerHTML = '<i class="bi bi-upload"></i> Subir';
        progresoDiv.style.display = 'none';
        barraProgreso.classList.remove('bg-danger');
        barraProgreso.classList.add('progress-bar-animated', 'bg-success');
    }, 3000);
}

// ============================================================================
// CONTROL DEL CAMPO CARGADOR EN EL MODAL
// ============================================================================
function toggleCargadorFieldsModal() {
    const checkboxCargador = document.getElementById('id_tiene_cargador_modal');
    const divNumeroSerie = document.getElementById('divNumeroSerieCargadorModal');
    
    if (checkboxCargador && divNumeroSerie) {
        if (checkboxCargador.checked) {
            divNumeroSerie.style.display = 'block';
        } else {
            divNumeroSerie.style.display = 'none';
            // Limpiar el campo si se desmarca
            const inputNumeroSerie = document.getElementById('id_numero_serie_cargador_modal');
            if (inputNumeroSerie) {
                inputNumeroSerie.value = '';
            }
        }
    }
}

// Inicializar estado al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    toggleCargadorFieldsModal();
});

// Inicializar estado al abrir el modal
const modalEditarInfo = document.getElementById('modalEditarInfoEquipo');
if (modalEditarInfo) {
    modalEditarInfo.addEventListener('shown.bs.modal', function() {
        toggleCargadorFieldsModal();
    });
}

// ============================================================================
// GESTIÓN DE COTIZACIÓN - Mostrar/Ocultar campos de rechazo
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    const formGestionar = document.getElementById('formGestionarCotizacion');
    
    if (formGestionar) {
        const radiosAccion = document.querySelectorAll('input[name="accion"]');
        const camposRechazo = document.getElementById('camposRechazo');
        const selectMotivo = document.querySelector('select[name="motivo_rechazo"]');
        
        // Función para mostrar/ocultar campos de rechazo
        function toggleCamposRechazo() {
            const accionSeleccionada = document.querySelector('input[name="accion"]:checked');
            
            if (accionSeleccionada && accionSeleccionada.value === 'rechazar') {
                camposRechazo.style.display = 'block';
                // Hacer el motivo obligatorio
                if (selectMotivo) {
                    selectMotivo.required = true;
                }
            } else {
                camposRechazo.style.display = 'none';
                // Quitar obligatoriedad
                if (selectMotivo) {
                    selectMotivo.required = false;
                }
            }
        }
        
        // Escuchar cambios en los radio buttons
        radiosAccion.forEach(radio => {
            radio.addEventListener('change', toggleCamposRechazo);
        });
        
        // Inicializar al cargar
        toggleCamposRechazo();
        
        // Confirmación antes de enviar
        formGestionar.addEventListener('submit', function(e) {
            const accionSeleccionada = document.querySelector('input[name="accion"]:checked');
            
            if (!accionSeleccionada) {
                e.preventDefault();
                alert('Por favor selecciona si aceptas o rechazas la cotización.');
                return false;
            }
            
            const accion = accionSeleccionada.value;
            const mensaje = accion === 'aceptar' 
                ? '¿Confirmas que el cliente ACEPTÓ la cotización? Esto cambiará el estado de la orden.'
                : '¿Confirmas que el cliente RECHAZÓ la cotización? Esto cambiará el estado de la orden.';
            
            if (!confirm(mensaje)) {
                e.preventDefault();
                return false;
            }
        });
    }
});

// ============================================================================
// GESTIÓN DE PIEZAS COTIZADAS - FUNCIONES AJAX
// ============================================================================

/**
 * Abre el modal para agregar una nueva pieza
 */
function abrirModalPieza(piezaId = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalPieza'));
    const form = document.getElementById('formPieza');
    const titulo = document.getElementById('modalPiezaTitulo');
    const btnTexto = document.getElementById('btnPiezaTexto');
    const alertErrores = document.getElementById('alertErroresPieza');
    
    // Resetear formulario
    form.reset();
    alertErrores.classList.add('d-none');
    
    if (piezaId) {
        // Modo EDITAR - Cargar datos de la pieza
        titulo.textContent = 'Editar Pieza';
        btnTexto.textContent = 'Actualizar Pieza';
        document.getElementById('piezaId').value = piezaId;
        
        // Aquí cargaríamos los datos vía AJAX si fuera necesario
        // Por ahora asumimos que los datos ya están en el form
    } else {
        // Modo AGREGAR
        titulo.textContent = 'Agregar Pieza';
        btnTexto.textContent = 'Agregar Pieza';
        document.getElementById('piezaId').value = '';
    }
    
    modal.show();
}

/**
 * Guarda una pieza (agregar o editar)
 */
document.getElementById('formPieza')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const piezaId = document.getElementById('piezaId').value;
    const formData = new FormData(this);
    const alertErrores = document.getElementById('alertErroresPieza');
    const listaErrores = document.getElementById('listaErroresPieza');
    
    // Determinar URL según sea agregar o editar
    let url;
    if (piezaId) {
        url = "{% url 'servicio_tecnico:editar_pieza' 0 %}".replace('/0/', `/${piezaId}/`);
    } else {
        url = "{% url 'servicio_tecnico:agregar_pieza' orden.id %}";
    }
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalPieza')).hide();
            
            // Mostrar mensaje de éxito
            mostrarToast(data.message, 'success');
            
            // Recargar la página para actualizar la tabla
            setTimeout(() => location.reload(), 1000);
        } else {
            // Mostrar errores del formulario
            listaErrores.innerHTML = '';
            if (data.errors) {
                Object.entries(data.errors).forEach(([field, error]) => {
                    const li = document.createElement('li');
                    li.textContent = `${field}: ${error}`;
                    listaErrores.appendChild(li);
                });
            } else if (data.error) {
                const li = document.createElement('li');
                li.textContent = data.error;
                listaErrores.appendChild(li);
            }
            alertErrores.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexión', 'danger');
    }
});

/**
 * Edita una pieza existente
 */
function editarPieza(piezaId) {
    abrirModalPieza(piezaId);
    // TODO: Cargar datos de la pieza vía AJAX y poblar el formulario
}

/**
 * Elimina una pieza
 */
async function eliminarPieza(piezaId) {
    if (!confirm('¿Estás seguro de eliminar esta pieza?')) {
        return;
    }
    
    const url = "{% url 'servicio_tecnico:eliminar_pieza' 0 %}".replace('/0/', `/${piezaId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message, 'success');
            
            // Eliminar la fila de la tabla
            const fila = document.querySelector(`tr[data-pieza-id="${piezaId}"]`);
            if (fila) {
                fila.remove();
            }
            
            // Recargar para actualizar totales
            setTimeout(() => location.reload(), 1000);
        } else {
            mostrarToast(data.error || 'Error al eliminar', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexión', 'danger');
    }
}

// ============================================================================
// GESTIÓN DE SEGUIMIENTOS - FUNCIONES AJAX
// ============================================================================

/**
 * Abre el modal para agregar/editar seguimiento
 */
function abrirModalSeguimiento(seguimientoId = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalSeguimiento'));
    const form = document.getElementById('formSeguimiento');
    const titulo = document.getElementById('modalSeguimientoTitulo');
    const btnTexto = document.getElementById('btnSeguimientoTexto');
    const alertErrores = document.getElementById('alertErroresSeguimiento');
    
    // Resetear formulario
    form.reset();
    alertErrores.classList.add('d-none');
    
    if (seguimientoId) {
        // Modo EDITAR
        titulo.textContent = 'Editar Seguimiento';
        btnTexto.textContent = 'Actualizar Seguimiento';
        document.getElementById('seguimientoId').value = seguimientoId;
        
        // TODO: Cargar datos del seguimiento vía AJAX
    } else {
        // Modo AGREGAR
        titulo.textContent = 'Agregar Seguimiento';
        btnTexto.textContent = 'Agregar Seguimiento';
        document.getElementById('seguimientoId').value = '';
        
        // Establecer fecha de hoy por defecto
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_pedido').value = hoy;
    }
    
    modal.show();
}

/**
 * Guarda un seguimiento (agregar o editar)
 */
document.getElementById('formSeguimiento')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const seguimientoId = document.getElementById('seguimientoId').value;
    const formData = new FormData(this);
    const alertErrores = document.getElementById('alertErroresSeguimiento');
    const listaErrores = document.getElementById('listaErroresSeguimiento');
    
    // Determinar URL
    let url;
    if (seguimientoId) {
        url = "{% url 'servicio_tecnico:editar_seguimiento' 0 %}".replace('/0/', `/${seguimientoId}/`);
    } else {
        url = "{% url 'servicio_tecnico:agregar_seguimiento' orden.id %}";
    }
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('modalSeguimiento')).hide();
            mostrarToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            listaErrores.innerHTML = '';
            if (data.errors) {
                Object.entries(data.errors).forEach(([field, error]) => {
                    const li = document.createElement('li');
                    li.textContent = `${field}: ${error}`;
                    listaErrores.appendChild(li);
                });
            } else if (data.error) {
                const li = document.createElement('li');
                li.textContent = data.error;
                listaErrores.appendChild(li);
            }
            alertErrores.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexión', 'danger');
    }
});

/**
 * Edita un seguimiento existente
 */
function editarSeguimiento(seguimientoId) {
    abrirModalSeguimiento(seguimientoId);
}

/**
 * Elimina un seguimiento
 */
async function eliminarSeguimiento(seguimientoId) {
    if (!confirm('¿Estás seguro de eliminar este seguimiento?')) {
        return;
    }
    
    const url = "{% url 'servicio_tecnico:eliminar_seguimiento' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message, 'success');
            
            // Eliminar la card
            const card = document.querySelector(`[data-seguimiento-id="${seguimientoId}"]`).closest('.col-md-6');
            if (card) {
                card.remove();
            }
            
            setTimeout(() => location.reload(), 1000);
        } else {
            mostrarToast(data.error || 'Error al eliminar', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexión', 'danger');
    }
}

/**
 * Marca una pieza como recibida
 */
async function marcarRecibido(seguimientoId) {
    const fechaReal = prompt('Fecha de entrega real (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
    
    if (!fechaReal) return;
    
    const url = "{% url 'servicio_tecnico:marcar_recibido' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('fecha_entrega_real', fechaReal);
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message + ' 📧 Email enviado al técnico', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarToast(data.error || 'Error al marcar como recibido', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexión', 'danger');
    }
}

/**
 * Función helper para mostrar notificaciones toast
 */
function mostrarToast(mensaje, tipo = 'info') {
    // Crear elemento de alerta temporal
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-ocultar después de 3 segundos
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
