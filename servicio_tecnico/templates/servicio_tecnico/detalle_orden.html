{% extends 'base.html' %}
{% load static %}
{% load rhitso_filters %}

{% block title %}Orden {{ orden.numero_orden_interno }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/servicio_tecnico.css' %}?v=7.3">
<link rel="stylesheet" href="{% static 'css/lightbox_galeria.css' %}?v=1.0">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <!-- ============================================================ -->
    <!-- ENCABEZADO CON INFORMACI√ìN PRINCIPAL -->
    <!-- ============================================================ -->
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="bi bi-tools"></i> 
                        {{ orden.numero_orden_interno }}
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="bi bi-calendar"></i> 
                        Ingreso: {{ orden.fecha_ingreso|date:"d/m/Y H:i" }}
                    </p>
                </div>
                <div class="text-end">
                    <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- ALERTA: ORDEN CONVERTIDA A DIAGN√ìSTICO (No Modificable) -->
    <!-- ============================================================ -->
    
    {% if esta_convertida %}
    <div class="alert alert-danger shadow mb-4" role="alert" style="border-left: 5px solid #dc3545; border-radius: 8px;">
        <div class="d-flex align-items-start">
            <div class="me-3" style="font-size: 2.5rem; animation: pulse 2s infinite;">
                <i class="bi bi-lock-fill"></i>
            </div>
            <div class="flex-grow-1">
                <h4 class="alert-heading mb-3">
                    <strong>üîí ORDEN CONVERTIDA A DIAGN√ìSTICO - NO MODIFICABLE</strong>
                </h4>
                <p class="mb-3" style="font-size: 1.05rem;">
                    Esta orden de venta mostrador fue convertida a una orden con diagn√≥stico t√©cnico.
                    <strong>Ya no puede modificarse, agregar piezas, ni cambiar de estado.</strong>
                </p>
                <hr>
                <p class="mb-2 mt-3">
                    <strong>üìã ¬øQu√© hacer ahora?</strong>
                </p>
                <ul class="mb-3">
                    <li>Esta orden queda como <strong>registro hist√≥rico</strong> de lo que se intent√≥ vender</li>
                    <li>El trabajo contin√∫a en la <strong>nueva orden de diagn√≥stico</strong> que se cre√≥ autom√°ticamente</li>
                    <li>Puedes consultar el <strong>historial</strong> abajo para ver el motivo de conversi√≥n y el n√∫mero de la nueva orden</li>
                </ul>
                <div class="mt-3">
                    <a href="{% url 'servicio_tecnico:lista_activas' %}" class="btn btn-light btn-lg">
                        <i class="bi bi-list-ul"></i> Ver Lista de √ìrdenes Activas
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }
    </style>
    {% endif %}
    
    <!-- ============================================================ -->
    <!-- ALERTA: CANDIDATO A RHITSO - ACCESO R√ÅPIDO (FASE 11) -->
    <!-- ============================================================ -->
    
    {% if orden.es_candidato_rhitso %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info shadow-sm" role="alert" style="border-left: 5px solid #0d6efd; border-radius: 10px; background: linear-gradient(to right, #e8f4fd, #ffffff);">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2" style="color: #0d6efd;">
                            <i class="bi bi-gear-fill"></i> <strong>Candidato a RHITSO</strong>
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="bi bi-exclamation-triangle"></i> Requiere Reparaci√≥n Externa
                            </span>
                        </h5>
                        <div class="row">
                            <div class="col-md-8">
                                <p class="mb-2">
                                    <strong><i class="bi bi-clipboard-text"></i> Motivo:</strong> 
                                    <span class="badge bg-primary">{{ orden.get_motivo_rhitso_display }}</span>
                                </p>
                                {% if orden.descripcion_rhitso %}
                                <p class="mb-2">
                                    <strong><i class="bi bi-chat-left-text"></i> Descripci√≥n:</strong>
                                    <span class="text-muted">{{ orden.descripcion_rhitso|truncatewords:15 }}</span>
                                </p>
                                {% endif %}
                                {% if orden.estado_rhitso %}
                                <p class="mb-0">
                                    <strong><i class="bi bi-arrow-repeat"></i> Estado RHITSO:</strong> 
                                    <span class="badge" style="background-color: {{ orden.estado_rhitso|color_estado_especifico }}; color: {{ orden.estado_rhitso|color_estado_especifico|text_color_for_bg }};">{{ orden.estado_rhitso }}</span>
                                    {% if orden.dias_en_rhitso %}
                                        <span class="badge bg-secondary ms-1">
                                            <i class="bi bi-calendar-day"></i> {{ orden.dias_en_rhitso }} d√≠a{{ orden.dias_en_rhitso|pluralize }}
                                        </span>
                                    {% endif %}
                                </p>
                                {% else %}
                                <p class="mb-0">
                                    <em class="text-muted">
                                        <i class="bi bi-info-circle"></i> A√∫n no se ha iniciado el proceso RHITSO
                                    </em>
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
                                <a href="{% url 'servicio_tecnico:gestion_rhitso' orden.id %}" 
                                   class="btn btn-primary btn-lg shadow-sm"
                                   style="min-width: 200px;"
                                   data-bs-toggle="tooltip"
                                   data-bs-placement="left"
                                   title="Ir al panel de seguimiento especializado RHITSO">
                                    <i class="bi bi-gear-wide-connected"></i> 
                                    <strong>Gesti√≥n RHITSO</strong>
                                    <i class="bi bi-arrow-right-circle ms-2"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 1: INFORMACI√ìN PRINCIPAL (Solo Lectura) -->
    <!-- ============================================================ -->
    
    <div class="row">
        <!-- Panel Principal Izquierdo (7 columnas) -->
        <div class="col-lg-7">
            <div class="card section-card">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle-fill"></i>
                        Informaci√≥n Principal
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalEditarInfoEquipo">
                        <i class="bi bi-pencil-square"></i> Editar informaci√≥n
                    </button>
                </div>
                <div class="card-body" style="font-size: 110%;">
                    <div class="row">
                        <!-- Estado y D√≠as en Servicio -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Estado Actual</label>
                            <div>
                                <span class="estado-badge bg-{{ orden.estado|yesno:'success,warning,danger' }}">
                                    {{ orden.get_estado_display }}
                                </span>
                                {% if orden.esta_retrasada %}
                                <span class="badge bg-danger ms-2">
                                    <i class="bi bi-exclamation-triangle"></i> Retrasada
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- ‚úÖ NUEVO: Indicadores de complementos activos (Oct 2025) -->
                            <div class="mt-2">
                                {% if tiene_cotizacion %}
                                    <span class="badge bg-primary me-1" title="Tiene cotizaci√≥n de reparaci√≥n" data-bs-toggle="tooltip">
                                        <i class="bi bi-clipboard-check"></i> Cotizaci√≥n
                                    </span>
                                {% endif %}
                                
                                {% if tiene_venta_mostrador %}
                                    <span class="badge bg-warning text-dark me-1" title="Tiene venta mostrador" data-bs-toggle="tooltip">
                                        <i class="bi bi-cart-check"></i> Venta Mostrador
                                    </span>
                                {% endif %}
                                
                                {% if not tiene_cotizacion and not tiene_venta_mostrador %}
                                    <span class="badge bg-secondary me-1" title="Sin complementos registrados" data-bs-toggle="tooltip">
                                        <i class="bi bi-dash-circle"></i> Sin servicios
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">
                                D√≠as H√°biles en Servicio
                                <i class="bi bi-info-circle-fill text-info ms-1" 
                                   data-bs-toggle="tooltip" 
                                   title="Solo cuenta d√≠as laborables (lunes a viernes), excluyendo fines de semana"></i>
                            </label>
                            <div class="dias-servicio">
                                <strong style="font-size: 1.2rem; color: #0d6efd;">
                                    <i class="bi bi-calendar-week"></i> {{ dias_habiles_en_servicio }} d√≠as h√°biles
                                </strong>
                                <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                                    ({{ dias_en_servicio }} d√≠as naturales)
                                </small>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del Equipo -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Tipo de Equipo</label>
                            <p class="mb-0"><strong>{{ detalle.get_tipo_equipo_display|upper }}</strong></p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Marca y Modelo</label>
                            <p class="mb-0"><strong>{{ detalle.marca }} {{ detalle.modelo }}</strong></p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">N√∫mero de Serie (Service Tag)</label>
                            <p class="mb-0"><code>{{ detalle.numero_serie }}</code></p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Orden del Cliente</label>
                            <p class="mb-0"><code>{{ detalle.orden_cliente|default:"N/A" }}</code></p>
                        </div>
                        
                        <!-- ‚úÖ NUEVO: Email del Cliente (Noviembre 2025) -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">
                                <i class="bi bi-envelope-fill text-primary"></i> Email del Cliente
                            </label>
                            <p class="mb-0">
                                {% if detalle.email_cliente %}
                                    {% if detalle.email_cliente != 'cliente@ejemplo.com' %}
                                        <a href="mailto:{{ detalle.email_cliente }}" class="text-decoration-none" title="Enviar email">
                                            <i class="bi bi-envelope"></i> {{ detalle.email_cliente }}
                                        </a>
                                    {% else %}
                                        <span class="badge bg-warning text-dark" title="Email pendiente de actualizar">
                                            <i class="bi bi-exclamation-triangle"></i> {{ detalle.email_cliente }}
                                        </span>
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-info-circle"></i> Email por defecto - Actualizar con email real
                                        </small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle"></i> Sin email registrado
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- Gama y Accesorios -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Gama del Equipo</label>
                            <p class="mb-0">
                                <span class="badge bg-{% if detalle.gama == 'alta' %}success{% elif detalle.gama == 'media' %}warning{% else %}secondary{% endif %}">
                                    {{ detalle.get_gama_display }}
                                </span>
                            </p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Accesorios</label>
                            <p class="mb-0">
                                {% if detalle.tiene_cargador %}
                                    <i class="bi bi-check-circle text-success"></i> Incluye cargador
                                    {% if detalle.numero_serie_cargador %}
                                        <br><small class="text-muted">S/N: {{ detalle.numero_serie_cargador }}</small>
                                    {% endif %}
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i> Sin cargador
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- Ubicaci√≥n y Responsables -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Sucursal</label>
                            <p class="mb-0">
                                <i class="bi bi-building"></i> {{ orden.sucursal.nombre }}
                            </p>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">T√©cnico Asignado</label>
                            <p class="mb-0"><i class="bi bi-person-badge"></i> <code>{{ orden.tecnico_asignado_actual.nombre_completo }}</code></p>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label class="form-label text-muted small">Responsable de Seguimiento</label>
                            <p class="mb-0"><i class="bi bi-person-check"></i> <code>{{ orden.responsable_seguimiento.nombre_completo }}</code></p>
                        </div>
                        
                        <!-- Equipo Enciende -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">¬øEl equipo enciende?</label>
                            <p class="mb-0">
                                {% if detalle.equipo_enciende %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-power"></i> S√ç ENCIENDE
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-power"></i> NO ENCIENDE
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- MIS: Mail-In Service -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Tipo de Ingreso</label>
                            <p class="mb-0">
                                {% if detalle.es_mis %}
                                    <span class="badge bg-primary">
                                        <i class="bi bi-box-seam"></i> MIS - PAQUETER√çA
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-shop"></i> PRESENCIAL
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel Lateral Derecho (5 columnas) - Configuraci√≥n Adicional -->
        <div class="col-lg-5">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-gear-fill"></i>
                    Configuraci√≥n Adicional
                </div>
                <div class="card-body">
                    <form method="post" id="formConfiguracion">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="configuracion">
                        
                        {{ form_config.falla_principal.errors }}
                        <div class="mb-3">
                            <label for="{{ form_config.falla_principal.id_for_label }}" class="form-label">
                                {{ form_config.falla_principal.label }}
                            </label>
                            {{ form_config.falla_principal }}
                            <small class="text-muted">{{ form_config.falla_principal.help_text }}</small>
                        </div>
                        
                        {{ form_config.diagnostico_sic.errors }}
                        <div class="mb-3">
                            <label for="{{ form_config.diagnostico_sic.id_for_label }}" class="form-label">
                                {{ form_config.diagnostico_sic.label }}
                            </label>
                            {{ form_config.diagnostico_sic }}
                            <small class="text-muted">{{ form_config.diagnostico_sic.help_text }}</small>
                        </div>
                        
                        <!-- ===================================== -->
                        <!-- SECCI√ìN: FECHAS DE DIAGN√ìSTICO -->
                        <!-- ===================================== -->
                        <div class="fechas-seccion mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0" style="color: #17a2b8; font-weight: 600;">
                                    <i class="bi bi-search"></i> Fechas de Diagn√≥stico
                                </h6>
                                {% if orden.detalle_equipo.fecha_inicio_diagnostico and orden.detalle_equipo.fecha_fin_diagnostico %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle-fill"></i> Completo
                                    </span>
                                {% elif orden.detalle_equipo.fecha_inicio_diagnostico or orden.detalle_equipo.fecha_fin_diagnostico %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock-fill"></i> Parcial
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-dash-circle"></i> Sin registrar
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="border rounded p-3 bg-light" style="border-left: 4px solid #17a2b8 !important;">
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        {{ form_config.fecha_inicio_diagnostico.errors }}
                                        <label for="{{ form_config.fecha_inicio_diagnostico.id_for_label }}" class="form-label small">
                                            <i class="bi bi-play-fill text-success"></i> {{ form_config.fecha_inicio_diagnostico.label }}
                                        </label>
                                        {{ form_config.fecha_inicio_diagnostico }}
                                        {% if orden.detalle_equipo.fecha_inicio_diagnostico %}
                                            <small class="text-success d-block mt-1">
                                                <i class="bi bi-check-circle"></i> Guardado: {{ orden.detalle_equipo.fecha_inicio_diagnostico|date:"d/m/Y" }}
                                            </small>
                                        {% endif %}
                                    </div>
                                    <div class="col-6 mb-2">
                                        {{ form_config.fecha_fin_diagnostico.errors }}
                                        <label for="{{ form_config.fecha_fin_diagnostico.id_for_label }}" class="form-label small">
                                            <i class="bi bi-stop-fill text-danger"></i> {{ form_config.fecha_fin_diagnostico.label }}
                                        </label>
                                        {{ form_config.fecha_fin_diagnostico }}
                                        {% if orden.detalle_equipo.fecha_fin_diagnostico %}
                                            <small class="text-success d-block mt-1">
                                                <i class="bi bi-check-circle"></i> Guardado: {{ orden.detalle_equipo.fecha_fin_diagnostico|date:"d/m/Y" }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Duraci√≥n del diagn√≥stico (si ambas fechas existen) -->
                                {% if orden.detalle_equipo.fecha_inicio_diagnostico and orden.detalle_equipo.fecha_fin_diagnostico %}
                                    <div class="alert alert-info mb-0 mt-2 py-2 px-3" style="font-size: 0.9rem;">
                                        <i class="bi bi-clock-history"></i> 
                                        <strong>Duraci√≥n:</strong> 
                                        {{ orden.detalle_equipo.duracion_diagnostico }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- ===================================== -->
                        <!-- SECCI√ìN: FECHAS DE REPARACI√ìN -->
                        <!-- ===================================== -->
                        <div class="fechas-seccion mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0" style="color: #fd7e14; font-weight: 600;">
                                    <i class="bi bi-wrench"></i> Fechas de Reparaci√≥n
                                </h6>
                                {% if orden.detalle_equipo.fecha_inicio_reparacion and orden.detalle_equipo.fecha_fin_reparacion %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle-fill"></i> Completo
                                    </span>
                                {% elif orden.detalle_equipo.fecha_inicio_reparacion or orden.detalle_equipo.fecha_fin_reparacion %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock-fill"></i> Parcial
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-dash-circle"></i> Sin registrar
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="border rounded p-3 bg-light" style="border-left: 4px solid #fd7e14 !important;">
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        {{ form_config.fecha_inicio_reparacion.errors }}
                                        <label for="{{ form_config.fecha_inicio_reparacion.id_for_label }}" class="form-label small">
                                            <i class="bi bi-play-fill text-success"></i> {{ form_config.fecha_inicio_reparacion.label }}
                                        </label>
                                        {{ form_config.fecha_inicio_reparacion }}
                                        {% if orden.detalle_equipo.fecha_inicio_reparacion %}
                                            <small class="text-success d-block mt-1">
                                                <i class="bi bi-check-circle"></i> Guardado: {{ orden.detalle_equipo.fecha_inicio_reparacion|date:"d/m/Y" }}
                                            </small>
                                        {% endif %}
                                    </div>
                                    <div class="col-6 mb-2">
                                        {{ form_config.fecha_fin_reparacion.errors }}
                                        <label for="{{ form_config.fecha_fin_reparacion.id_for_label }}" class="form-label small">
                                            <i class="bi bi-stop-fill text-danger"></i> {{ form_config.fecha_fin_reparacion.label }}
                                        </label>
                                        {{ form_config.fecha_fin_reparacion }}
                                        {% if orden.detalle_equipo.fecha_fin_reparacion %}
                                            <small class="text-success d-block mt-1">
                                                <i class="bi bi-check-circle"></i> Guardado: {{ orden.detalle_equipo.fecha_fin_reparacion|date:"d/m/Y" }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Duraci√≥n de la reparaci√≥n (si ambas fechas existen) -->
                                {% if orden.detalle_equipo.fecha_inicio_reparacion and orden.detalle_equipo.fecha_fin_reparacion %}
                                    <div class="alert alert-warning mb-0 mt-2 py-2 px-3" style="font-size: 0.9rem;">
                                        <i class="bi bi-clock-history"></i> 
                                        <strong>Duraci√≥n:</strong> 
                                        {{ orden.detalle_equipo.duracion_reparacion }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Guardar Configuraci√≥n
                            </button>
                        </div>
                    </form>
                    
                    <!-- BOT√ìN: Enviar Diagn√≥stico al Cliente -->
                    {% if orden.detalle_equipo.falla_principal and orden.detalle_equipo.diagnostico_sic %}
                    <div class="d-grid mt-3">
                        <button type="button" 
                                class="btn btn-success btn-lg"
                                data-bs-toggle="modal" 
                                data-bs-target="#modalEnviarDiagnostico"
                                {% if not orden.detalle_equipo.email_cliente or orden.detalle_equipo.email_cliente == 'cliente@ejemplo.com' %}
                                    disabled
                                    title="‚ö†Ô∏è Configura un email v√°lido del cliente antes de enviar"
                                {% else %}
                                    title="Enviar diagn√≥stico al cliente con PDF adjunto"
                                {% endif %}>
                            <i class="bi bi-file-earmark-medical"></i> üìã Enviar Diagn√≥stico al Cliente
                        </button>
                        {% if not orden.detalle_equipo.email_cliente or orden.detalle_equipo.email_cliente == 'cliente@ejemplo.com' %}
                        <small class="text-danger text-center mt-1">
                            <i class="bi bi-exclamation-triangle"></i> Email del cliente no configurado
                        </small>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="d-grid mt-3">
                        <button type="button" class="btn btn-outline-secondary" disabled
                                title="Completa la falla principal y el diagn√≥stico SIC para habilitar">
                            <i class="bi bi-file-earmark-medical"></i> üìã Enviar Diagn√≥stico al Cliente
                        </button>
                        <small class="text-muted text-center mt-1">
                            <i class="bi bi-info-circle"></i> Completa "Falla principal" y "Diagn√≥stico SIC" para habilitar
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 2: REINGRESO Y RHITSO -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <i class="bi bi-arrow-repeat"></i>
                    Reingreso y RHITSO (Reparaci√≥n Especializada)
                </div>
                <div class="card-body">
                    <form method="post" id="formReingresoRHITSO">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="reingreso_rhitso">
                        
                        <div class="row">
                            <!-- Reingreso -->
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="text-danger mb-3">
                                        <i class="bi bi-arrow-clockwise"></i> Reingreso
                                    </h6>
                                    
                                    <div class="form-check mb-3">
                                        {{ form_reingreso.es_reingreso }}
                                        <label class="form-check-label" for="{{ form_reingreso.es_reingreso.id_for_label }}">
                                            {{ form_reingreso.es_reingreso.label }}
                                        </label>
                                    </div>
                                    
                                    {% if orden.es_reingreso %}
                                        <div class="alert alert-danger mb-3">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <strong>Esta orden es un REINGRESO</strong>
                                            {% if orden.incidencia_scorecard %}
                                                <br><small>Incidencia: {{ orden.incidencia_scorecard.folio }}</small>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        {{ form_reingreso.orden_original.errors }}
                                        <label for="{{ form_reingreso.orden_original.id_for_label }}" class="form-label small">
                                            {{ form_reingreso.orden_original.label }}
                                        </label>
                                        {{ form_reingreso.orden_original }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RHITSO -->
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="text-warning mb-3">
                                        <i class="bi bi-tools"></i> RHITSO (Reparaci√≥n Especializada)
                                    </h6>
                                    
                                    <div class="form-check mb-3">
                                        {{ form_reingreso.es_candidato_rhitso }}
                                        <label class="form-check-label" for="{{ form_reingreso.es_candidato_rhitso.id_for_label }}">
                                            {{ form_reingreso.es_candidato_rhitso.label }}
                                        </label>
                                    </div>
                                    
                                    {% if orden.es_candidato_rhitso %}
                                        <div class="alert alert-warning mb-3">
                                            <i class="bi bi-tools"></i>
                                            <strong>Candidato a RHITSO</strong>
                                            <br><small>{{ orden.get_motivo_rhitso_display }}</small>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        {{ form_reingreso.motivo_rhitso.errors }}
                                        <label for="{{ form_reingreso.motivo_rhitso.id_for_label }}" class="form-label small">
                                            {{ form_reingreso.motivo_rhitso.label }}
                                        </label>
                                        {{ form_reingreso.motivo_rhitso }}
                                    </div>
                                    
                                    <div class="mb-3">
                                        {{ form_reingreso.descripcion_rhitso.errors }}
                                        <label for="{{ form_reingreso.descripcion_rhitso.id_for_label }}" class="form-label small">
                                            {{ form_reingreso.descripcion_rhitso.label }}
                                        </label>
                                        {{ form_reingreso.descripcion_rhitso }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-save"></i> Actualizar Reingreso/RHITSO
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 3: GESTI√ìN DE COTIZACI√ìN -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-currency-dollar"></i>
                    Gesti√≥n de Cotizaci√≥n
                </div>
                <div class="card-body">
                    
                    {% if not cotizacion %}
                        <!-- ========================================== -->
                        <!-- NO EXISTE COTIZACI√ìN - Mostrar bot√≥n crear -->
                        <!-- ========================================== -->
                        <div class="alert alert-info d-flex align-items-center mb-4">
                            <i class="bi bi-info-circle-fill fs-3 me-3"></i>
                            <div>
                                <h6 class="mb-1">No hay cotizaci√≥n para esta orden</h6>
                                <p class="mb-0 small">Crea una cotizaci√≥n para enviar al cliente con el costo de mano de obra. Despu√©s agrega las piezas necesarias desde el admin.</p>
                            </div>
                        </div>
                        
                        <form method="post" id="formCrearCotizacion">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="crear_cotizacion">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_crear_cotizacion.costo_mano_obra.errors }}
                                    <label for="{{ form_crear_cotizacion.costo_mano_obra.id_for_label }}" class="form-label">
                                        <i class="bi bi-tools"></i> {{ form_crear_cotizacion.costo_mano_obra.label }}
                                    </label>
                                    {{ form_crear_cotizacion.costo_mano_obra }}
                                    <small class="text-muted">{{ form_crear_cotizacion.costo_mano_obra.help_text }}</small>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="bi bi-plus-circle"></i> Crear Cotizaci√≥n
                                    </button>
                                </div>
                            </div>
                        </form>
                    
                    {% else %}
                        <!-- ========================================== -->
                        <!-- EXISTE COTIZACI√ìN - Mostrar informaci√≥n -->
                        <!-- ========================================== -->
                        
                        <div class="row mb-4">
                            <!-- Panel Izquierdo: Estado y Decisi√≥n -->
                            <div class="col-lg-6">
                                <div class="card h-100" style="border-left: 4px solid #f093fb;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-clipboard-check"></i> Estado de la Cotizaci√≥n
                                        </h6>
                                        
                                        <!-- Estado Actual -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Decisi√≥n del Cliente:</label>
                                            <div>
                                                {% if cotizacion.usuario_acepto is None %}
                                                    <span class="badge bg-warning text-dark" style="font-size: 1rem;">
                                                        <i class="bi bi-hourglass-split"></i> Sin Respuesta
                                                    </span>
                                                {% elif cotizacion.usuario_acepto %}
                                                    <span class="badge bg-success" style="font-size: 1rem;">
                                                        <i class="bi bi-check-circle-fill"></i> ACEPTADA
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-danger" style="font-size: 1rem;">
                                                        <i class="bi bi-x-circle-fill"></i> RECHAZADA
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Fecha de Env√≠o (editable) -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Fecha de Env√≠o:</label>
                                            <form method="post" class="d-flex align-items-center gap-2" id="formEditarFechaEnvio">
                                                {% csrf_token %}
                                                <input type="hidden" name="form_type" value="editar_fecha_envio">
                                                <input type="datetime-local" 
                                                       name="fecha_envio" 
                                                       class="form-control form-control-sm" 
                                                       style="max-width: 220px;"
                                                       value="{{ cotizacion.fecha_envio|date:'Y-m-d\TH:i' }}">
                                                <button type="submit" class="btn btn-outline-primary btn-sm" title="Guardar fecha">
                                                    <i class="bi bi-check-lg"></i>
                                                </button>
                                            </form>
                                            <small class="text-muted">Editable para ajustar m√©tricas</small>
                                        </div>
                                        
                                        {% if cotizacion.fecha_respuesta %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Fecha de Respuesta:</label>
                                                <p class="mb-0"><strong>{{ cotizacion.fecha_respuesta|date:"d/m/Y H:i" }}</strong></p>
                                            </div>
                                        {% else %}
                                            <div class="mb-3">
                                                <label class="text-muted small">D√≠as sin Respuesta:</label>
                                                <p class="mb-0">
                                                    <span class="badge {% if cotizacion.dias_sin_respuesta > 7 %}bg-danger{% elif cotizacion.dias_sin_respuesta > 3 %}bg-warning{% else %}bg-info{% endif %}">
                                                        {{ cotizacion.dias_sin_respuesta }} d√≠a{{ cotizacion.dias_sin_respuesta|pluralize }}
                                                    </span>
                                                </p>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Informaci√≥n de Rechazo (si aplica) -->
                                        {% if not cotizacion.usuario_acepto and cotizacion.usuario_acepto is not None %}
                                            <div class="alert alert-danger mt-3">
                                                <strong><i class="bi bi-exclamation-triangle"></i> Motivo del Rechazo:</strong><br>
                                                {{ cotizacion.get_motivo_rechazo_display }}
                                                {% if cotizacion.detalle_rechazo %}
                                                    <br><small>{{ cotizacion.detalle_rechazo }}</small>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Formulario de Gesti√≥n (Solo si sin respuesta) -->
                                        {% if cotizacion.usuario_acepto is None and form_gestionar_cotizacion %}
                                            <hr>
                                            <h6 class="mb-3"><i class="bi bi-hand-index"></i> Registrar Decisi√≥n del Cliente</h6>
                                            
                                            <form method="post" id="formGestionarCotizacion">
                                                {% csrf_token %}
                                                <input type="hidden" name="form_type" value="gestionar_cotizacion">
                                                
                                                <!-- Acci√≥n: Aceptar o Rechazar -->
                                                <div class="mb-3">
                                                    {{ form_gestionar_cotizacion.accion.errors }}
                                                    <label class="form-label">{{ form_gestionar_cotizacion.accion.label }}</label>
                                                    <div class="d-flex gap-3">
                                                        {% for radio in form_gestionar_cotizacion.accion %}
                                                            <div class="form-check">
                                                                {{ radio.tag }}
                                                                <label class="form-check-label" for="{{ radio.id_for_label }}">
                                                                    {% if 'aceptar' in radio.choice_value %}
                                                                        <i class="bi bi-check-circle text-success"></i> {{ radio.choice_label }}
                                                                    {% else %}
                                                                        <i class="bi bi-x-circle text-danger"></i> {{ radio.choice_label }}
                                                                    {% endif %}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                
                                                <!-- üÜï NUEVO: Descuento de Mano de Obra (solo visible al aceptar) -->
                                                <div id="divDescontoManoObra" style="display: none;">
                                                    <div class="alert alert-success mb-3" style="border-left: 4px solid #28a745;">
                                                        <div class="form-check">
                                                            {{ form_gestionar_cotizacion.descontar_mano_obra }}
                                                            <label for="id_descontar_mano_obra" class="form-check-label">
                                                                <strong>{{ form_gestionar_cotizacion.descontar_mano_obra.label }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    üíµ Costo actual de mano de obra: <strong>${{ cotizacion.costo_mano_obra|floatformat:2 }}</strong>
                                                                    - Si activas esta opci√≥n, el diagn√≥stico ser√° gratuito
                                                                </small>
                                                            </label>
                                                        </div>
                                                        <div class="mt-3 p-2" style="background-color: rgba(255,255,255,0.6); border-radius: 6px;">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">üí∞ Total con piezas:</span>
                                                                <span id="totalSinDescuento" class="fw-bold">
                                                                    ${{ cotizacion.costo_total_piezas|add:cotizacion.costo_mano_obra|floatformat:2 }}
                                                                </span>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center mt-1" id="filaDescuento" style="display:none;">
                                                                <span class="text-danger">‚úÇÔ∏è Descuento mano de obra:</span>
                                                                <span class="text-danger fw-bold">-${{ cotizacion.costo_mano_obra|floatformat:2 }}</span>
                                                            </div>
                                                            <hr class="my-2" id="separadorTotal" style="display:none;">
                                                            <div class="d-flex justify-content-between align-items-center" id="filaTotalFinal" style="display:none;">
                                                                <span class="text-success fw-bold">üéÅ TOTAL A PAGAR:</span>
                                                                <span class="text-success fw-bold fs-5" id="totalConDescuento">
                                                                    ${{ cotizacion.costo_total_piezas|floatformat:2 }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Campos de Rechazo (solo visibles si rechaza) -->
                                                <div id="camposRechazo" style="display: none;">
                                                    <div class="mb-3">
                                                        {{ form_gestionar_cotizacion.motivo_rechazo.errors }}
                                                        <label for="{{ form_gestionar_cotizacion.motivo_rechazo.id_for_label }}" class="form-label">
                                                            {{ form_gestionar_cotizacion.motivo_rechazo.label }}
                                                        </label>
                                                        {{ form_gestionar_cotizacion.motivo_rechazo }}
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        {{ form_gestionar_cotizacion.detalle_rechazo.errors }}
                                                        <label for="{{ form_gestionar_cotizacion.detalle_rechazo.id_for_label }}" class="form-label">
                                                            {{ form_gestionar_cotizacion.detalle_rechazo.label }}
                                                        </label>
                                                        {{ form_gestionar_cotizacion.detalle_rechazo }}
                                                    </div>
                                                </div>
                                                
                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="bi bi-save"></i> Guardar Decisi√≥n
                                                    </button>
                                                </div>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel Derecho: Resumen Financiero -->
                            <div class="col-lg-6">
                                <div class="card h-100" style="border-left: 4px solid #4facfe;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-cash-stack"></i> Resumen Financiero
                                        </h6>
                                        
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="text-muted">Mano de Obra:</td>
                                                <td class="text-end">
                                                    <form method="post" class="d-inline-flex align-items-center gap-1" id="formEditarManoObra">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="form_type" value="editar_mano_obra">
                                                        <span class="text-muted">$</span>
                                                        <input type="number" 
                                                               name="costo_mano_obra" 
                                                               class="form-control form-control-sm text-end" 
                                                               style="max-width: 110px;"
                                                               step="0.01"
                                                               min="0"
                                                               value="{{ cotizacion.costo_mano_obra|floatformat:2 }}">
                                                        <button type="submit" class="btn btn-outline-primary btn-sm" title="Guardar mano de obra">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                    {% if cotizacion.descontar_mano_obra and cotizacion.usuario_acepto %}
                                                        <span class="badge bg-success ms-1" title="Descuento aplicado">
                                                            üéÅ GRATIS
                                                        </span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Total Piezas Cotizadas:</td>
                                                <td class="text-end"><strong>${{ cotizacion.costo_total_piezas|floatformat:2 }}</strong></td>
                                            </tr>
                                            {% if cotizacion.usuario_acepto is not None %}
                                                <!-- Mostrar desglose de piezas solo si hay decisi√≥n -->
                                                {% if cotizacion.costo_piezas_aceptadas != cotizacion.costo_total_piezas %}
                                                    <tr>
                                                        <td class="text-muted">Piezas Aceptadas:</td>
                                                        <td class="text-end text-success"><strong>${{ cotizacion.costo_piezas_aceptadas|floatformat:2 }}</strong></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-muted">Piezas Rechazadas:</td>
                                                        <td class="text-end text-danger">
                                                            <strong>${{ cotizacion.costo_piezas_rechazadas|floatformat:2 }}</strong>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endif %}
                                            <tr style="border-top: 2px solid #dee2e6;">
                                                <td class="text-muted"><strong>TOTAL COTIZACI√ìN:</strong></td>
                                                <td class="text-end"><h5 class="mb-0 text-primary">${{ cotizacion.costo_total|floatformat:2 }}</h5></td>
                                            </tr>
                                            
                                            <!-- üÜï NUEVO: Mostrar descuento de mano de obra si aplica -->
                                            {% if cotizacion.usuario_acepto and cotizacion.descontar_mano_obra %}
                                                <tr style="border-top: 2px solid #ffc107;">
                                                    <td class="text-danger">
                                                        <strong><i class="bi bi-scissors"></i> Descuento Mano de Obra:</strong>
                                                    </td>
                                                    <td class="text-end">
                                                        <h5 class="mb-0 text-danger">
                                                            -${{ cotizacion.monto_descuento_mano_obra|floatformat:2 }}
                                                        </h5>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                            
                                            <!-- Total a pagar (actualizado para usar costo_total_final) -->
                                            {% if cotizacion.usuario_acepto %}
                                                <tr style="border-top: 2px solid #28a745;">
                                                    <td class="text-success"><strong>üéØ TOTAL A PAGAR:</strong></td>
                                                    <td class="text-end">
                                                        <h5 class="mb-0 text-success">
                                                            ${{ cotizacion.costo_total_final|floatformat:2 }}
                                                        </h5>
                                                    </td>
                                                </tr>
                                                
                                                <!-- Mostrar ahorro si hay descuento -->
                                                {% if cotizacion.descontar_mano_obra %}
                                                    <tr>
                                                        <td colspan="2" class="text-center">
                                                            <div class="alert alert-success mb-0 mt-2 py-2" style="border-left: 4px solid #28a745;">
                                                                <small>
                                                                    <i class="bi bi-gift-fill"></i>
                                                                    <strong>¬°Beneficio aplicado!</strong>
                                                                    El cliente ahorra <strong>${{ cotizacion.monto_descuento_mano_obra|floatformat:2 }}</strong> en mano de obra
                                                                </small>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endif %}
                                        </table>
                                        
                                        <!-- Desglose de piezas aceptadas/rechazadas (solo si hay decisi√≥n) -->
                                        {% if cotizacion.usuario_acepto is not None %}
                                            <hr class="my-3">
                                            <h6 class="mb-2">
                                                <i class="bi bi-list-check"></i> Desglose de Piezas
                                            </h6>
                                            
                                            <!-- Piezas Aceptadas -->
                                            {% with piezas_aceptadas=piezas_cotizadas|dictsort:"aceptada_por_cliente" %}
                                                {% for pieza in piezas_cotizadas %}
                                                    {% if pieza.aceptada_por_cliente %}
                                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2" 
                                                             style="background-color: rgba(40, 167, 69, 0.1); border-left: 3px solid #28a745; border-radius: 4px;">
                                                            <div>
                                                                <small>
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                    <strong>{{ pieza.componente.nombre }}</strong>
                                                                    <span class="text-muted">√ó {{ pieza.cantidad }}</span>
                                                                </small>
                                                            </div>
                                                            <small class="text-success fw-bold">${{ pieza.costo_total|floatformat:2 }}</small>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endwith %}
                                            
                                            <!-- Piezas Rechazadas -->
                                            {% for pieza in piezas_cotizadas %}
                                                {% if pieza.aceptada_por_cliente == False %}
                                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" 
                                                         style="background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;">
                                                        <div>
                                                            <small>
                                                                <i class="bi bi-x-circle-fill text-danger"></i>
                                                                <strong class="text-muted text-decoration-line-through">{{ pieza.componente.nombre }}</strong>
                                                                <span class="text-muted">√ó {{ pieza.cantidad }}</span>
                                                            </small>
                                                        </div>
                                                        <small class="text-danger fw-bold text-decoration-line-through">${{ pieza.costo_total|floatformat:2 }}</small>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de Piezas Cotizadas -->
                        {% if piezas_cotizadas %}
                            <div class="card mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-tools"></i> Piezas Cotizadas 
                                        <span class="badge bg-secondary">{{ piezas_cotizadas.count }}</span>
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="abrirModalPieza()">
                                        <i class="bi bi-plus-circle"></i> Agregar Pieza
                                    </button>
                                </div>
                                <!-- Mensaje de Ayuda (solo visible si cotizaci√≥n pendiente) -->
                                {% if cotizacion.usuario_acepto is None %}
                                    <div class="alert alert-info mb-0 mx-3 mt-3" style="border-left: 4px solid #0dcaf0;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-info-circle-fill me-2" style="font-size: 1.5rem;"></i>
                                            <div>
                                                <strong>üí° Instrucciones:</strong> Selecciona con los checkboxes las piezas que el cliente <strong>acepta</strong>.
                                                Al guardar la decisi√≥n, solo las piezas seleccionadas ser√°n aceptadas. 
                                                Si rechazas la cotizaci√≥n, todas las piezas se marcar√°n como rechazadas autom√°ticamente.
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" id="tablaPiezas">
                                            <thead class="table-light">
                                                <tr>
                                                    <!-- Nueva columna: Checkbox para seleccionar piezas (solo si cotizaci√≥n pendiente) -->
                                                    {% if cotizacion.usuario_acepto is None %}
                                                        <th class="text-center" style="width: 60px;">
                                                            <div class="form-check d-flex justify-content-center">
                                                                <input class="form-check-input" type="checkbox" 
                                                                       id="selectAllPiezas" 
                                                                       checked 
                                                                       title="Seleccionar/Deseleccionar todas"
                                                                       style="cursor: pointer;">
                                                            </div>
                                                            <small class="text-muted" style="font-size: 0.7rem;">Todas</small>
                                                        </th>
                                                    {% endif %}
                                                    <th>Prioridad</th>
                                                    <th>Componente</th>
                                                    <th>Descripci√≥n</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-end">Precio Unit.</th>
                                                    <th class="text-end">Total</th>
                                                    <th class="text-center">Proveedor</th>
                                                    <th class="text-center">Necesaria</th>
                                                    <th class="text-center">Cliente</th>
                                                    <th class="text-center">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pieza in piezas_cotizadas %}
                                                    <tr data-pieza-id="{{ pieza.id }}" class="pieza-row">
                                                        <!-- Checkbox de selecci√≥n (solo si cotizaci√≥n pendiente) -->
                                                        {% if cotizacion.usuario_acepto is None %}
                                                            <td class="text-center">
                                                                <div class="form-check d-flex justify-content-center">
                                                                    <input class="form-check-input pieza-checkbox" 
                                                                           type="checkbox" 
                                                                           name="piezas_seleccionadas" 
                                                                           value="{{ pieza.id }}"
                                                                           checked
                                                                           title="Seleccionar esta pieza"
                                                                           style="cursor: pointer;">
                                                                </div>
                                                            </td>
                                                        {% endif %}
                                                        <td>
                                                            <span class="badge bg-secondary">{{ pieza.orden_prioridad }}</span>
                                                        </td>
                                                        <td><strong>{{ pieza.componente.nombre }}</strong></td>
                                                        <td>
                                                            <small class="text-muted">
                                                                {{ pieza.descripcion_adicional|default:"‚Äî" }}
                                                            </small>
                                                        </td>
                                                        <td class="text-center">{{ pieza.cantidad }}</td>
                                                        <td class="text-end">${{ pieza.costo_unitario|floatformat:2 }}</td>
                                                        <td class="text-end"><strong>${{ pieza.costo_total|floatformat:2 }}</strong></td>
                                                        <td class="text-center">
                                                            {% if pieza.proveedor %}
                                                                <span class="badge bg-secondary" style="font-size: 0.75rem;">üè™ {{ pieza.proveedor }}</span>
                                                            {% else %}
                                                                <span class="text-muted">‚Äî</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if pieza.es_necesaria %}
                                                                <span class="badge bg-danger">S√≠</span>
                                                            {% else %}
                                                                <span class="badge bg-info">Mejora</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if pieza.aceptada_por_cliente is None %}
                                                                <span class="badge bg-warning text-dark">‚è≥ Sin resp.</span>
                                                            {% elif pieza.aceptada_por_cliente %}
                                                                <span class="badge bg-success">‚úÖ Aceptada</span>
                                                            {% else %}
                                                                <span class="badge bg-danger">‚ùå Rechazada</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                                    onclick="editarPieza({{ pieza.id }})" title="Editar">
                                                                üìù
                                                            </button>
                                                            {% if cotizacion.usuario_acepto %}
                                                                <span class="text-muted" title="No se puede eliminar (cotizaci√≥n aceptada)">
                                                                    üîí
                                                                </span>
                                                            {% else %}
                                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                        onclick="eliminarPieza({{ pieza.id }})" title="Eliminar">
                                                                    üóëÔ∏è
                                                                </button>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="card mb-4">
                                <div class="card-body text-center py-4">
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-tools" style="font-size: 3rem;"></i><br>
                                        No hay piezas cotizadas a√∫n
                                    </p>
                                    <button type="button" class="btn btn-primary" onclick="abrirModalPieza()">
                                        <i class="bi bi-plus-circle"></i> Agregar Primera Pieza
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Seguimiento de Proveedores -->
                        {% if seguimientos_piezas %}
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <h6 class="mb-0">
                                            <i class="bi bi-truck"></i> Seguimiento de Pedidos a Proveedores
                                            <span class="badge bg-secondary">{{ seguimientos_piezas.count }}</span>
                                        </h6>
                                        {% if seguimientos_retrasados_count > 0 %}
                                            <span class="badge badge-retraso-global">
                                                ‚ö†Ô∏è {{ seguimientos_retrasados_count }} Pedido{{ seguimientos_retrasados_count|pluralize }} con Retraso
                                            </span>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-info text-white" onclick="abrirModalSeguimiento()">
                                        <i class="bi bi-plus-circle"></i> Agregar Seguimiento
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3" id="contenedorSeguimientos">
                                        {% for seguimiento in seguimientos_piezas %}
                                            <div class="col-md-6">
                                                <div class="card h-100 border-start border-4 seguimiento-card
                                                    {% if seguimiento.estado == 'recibido' %}border-success
                                                    {% elif seguimiento.estado == 'incorrecto' %}border-danger
                                                    {% elif seguimiento.estado == 'danado' %}border-danger
                                                    {% elif seguimiento.estado == 'retrasado' %}border-danger
                                                    {% elif seguimiento.estado == 'transito' %}border-info
                                                    {% elif seguimiento.estado == 'confirmado' %}border-primary
                                                    {% elif seguimiento.estado == 'pedido' %}border-secondary
                                                    {% else %}border-secondary{% endif %}" 
                                                    data-seguimiento-id="{{ seguimiento.id }}">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <h6 class="card-title mb-0">
                                                                <i class="bi bi-building"></i> {{ seguimiento.proveedor }}
                                                            </h6>
                                                            <span class="badge 
                                                                {% if seguimiento.estado == 'recibido' %}bg-success
                                                                {% elif seguimiento.estado == 'incorrecto' %}bg-danger
                                                                {% elif seguimiento.estado == 'danado' %}bg-warning text-dark
                                                                {% elif seguimiento.estado == 'retrasado' %}bg-danger
                                                                {% elif seguimiento.estado == 'transito' %}bg-info
                                                                {% elif seguimiento.estado == 'confirmado' %}bg-primary
                                                                {% elif seguimiento.estado == 'pedido' %}bg-secondary
                                                                {% else %}bg-warning text-dark{% endif %}">
                                                                {{ seguimiento.get_estado_display }}
                                                            </span>
                                                        </div>
                                                        
                                                        <p class="card-text small mb-2">
                                                            <strong>Pedido:</strong> {{ seguimiento.numero_pedido|default:"Sin n√∫mero" }}<br>
                                                            <strong>Piezas:</strong> {{ seguimiento.descripcion_piezas|truncatewords:10 }}
                                                        </p>
                                                        
                                                        <!-- NUEVO: Mostrar piezas espec√≠ficas vinculadas -->
                                                        {% if seguimiento.piezas.exists %}
                                                            <div class="mt-2 p-2" style="background-color: rgba(13, 110, 253, 0.05); border-left: 3px solid #0d6efd; border-radius: 4px;">
                                                                <small class="text-primary fw-bold">
                                                                    <i class="bi bi-box-seam"></i> Piezas Vinculadas:
                                                                </small>
                                                                <ul class="list-unstyled mb-0 mt-1">
                                                                    {% for pieza in seguimiento.piezas.all %}
                                                                        <li class="small text-muted">
                                                                            <i class="bi bi-check2"></i> {{ pieza.componente.nombre }} √ó {{ pieza.cantidad }}
                                                                        </li>
                                                                    {% endfor %}
                                                                </ul>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="small">
                                                            <div class="row">
                                                                <div class="col-6">
                                                                    <strong>Pedido:</strong><br>
                                                                    <small>{{ seguimiento.fecha_pedido|date:"d/m/Y" }}</small>
                                                                </div>
                                                                <div class="col-6">
                                                                    <strong>Estimado:</strong><br>
                                                                    <small>{{ seguimiento.fecha_entrega_estimada|date:"d/m/Y" }}</small>
                                                                </div>
                                                            </div>
                                                            {% if seguimiento.fecha_entrega_real %}
                                                                <div class="mt-2">
                                                                    <strong>Entregado:</strong> <small>{{ seguimiento.fecha_entrega_real|date:"d/m/Y" }}</small>
                                                                </div>
                                                            {% elif seguimiento.esta_retrasado %}
                                                                <div class="alert alert-danger p-2 mt-2 mb-0">
                                                                    <small><i class="bi bi-exclamation-triangle"></i> <strong>‚ö†Ô∏è RETRASO: {{ seguimiento.dias_retraso }} d√≠a{{ seguimiento.dias_retraso|pluralize }}</strong></small>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        {% if seguimiento.notas_seguimiento %}
                                                            <div class="mt-2 pt-2 border-top">
                                                                <small class="text-muted">
                                                                    <i class="bi bi-sticky"></i> {{ seguimiento.notas_seguimiento|truncatewords:20 }}
                                                                </small>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <!-- Botones de acci√≥n -->
                                                        <div class="mt-3">
                                                            <!-- Fila 1: Cambio r√°pido de estado -->
                                                            {% if seguimiento.estado not in 'recibido,incorrecto,danado' %}
                                                                <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                                                                    {% if seguimiento.estado == 'pedido' %}
                                                                        <button type="button" class="btn btn-info" 
                                                                                onclick="cambiarEstadoSeguimiento({{ seguimiento.id }}, 'confirmado')" 
                                                                                title="Confirmar pedido">
                                                                            ‚úÖ Confirmar
                                                                        </button>
                                                                    {% endif %}
                                                                    
                                                                    {% if seguimiento.estado in 'pedido,confirmado' %}
                                                                        <button type="button" class="btn btn-warning" 
                                                                                onclick="cambiarEstadoSeguimiento({{ seguimiento.id }}, 'transito')" 
                                                                                title="Marcar en tr√°nsito">
                                                                            ÔøΩ En Tr√°nsito
                                                                        </button>
                                                                    {% endif %}
                                                                    
                                                                    {% if seguimiento.estado in 'pedido,confirmado,transito' %}
                                                                        <button type="button" class="btn btn-danger" 
                                                                                onclick="cambiarEstadoSeguimiento({{ seguimiento.id }}, 'retrasado')" 
                                                                                title="Marcar como retrasado">
                                                                            ‚ö†Ô∏è Retrasado
                                                                        </button>
                                                                    {% endif %}
                                                                    
                                                                    <button type="button" class="btn btn-success" 
                                                                            onclick="marcarRecibido({{ seguimiento.id }})" 
                                                                            title="Marcar como recibido">
                                                                        üì¨ Recibido
                                                                    </button>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            <!-- Fila 2: Reportar problemas con pieza recibida (NUEVO Nov 2025) -->
                                                            {% if seguimiento.estado == 'recibido' %}
                                                                <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                                                                    <button type="button" class="btn btn-outline-danger" 
                                                                            onclick="marcarIncorrecto({{ seguimiento.id }})" 
                                                                            title="La pieza recibida es incorrecta">
                                                                        ‚ùå Pieza Incorrecta
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-warning" 
                                                                            onclick="marcarDanado({{ seguimiento.id }})" 
                                                                            title="La pieza recibida est√° da√±ada o no funciona">
                                                                        ‚ö†Ô∏è Pieza Da√±ada
                                                                    </button>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            <!-- Fila 3: Editar, Eliminar y Reenviar -->
                                                            <div class="btn-group btn-group-sm w-100" role="group">
                                                                <button type="button" class="btn btn-outline-primary" 
                                                                        onclick="editarSeguimiento({{ seguimiento.id }})" 
                                                                        title="Editar">
                                                                    üìù Editar
                                                                </button>
                                                                <button type="button" class="btn btn-outline-danger" 
                                                                        onclick="eliminarSeguimiento({{ seguimiento.id }})" 
                                                                        title="Eliminar">
                                                                    üóëÔ∏è Eliminar
                                                                </button>
                                                                {% if seguimiento.estado == 'recibido' %}
                                                                    <button type="button" class="btn btn-outline-info" 
                                                                            onclick="reenviarNotificacion({{ seguimiento.id }})" 
                                                                            title="Reenviar notificaci√≥n al t√©cnico">
                                                                        ÔøΩ Reenviar
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="card">
                                <div class="card-body text-center py-4">
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-truck" style="font-size: 3rem;"></i><br>
                                        No hay seguimientos de proveedores a√∫n
                                    </p>
                                    <button type="button" class="btn btn-info text-white" onclick="abrirModalSeguimiento()">
                                        <i class="bi bi-plus-circle"></i> Agregar Primer Seguimiento
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    
                    {% endif %}
                    
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 3.5: GESTI√ìN DE VENTA MOSTRADOR -->
    <!-- SIEMPRE VISIBLE - UI Contextual seg√∫n tipo_servicio (Refactor Oct 2025) -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12">
            <div class="card section-card">
                <!-- HEADER CONTEXTUAL: Cambia color y texto seg√∫n tipo de orden -->
                <div class="section-header" style="background: {% if orden.tipo_servicio == 'diagnostico' %}linear-gradient(135deg, #667eea 0%, #764ba2 100%){% else %}linear-gradient(135deg, #f6d365 0%, #fda085 100%){% endif %};">
                    {% if orden.tipo_servicio == 'diagnostico' %}
                        <!-- UI para DIAGN√ìSTICO: Ventas adicionales (complemento) -->
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <i class="bi bi-cart-plus"></i>
                                üí∞ Ventas Adicionales de Mostrador
                                {% if venta_mostrador %}
                                    <span class="badge bg-light text-dark ms-2">{{ venta_mostrador.folio_venta }}</span>
                                {% endif %}
                            </div>
                            <span class="badge bg-light text-dark">Complemento</span>
                        </div>
                    {% else %}
                        <!-- UI para DIRECTO: Venta principal -->
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <i class="bi bi-shop"></i>
                                üõí Venta Mostrador Principal
                                {% if venta_mostrador %}
                                    <span class="badge bg-dark ms-2">{{ venta_mostrador.folio_venta }}</span>
                                {% endif %}
                            </div>
                            <span class="badge bg-light text-dark">Servicio Directo</span>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    
                    {% if not venta_mostrador %}
                        <!-- ========================================== -->
                        <!-- NO EXISTE VENTA MOSTRADOR - Mostrar bot√≥n crear -->
                        <!-- ========================================== -->
                        <div class="alert {% if orden.tipo_servicio == 'diagnostico' %}alert-info{% else %}alert-warning{% endif %} d-flex align-items-center mb-4">
                            <i class="bi bi-info-circle-fill fs-3 me-3"></i>
                            <div>
                                {% if orden.tipo_servicio == 'diagnostico' %}
                                    <h6 class="mb-1">Ventas Adicionales Opcionales</h6>
                                    <p class="mb-0 small">
                                        Si el cliente adquiere <strong>accesorios, kits, cables u otros productos</strong>
                                        durante el diagn√≥stico o reparaci√≥n, reg√≠stralos aqu√≠ como ventas complementarias.
                                    </p>
                                {% else %}
                                    <h6 class="mb-1">No hay venta mostrador registrada para esta orden</h6>
                                    <p class="mb-0 small">Crea una venta mostrador para servicios directos sin diagn√≥stico: instalaci√≥n de piezas, reinstalaci√≥n de SO, limpieza, etc.</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="button" class="btn {% if orden.tipo_servicio == 'diagnostico' %}btn-outline-primary{% else %}btn-warning{% endif %} btn-lg" onclick="abrirModalVentaMostrador()">
                                <i class="bi bi-plus-circle"></i>
                                {% if orden.tipo_servicio == 'diagnostico' %}
                                    Agregar Ventas Adicionales
                                {% else %}
                                    Crear Venta Mostrador
                                {% endif %}
                            </button>
                        </div>
                    
                    {% else %}
                        <!-- ========================================== -->
                        <!-- EXISTE VENTA MOSTRADOR - Mostrar informaci√≥n -->
                        <!-- ========================================== -->
                        
                        <div class="row mb-4">
                            <!-- Panel Izquierdo: Informaci√≥n del Paquete -->
                            <div class="col-lg-6">
                                <div class="card h-100" style="border-left: 4px solid #f6d365;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-box-seam"></i> Informaci√≥n del Paquete
                                        </h6>
                                        
                                        <!-- Paquete Seleccionado -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Paquete:</label>
                                            <div>
                                                {% if venta_mostrador.paquete == 'premium' %}
                                                    <span class="badge" style="background-color: #9b59b6; font-size: 1rem;">
                                                        <i class="bi bi-star-fill"></i> PREMIUM
                                                    </span>
                                                {% elif venta_mostrador.paquete == 'oro' %}
                                                    <span class="badge" style="background-color: #FFD700; color: #000; font-size: 1rem;">
                                                        <i class="bi bi-trophy-fill"></i> ORO
                                                    </span>
                                                {% elif venta_mostrador.paquete == 'plata' %}
                                                    <span class="badge" style="background-color: #C0C0C0; color: #000; font-size: 1rem;">
                                                        <i class="bi bi-award-fill"></i> PLATA
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary" style="font-size: 1rem;">
                                                        Sin Paquete
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Costo del Paquete -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Costo Paquete:</label>
                                            <p class="mb-0"><strong>${{ venta_mostrador.costo_paquete|floatformat:2 }}</strong></p>
                                        </div>
                                        
                                        <!-- Servicios Adicionales -->
                                        <div class="mb-3">
                                            <label class="text-muted small">Servicios Adicionales:</label>
                                            <ul class="list-unstyled mb-0">
                                                {% if venta_mostrador.incluye_cambio_pieza %}
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        Cambio de Pieza - <strong>${{ venta_mostrador.costo_cambio_pieza|floatformat:2 }}</strong>
                                                    </li>
                                                {% endif %}
                                                {% if venta_mostrador.incluye_limpieza %}
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        Limpieza - <strong>${{ venta_mostrador.costo_limpieza|floatformat:2 }}</strong>
                                                    </li>
                                                {% endif %}
                                                {% if venta_mostrador.incluye_kit_limpieza %}
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        Kit de Limpieza - <strong>${{ venta_mostrador.costo_kit|floatformat:2 }}</strong>
                                                    </li>
                                                {% endif %}
                                                {% if venta_mostrador.incluye_reinstalacion_so %}
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        Reinstalaci√≥n SO - <strong>${{ venta_mostrador.costo_reinstalacion|floatformat:2 }}</strong>
                                                    </li>
                                                {% endif %}
                                                {% if venta_mostrador.incluye_respaldo %}
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        Respaldo de Informaci√≥n - <strong>${{ venta_mostrador.costo_respaldo|floatformat:2 }}</strong>
                                                    </li>
                                                {% endif %}
                                                {% if not venta_mostrador.incluye_cambio_pieza and not venta_mostrador.incluye_limpieza and not venta_mostrador.incluye_kit_limpieza and not venta_mostrador.incluye_reinstalacion_so and not venta_mostrador.incluye_respaldo %}
                                                    <li class="text-muted"><em>Sin servicios adicionales</em></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        
                                        <!-- Notas Adicionales -->
                                        {% if venta_mostrador.notas_adicionales %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Notas:</label>
                                                <p class="mb-0 small">{{ venta_mostrador.notas_adicionales }}</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel Derecho: Resumen Financiero -->
                            <div class="col-lg-6">
                                <div class="card h-100" style="border-left: 4px solid #fda085;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-cash-stack"></i> Resumen Financiero
                                        </h6>
                                        
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="text-muted">Paquete Base:</td>
                                                <td class="text-end"><strong>${{ venta_mostrador.costo_paquete|floatformat:2 }}</strong></td>
                                            </tr>
                                            {% if venta_mostrador.incluye_cambio_pieza %}
                                                <tr>
                                                    <td class="text-muted">+ Cambio Pieza:</td>
                                                    <td class="text-end"><strong>${{ venta_mostrador.costo_cambio_pieza|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            {% if venta_mostrador.incluye_limpieza %}
                                                <tr>
                                                    <td class="text-muted">+ Limpieza:</td>
                                                    <td class="text-end"><strong>${{ venta_mostrador.costo_limpieza|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            {% if venta_mostrador.incluye_kit_limpieza %}
                                                <tr>
                                                    <td class="text-muted">+ Kit Limpieza:</td>
                                                    <td class="text-end"><strong>${{ venta_mostrador.costo_kit|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            {% if venta_mostrador.incluye_reinstalacion_so %}
                                                <tr>
                                                    <td class="text-muted">+ Reinstalaci√≥n SO:</td>
                                                    <td class="text-end"><strong>${{ venta_mostrador.costo_reinstalacion|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            {% if venta_mostrador.incluye_respaldo %}
                                                <tr>
                                                    <td class="text-muted">+ Respaldo de Informaci√≥n:</td>
                                                    <td class="text-end"><strong>${{ venta_mostrador.costo_respaldo|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            {% if piezas_venta_mostrador %}
                                                <tr>
                                                    <td class="text-muted">+ Piezas Vendidas:</td>
                                                    <td class="text-end"><strong>${{ venta_mostrador.total_piezas_vendidas|floatformat:2 }}</strong></td>
                                                </tr>
                                            {% endif %}
                                            <tr style="border-top: 2px solid #dee2e6;">
                                                <td class="text-muted"><strong>TOTAL VENTA:</strong></td>
                                                <td class="text-end">
                                                    <h5 class="mb-0 text-warning" id="totalVentaMostrador">
                                                        ${{ venta_mostrador.total_venta|floatformat:2 }}
                                                    </h5>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <!-- Informaci√≥n de Comisi√≥n -->
                                        {% if venta_mostrador.genera_comision %}
                                            <div class="alert alert-success mt-3 mb-0">
                                                <small>
                                                    <i class="bi bi-percent"></i>
                                                    <strong>Esta venta genera comisi√≥n</strong>
                                                </small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de Piezas Vendidas -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-tools"></i> Piezas Vendidas Individualmente
                                    <span class="badge bg-secondary">{{ piezas_venta_mostrador.count }}</span>
                                </h6>
                                <button type="button" class="btn btn-sm btn-primary" onclick="abrirModalPiezaVentaMostrador()">
                                    <i class="bi bi-plus-circle"></i> Agregar Pieza
                                </button>
                            </div>
                            
                            {% if piezas_venta_mostrador %}
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" id="tablaPiezasVentaMostrador">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Descripci√≥n</th>
                                                    <th>Componente</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-end">Precio Unit.</th>
                                                    <th class="text-end">Subtotal</th>
                                                    <th class="text-center">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pieza in piezas_venta_mostrador %}
                                                    <tr data-pieza-id="{{ pieza.id }}">
                                                        <td>
                                                            <strong>{{ pieza.descripcion_pieza }}</strong>
                                                            {% if pieza.notas %}
                                                                <br><small class="text-muted">{{ pieza.notas|truncatewords:15 }}</small>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if pieza.componente %}
                                                                <span class="badge bg-info">{{ pieza.componente.nombre }}</span>
                                                            {% else %}
                                                                <span class="text-muted">‚Äî</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">{{ pieza.cantidad }}</td>
                                                        <td class="text-end">${{ pieza.precio_unitario|floatformat:2 }}</td>
                                                        <td class="text-end"><strong>${{ pieza.subtotal|floatformat:2 }}</strong></td>
                                                        <td class="text-center">
                                                            <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                                    onclick="editarPiezaVentaMostrador({{ pieza.id }})" 
                                                                    title="Editar">
                                                                üìù
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                    onclick="eliminarPiezaVentaMostrador({{ pieza.id }})" 
                                                                    title="Eliminar">
                                                                üóëÔ∏è
                                                            </button>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            {% else %}
                                <div class="card-body text-center py-4">
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-inbox" style="font-size: 3rem;"></i><br>
                                        No hay piezas vendidas individualmente
                                    </p>
                                    <button type="button" class="btn btn-primary" onclick="abrirModalPiezaVentaMostrador()">
                                        <i class="bi bi-plus-circle"></i> Agregar Primera Pieza
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- ‚õî BOT√ìN DE CONVERSI√ìN ELIMINADO (Oct 2025) -->
                        <!-- Venta mostrador ahora es complemento opcional, no requiere conversi√≥n -->
                    
                    {% endif %}
                    
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 4: CAMBIAR ESTADO Y ASIGNAR RESPONSABLES -->
    <!-- ============================================================ -->
    
    <div class="row">
        <!-- SUBSECCI√ìN 4.1: Cambiar Estado -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <i class="bi bi-activity"></i>
                    Cambiar Estado de la Orden
                </div>
                <div class="card-body">
                    {% if esta_convertida %}
                    <!-- Orden convertida: Mostrar mensaje en lugar del formulario -->
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-lock-fill"></i> 
                        <strong>No disponible:</strong> Esta orden fue convertida a diagn√≥stico y ya no puede cambiar de estado.
                    </div>
                    {% else %}
                    <!-- Orden normal: Mostrar formulario -->
                    <form method="post" id="formCambioEstado">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="cambio_estado">
                        
                        <div class="row align-items-end">
                            <div class="col-md-8 mb-3">
                                {{ form_estado.estado.errors }}
                                <label for="{{ form_estado.estado.id_for_label }}" class="form-label">
                                    <i class="bi bi-arrow-repeat"></i> {{ form_estado.estado.label }}
                                </label>
                                {{ form_estado.estado }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check-circle"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                {{ form_estado.comentario_cambio.errors }}
                                <label for="{{ form_estado.comentario_cambio.id_for_label }}" class="form-label">
                                    <i class="bi bi-chat-text"></i> {{ form_estado.comentario_cambio.label }}
                                </label>
                                {{ form_estado.comentario_cambio }}
                            </div>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- SUBSECCI√ìN 4.2: Asignar Responsables -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-people-fill"></i>
                    Responsables de la Orden
                </div>
                <div class="card-body">
                    <!-- Cuadro informativo con responsables actuales -->
                    <div class="alert alert-info d-flex align-items-start mb-3" style="background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%); border: none;">
                        <i class="bi bi-info-circle-fill fs-4 me-3" style="color: #0288d1;"></i>
                        <div>
                            <h6 class="mb-2" style="color: #01579b;">Configuraci√≥n Actual:</h6>
                            <p class="mb-1">
                                <strong>T√©cnico:</strong> 
                                <span class="badge bg-primary">{{ orden.tecnico_asignado_actual.nombre_completo }}</span>
                            </p>
                            <p class="mb-0">
                                <strong>Responsable:</strong> 
                                <span class="badge bg-secondary">{{ orden.responsable_seguimiento.nombre_completo }}</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Formulario para cambiar responsables -->
                    <form method="post" id="formAsignarResponsables">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="asignar_responsables">
                        
                        <div class="mb-3">
                            {{ form_responsables.tecnico_asignado_actual.errors }}
                            <label for="{{ form_responsables.tecnico_asignado_actual.id_for_label }}" class="form-label">
                                <i class="bi bi-person-badge"></i> {{ form_responsables.tecnico_asignado_actual.label }}
                            </label>
                            {{ form_responsables.tecnico_asignado_actual }}
                            <small class="text-muted">{{ form_responsables.tecnico_asignado_actual.help_text }}</small>
                            
                            <!-- Alerta de carga de trabajo del t√©cnico seleccionado -->
                            <div id="alertaTecnico" class="mt-2" style="display: none;">
                                <!-- Se llena din√°micamente con JavaScript -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form_responsables.responsable_seguimiento.errors }}
                            <label for="{{ form_responsables.responsable_seguimiento.id_for_label }}" class="form-label">
                                <i class="bi bi-person-check"></i> {{ form_responsables.responsable_seguimiento.label }}
                            </label>
                            {{ form_responsables.responsable_seguimiento }}
                            <small class="text-muted">{{ form_responsables.responsable_seguimiento.help_text }}</small>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Actualizar Responsables
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 5: HISTORIAL Y COMENTARIOS (2 columnas) -->
    <!-- ============================================================ -->
    
    <div class="row">
        <!-- Historial Autom√°tico (Izquierda) -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="bi bi-clock-history"></i>
                    Historial Autom√°tico
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if historial_automatico %}
                        <div class="timeline">
                            {% for evento in historial_automatico %}
                            <div class="timeline-item">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <span class="badge bg-secondary">{{ evento.get_tipo_evento_display }}</span>
                                    <small class="text-muted">{{ evento.fecha_evento|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ evento.comentario }}</p>
                                {% if evento.usuario %}
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> {{ evento.usuario.nombre_completo }}
                                    </small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No hay eventos en el historial.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Comentarios (Derecha) -->
        <div class="col-lg-6">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                    <i class="bi bi-chat-dots"></i>
                    Comentarios
                </div>
                <div class="card-body">
                    <!-- Formulario para agregar comentario -->
                    <form method="post" id="formComentario" class="mb-4">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="comentario">
                        
                        {{ form_comentario.comentario.errors }}
                        <label for="{{ form_comentario.comentario.id_for_label }}" class="form-label">
                            <i class="bi bi-plus-circle"></i> Agregar Comentario
                        </label>
                        {{ form_comentario.comentario }}
                        
                        <div class="d-grid mt-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Publicar Comentario
                            </button>
                        </div>
                    </form>
                    
                    <hr>
                    
                    <!-- Lista de comentarios -->
                    <div style="max-height: 350px; overflow-y: auto;">
                        {% if comentarios %}
                            {% for comentario in comentarios %}
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <strong>
                                        <i class="bi bi-person-circle"></i>
                                        {{ comentario.usuario.nombre_completo|default:"Sistema" }}
                                    </strong>
                                    <small class="text-muted">{{ comentario.fecha_evento|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-0">{{ comentario.comentario }}</p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center">No hay comentarios a√∫n.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- SECCI√ìN 6: GALER√çA DE IM√ÅGENES -->
    <!-- ============================================================ -->
    
    <div class="row">
        <div class="col-12" id="galeria-imagenes">
            <div class="card section-card">
                <div class="section-header" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); color: #333;">
                    <i class="bi bi-images"></i>
                    Galer√≠a de Im√°genes del Equipo
                    <span class="badge bg-dark ms-2">{{ total_imagenes }} imagen{{ total_imagenes|pluralize:"es" }}</span>
                </div>
                <div class="card-body">
                    
                    <!-- Formulario para subir im√°genes -->
                    <div class="border rounded p-3 mb-4 bg-light">
                        <h6 class="mb-3">
                            <i class="bi bi-cloud-upload"></i> Subir Nuevas Im√°genes
                        </h6>
                        
                        <form method="post" enctype="multipart/form-data" id="formSubirImagenes"
                              data-tipo-id="{{ form_imagenes.tipo.id_for_label }}"
                              data-descripcion-id="{{ form_imagenes.descripcion.id_for_label }}">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="subir_imagenes">
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    {{ form_imagenes.tipo.errors }}
                                    <label for="{{ form_imagenes.tipo.id_for_label }}" class="form-label">
                                        {{ form_imagenes.tipo.label }}
                                    </label>
                                    {{ form_imagenes.tipo }}
                                </div>
                                
                                <div class="col-md-9 mb-3">
                                    {{ form_imagenes.imagenes.errors }}
                                    <label class="form-label">
                                        Seleccionar Im√°genes
                                    </label>
                                    
                                    <!-- Contenedor de botones dual: Galer√≠a y C√°mara -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <label for="inputGaleria" class="btn btn-outline-primary w-100 btn-upload-dual" style="height: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; padding: 0.5rem;">
                                                <i class="bi bi-folder2-open" style="font-size: 1.8rem; line-height: 1;"></i>
                                                <span style="margin-top: 0.4rem; font-size: 0.85rem; line-height: 1.2;">Seleccionar de<br>Galer√≠a</span>
                                            </label>
                                            <input type="file" 
                                                   name="imagenes_galeria" 
                                                   class="d-none" 
                                                   id="inputGaleria"
                                                   accept="image/jpeg,image/jpg,image/png,image/gif"
                                                   multiple>
                                        </div>
                                        <div class="col-6">
                                            <label for="inputCamara" class="btn btn-outline-success w-100 btn-upload-dual" style="height: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; padding: 0.5rem;">
                                                <i class="bi bi-camera-fill" style="font-size: 1.8rem; line-height: 1;"></i>
                                                <span style="margin-top: 0.4rem; font-size: 0.85rem; line-height: 1.2;">Capturar con<br>C√°mara</span>
                                            </label>
                                            <input type="file" 
                                                   name="imagenes_camara" 
                                                   class="d-none" 
                                                   id="inputCamara"
                                                   accept="image/*"
                                                   capture="environment"
                                                   multiple>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview de im√°genes seleccionadas -->
                                    <div id="previewImagenes" class="preview-container" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-images"></i> <span id="cantidadImagenes">0</span> imagen(es) seleccionada(s)
                                            </small>
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="btnLimpiarTodo">
                                                <i class="bi bi-x-circle"></i> Limpiar todo
                                            </button>
                                        </div>
                                        <div id="contenedorMiniaturas" class="row g-2">
                                            <!-- Miniaturas se insertar√°n aqu√≠ din√°micamente -->
                                        </div>
                                    </div>
                                    
                                    <small class="text-muted d-block mt-2">
                                        <i class="bi bi-info-circle"></i> M√°ximo 30 im√°genes por carga, 50MB cada una. Formatos: JPG, PNG, GIF
                                    </small>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <label class="form-label d-block">&nbsp;</label>
                                    <button type="submit" class="btn btn-success w-100" id="btnSubirImagenes" style="height: 45px; font-size: 0.95rem;" disabled>
                                        <i class="bi bi-cloud-upload"></i> Subir Im√°genes
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bot√≥n para enviar im√°genes al cliente -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <button type="button" 
                                            class="btn btn-primary w-100" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEnviarImagenesCliente"
                                            {% if not imagenes_por_tipo.ingreso %}disabled{% endif %}
                                            title="{% if not imagenes_por_tipo.ingreso %}Debe subir al menos una imagen de ingreso{% else %}Enviar fotograf√≠as del equipo al cliente por correo{% endif %}">
                                        <i class="bi bi-envelope-paper"></i> Env√≠o de im√°genes al cliente
                                        {% if imagenes_por_tipo.ingreso %}
                                            <span class="badge bg-light text-primary ms-2">{{ imagenes_por_tipo.ingreso.count }} disponible{{ imagenes_por_tipo.ingreso.count|pluralize:"s" }}</span>
                                        {% endif %}
                                    </button>
                                    {% if not imagenes_por_tipo.ingreso %}
                                    <small class="text-muted d-block mt-2 text-center">
                                        <i class="bi bi-info-circle"></i> Sube al menos una imagen de ingreso para habilitar el env√≠o
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Barra de progreso (oculta por defecto) -->
                            <div class="row mb-3" id="progresoUpload" style="display: none;">
                                <div class="col-12">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1 me-3">
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                     role="progressbar" 
                                                     id="barraProgreso"
                                                     style="width: 0%">
                                                    <span id="textoProgreso">Subiendo...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="badge bg-primary" id="porcentajeProgreso">0%</span>
                                    </div>
                                    <small class="text-muted d-block mt-1" id="infoArchivos">
                                        <i class="bi bi-hourglass-split"></i> Procesando im√°genes, por favor espere...
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    {{ form_imagenes.descripcion.errors }}
                                    <label for="{{ form_imagenes.descripcion.id_for_label }}" class="form-label">
                                        {{ form_imagenes.descripcion.label }}
                                    </label>
                                    {{ form_imagenes.descripcion }}
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabs de categor√≠as de im√°genes -->
                    <ul class="nav nav-pills mb-3" id="imagenesTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ingreso-tab" data-bs-toggle="pill" data-bs-target="#ingreso" type="button">
                                <i class="bi bi-arrow-down-circle"></i> Ingreso 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.ingreso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diagnostico-tab" data-bs-toggle="pill" data-bs-target="#diagnostico" type="button">
                                <i class="bi bi-search"></i> Diagn√≥stico 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.diagnostico.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reparacion-tab" data-bs-toggle="pill" data-bs-target="#reparacion" type="button">
                                <i class="bi bi-tools"></i> Reparaci√≥n 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.reparacion.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="egreso-tab" data-bs-toggle="pill" data-bs-target="#egreso" type="button">
                                <i class="bi bi-arrow-up-circle"></i> Egreso 
                                <span class="badge bg-primary">{{ imagenes_por_tipo.egreso.count }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="autorizacion-tab" data-bs-toggle="pill" data-bs-target="#autorizacion" type="button">
                                <i class="bi bi-shield-check"></i> Autorizaci√≥n/Pass 
                                <span class="badge bg-success">{{ imagenes_por_tipo.autorizacion.count }}</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Contenido de los tabs -->
                    <div class="tab-content" id="imagenesTabContent">
                        {% for tipo, imagenes in imagenes_por_tipo.items %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ tipo }}" role="tabpanel">
                            {% if imagenes %}
                            <div class="row g-3">
                                {% for imagen in imagenes %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="gallery-image-container"
                                         data-imagen-id="{{ imagen.pk }}"
                                         data-descripcion="{{ imagen.descripcion|default:'Sin descripci√≥n' }}"
                                         data-usuario="{{ imagen.subido_por.nombre_completo }}"
                                         data-fecha="{{ imagen.fecha_subida|date:'d/m/Y H:i' }}"
                                         data-url-descarga="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}">
                                        
                                        <!-- Bot√≥n descarga en miniatura -->
                                        <a href="{% url 'servicio_tecnico:descargar_imagen' imagen.pk %}" 
                                           class="btn-descarga-miniatura" 
                                           title="Descargar imagen original"
                                           onclick="event.stopPropagation();">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        
                                        <!-- Bot√≥n eliminar en miniatura -->
                                        <button type="button"
                                                class="btn-eliminar-miniatura" 
                                                title="Eliminar imagen"
                                                onclick="confirmarEliminarImagen({{ imagen.pk }}, '{{ imagen.get_tipo_display }}', event);">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                        
                                        <div class="gallery-image">
                                            <img src="{{ imagen.imagen.url }}" alt="{{ imagen.descripcion }}">
                                            <div class="image-overlay">
                                                <div>{{ imagen.fecha_subida|date:"d/m/Y H:i" }}</div>
                                                {% if imagen.descripcion %}
                                                    <div class="small">{{ imagen.descripcion|truncatewords:5 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Pie de imagen con usuario -->
                                        <div class="image-footer">
                                            <small class="text-muted">
                                                <i class="bi bi-person-circle"></i> {{ imagen.subido_por.nombre_completo }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <p class="mt-2">No hay im√°genes de {{ tipo }} a√∫n.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- ============================================================ -->
<!-- MODAL: EDITAR INFORMACI√ìN PRINCIPAL DEL EQUIPO -->
<!-- ============================================================ -->
<div class="modal fade" id="modalEditarInfoEquipo" tabindex="-1" aria-labelledby="modalEditarInfoEquipoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEditarInfoEquipoLabel">
                    <i class="bi bi-pencil-square"></i> Editar Informaci√≥n del Equipo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <form method="post" id="formEditarInfoEquipo">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="editar_info_equipo">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Importante:</strong> Puedes actualizar cualquier informaci√≥n del equipo que haya sido omitida o necesite correcci√≥n.
                    </div>
                    
                    <div class="row">
                        <!-- Tipo de Equipo -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.tipo_equipo.errors }}
                            <label for="{{ form_editar_info.tipo_equipo.id_for_label }}" class="form-label">
                                {{ form_editar_info.tipo_equipo.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.tipo_equipo }}
                            {% if form_editar_info.tipo_equipo.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.tipo_equipo.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Gama -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.gama.errors }}
                            <label for="{{ form_editar_info.gama.id_for_label }}" class="form-label">
                                {{ form_editar_info.gama.label }}
                            </label>
                            {{ form_editar_info.gama }}
                            {% if form_editar_info.gama.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.gama.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Marca -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.marca.errors }}
                            <label for="{{ form_editar_info.marca.id_for_label }}" class="form-label">
                                {{ form_editar_info.marca.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.marca }}
                            {% if form_editar_info.marca.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.marca.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Modelo -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.modelo.errors }}
                            <label for="{{ form_editar_info.modelo.id_for_label }}" class="form-label">
                                {{ form_editar_info.modelo.label }}
                            </label>
                            {{ form_editar_info.modelo }}
                            {% if form_editar_info.modelo.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.modelo.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- N√∫mero de Serie -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.numero_serie.errors }}
                            <label for="{{ form_editar_info.numero_serie.id_for_label }}" class="form-label">
                                {{ form_editar_info.numero_serie.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.numero_serie }}
                            {% if form_editar_info.numero_serie.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.numero_serie.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- Orden del Cliente -->
                        <div class="col-md-6 mb-3">
                            {{ form_editar_info.orden_cliente.errors }}
                            <label for="{{ form_editar_info.orden_cliente.id_for_label }}" class="form-label">
                                {{ form_editar_info.orden_cliente.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_editar_info.orden_cliente }}
                            {% if form_editar_info.orden_cliente.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.orden_cliente.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- ‚úÖ NUEVO: Email del Cliente (Noviembre 2025) -->
                        <div class="col-md-12 mb-3">
                            {{ form_editar_info.email_cliente.errors }}
                            <label for="{{ form_editar_info.email_cliente.id_for_label }}" class="form-label">
                                <i class="bi bi-envelope-fill text-primary"></i>
                                {{ form_editar_info.email_cliente.label }}
                                <span class="badge bg-danger ms-2">Obligatorio</span>
                            </label>
                            {{ form_editar_info.email_cliente }}
                            {% if form_editar_info.email_cliente.help_text %}
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle"></i>
                                    {{ form_editar_info.email_cliente.help_text|safe }}
                                </small>
                            {% endif %}
                        </div>
                        
                        <!-- Equipo Enciende -->
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form_editar_info.equipo_enciende }}
                                <label class="form-check-label" for="{{ form_editar_info.equipo_enciende.id_for_label }}">
                                    {{ form_editar_info.equipo_enciende.label }}
                                </label>
                            </div>
                            {% if form_editar_info.equipo_enciende.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.equipo_enciende.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- MIS: Mail-In Service -->
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form_editar_info.es_mis }}
                                <label class="form-check-label" for="{{ form_editar_info.es_mis.id_for_label }}">
                                    {{ form_editar_info.es_mis.label }}
                                </label>
                            </div>
                            {% if form_editar_info.es_mis.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.es_mis.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <hr class="my-3">
                        
                        <!-- Tiene Cargador -->
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form_editar_info.tiene_cargador }}
                                <label class="form-check-label" for="{{ form_editar_info.tiene_cargador.id_for_label }}">
                                    {{ form_editar_info.tiene_cargador.label }}
                                </label>
                            </div>
                            {% if form_editar_info.tiene_cargador.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.tiene_cargador.help_text }}</small>
                            {% endif %}
                        </div>
                        
                        <!-- N√∫mero de Serie del Cargador -->
                        <div class="col-md-12 mb-3" id="divNumeroSerieCargadorModal" style="display: none;">
                            {{ form_editar_info.numero_serie_cargador.errors }}
                            <label for="{{ form_editar_info.numero_serie_cargador.id_for_label }}" class="form-label">
                                {{ form_editar_info.numero_serie_cargador.label }}
                            </label>
                            {{ form_editar_info.numero_serie_cargador }}
                            {% if form_editar_info.numero_serie_cargador.help_text %}
                                <small class="form-text text-muted">{{ form_editar_info.numero_serie_cargador.help_text }}</small>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" form="formEditarInfoEquipo" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: GESTIONAR PIEZA COTIZADA (Agregar/Editar) -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalPieza" tabindex="-1" aria-labelledby="modalPiezaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalPiezaLabel">
                    <i class="bi bi-gear"></i> <span id="modalPiezaTitulo">Agregar Pieza</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formPieza">
                {% csrf_token %}
                <input type="hidden" id="piezaId" name="pieza_id" value="">
                
                <div class="modal-body">
                    <!-- Alerta de errores (oculta por defecto) -->
                    <div class="alert alert-danger d-none" id="alertErroresPieza" role="alert">
                        <strong>‚ùå Errores:</strong>
                        <ul id="listaErroresPieza" class="mb-0"></ul>
                    </div>
                    
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-md-6">
                            <!-- Componente -->
                            <div class="mb-3">
                                <label for="{{ form_pieza.componente.id_for_label }}" class="form-label">
                                    {{ form_pieza.componente.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form_pieza.componente }}
                                {% if form_pieza.componente.help_text %}
                                    <small class="form-text text-muted">{{ form_pieza.componente.help_text }}</small>
                                {% endif %}
                                {% if form_pieza.componente.errors %}
                                    <div class="text-danger small">{{ form_pieza.componente.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Cantidad -->
                            <div class="mb-3">
                                <label for="{{ form_pieza.cantidad.id_for_label }}" class="form-label">
                                    {{ form_pieza.cantidad.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form_pieza.cantidad }}
                                {% if form_pieza.cantidad.help_text %}
                                    <small class="form-text text-muted">{{ form_pieza.cantidad.help_text }}</small>
                                {% endif %}
                            </div>
                            
                            <!-- Costo Unitario -->
                            <div class="mb-3">
                                <label for="{{ form_pieza.costo_unitario.id_for_label }}" class="form-label">
                                    {{ form_pieza.costo_unitario.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form_pieza.costo_unitario }}
                                {% if form_pieza.costo_unitario.help_text %}
                                    <small class="form-text text-muted">{{ form_pieza.costo_unitario.help_text }}</small>
                                {% endif %}
                            </div>
                            
                            <!-- ‚ú® NUEVO: Proveedor (Noviembre 2025) -->
                            <div class="mb-3">
                                <label for="{{ form_pieza.proveedor.id_for_label }}" class="form-label">
                                    {{ form_pieza.proveedor.label }}
                                </label>
                                {{ form_pieza.proveedor }}
                                {% if form_pieza.proveedor.help_text %}
                                    <small class="form-text text-muted">{{ form_pieza.proveedor.help_text }}</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Columna derecha -->
                        <div class="col-md-6">
                            <!-- Orden de Prioridad -->
                            <div class="mb-3">
                                <label for="{{ form_pieza.orden_prioridad.id_for_label }}" class="form-label">
                                    {{ form_pieza.orden_prioridad.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form_pieza.orden_prioridad }}
                                {% if form_pieza.orden_prioridad.help_text %}
                                    <small class="form-text text-muted">{{ form_pieza.orden_prioridad.help_text }}</small>
                                {% endif %}
                            </div>
                            
                            <!-- Es Necesaria -->
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form_pieza.es_necesaria }}
                                    <label class="form-check-label" for="{{ form_pieza.es_necesaria.id_for_label }}">
                                        {{ form_pieza.es_necesaria.label }}
                                    </label>
                                </div>
                                {% if form_pieza.es_necesaria.help_text %}
                                    <small class="form-text text-muted">{{ form_pieza.es_necesaria.help_text }}</small>
                                {% endif %}
                            </div>
                            
                            <!-- Sugerida por T√©cnico -->
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form_pieza.sugerida_por_tecnico }}
                                    <label class="form-check-label" for="{{ form_pieza.sugerida_por_tecnico.id_for_label }}">
                                        {{ form_pieza.sugerida_por_tecnico.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Descripci√≥n Adicional (full width) -->
                    <div class="mb-3">
                        <label for="{{ form_pieza.descripcion_adicional.id_for_label }}" class="form-label">
                            {{ form_pieza.descripcion_adicional.label }}
                        </label>
                        {{ form_pieza.descripcion_adicional }}
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> <span id="btnPiezaTexto">Agregar Pieza</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: GESTIONAR SEGUIMIENTO DE PIEZA (Agregar/Editar) -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalSeguimiento" tabindex="-1" aria-labelledby="modalSeguimientoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalSeguimientoLabel">
                    <i class="bi bi-truck"></i> <span id="modalSeguimientoTitulo">Agregar Seguimiento</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formSeguimiento">
                {% csrf_token %}
                <input type="hidden" id="seguimientoId" name="seguimiento_id" value="">
                
                <div class="modal-body">
                    <!-- Alerta de errores (oculta por defecto) -->
                    <div class="alert alert-danger d-none" id="alertErroresSeguimiento" role="alert">
                        <strong>‚ùå Errores:</strong>
                        <ul id="listaErroresSeguimiento" class="mb-0"></ul>
                    </div>
                    
                    <!-- NUEVO: Selecci√≥n de piezas espec√≠ficas -->
                    <div class="mb-4 p-3" style="background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <h6 class="mb-3">
                            <i class="bi bi-tools"></i> Piezas a Rastrear
                            <small class="text-muted">(opcional)</small>
                        </h6>
                        <p class="small text-muted mb-3">
                            <i class="bi bi-info-circle"></i> 
                            Selecciona las piezas espec√≠ficas que se est√°n pidiendo en este pedido.
                            Solo aparecen las piezas que el cliente acept√≥.
                        </p>
                        
                        <!-- Renderizado manual de checkboxes con Bootstrap -->
                        <div id="listaPiezasDisponibles" class="row g-2">
                            {% if form_seguimiento.piezas.field.queryset %}
                                {% for pieza in form_seguimiento.piezas.field.queryset %}
                                <div class="col-md-6">
                                    <div class="form-check p-3 border rounded" style="background-color: white;">
                                        <input class="form-check-input pieza-checkbox" 
                                               type="checkbox" 
                                               name="piezas" 
                                               value="{{ pieza.id }}" 
                                               id="pieza_{{ pieza.id }}"
                                               {% if pieza in form_seguimiento.piezas.value %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="pieza_{{ pieza.id }}" style="cursor: pointer;">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>{{ pieza.componente.nombre }}</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        Cantidad: {{ pieza.cantidad }} √ó ${{ pieza.costo_unitario|floatformat:2 }}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-info">${{ pieza.costo_total|floatformat:2 }}</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle"></i> 
                                        No hay piezas disponibles para rastrear. Aseg√∫rate de que la cotizaci√≥n tenga piezas aceptadas.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <small class="form-text text-muted d-block mt-3">
                            <i class="bi bi-hand-index"></i> Haz clic en cualquier parte de la tarjeta para seleccionar/deseleccionar
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-md-6">
                            <!-- Proveedor -->
                            <div class="mb-3">
                                <label for="{{ form_seguimiento.proveedor.id_for_label }}" class="form-label">
                                    üè™ Proveedor <span class="text-danger">*</span>
                                </label>
                                {{ form_seguimiento.proveedor }}
                                {% if form_seguimiento.proveedor.help_text %}
                                    <small class="form-text text-muted">{{ form_seguimiento.proveedor.help_text }}</small>
                                {% endif %}
                            </div>
                            
                            <!-- Descripci√≥n de Piezas -->
                            <div class="mb-3">
                                <label for="descripcion_piezas" class="form-label">
                                    Descripci√≥n de Piezas <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="descripcion_piezas" name="descripcion_piezas" 
                                          rows="2" placeholder="Describe las piezas incluidas en este pedido" required></textarea>
                                <small class="form-text text-muted">Lista de piezas incluidas en este pedido</small>
                            </div>
                            
                            <!-- N√∫mero de Pedido -->
                            <div class="mb-3">
                                <label for="numero_pedido" class="form-label">
                                    N√∫mero de Pedido / Tracking
                                </label>
                                <input type="text" class="form-control" id="numero_pedido" name="numero_pedido" 
                                       placeholder="N√∫mero de pedido o tracking">
                                <small class="form-text text-muted">N√∫mero de orden o tracking del proveedor (opcional)</small>
                            </div>
                        </div>
                        
                        <!-- Columna derecha -->
                        <div class="col-md-6">
                            <!-- Fecha de Pedido -->
                            <div class="mb-3">
                                <label for="fecha_pedido" class="form-label">
                                    Fecha de Pedido <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="fecha_pedido" name="fecha_pedido" required>
                            </div>
                            
                            <!-- Fecha Estimada de Entrega -->
                            <div class="mb-3">
                                <label for="fecha_entrega_estimada" class="form-label">
                                    Fecha Estimada de Entrega <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="fecha_entrega_estimada" name="fecha_entrega_estimada" required>
                                <small class="form-text text-muted">Fecha comprometida por el proveedor</small>
                            </div>
                            
                            <!-- Fecha Real de Entrega -->
                            <div class="mb-3">
                                <label for="fecha_entrega_real" class="form-label">
                                    Fecha Real de Entrega
                                </label>
                                <input type="date" class="form-control" id="fecha_entrega_real" name="fecha_entrega_real">
                                <small class="form-text text-muted">Dejar vac√≠o si a√∫n no llega</small>
                            </div>
                            
                            <!-- Estado -->
                            <div class="mb-3">
                                <label for="estado" class="form-label">
                                    Estado del Pedido <span class="text-danger">*</span>
                                </label>
                                <select class="form-control form-select" id="estado" name="estado" required>
                                    <option value="pedido">üìã Pedido Realizado</option>
                                    <option value="confirmado">‚úÖ Pedido Confirmado</option>
                                    <option value="transito">üöö En Tr√°nsito</option>
                                    <option value="retrasado">‚ö†Ô∏è Retrasado</option>
                                    <option value="recibido">üì¨ Recibido en Sucursal</option>
                                </select>
                                <small class="form-text text-muted">Estado actual del pedido</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notas de Seguimiento (full width) -->
                    <div class="mb-3">
                        <label for="notas_seguimiento" class="form-label">
                            Notas de Seguimiento
                        </label>
                        <textarea class="form-control" id="notas_seguimiento" name="notas_seguimiento" 
                                  rows="2" placeholder="Notas adicionales sobre el seguimiento (opcional)"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="bi bi-check-circle"></i> <span id="btnSeguimientoTexto">Agregar Seguimiento</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: CREAR/EDITAR VENTA MOSTRADOR -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalVentaMostrador" tabindex="-1" aria-labelledby="modalVentaMostradorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">
                <h5 class="modal-title" id="modalVentaMostradorLabel">
                    <i class="bi bi-shop"></i> <span id="modalVentaMostradorTitulo">Crear Venta Mostrador</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formVentaMostrador">
                {% csrf_token %}
                
                <div class="modal-body">
                    <!-- Alerta de errores (oculta por defecto) -->
                    <div class="alert alert-danger d-none" id="alertErroresVentaMostrador" role="alert">
                        <strong>‚ùå Errores:</strong>
                        <ul id="listaErroresVentaMostrador" class="mb-0"></ul>
                    </div>
                    
                    <!-- Selecci√≥n de Paquete -->
                    <div class="mb-4 p-3" style="background-color: #fff8e1; border-radius: 8px; border-left: 4px solid #fda085;">
                        <h6 class="mb-3">
                            <i class="bi bi-box-seam"></i> Selecci√≥n de Paquete
                        </h6>
                        
                        <div class="mb-3">
                            <label for="id_paquete_venta" class="form-label">
                                Paquete <span class="text-danger">*</span>
                            </label>
                            {{ form_venta_mostrador.paquete }}
                        </div>
                        
                        <!-- Descripciones de paquetes -->
                        <div id="descripcionPaquete" class="alert alert-info small mb-0" style="display: none;">
                            <div id="textoPaquete"></div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Servicios Adicionales -->
                    <h6 class="mb-3">
                        <i class="bi bi-plus-circle"></i> Servicios Adicionales
                    </h6>
                    
                    <div class="row">
                        <!-- Cambio de Pieza -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check mb-2">
                                {{ form_venta_mostrador.incluye_cambio_pieza }}
                                <label class="form-check-label fw-bold" for="{{ form_venta_mostrador.incluye_cambio_pieza.id_for_label }}">
                                    üîß Cambio de Pieza
                                </label>
                            </div>
                            <div id="divCostoCambioPieza" style="display: none;">
                                <label for="{{ form_venta_mostrador.costo_cambio_pieza.id_for_label }}" class="form-label small">
                                    Costo de Cambio de Pieza <span class="text-danger">*</span>
                                </label>
                                {{ form_venta_mostrador.costo_cambio_pieza }}
                            </div>
                        </div>
                        
                        <!-- Limpieza -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check mb-2">
                                {{ form_venta_mostrador.incluye_limpieza }}
                                <label class="form-check-label fw-bold" for="{{ form_venta_mostrador.incluye_limpieza.id_for_label }}">
                                    üßπ Limpieza de Equipo
                                </label>
                            </div>
                            <div id="divCostoLimpieza" style="display: none;">
                                <label for="{{ form_venta_mostrador.costo_limpieza.id_for_label }}" class="form-label small">
                                    Costo de Limpieza <span class="text-danger">*</span>
                                </label>
                                {{ form_venta_mostrador.costo_limpieza }}
                            </div>
                        </div>
                        
                        <!-- Kit de Limpieza -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check mb-2">
                                {{ form_venta_mostrador.incluye_kit_limpieza }}
                                <label class="form-check-label fw-bold" for="{{ form_venta_mostrador.incluye_kit_limpieza.id_for_label }}">
                                    üßº Kit de Limpieza
                                </label>
                            </div>
                            <div id="divCostoKit" style="display: none;">
                                <label for="{{ form_venta_mostrador.costo_kit.id_for_label }}" class="form-label small">
                                    Costo del Kit <span class="text-danger">*</span>
                                </label>
                                {{ form_venta_mostrador.costo_kit }}
                            </div>
                        </div>
                        
                        <!-- Reinstalaci√≥n SO -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check mb-2">
                                {{ form_venta_mostrador.incluye_reinstalacion_so }}
                                <label class="form-check-label fw-bold" for="{{ form_venta_mostrador.incluye_reinstalacion_so.id_for_label }}">
                                    üñ•Ô∏è Reinstalaci√≥n de Sistema Operativo
                                </label>
                            </div>
                            <div id="divCostoReinstalacion" style="display: none;">
                                <label for="{{ form_venta_mostrador.costo_reinstalacion.id_for_label }}" class="form-label small">
                                    Costo de Reinstalaci√≥n <span class="text-danger">*</span>
                                </label>
                                {{ form_venta_mostrador.costo_reinstalacion }}
                            </div>
                        </div>
                        
                        <!-- Respaldo de Informaci√≥n -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check mb-2">
                                {{ form_venta_mostrador.incluye_respaldo }}
                                <label class="form-check-label fw-bold" for="{{ form_venta_mostrador.incluye_respaldo.id_for_label }}">
                                    üíæ Respaldo de Informaci√≥n
                                </label>
                            </div>
                            <div id="divCostoRespaldo" style="display: none;">
                                <label for="{{ form_venta_mostrador.costo_respaldo.id_for_label }}" class="form-label small">
                                    Costo del Respaldo <span class="text-danger">*</span>
                                </label>
                                {{ form_venta_mostrador.costo_respaldo }}
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Notas Adicionales -->
                    <div class="mb-3">
                        <label for="{{ form_venta_mostrador.notas_adicionales.id_for_label }}" class="form-label">
                            <i class="bi bi-sticky"></i> Notas Adicionales
                        </label>
                        {{ form_venta_mostrador.notas_adicionales }}
                        <small class="form-text text-muted">Informaci√≥n adicional sobre la venta</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Crear Venta Mostrador
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: AGREGAR/EDITAR PIEZA VENTA MOSTRADOR -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalPiezaVentaMostrador" tabindex="-1" aria-labelledby="modalPiezaVentaMostradorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalPiezaVentaMostradorLabel">
                    <i class="bi bi-tools"></i> <span id="modalPiezaVentaMostradorTitulo">Agregar Pieza</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formPiezaVentaMostrador">
                {% csrf_token %}
                <input type="hidden" id="piezaVentaMostradorId" name="pieza_id" value="">
                
                <div class="modal-body">
                    <!-- Alerta de errores (oculta por defecto) -->
                    <div class="alert alert-danger d-none" id="alertErroresPiezaVentaMostrador" role="alert">
                        <strong>‚ùå Errores:</strong>
                        <ul id="listaErroresPiezaVentaMostrador" class="mb-0"></ul>
                    </div>
                    
                    <div class="row">
                        <!-- Componente (opcional) -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form_pieza_venta_mostrador.componente.id_for_label }}" class="form-label">
                                {{ form_pieza_venta_mostrador.componente.label }}
                                <small class="text-muted">(opcional)</small>
                            </label>
                            {{ form_pieza_venta_mostrador.componente }}
                            <small class="form-text text-muted">Si la pieza est√° en el cat√°logo, selecci√≥nala aqu√≠</small>
                        </div>
                        
                        <!-- Descripci√≥n (obligatorio) -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form_pieza_venta_mostrador.descripcion_pieza.id_for_label }}" class="form-label">
                                {{ form_pieza_venta_mostrador.descripcion_pieza.label }} 
                                <span class="text-danger">*</span>
                            </label>
                            {{ form_pieza_venta_mostrador.descripcion_pieza }}
                            <small class="form-text text-muted">Ej: RAM 8GB DDR4 Kingston, Cable HDMI 2m</small>
                        </div>
                        
                        <!-- Cantidad -->
                        <div class="col-md-4 mb-3">
                            <label for="{{ form_pieza_venta_mostrador.cantidad.id_for_label }}" class="form-label">
                                {{ form_pieza_venta_mostrador.cantidad.label }} 
                                <span class="text-danger">*</span>
                            </label>
                            {{ form_pieza_venta_mostrador.cantidad }}
                        </div>
                        
                        <!-- Precio Unitario -->
                        <div class="col-md-4 mb-3">
                            <label for="{{ form_pieza_venta_mostrador.precio_unitario.id_for_label }}" class="form-label">
                                {{ form_pieza_venta_mostrador.precio_unitario.label }} 
                                <span class="text-danger">*</span>
                            </label>
                            {{ form_pieza_venta_mostrador.precio_unitario }}
                        </div>
                        
                        <!-- Subtotal (calculado) -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Subtotal</label>
                            <div class="form-control-plaintext bg-light p-2 text-center rounded">
                                <strong id="subtotalPiezaVentaMostrador">$0.00</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notas -->
                    <div class="mb-3">
                        <label for="{{ form_pieza_venta_mostrador.notas.id_for_label }}" class="form-label">
                            {{ form_pieza_venta_mostrador.notas.label }}
                        </label>
                        {{ form_pieza_venta_mostrador.notas }}
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> <span id="btnPiezaVentaMostradorTexto">Agregar Pieza</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- ‚õî MODAL DE CONVERSI√ìN A DIAGN√ìSTICO ELIMINADO (Oct 2025) -->
<!-- Funcionalidad eliminada: Venta mostrador ahora es complemento opcional -->
<!-- ============================================================================ -->

<!-- ============================================================================ -->
<!-- MODAL: ENVIAR DIAGN√ìSTICO AL CLIENTE -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalEnviarDiagnostico" tabindex="-1" aria-labelledby="modalEnviarDiagnosticoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <!-- Encabezado del Modal -->
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);">
                <h5 class="modal-title" id="modalEnviarDiagnosticoLabel">
                    <i class="bi bi-file-earmark-medical"></i> üìã Enviar Diagn√≥stico al Cliente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Cuerpo del Modal -->
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="formEnviarDiagnostico" method="post" action="{% url 'servicio_tecnico:enviar_diagnostico_cliente' orden.id %}"
                      data-current-user-empleado-id="{{ request.user.empleado.id|default:'' }}"
                      data-current-user-email="{{ request.user.empleado.email|default:'' }}"
                      data-current-user-nombre="{{ request.user.empleado.nombre_completo|default:'' }}"
                      data-detalle-equipo-id="{{ orden.detalle_equipo.pk }}">
                    {% csrf_token %}
                    
                    <!-- SECCI√ìN 1: FOLIO PERSONALIZADO -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-hash text-success fs-5 me-2"></i>
                            <h6 class="mb-0 text-success fw-bold">Folio del Diagn√≥stico</h6>
                        </div>
                        
                        <div class="mb-3">
                            <label for="inputFolioDiagnostico" class="form-label fw-bold">
                                <i class="bi bi-upc-scan"></i> Folio personalizado <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="inputFolioDiagnostico" 
                                   name="folio"
                                   placeholder="Ej: MX_CIS_MX_MONTERREY1_02690"
                                   required>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Escribe el folio completo tal como debe aparecer en el PDF y en el asunto del correo.
                            </small>
                        </div>
                        
                        <!-- Vista previa del asunto -->
                        <div class="alert alert-light border-start border-4 border-success py-2">
                            <small class="text-muted"><strong>Asunto del correo:</strong></small>
                            <div class="fw-bold text-success" id="previewAsuntoDiagnostico">
                                DIAGNOSTICO FOLIO <span id="spanFolioPreview" class="text-primary">___</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- SECCI√ìN 2: DESTINATARIO PRINCIPAL -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-person-fill text-primary fs-5 me-2"></i>
                            <h6 class="mb-0 text-primary fw-bold">Para: (Destinatario principal)</h6>
                        </div>
                        
                        {% if orden.detalle_equipo.email_cliente and orden.detalle_equipo.email_cliente != 'cliente@ejemplo.com' %}
                        <div class="destinatario-card p-3 border rounded shadow-sm" 
                             id="cardDestinatarioEmail"
                             style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border: 2px solid #4caf50 !important;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-check-fill text-success fs-2 me-3 flex-shrink-0"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-success">
                                        <i class="bi bi-laptop"></i> Cliente del Equipo
                                        <span class="badge bg-success ms-2" id="badgeEmailValido">
                                            <i class="bi bi-check-circle-fill"></i> V√ÅLIDO
                                        </span>
                                    </div>
                                    
                                    {# === MODO LECTURA: Muestra el email + bot√≥n editar === #}
                                    <div id="emailClienteVistaLectura" class="d-flex align-items-center mt-1">
                                        <small class="text-dark">
                                            <i class="bi bi-envelope-fill"></i> 
                                            <strong id="spanEmailCliente">{{ orden.detalle_equipo.email_cliente }}</strong>
                                        </small>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-primary ms-2 py-0 px-2"
                                                id="btnEditarEmailCliente"
                                                title="Editar email del cliente"
                                                style="font-size: 0.75rem; line-height: 1.5;">
                                            <i class="bi bi-pencil-fill"></i> Editar
                                        </button>
                                    </div>
                                    
                                    {# === MODO EDICI√ìN: Input + Guardar/Cancelar === #}
                                    <div id="emailClienteVistaEdicion" class="mt-2" style="display: none;">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white">
                                                <i class="bi bi-envelope-fill text-primary"></i>
                                            </span>
                                            <input type="email" 
                                                   class="form-control form-control-sm" 
                                                   id="inputEditarEmailCliente"
                                                   value="{{ orden.detalle_equipo.email_cliente }}"
                                                   placeholder="correo@ejemplo.com"
                                                   style="font-weight: 600;">
                                            <button type="button" 
                                                    class="btn btn-sm btn-success"
                                                    id="btnGuardarEmailCliente"
                                                    title="Guardar cambio">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    id="btnCancelarEmailCliente"
                                                    title="Cancelar edici√≥n">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted mt-1 d-block" id="feedbackEmailCliente"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="destinatario-card p-3 border rounded shadow-sm" 
                             id="cardDestinatarioEmail"
                             style="background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%); border: 2px solid #ff9800 !important;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill text-warning fs-2 me-3 flex-shrink-0"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-warning">
                                        <i class="bi bi-laptop"></i> Cliente del Equipo
                                        <span class="badge bg-warning text-dark ms-2" id="badgeEmailValido">
                                            <i class="bi bi-exclamation-triangle-fill"></i> SIN EMAIL
                                        </span>
                                    </div>
                                    
                                    {# === MODO LECTURA: Muestra advertencia + bot√≥n agregar === #}
                                    <div id="emailClienteVistaLectura" class="d-flex align-items-center mt-1">
                                        <small class="text-dark">
                                            <i class="bi bi-envelope-fill"></i> 
                                            <strong id="spanEmailCliente" class="text-danger">No configurado</strong>
                                        </small>
                                        <button type="button" 
                                                class="btn btn-sm btn-primary ms-2 py-0 px-2"
                                                id="btnEditarEmailCliente"
                                                title="Agregar email del cliente"
                                                style="font-size: 0.75rem; line-height: 1.5;">
                                            <i class="bi bi-plus-circle-fill"></i> Agregar
                                        </button>
                                    </div>
                                    
                                    {# === MODO EDICI√ìN: Input + Guardar/Cancelar === #}
                                    <div id="emailClienteVistaEdicion" class="mt-2" style="display: none;">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white">
                                                <i class="bi bi-envelope-fill text-primary"></i>
                                            </span>
                                            <input type="email" 
                                                   class="form-control form-control-sm" 
                                                   id="inputEditarEmailCliente"
                                                   value=""
                                                   placeholder="correo@ejemplo.com"
                                                   style="font-weight: 600;">
                                            <button type="button" 
                                                    class="btn btn-sm btn-success"
                                                    id="btnGuardarEmailCliente"
                                                    title="Guardar cambio">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    id="btnCancelarEmailCliente"
                                                    title="Cancelar edici√≥n">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted mt-1 d-block" id="feedbackEmailCliente"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- SECCI√ìN 3: CON COPIA A -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-file-earmark-text-fill text-info fs-5 me-2"></i>
                            <h6 class="mb-0 text-info fw-bold">Con copia a: (Opcional)</h6>
                        </div>
                        
                        <div class="row g-3">
                            <!-- T√©cnico asignado -->
                            <div class="col-12">
                                <h6 class="mb-2"><i class="bi bi-tools text-success"></i> T√©cnico Asignado</h6>
                                {% if orden.tecnico_asignado_actual and orden.tecnico_asignado_actual.email %}
                                <label class="destinatario-card p-3 border rounded bg-light hover-shadow d-block mb-0 cursor-pointer" for="diag_tecnico_asignado">
                                    <div class="d-flex align-items-center">
                                        <input class="form-check-input me-3 flex-shrink-0" 
                                               type="checkbox" name="copia_tecnico" 
                                               value="{{ orden.tecnico_asignado_actual.email }}" 
                                               id="diag_tecnico_asignado">
                                        
                                        {% if orden.tecnico_asignado_actual.foto_perfil %}
                                            <img src="{{ orden.tecnico_asignado_actual.foto_perfil.url }}" 
                                                 alt="{{ orden.tecnico_asignado_actual.nombre_completo }}" 
                                                 class="rounded-circle me-2 flex-shrink-0"
                                                 style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #28a745;">
                                        {% else %}
                                            <i class="bi bi-person-badge-fill text-success fs-3 me-2 flex-shrink-0"></i>
                                        {% endif %}
                                        
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <div class="fw-bold text-truncate">
                                                <i class="bi bi-wrench"></i> {{ orden.tecnico_asignado_actual.nombre_completo }}
                                            </div>
                                            <small class="text-muted">
                                                <span class="badge bg-success me-1">T√âCNICO</span>
                                                {{ orden.tecnico_asignado_actual.email }}
                                            </small>
                                        </div>
                                    </div>
                                </label>
                                {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> Sin t√©cnico asignado o sin email configurado.
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-12"><hr class="my-2"></div>
                            
                            <!-- Empleados internos -->
                            <div class="col-12">
                                <h6 class="mb-2"><i class="bi bi-people-fill text-info"></i> Empleados Internos</h6>
                                {% if empleados_copia_imagenes %}
                                <div class="row g-2">
                                    {% for empleado in empleados_copia_imagenes %}
                                    <div class="col-lg-6 col-md-12">
                                        <label class="destinatario-card p-3 border rounded bg-light hover-shadow d-block mb-0 cursor-pointer {% if empleado.id == request.user.empleado.id %}border-primary border-2{% endif %}" 
                                               for="diag_emp_{{ empleado.id }}"
                                               id="label_emp_{{ empleado.id }}">
                                            <div class="d-flex align-items-center">
                                                <input class="form-check-input me-3 flex-shrink-0 checkbox-cc-empleado" 
                                                       type="checkbox" name="copia_empleados" 
                                                       value="{{ empleado.email }}" 
                                                       data-empleado-id="{{ empleado.id }}"
                                                       id="diag_emp_{{ empleado.id }}"
                                                       {% if empleado.id == request.user.empleado.id %}checked disabled{% endif %}>
                                                
                                                {# Input oculto para que el valor se env√≠e aunque est√© disabled #}
                                                {% if empleado.id == request.user.empleado.id %}
                                                <input type="hidden" name="copia_empleados" value="{{ empleado.email }}">
                                                {% endif %}
                                                
                                                {% if empleado.foto_perfil %}
                                                    <img src="{{ empleado.foto_perfil.url }}" 
                                                         alt="{{ empleado.nombre_completo }}" 
                                                         class="rounded-circle me-2 flex-shrink-0"
                                                         style="width: 48px; height: 48px; object-fit: cover; border: 2px solid {% if empleado.id == request.user.empleado.id %}#0d6efd{% else %}#17a2b8{% endif %};">
                                                {% else %}
                                                    <i class="bi bi-person-badge {% if empleado.id == request.user.empleado.id %}text-primary{% else %}text-info{% endif %} fs-3 me-2 flex-shrink-0"></i>
                                                {% endif %}
                                                <div class="flex-grow-1" style="min-width: 0;">
                                                    <div class="fw-bold text-truncate">
                                                        {{ empleado.nombre_completo }}
                                                        {% if empleado.id == request.user.empleado.id %}
                                                        <span class="badge bg-primary ms-1" style="font-size: 0.65rem;">
                                                            <i class="bi bi-person-fill"></i> T√ö
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                    <small class="text-muted">
                                                        <span class="badge bg-secondary me-1">{{ empleado.area }}</span>
                                                        <span class="text-truncate d-inline-block" style="max-width: 180px; vertical-align: middle;">{{ empleado.email }}</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> Sin empleados disponibles con email.
                                </div>
                                {% endif %}
                                
                                {# Si el usuario logueado NO est√° en la lista de CC, agregar su checkbox autom√°ticamente #}
                                {% if not usuario_en_lista_cc and request.user.empleado and request.user.empleado.email %}
                                <div class="mt-2">
                                    <label class="destinatario-card p-3 border rounded border-primary border-2 d-block mb-0 cursor-pointer" 
                                           for="diag_emp_current_user"
                                           id="label_emp_{{ request.user.empleado.id }}"
                                           style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 50%, #e8f5e9 100%);">
                                        <div class="d-flex align-items-center">
                                            <input class="form-check-input me-3 flex-shrink-0 checkbox-cc-empleado" 
                                                   type="checkbox" name="copia_empleados" 
                                                   value="{{ request.user.empleado.email }}" 
                                                   data-empleado-id="{{ request.user.empleado.id }}"
                                                   id="diag_emp_current_user"
                                                   checked disabled>
                                            <input type="hidden" name="copia_empleados" value="{{ request.user.empleado.email }}">
                                            
                                            {% if request.user.empleado.foto_perfil %}
                                                <img src="{{ request.user.empleado.foto_perfil.url }}" 
                                                     alt="{{ request.user.empleado.nombre_completo }}" 
                                                     class="rounded-circle me-2 flex-shrink-0"
                                                     style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #0d6efd;">
                                            {% else %}
                                                <i class="bi bi-person-badge text-primary fs-3 me-2 flex-shrink-0"></i>
                                            {% endif %}
                                            <div class="flex-grow-1" style="min-width: 0;">
                                                <div class="fw-bold text-truncate">
                                                    {{ request.user.empleado.nombre_completo }}
                                                    <span class="badge bg-primary ms-1" style="font-size: 0.65rem;">
                                                        <i class="bi bi-person-fill"></i> T√ö
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    <span class="badge bg-secondary me-1">{{ request.user.empleado.area }}</span>
                                                    <span class="text-truncate d-inline-block" style="max-width: 180px; vertical-align: middle;">{{ request.user.empleado.email }}</span>
                                                </small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- SECCI√ìN 4: CHECKLIST DE COMPONENTES -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-list-check text-warning fs-5 me-2"></i>
                                <h6 class="mb-0 text-warning fw-bold">
                                    Observaciones Adicionales (Componentes)
                                    <span class="badge bg-warning text-dark ms-2" id="contadorComponentesSeleccionados">0 seleccionados</span>
                                </h6>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <!-- Bot√≥n para detectar piezas autom√°ticamente del diagn√≥stico -->
                                {% if orden.detalle_equipo.diagnostico_sic %}
                                <button type="button" 
                                        class="btn btn-sm btn-outline-info"
                                        id="btnDetectarPiezas"
                                        data-diagnostico="{{ orden.detalle_equipo.diagnostico_sic }}"
                                        title="Analizar el diagn√≥stico para detectar n√∫meros de parte autom√°ticamente">
                                    <i class="bi bi-cpu"></i> Detectar Piezas
                                </button>
                                {% endif %}
                                <!-- Bot√≥n para agregar componentes adicionales -->
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-success dropdown-toggle" 
                                            type="button" 
                                            id="btnAgregarComponente" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false"
                                            data-componentes='{{ componentes_adicionales_json }}'>
                                        <i class="bi bi-plus-circle"></i> Agregar Componente
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" 
                                        aria-labelledby="btnAgregarComponente" 
                                        id="dropdownComponentesAdicionales"
                                        style="max-height: 300px; overflow-y: auto;">
                                        <!-- Los componentes se cargar√°n din√°micamente via JavaScript -->
                                        <li><span class="dropdown-item text-muted small"><i class="bi bi-hourglass-split"></i> Cargando...</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panel de piezas detectadas (oculto por defecto, se muestra al presionar "Detectar Piezas") -->
                        <div id="panelPiezasDetectadas" style="display: none;" class="mb-3">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10 d-flex align-items-center justify-content-between py-2">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-cpu text-info me-2"></i>
                                        <span class="fw-bold text-info">Piezas detectadas en el diagn√≥stico</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-primary" 
                                                id="btnAplicarTodasPiezas"
                                                style="display: none;">
                                            <i class="bi bi-check-all"></i> Aplicar todas
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-secondary" 
                                                id="btnCerrarPanelPiezas"
                                                title="Cerrar panel">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0" id="contenedorPiezasDetectadas">
                                    <!-- El contenido se genera din√°micamente via JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover mb-0" id="tablaComponentesDiagnostico">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 40px;" class="text-center">‚úì</th>
                                        <th>Componente</th>
                                        <th style="width: 280px;">DPN / N√∫mero de parte</th>
                                        <th style="width: 110px;" class="text-center">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for comp in componentes_diagnostico_orden %}
                                    <tr>
                                        <td class="text-center align-middle">
                                            <input class="form-check-input checkbox-componente" 
                                                   type="checkbox" 
                                                   data-componente-db="{{ comp.componente_db }}"
                                                   id="comp_{{ forloop.counter }}">
                                        </td>
                                        <td class="align-middle fw-semibold">
                                            <label for="comp_{{ forloop.counter }}" class="mb-0 cursor-pointer d-block">
                                                {{ comp.label_pdf }}
                                            </label>
                                        </td>
                                        <td class="align-middle">
                                            <input type="text" 
                                                   class="form-control form-control-sm input-dpn"
                                                   data-componente-db="{{ comp.componente_db }}"
                                                   placeholder="Ej: DPN: 0XPJWG"
                                                   disabled>
                                        </td>
                                        <td class="align-middle text-center celda-tipo-pieza" data-componente-db="{{ comp.componente_db }}">
                                            <!-- Badge de tipo se inserta via JavaScript al marcar checkbox -->
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <!-- Secci√≥n para componentes adicionales din√°micos -->
                                <tbody id="componentesAdicionales">
                                    <!-- Las filas de componentes adicionales se insertar√°n aqu√≠ via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-lightbulb"></i> 
                            Marca los componentes afectados y opcionalmente ingresa el DPN o n√∫mero de parte.
                            Los componentes marcados se pre-crear√°n como piezas cotizadas.
                        </small>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- SECCI√ìN 5: IM√ÅGENES DE DIAGN√ìSTICO -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-images text-primary fs-5 me-2"></i>
                            <h6 class="mb-0 text-primary fw-bold">
                                Im√°genes de diagn√≥stico (Opcional)
                                <span class="badge bg-primary ms-2" id="contadorImagenesDiagSeleccionadas">0 seleccionadas</span>
                            </h6>
                        </div>
                        
                        {% if imagenes_por_tipo.diagnostico %}
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="seleccionarTodasImagenesDiag">
                                <label class="form-check-label fw-bold" for="seleccionarTodasImagenesDiag">
                                    <i class="bi bi-check-all"></i> Seleccionar todas las im√°genes
                                </label>
                            </div>
                        </div>
                        
                        <div class="row g-3" id="galeriaImagenesDiagnosticoModal">
                            {% for imagen in imagenes_por_tipo.diagnostico %}
                            <div class="col-lg-3 col-md-4 col-sm-6">
                                <label class="card h-100 hover-shadow cursor-pointer imagen-selectable" for="diag_img_{{ imagen.id }}">
                                    <div class="position-relative">
                                        <img src="{{ imagen.imagen.url }}" 
                                             class="card-img-top" 
                                             alt="Imagen {{ forloop.counter }}"
                                             style="height: 200px; object-fit: cover;">
                                        <div class="position-absolute top-0 start-0 m-2">
                                            <input class="form-check-input checkbox-imagen-diag" 
                                                   type="checkbox" 
                                                   name="imagenes_seleccionadas" 
                                                   value="{{ imagen.id }}" 
                                                   id="diag_img_{{ imagen.id }}"
                                                   style="width: 1.5rem; height: 1.5rem;">
                                        </div>
                                        <div class="position-absolute bottom-0 end-0 m-2">
                                            <span class="badge bg-dark bg-opacity-75">
                                                <i class="bi bi-calendar3"></i> {{ imagen.fecha_subida|date:"d/m/Y" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body p-2">
                                        <small class="text-muted d-block text-truncate">
                                            {% if imagen.descripcion %}{{ imagen.descripcion }}{% else %}Imagen de diagn√≥stico{% endif %}
                                        </small>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            <small>
                                <strong>Nota:</strong> Las im√°genes se enviar√°n comprimidas autom√°ticamente. Son opcionales.
                            </small>
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-camera"></i>
                            <strong>Sin im√°genes de diagn√≥stico.</strong> No hay im√°genes tipo "Diagn√≥stico" para esta orden.
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- SECCI√ìN 6: MENSAJE PERSONALIZADO -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-chat-left-text text-success fs-5 me-2"></i>
                            <h6 class="mb-0 text-success fw-bold">Mensaje personalizado (Opcional)</h6>
                        </div>
                        
                        <div class="form-floating">
                            <textarea class="form-control" 
                                      placeholder="Mensaje adicional" 
                                      id="diagMensajePersonalizado"
                                      name="mensaje_personalizado"
                                      style="height: 100px;"></textarea>
                            <label for="diagMensajePersonalizado">
                                <i class="bi bi-pencil"></i> Mensaje adicional para el cliente
                            </label>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- SECCI√ìN 7: VISTA PREVIA DEL PDF -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-eye-fill text-info fs-5 me-2"></i>
                            <h6 class="mb-0 text-info fw-bold">Vista previa del PDF</h6>
                        </div>
                        
                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" class="btn btn-outline-info btn-sm" id="btnRefrescarPreviewDiag">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar Vista Previa
                            </button>
                        </div>
                        
                        <div class="border rounded overflow-hidden shadow-sm" style="height: 500px;">
                            <iframe id="iframePreviewDiagnostico" 
                                    src="about:blank" 
                                    style="width: 100%; height: 100%; border: none;"
                                    title="Vista previa del PDF de diagn√≥stico"></iframe>
                        </div>
                        
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> 
                            Haz clic en "Actualizar Vista Previa" para ver c√≥mo se ver√° el PDF con los datos actuales.
                        </small>
                    </div>
                    
                    <!-- Campo oculto para componentes (se llena via JS) -->
                    <input type="hidden" name="componentes" id="inputComponentesJSON" value="[]">
                    
                </form>
            </div>
            
            <!-- Footer del Modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" 
                        class="btn btn-success btn-lg"
                        id="btnEnviarDiagnostico"
                        {% if not orden.detalle_equipo.email_cliente or orden.detalle_equipo.email_cliente == 'cliente@ejemplo.com' %}
                            disabled
                        {% endif %}
                        title="Enviar diagn√≥stico al cliente por correo electr√≥nico">
                    <i class="bi bi-send-fill"></i> Enviar Diagn√≥stico
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODAL: ENVIAR IM√ÅGENES AL CLIENTE -->
<!-- ============================================================================ -->
<div class="modal fade" id="modalEnviarImagenesCliente" tabindex="-1" aria-labelledby="modalEnviarImagenesClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <!-- Encabezado del Modal -->
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="modal-title" id="modalEnviarImagenesClienteLabel">
                    <i class="bi bi-envelope-paper"></i> üì∏ Enviar im√°genes del equipo al cliente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Cuerpo del Modal -->
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="formEnviarImagenesCliente" method="post" action="{% url 'servicio_tecnico:enviar_imagenes_cliente' orden.id %}">
                    {% csrf_token %}
                    
                    <!-- SECCI√ìN 1: DESTINATARIO PRINCIPAL (CLIENTE) -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-person-fill text-primary fs-5 me-2"></i>
                            <h6 class="mb-0 text-primary fw-bold">Para: (Destinatario principal)</h6>
                        </div>
                        
                        {% if not orden.detalle_equipo.email_cliente|es_email_valido %}
                        <!-- ADVERTENCIA: Email no configurado o inv√°lido -->
                        <div class="alert alert-warning border-warning border-2">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-exclamation-triangle-fill fs-3 me-3 flex-shrink-0"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2">
                                        <strong>‚ö†Ô∏è Email del cliente no configurado</strong>
                                    </h6>
                                    <p class="mb-2">
                                        {% if orden.detalle_equipo.email_cliente == 'cliente@ejemplo.com' %}
                                            El email del cliente est√° configurado con el <strong>valor por defecto</strong>. 
                                        {% else %}
                                            El email del cliente <strong>no est√° configurado correctamente</strong>.
                                        {% endif %}
                                        <strong>Debes actualizarlo antes de poder enviar las im√°genes.</strong>
                                    </p>
                                    <div class="alert alert-light border-start border-4 border-info mb-2">
                                        <small>
                                            <i class="bi bi-info-circle-fill text-info"></i>
                                            <strong>Email actual:</strong> 
                                            <code class="bg-white px-2 py-1 rounded">{{ orden.detalle_equipo.email_cliente }}</code>
                                        </small>
                                    </div>
                                    <hr class="my-2">
                                    <button type="button" 
                                            class="btn btn-warning btn-sm"
                                            data-bs-dismiss="modal"
                                            onclick="document.querySelector('[data-bs-target=\'#modalEditarInfoEquipo\']').click()">
                                        <i class="bi bi-pencil-square"></i> Editar Email del Cliente Ahora
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="bi bi-info-circle"></i> 
                                        Cierra este modal y haz clic en el bot√≥n "Editar Informaci√≥n" en la secci√≥n de informaci√≥n del equipo.
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Cliente con email v√°lido -->
                        <div class="destinatario-card p-3 border rounded shadow-sm" style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border: 2px solid #4caf50 !important;">
                            <div class="d-flex align-items-center">
                                <input 
                                    class="form-check-input me-3 flex-shrink-0" 
                                    type="checkbox" 
                                    name="enviar_a_cliente" 
                                    id="enviar_a_cliente"
                                    value="1"
                                    checked
                                    disabled>
                                <i class="bi bi-person-check-fill text-success fs-2 me-3 flex-shrink-0"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-success">
                                        <i class="bi bi-laptop"></i> Cliente del Equipo
                                        <span class="badge bg-success ms-2">
                                            <i class="bi bi-check-circle-fill"></i> V√ÅLIDO
                                        </span>
                                    </div>
                                    <small class="text-dark d-block mt-1">
                                        <i class="bi bi-envelope-fill"></i> <strong>{{ orden.detalle_equipo.email_cliente }}</strong>
                                    </small>
                                    <small class="text-success d-block mt-1">
                                        <i class="bi bi-check-circle-fill"></i> Destinatario principal (siempre incluido)
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 2: CON COPIA A (EMPLEADOS + T√âCNICO ASIGNADO) -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-file-earmark-text-fill text-info fs-5 me-2"></i>
                            <h6 class="mb-0 text-info fw-bold">Con copia a: (Opcional)</h6>
                        </div>
                        
                        <div class="row g-3">
                            <!-- T√âCNICO ASIGNADO -->
                            <div class="col-12">
                                <h6 class="mb-2">
                                    <i class="bi bi-tools text-success"></i> T√©cnico Asignado
                                </h6>
                                
                                {% if orden.tecnico_asignado_actual and orden.tecnico_asignado_actual.email %}
                                <label class="destinatario-card p-3 border rounded bg-light hover-shadow d-block mb-0 cursor-pointer" for="tecnico_asignado">
                                    <div class="d-flex align-items-center">
                                        <input 
                                            class="form-check-input me-3 flex-shrink-0" 
                                            type="checkbox" 
                                            name="copia_tecnico" 
                                            value="{{ orden.tecnico_asignado_actual.email }}" 
                                            id="tecnico_asignado">
                                        
                                        {% if orden.tecnico_asignado_actual.foto_perfil %}
                                            <img src="{{ orden.tecnico_asignado_actual.foto_perfil.url }}" 
                                                 alt="{{ orden.tecnico_asignado_actual.nombre_completo }}" 
                                                 class="rounded-circle me-2 flex-shrink-0"
                                                 style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #28a745;">
                                        {% else %}
                                            <i class="bi bi-person-badge-fill text-success fs-3 me-2 flex-shrink-0"></i>
                                        {% endif %}
                                        
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <div class="fw-bold text-truncate">
                                                <i class="bi bi-wrench"></i> {{ orden.tecnico_asignado_actual.nombre_completo }}
                                            </div>
                                            <small class="text-muted d-block">
                                                <span class="badge bg-success me-1">T√âCNICO ASIGNADO</span>
                                                <span class="text-truncate d-inline-block" style="max-width: 200px; vertical-align: middle;">
                                                    {{ orden.tecnico_asignado_actual.email }}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </label>
                                {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i>
                                    {% if not orden.tecnico_asignado_actual %}
                                        <strong>Sin t√©cnico asignado:</strong> Esta orden a√∫n no tiene t√©cnico asignado.
                                    {% else %}
                                        <strong>Sin email configurado:</strong> El t√©cnico asignado no tiene email configurado en su perfil.
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                <hr class="my-2">
                            </div>
                            
                            <!-- EMPLEADOS INTERNOS -->
                            <div class="col-12">
                                <h6 class="mb-2">
                                    <i class="bi bi-people-fill text-info"></i> Empleados Internos
                                </h6>
                                
                                {% if empleados_copia_imagenes %}
                                <div class="row g-2">
                                    {% for empleado in empleados_copia_imagenes %}
                                    <div class="col-lg-6 col-md-12">
                                        <label class="destinatario-card p-3 border rounded bg-light hover-shadow d-block mb-0 cursor-pointer" for="emp_img_{{ empleado.id }}">
                                            <div class="d-flex align-items-center">
                                                <input 
                                                    class="form-check-input me-3 flex-shrink-0" 
                                                    type="checkbox" 
                                                    name="copia_empleados" 
                                                    value="{{ empleado.email }}" 
                                                    id="emp_img_{{ empleado.id }}">
                                                
                                                {% if empleado.foto_perfil %}
                                                    <img src="{{ empleado.foto_perfil.url }}" 
                                                         alt="{{ empleado.nombre_completo }}" 
                                                         class="rounded-circle me-2 flex-shrink-0"
                                                         style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #17a2b8;">
                                                {% else %}
                                                    <i class="bi bi-person-badge text-info fs-3 me-2 flex-shrink-0"></i>
                                                {% endif %}
                                                
                                                <div class="flex-grow-1" style="min-width: 0;">
                                                    <div class="fw-bold text-truncate">{{ empleado.nombre_completo }}</div>
                                                    <small class="text-muted d-block">
                                                        <span class="badge bg-secondary me-1">{{ empleado.area }}</span>
                                                        <span class="text-truncate d-inline-block" style="max-width: 180px; vertical-align: middle;">
                                                            {{ empleado.email }}
                                                        </span>
                                                    </small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Sin empleados disponibles:</strong> No hay empleados de las √°reas CALIDAD o FRONTDESK con email configurado.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 3: SELECCIONAR IM√ÅGENES -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-images text-primary fs-5 me-2"></i>
                            <h6 class="mb-0 text-primary fw-bold">
                                Im√°genes a enviar 
                                <span class="badge bg-primary ms-2" id="contadorImagenesSeleccionadas">0 seleccionadas</span>
                            </h6>
                        </div>
                        
                        {% if imagenes_por_tipo.ingreso %}
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="seleccionarTodasImagenes">
                                <label class="form-check-label fw-bold" for="seleccionarTodasImagenes">
                                    <i class="bi bi-check-all"></i> Seleccionar todas las im√°genes
                                </label>
                            </div>
                        </div>
                        
                        <div class="row g-3" id="galeriaImagenesModal">
                            {% for imagen in imagenes_por_tipo.ingreso %}
                            <div class="col-lg-3 col-md-4 col-sm-6">
                                <label class="card h-100 hover-shadow cursor-pointer imagen-selectable" for="img_{{ imagen.id }}">
                                    <div class="position-relative">
                                        <img src="{{ imagen.imagen.url }}" 
                                             class="card-img-top" 
                                             alt="Imagen {{ forloop.counter }}"
                                             style="height: 200px; object-fit: cover;">
                                        <div class="position-absolute top-0 start-0 m-2">
                                            <input 
                                                class="form-check-input checkbox-imagen" 
                                                type="checkbox" 
                                                name="imagenes_seleccionadas" 
                                                value="{{ imagen.id }}" 
                                                id="img_{{ imagen.id }}"
                                                style="width: 1.5rem; height: 1.5rem;">
                                        </div>
                                        <div class="position-absolute bottom-0 end-0 m-2">
                                            <span class="badge bg-dark bg-opacity-75">
                                                <i class="bi bi-calendar3"></i> {{ imagen.fecha_subida|date:"d/m/Y" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body p-2">
                                        <small class="text-muted d-block text-truncate">
                                            {% if imagen.descripcion %}
                                                {{ imagen.descripcion }}
                                            {% else %}
                                                Imagen de ingreso
                                            {% endif %}
                                        </small>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            <small>
                                <strong>Nota:</strong> Las im√°genes se enviar√°n comprimidas autom√°ticamente para optimizar el tama√±o del correo. 
                                Selecciona solo las im√°genes relevantes para el cliente.
                            </small>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Sin im√°genes disponibles:</strong> No hay im√°genes de tipo "Ingreso" para enviar.
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 4: MENSAJE PERSONALIZADO -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-chat-left-text text-success fs-5 me-2"></i>
                            <h6 class="mb-0 text-success fw-bold">Mensaje personalizado (Opcional)</h6>
                        </div>
                        
                        <div class="form-floating">
                            <textarea 
                                class="form-control" 
                                placeholder="Mensaje adicional para el cliente" 
                                id="mensaje_personalizado"
                                name="mensaje_personalizado"
                                style="height: 120px;"></textarea>
                            <label for="mensaje_personalizado">
                                <i class="bi bi-pencil"></i> Mensaje adicional para el cliente
                            </label>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-lightbulb"></i> 
                            <strong>Sugerencia:</strong> Puedes agregar informaci√≥n adicional como el estado del equipo, 
                            pr√≥ximos pasos, o cualquier detalle relevante para el cliente.
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- SECCI√ìN 5: PREVISUALIZACI√ìN -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <i class="bi bi-eye-fill text-info fs-5 me-2"></i>
                            <h6 class="mb-0 text-info fw-bold">Vista previa del correo</h6>
                        </div>
                        
                        <div class="alert alert-light border-info border-2 mb-3">
                            <i class="bi bi-info-circle"></i>
                            <small><strong>Informaci√≥n:</strong> As√≠ se ver√° el correo que recibir√° el cliente.</small>
                        </div>
                        
                        <div class="border rounded overflow-hidden shadow-sm">
                            <!-- Encabezado del correo -->
                            <div class="bg-light border-bottom p-3">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <small class="text-muted"><strong>De:</strong></small>
                                        <div>
                                            <i class="bi bi-building text-primary me-1"></i>
                                            {{ request.user.empleado.nombre_completo|default:"Sistema SIC" }}
                                            <small class="text-muted">&lt;{{ request.user.email }}&gt;</small>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <small class="text-muted"><strong>Para:</strong></small>
                                        <div>
                                            <span class="badge bg-primary">
                                                <i class="bi bi-person"></i> Cliente - {{ orden.detalle_equipo.email_cliente }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <small class="text-muted"><strong>Asunto:</strong></small>
                                        <div class="p-2 bg-white border rounded">
                                            <strong>üì∏ Fotograf√≠as de ingreso - Orden {{ detalle.orden_cliente }}</strong>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <small class="text-muted"><strong>Archivos adjuntos:</strong></small>
                                        <div>
                                            <span class="badge bg-info" id="previsualizacionArchivos">
                                                <i class="bi bi-images"></i> 0 imagen(es)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cuerpo del correo -->
                            <div class="p-4 bg-white">
                                <p>Estimado/a cliente,</p>
                                <p>
                                    Le informamos que su equipo <strong>{{ orden.detalle_equipo.tipo_equipo }} {{ orden.detalle_equipo.marca }}</strong> 
                                    (S/N: <strong>{{ orden.detalle_equipo.numero_serie }}</strong>) ha sido recibido en nuestras instalaciones.
                                </p>
                                <p>
                                    Adjuntamos las fotograf√≠as del estado en el que ingres√≥ su equipo para su conocimiento y registro.
                                </p>
                                <p><strong>N√∫mero de orden:</strong> 
                                    {% if orden.detalle_equipo.orden_cliente %}
                                        {{ orden.detalle_equipo.orden_cliente }}
                                    {% else %}
                                        {{ orden.numero_orden_interno }}
                                    {% endif %}
                                </p>
                                <p><strong>Fecha de ingreso:</strong> {{ orden.fecha_ingreso|date:"d/m/Y H:i" }}</p>
                                
                                <hr>
                                
                                <div id="previsualizacionMensajePersonalizado" style="display: none;">
                                    <p><strong>Mensaje adicional:</strong></p>
                                    <div class="bg-light p-3 rounded border-start border-primary border-4">
                                        <em id="textoMensajePersonalizado"></em>
                                    </div>
                                    <hr>
                                </div>
                                
                                <p>
                                    Si tiene alguna pregunta o necesita informaci√≥n adicional, no dude en contactarnos.
                                </p>
                                <p>Atentamente,</p>
                                
                                <!-- Firma -->
                                <div class="mt-3 pt-3 border-top">
                                    <strong>{{ request.user.empleado.nombre_completo|default:"Sistema Integral SIC" }}</strong><br>
                                    {% if request.user.empleado %}
                                        {{ request.user.empleado.cargo }}<br>
                                        {{ request.user.empleado.area }}<br>
                                    {% endif %}
                                    <a href="mailto:{{ request.user.email }}">{{ request.user.email }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </form>
            </div>
            
            <!-- Footer del Modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" 
                        form="formEnviarImagenesCliente" 
                        class="btn btn-primary btn-lg"
                        id="btnEnviarImagenes"
                        {% if not orden.detalle_equipo.email_cliente|es_email_valido %}
                            disabled 
                            data-email-invalido="true"
                            title="‚ö†Ô∏è Debes configurar un email v√°lido antes de enviar"
                        {% else %}
                            title="Enviar im√°genes al cliente por correo electr√≥nico"
                        {% endif %}>
                    <i class="bi bi-send-fill"></i> 
                    {% if not orden.detalle_equipo.email_cliente|es_email_valido %}
                        <span class="text-decoration-line-through">Enviar Correo</span>
                        <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                    {% else %}
                        Enviar Correo
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- MODAL: VISOR DE C√ÅMARA INTEGRADO -->
<!-- ============================================================ -->
<div class="modal fade" id="modalCamaraIntegrada" tabindex="-1" aria-labelledby="modalCamaraIntegradaLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header text-white">
                <h5 class="modal-title" id="modalCamaraIntegradaLabel">
                    <i class="bi bi-camera-fill"></i> Capturar Im√°genes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar" id="btnCerrarCamara"></button>
            </div>
            <div class="modal-body p-0 position-relative">
                <!-- Visor de video de la c√°mara -->
                <div class="camera-viewer-container">
                    <video id="videoPreview" autoplay playsinline class="camera-video"></video>
                    
                    <!-- Canvas oculto para capturar frames -->
                    <canvas id="canvasCaptura" class="d-none"></canvas>
                    
                    <!-- Overlay con informaci√≥n -->
                    <div class="camera-overlay">
                        <div class="camera-info">
                            <!-- Badge circular: C√°mara activa (F/T) estilo WhatsApp -->
                            <div class="camera-badge-circle" id="badgeCamaraActiva">
                                <i class="bi bi-camera-fill"></i>
                                <span id="infoCamaras">T</span>
                            </div>
                            
                            <!-- Badge circular: Contador de fotos estilo WhatsApp -->
                            <div class="camera-badge-circle" id="badgeFotosTomadas">
                                <i class="bi bi-check-lg"></i>
                                <span id="contadorFotos">0</span>
                            </div>
                            
                            <!-- Badge circular: Orientaci√≥n detectada (DEBUG) -->
                            <div class="camera-badge-circle" id="badgeOrientacion" title="Orientaci√≥n del dispositivo">
                                <i class="bi bi-phone"></i>
                                <span id="infoOrientacion">0¬∞</span>
                            </div>
                            
                            <!-- Badge circular: Toggle manual de orientaci√≥n (NUEVO) -->
                            <div class="camera-badge-circle camera-badge-clickable" id="badgeToggleOrientacion" title="Cambiar orientaci√≥n manualmente">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span id="infoModoOrientacion">ü§ñ</span>
                            </div>
                        </div>
                        
                        <!-- Selector de lentes (m√∫ltiples c√°maras traseras) -->
                        <div class="camera-lens-selector" id="selectorLentes" style="display: none;">
                            <!-- Los botones se generan din√°micamente desde TypeScript -->
                        </div>
                    </div>
                    
                    <!-- Mensaje de error (oculto por defecto) -->
                    <div class="camera-error" id="cameraError" style="display: none;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <p id="mensajeError">No se pudo acceder a la c√°mara</p>
                        <small id="detalleError">Verifica los permisos del navegador</small>
                    </div>
                </div>
                
                <!-- Controles de la c√°mara -->
                <div class="camera-controls">
                    <button type="button" class="btn btn-lg btn-outline-light" id="btnCambiarCamara" title="Cambiar c√°mara">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                    
                    <button type="button" class="btn btn-capture" id="btnCapturar" title="Capturar foto">
                        <i class="bi bi-circle"></i>
                    </button>
                    
                    <button type="button" class="btn btn-lg btn-success" data-bs-dismiss="modal" id="btnFinalizarCaptura" title="Finalizar captura">
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n flotante para ir a galer√≠a de im√°genes -->
<button id="btnIrGaleria" class="btn-ir-galeria" aria-label="Ir a Galer√≠a de Im√°genes" title="Ver galer√≠a de im√°genes">
    <i class="bi bi-camera"></i>
</button>

<!-- ============================================================ -->
<!-- MODAL: CONFIRMACI√ìN DE SALIDA DE C√ÅMARA CON FOTOS PENDIENTES -->
<!-- ============================================================ -->
<div class="modal fade" id="modalConfirmacionSalidaCamara" tabindex="-1" aria-labelledby="modalConfirmacionSalidaCamaraLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalConfirmacionSalidaCamaraLabel">
                    <i class="bi bi-exclamation-triangle-fill"></i> ¬øSalir sin guardar?
                </h5>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    <strong>Tienes <span id="cantidadFotosPendientes">0</span> foto(s) capturada(s) sin finalizar.</strong>
                </p>
                <p class="text-muted mt-2 mb-0">
                    Si sales ahora, las fotos capturadas se descartar√°n y tendr√°s que volver a tomarlas.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left"></i> Volver a la c√°mara
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarSalida">
                    <i class="bi bi-trash"></i> Salir y descartar fotos
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Lightbox personalizado para galer√≠a -->
<script src="{% static 'js/lightbox_galeria.js' %}?v=1.0"></script>

<!-- Sistema dual de subida de im√°genes (galer√≠a + c√°mara) -->
<!-- v6.0: Subida por lotes con reintentos autom√°ticos (anti-Cloudflare disconnect) -->
<script src="{% static 'js/upload_imagenes_dual.js' %}?v=6.0"></script>

<!-- C√°mara integrada - v5.4: Modo manual + 270¬∞ por defecto -->
<script src="{% static 'js/camara_integrada.js' %}?v=6.0"></script>

<!-- Modal de env√≠o de diagn√≥stico al cliente -->
<script src="{% static 'js/diagnostico_modal.js' %}?v=3.4"></script>

<script>
// ============================================================================
// ESTAD√çSTICAS DE T√âCNICOS (Datos del servidor)
// ============================================================================
// Convertir las estad√≠sticas de t√©cnicos de Django a JavaScript
const estadisticasTecnicos = {{ estadisticas_tecnicos|safe }};

// ============================================================================
// ALERTA DIN√ÅMICA DE CARGA DE TRABAJO DEL T√âCNICO
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    // ============================================================================
    // INICIALIZAR TOOLTIPS DE BOOTSTRAP
    // ============================================================================
    // Los tooltips necesitan inicializarse manualmente para funcionar
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // ============================================================================
    // ALERTA DE CARGA DE TRABAJO DEL T√âCNICO
    // ============================================================================
    const selectTecnico = document.getElementById('id_tecnico_select');
    const divAlerta = document.getElementById('alertaTecnico');
    
    if (selectTecnico && divAlerta) {
        // Funci√≥n para mostrar la alerta seg√∫n el t√©cnico seleccionado
        function mostrarAlertaTecnico() {
            const tecnicoId = selectTecnico.value;
            
            if (!tecnicoId || !estadisticasTecnicos[tecnicoId]) {
                divAlerta.style.display = 'none';
                return;
            }
            
            const stats = estadisticasTecnicos[tecnicoId];
            const ordenesActivas = stats.ordenes_activas;
            const equiposNoEncienden = stats.equipos_no_encienden;
            const tieneSobrecarga = stats.tiene_sobrecarga;
            const porcentaje = stats.porcentaje_no_encienden;
            
            // Si no tiene √≥rdenes activas, no mostrar nada
            if (ordenesActivas === 0) {
                divAlerta.style.display = 'none';
                return;
            }
            
            // Determinar el tipo de alerta y mensaje
            let tipoAlerta = 'info';
            let icono = 'info-circle';
            let mensaje = '';
            
            if (tieneSobrecarga) {
                // ALERTA ROJA: 3 o m√°s equipos que no encienden
                tipoAlerta = 'danger';
                icono = 'exclamation-triangle-fill';
                mensaje = `
                    <strong>‚ö†Ô∏è ALTA CARGA DE TRABAJO</strong><br>
                    Este t√©cnico tiene <strong>${equiposNoEncienden}</strong> equipos que NO encienden 
                    de un total de <strong>${ordenesActivas}</strong> √≥rdenes activas (${porcentaje}%).<br>
                    <small>Considera asignar a otro t√©cnico con menos carga.</small>
                `;
            } else if (equiposNoEncienden > 0) {
                // ALERTA AMARILLA: Tiene equipos que no encienden pero no sobrecarga
                tipoAlerta = 'warning';
                icono = 'exclamation-circle-fill';
                mensaje = `
                    <strong>‚ö° Equipos complejos asignados</strong><br>
                    Este t√©cnico tiene <strong>${equiposNoEncienden}</strong> equipos que NO encienden 
                    de <strong>${ordenesActivas}</strong> √≥rdenes activas (${porcentaje}%).<br>
                    <small>A√∫n tiene capacidad, pero monitorea su carga de trabajo.</small>
                `;
            } else {
                // ALERTA AZUL: Tiene √≥rdenes pero todas encienden
                tipoAlerta = 'info';
                icono = 'info-circle-fill';
                mensaje = `
                    <strong>‚úì Carga normal</strong><br>
                    Este t√©cnico tiene <strong>${ordenesActivas}</strong> √≥rdenes activas, 
                    todos los equipos encienden.<br>
                    <small>Buena disponibilidad para nuevas asignaciones.</small>
                `;
            }
            
            // Mostrar la alerta
            divAlerta.className = `alert alert-${tipoAlerta} d-flex align-items-start`;
            divAlerta.innerHTML = `
                <i class="bi bi-${icono} me-2 mt-1"></i>
                <div style="font-size: 0.9rem;">${mensaje}</div>
            `;
            divAlerta.style.display = 'flex';
        }
        
        // Mostrar alerta al cargar la p√°gina (t√©cnico actual)
        mostrarAlertaTecnico();
        
        // Actualizar alerta al cambiar el t√©cnico
        selectTecnico.addEventListener('change', mostrarAlertaTecnico);
    }
});

// ============================================================================
// CONFIRMACIONES ANTES DE ENVIAR FORMULARIOS
// ============================================================================
document.getElementById('formCambioEstado').addEventListener('submit', function(e) {
    if (!confirm('¬øEst√°s seguro de cambiar el estado de la orden?')) {
        e.preventDefault();
    }
});

// ============================================================================
// CONTROL DEL CAMPO CARGADOR EN EL MODAL
// ============================================================================
function toggleCargadorFieldsModal() {
    const checkboxCargador = document.getElementById('id_tiene_cargador_modal');
    const divNumeroSerie = document.getElementById('divNumeroSerieCargadorModal');
    
    if (checkboxCargador && divNumeroSerie) {
        if (checkboxCargador.checked) {
            divNumeroSerie.style.display = 'block';
        } else {
            divNumeroSerie.style.display = 'none';
            // Limpiar el campo si se desmarca
            const inputNumeroSerie = document.getElementById('id_numero_serie_cargador_modal');
            if (inputNumeroSerie) {
                inputNumeroSerie.value = '';
            }
        }
    }
}

// Inicializar estado al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    toggleCargadorFieldsModal();
});

// Inicializar estado al abrir el modal
const modalEditarInfo = document.getElementById('modalEditarInfoEquipo');
if (modalEditarInfo) {
    modalEditarInfo.addEventListener('shown.bs.modal', function() {
        toggleCargadorFieldsModal();
    });
}

// ============================================================================
// GESTI√ìN DE COTIZACI√ìN - Mostrar/Ocultar campos de rechazo y descuento
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    const formGestionar = document.getElementById('formGestionarCotizacion');
    
    if (formGestionar) {
        const radiosAccion = document.querySelectorAll('input[name="accion"]');
        const camposRechazo = document.getElementById('camposRechazo');
        const selectMotivo = document.querySelector('select[name="motivo_rechazo"]');
        
        // üÜï NUEVO: Elementos del descuento de mano de obra
        const divDescontoManoObra = document.getElementById('divDescontoManoObra');
        const checkboxDescuento = document.getElementById('id_descontar_mano_obra');
        const filaDescuento = document.getElementById('filaDescuento');
        const filaTotalFinal = document.getElementById('filaTotalFinal');
        const separadorTotal = document.getElementById('separadorTotal');
        
        // Funci√≥n para mostrar/ocultar campos seg√∫n acci√≥n seleccionada
        function toggleCamposRechazo() {
            const accionSeleccionada = document.querySelector('input[name="accion"]:checked');
            
            if (accionSeleccionada && accionSeleccionada.value === 'rechazar') {
                // RECHAZAR: Mostrar campos de rechazo, ocultar descuento
                camposRechazo.style.display = 'block';
                if (selectMotivo) {
                    selectMotivo.required = true;
                }
                
                // Ocultar y desactivar descuento
                if (divDescontoManoObra) {
                    divDescontoManoObra.style.display = 'none';
                    if (checkboxDescuento) {
                        checkboxDescuento.checked = false;
                        checkboxDescuento.disabled = true;
                    }
                }
            } else if (accionSeleccionada && accionSeleccionada.value === 'aceptar') {
                // ACEPTAR: Ocultar campos de rechazo, mostrar descuento
                camposRechazo.style.display = 'none';
                if (selectMotivo) {
                    selectMotivo.required = false;
                }
                
                // Mostrar y habilitar descuento
                if (divDescontoManoObra) {
                    divDescontoManoObra.style.display = 'block';
                    if (checkboxDescuento) {
                        checkboxDescuento.disabled = false;
                    }
                }
            } else {
                // Sin selecci√≥n: ocultar todo
                camposRechazo.style.display = 'none';
                if (divDescontoManoObra) {
                    divDescontoManoObra.style.display = 'none';
                }
            }
        }
        
        // üÜï NUEVO: Funci√≥n para actualizar el resumen de totales
        function actualizarResumenDescuento() {
            if (!checkboxDescuento || !filaDescuento || !filaTotalFinal) return;
            
            if (checkboxDescuento.checked) {
                // Mostrar descuento y total final
                filaDescuento.style.display = 'flex';
                separadorTotal.style.display = 'block';
                filaTotalFinal.style.display = 'flex';
            } else {
                // Ocultar descuento y total final
                filaDescuento.style.display = 'none';
                separadorTotal.style.display = 'none';
                filaTotalFinal.style.display = 'none';
            }
        }
        
        // Escuchar cambios en los radio buttons de acci√≥n
        radiosAccion.forEach(radio => {
            radio.addEventListener('change', toggleCamposRechazo);
        });
        
        // üÜï NUEVO: Escuchar cambios en el checkbox de descuento
        if (checkboxDescuento) {
            checkboxDescuento.addEventListener('change', actualizarResumenDescuento);
        }
        
        // Inicializar al cargar
        toggleCamposRechazo();
        actualizarResumenDescuento();
        
        // Confirmaci√≥n antes de enviar
        formGestionar.addEventListener('submit', function(e) {
            const accionSeleccionada = document.querySelector('input[name="accion"]:checked');
            
            if (!accionSeleccionada) {
                e.preventDefault();
                alert('Por favor selecciona si aceptas o rechazas la cotizaci√≥n.');
                return false;
            }
            
            const accion = accionSeleccionada.value;
            
            // üÜï NUEVO: Mensaje personalizado si aplica descuento
            let mensaje;
            if (accion === 'aceptar') {
                if (checkboxDescuento && checkboxDescuento.checked) {
                    mensaje = '¬øConfirmas que el cliente ACEPT√ì la cotizaci√≥n con DESCUENTO de mano de obra?\n\n' +
                              'üéÅ El diagn√≥stico ser√° GRATUITO como beneficio.\n' +
                              'Esto cambiar√° el estado de la orden.';
                } else {
                    mensaje = '¬øConfirmas que el cliente ACEPT√ì la cotizaci√≥n?\n' +
                              'Esto cambiar√° el estado de la orden.';
                }
            } else {
                mensaje = '¬øConfirmas que el cliente RECHAZ√ì la cotizaci√≥n?\n' +
                          'Esto cambiar√° el estado de la orden.';
            }
            
            if (!confirm(mensaje)) {
                e.preventDefault();
                return false;
            }
        });
    }
});

// ============================================================================
// GESTI√ìN DE PIEZAS COTIZADAS - FUNCIONES AJAX
// ============================================================================

/**
 * Abre el modal para agregar una nueva pieza
 */
async function abrirModalPieza(piezaId = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalPieza'));
    const form = document.getElementById('formPieza');
    const titulo = document.getElementById('modalPiezaTitulo');
    const btnTexto = document.getElementById('btnPiezaTexto');
    const alertErrores = document.getElementById('alertErroresPieza');
    
    // Resetear formulario
    form.reset();
    alertErrores.classList.add('d-none');
    
    if (piezaId) {
        // Modo EDITAR - Cargar datos de la pieza
        titulo.textContent = 'Editar Pieza';
        btnTexto.textContent = 'Actualizar Pieza';
        document.getElementById('piezaId').value = piezaId;
        
        // Cargar datos de la pieza v√≠a AJAX
        try {
            const url = "{% url 'servicio_tecnico:obtener_pieza' 0 %}".replace('/0/', `/${piezaId}/`);
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                const pieza = data.pieza;
                
                // Poblar el formulario con los datos
                document.getElementById('componente').value = pieza.componente_id;
                document.getElementById('descripcion_adicional').value = pieza.descripcion_adicional;
                document.getElementById('proveedor').value = pieza.proveedor || '';  // ‚Üê NUEVO CAMPO (Noviembre 2025)
                document.getElementById('cantidad').value = pieza.cantidad;
                document.getElementById('costo_unitario').value = pieza.costo_unitario;
                document.getElementById('orden_prioridad').value = pieza.orden_prioridad;
                document.getElementById('es_necesaria').checked = pieza.es_necesaria;
                document.getElementById('sugerida_por_tecnico').checked = pieza.sugerida_por_tecnico;
            } else {
                mostrarToast(data.error || 'Error al cargar datos de la pieza', 'danger');
                return;
            }
        } catch (error) {
            console.error('Error al cargar pieza:', error);
            mostrarToast('Error de conexi√≥n al cargar la pieza', 'danger');
            return;
        }
    } else {
        // Modo AGREGAR
        titulo.textContent = 'Agregar Pieza';
        btnTexto.textContent = 'Agregar Pieza';
        document.getElementById('piezaId').value = '';
    }
    
    modal.show();
}

/**
 * Guarda una pieza (agregar o editar)
 */
document.getElementById('formPieza')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const piezaId = document.getElementById('piezaId').value;
    const formData = new FormData(this);
    const alertErrores = document.getElementById('alertErroresPieza');
    const listaErrores = document.getElementById('listaErroresPieza');
    
    // Determinar URL seg√∫n sea agregar o editar
    let url;
    if (piezaId) {
        url = "{% url 'servicio_tecnico:editar_pieza' 0 %}".replace('/0/', `/${piezaId}/`);
    } else {
        url = "{% url 'servicio_tecnico:agregar_pieza' orden.id %}";
    }
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalPieza')).hide();
            
            // Mostrar mensaje de √©xito
            mostrarToast(data.message, 'success');
            
            // Recargar la p√°gina para actualizar la tabla
            setTimeout(() => location.reload(), 1000);
        } else {
            // Mostrar errores del formulario
            listaErrores.innerHTML = '';
            if (data.errors) {
                Object.entries(data.errors).forEach(([field, error]) => {
                    const li = document.createElement('li');
                    li.textContent = `${field}: ${error}`;
                    listaErrores.appendChild(li);
                });
            } else if (data.error) {
                const li = document.createElement('li');
                li.textContent = data.error;
                listaErrores.appendChild(li);
            }
            alertErrores.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n', 'danger');
    }
});

/**
 * Edita una pieza existente
 */
function editarPieza(piezaId) {
    abrirModalPieza(piezaId);
}

/**
 * Elimina una pieza
 */
async function eliminarPieza(piezaId) {
    if (!confirm('¬øEst√°s seguro de eliminar esta pieza?')) {
        return;
    }
    
    const url = "{% url 'servicio_tecnico:eliminar_pieza' 0 %}".replace('/0/', `/${piezaId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message, 'success');
            
            // Eliminar la fila de la tabla
            const fila = document.querySelector(`tr[data-pieza-id="${piezaId}"]`);
            if (fila) {
                fila.remove();
            }
            
            // Recargar para actualizar totales
            setTimeout(() => location.reload(), 1000);
        } else {
            mostrarToast(data.error || 'Error al eliminar', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n', 'danger');
    }
}

// ============================================================================
// GESTI√ìN DE SEGUIMIENTOS - FUNCIONES AJAX
// ============================================================================

/**
 * Abre el modal para agregar/editar seguimiento
 */
function abrirModalSeguimiento(seguimientoId = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalSeguimiento'));
    const form = document.getElementById('formSeguimiento');
    const titulo = document.getElementById('modalSeguimientoTitulo');
    const btnTexto = document.getElementById('btnSeguimientoTexto');
    const alertErrores = document.getElementById('alertErroresSeguimiento');
    
    // Resetear formulario
    form.reset();
    alertErrores.classList.add('d-none');
    
    if (seguimientoId) {
        // Modo EDITAR
        titulo.textContent = 'Editar Seguimiento';
        btnTexto.textContent = 'Actualizar Seguimiento';
        document.getElementById('seguimientoId').value = seguimientoId;
        
        // Cargar datos del seguimiento v√≠a AJAX
        cargarDatosSeguimiento(seguimientoId);
    } else {
        // Modo AGREGAR
        titulo.textContent = 'Agregar Seguimiento';
        btnTexto.textContent = 'Agregar Seguimiento';
        document.getElementById('seguimientoId').value = '';
        
        // Establecer fecha de hoy por defecto
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_pedido').value = hoy;
    }
    
    modal.show();
}

/**
 * Carga los datos de un seguimiento existente en el formulario.
 * 
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * Esta funci√≥n es la que soluciona el problema de edici√≥n.
 * Cuando haces clic en "Editar", esta funci√≥n:
 * 1. Hace una petici√≥n al servidor (fetch) pidiendo los datos del seguimiento
 * 2. El servidor responde con un JSON que contiene toda la informaci√≥n
 * 3. La funci√≥n toma cada campo del JSON y lo coloca en el formulario
 * 
 * Es como copiar datos de una hoja a otra: lee de la base de datos
 * y los pega en los campos del formulario para que puedas editarlos.
 * 
 * @param {number} seguimientoId - ID del seguimiento a cargar
 */
async function cargarDatosSeguimiento(seguimientoId) {
    try {
        // Construir la URL para obtener los datos
        const url = "{% url 'servicio_tecnico:obtener_seguimiento' 0 %}".replace('/0/', `/${seguimientoId}/`);
        
        // Hacer la petici√≥n al servidor
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const seg = data.seguimiento;
            
            // Poblar los campos del formulario con los datos recibidos
            // IMPORTANTE: Django agrega el prefijo 'id_' a los campos del formulario
            document.getElementById('id_proveedor').value = seg.proveedor;
            document.getElementById('descripcion_piezas').value = seg.descripcion_piezas;
            document.getElementById('numero_pedido').value = seg.numero_pedido;
            document.getElementById('fecha_pedido').value = seg.fecha_pedido;
            document.getElementById('fecha_entrega_estimada').value = seg.fecha_entrega_estimada;
            document.getElementById('fecha_entrega_real').value = seg.fecha_entrega_real;
            document.getElementById('estado').value = seg.estado;
            document.getElementById('notas_seguimiento').value = seg.notas_seguimiento;
            
            // Cargar piezas seleccionadas (checkboxes)
            // Primero, desmarcar todas las piezas
            document.querySelectorAll('input[name="piezas"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Luego, marcar solo las piezas que pertenecen a este seguimiento
            seg.piezas.forEach(piezaId => {
                const checkbox = document.querySelector(`input[name="piezas"][value="${piezaId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
        } else {
            mostrarToast(data.error || 'Error al cargar datos del seguimiento', 'danger');
        }
        
    } catch (error) {
        console.error('Error al cargar seguimiento:', error);
        mostrarToast('Error de conexi√≥n al cargar datos', 'danger');
    }
}

/**
 * Guarda un seguimiento (agregar o editar)
 */
document.getElementById('formSeguimiento')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const seguimientoId = document.getElementById('seguimientoId').value;
    const formData = new FormData(this);
    const alertErrores = document.getElementById('alertErroresSeguimiento');
    const listaErrores = document.getElementById('listaErroresSeguimiento');
    
    // Determinar URL
    let url;
    if (seguimientoId) {
        url = "{% url 'servicio_tecnico:editar_seguimiento' 0 %}".replace('/0/', `/${seguimientoId}/`);
    } else {
        url = "{% url 'servicio_tecnico:agregar_seguimiento' orden.id %}";
    }
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('modalSeguimiento')).hide();
            mostrarToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            listaErrores.innerHTML = '';
            if (data.errors) {
                Object.entries(data.errors).forEach(([field, error]) => {
                    const li = document.createElement('li');
                    li.textContent = `${field}: ${error}`;
                    listaErrores.appendChild(li);
                });
            } else if (data.error) {
                const li = document.createElement('li');
                li.textContent = data.error;
                listaErrores.appendChild(li);
            }
            alertErrores.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n', 'danger');
    }
});

/**
 * Edita un seguimiento existente
 */
function editarSeguimiento(seguimientoId) {
    abrirModalSeguimiento(seguimientoId);
}

/**
 * Elimina un seguimiento
 */
async function eliminarSeguimiento(seguimientoId) {
    if (!confirm('¬øEst√°s seguro de eliminar este seguimiento?')) {
        return;
    }
    
    const url = "{% url 'servicio_tecnico:eliminar_seguimiento' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message, 'success');
            
            // Eliminar la card
            const card = document.querySelector(`[data-seguimiento-id="${seguimientoId}"]`).closest('.col-md-6');
            if (card) {
                card.remove();
            }
            
            setTimeout(() => location.reload(), 1000);
        } else {
            mostrarToast(data.error || 'Error al eliminar', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n', 'danger');
    }
}

/**
 * Marca una pieza como recibida
 */
// ============================================================================
// CAMBIO R√ÅPIDO DE ESTADO DE SEGUIMIENTO
// ============================================================================

/**
 * Cambia el estado de un seguimiento de pieza sin necesidad de editar todo el formulario.
 * 
 * EXPLICACI√ìN:
 * Permite cambios r√°pidos de estado: pedido ‚Üí confirmado ‚Üí transito ‚Üí retrasado ‚Üí recibido
 * √ötil para actualizar el progreso del pedido sin entrar al modal de edici√≥n completo.
 * 
 * @param {number} seguimientoId - ID del seguimiento a actualizar
 * @param {string} nuevoEstado - Nuevo estado (confirmado, transito, retrasado)
 */
async function cambiarEstadoSeguimiento(seguimientoId, nuevoEstado) {
    // Mensajes de confirmaci√≥n seg√∫n el estado
    const mensajes = {
        'confirmado': '¬øConfirmar que el proveedor acept√≥ el pedido?',
        'transito': '¬øMarcar el pedido como En Tr√°nsito?',
        'retrasado': '¬øMarcar este pedido como Retrasado?'
    };
    
    const estadosNombres = {
        'confirmado': 'Confirmado',
        'transito': 'En Tr√°nsito',
        'retrasado': 'Retrasado'
    };
    
    if (!confirm(mensajes[nuevoEstado] || '¬øCambiar el estado?')) {
        return;
    }
    
    const url = "{% url 'servicio_tecnico:cambiar_estado_seguimiento' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('nuevo_estado', nuevoEstado);
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(`‚úÖ Estado actualizado a: ${estadosNombres[nuevoEstado]}`, 'success');
            
            // Actualizar el card visualmente (sin recargar toda la p√°gina)
            const card = document.querySelector(`.seguimiento-card[data-seguimiento-id="${seguimientoId}"]`);
            if (card && data.card_html) {
                card.outerHTML = data.card_html;
            } else {
                // Fallback: recargar p√°gina
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            mostrarToast(data.error || 'Error al cambiar estado', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n', 'danger');
    }
}

// ============================================================================
// MARCAR SEGUIMIENTO COMO RECIBIDO
// ============================================================================

/**
 * Marca una pieza como recibida con opci√≥n de enviar o no el correo.
 * 
 * MEJORA (Enero 2026):
 * Ahora pregunta al usuario si desea enviar el correo de notificaci√≥n,
 * ya que hay casos donde el t√©cnico ya est√° informado y no es necesario.
 * 
 * @param {number} seguimientoId - ID del seguimiento de la pieza
 */
async function marcarRecibido(seguimientoId) {
    // Paso 1: Solicitar fecha de entrega real
    const fechaReal = prompt('Fecha de entrega real (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
    
    if (!fechaReal) return; // Usuario cancel√≥
    
    // Paso 2: Preguntar si desea enviar correo de notificaci√≥n
    const enviarEmail = confirm(
        'üìß ¬øDeseas enviar email de notificaci√≥n al t√©cnico?\n\n' +
        'Selecciona:\n' +
        '‚Ä¢ OK = Enviar email (recomendado)\n' +
        '‚Ä¢ CANCELAR = Omitir env√≠o (si el t√©cnico ya est√° informado)'
    );
    
    // Paso 3: Preparar datos para enviar al servidor
    const url = "{% url 'servicio_tecnico:marcar_recibido' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('fecha_entrega_real', fechaReal);
    formData.append('enviar_email', enviarEmail ? 'true' : 'false'); // Nuevo par√°metro
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Procesar respuesta
        if (data.success) {
            // Mostrar mensaje contextual seg√∫n si se envi√≥ email o no
            let mensajeFinal = data.message;
            
            if (data.email_omitido) {
                mensajeFinal += ' (Email omitido por decisi√≥n del usuario)';
            }
            
            mostrarToast(mensajeFinal, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarToast(data.error || 'Error al marcar como recibido', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error de conexi√≥n', 'danger');
    }
}

/**
 * Reenv√≠a la notificaci√≥n de pieza recibida al t√©cnico
 * 
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * Esta funci√≥n permite reintentar el env√≠o del email cuando el env√≠o original fall√≥.
 * Por ejemplo, si hubo un problema con el servidor de correo o el email del t√©cnico
 * estaba mal configurado, se puede corregir y luego usar este bot√≥n para reenviar.
 * 
 * MEJORA (Enero 2026):
 * Ahora pregunta si realmente desea enviar el correo, permitiendo cancelar si no es necesario.
 * 
 * @param {number} seguimientoId - ID del seguimiento de la pieza recibida
 */
async function reenviarNotificacion(seguimientoId) {
    // Confirmaci√≥n mejorada con opci√≥n de omitir env√≠o
    const enviarEmail = confirm(
        'üìß ¬øDeseas reenviar el email de notificaci√≥n al t√©cnico?\n\n' +
        'Selecciona:\n' +
        '‚Ä¢ OK = Reenviar email\n' +
        '‚Ä¢ CANCELAR = No enviar (si ya no es necesario)'
    );
    
    if (!enviarEmail) {
        // Usuario decidi√≥ NO reenviar
        mostrarToast('‚úì Reenv√≠o de email cancelado por el usuario', 'info');
        return;
    }
    
    // Construir URL de reenv√≠o
    const url = "{% url 'servicio_tecnico:reenviar_notificacion' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        // Mostrar indicador de carga
        mostrarToast('üìß Reenviando notificaci√≥n...', 'info');
        
        // Realizar petici√≥n AJAX
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Procesar respuesta
        if (data.success) {
            // Mensaje contextual
            const mensaje = data.email_omitido 
                ? '‚úì Email no enviado (omitido por decisi√≥n del usuario)'
                : '‚úÖ Notificaci√≥n reenviada exitosamente';
            
            mostrarToast(mensaje, data.email_omitido ? 'info' : 'success');
            
            if (!data.email_omitido) {
                setTimeout(() => location.reload(), 2000);
            }
        } else {
            mostrarToast(data.error || 'Error al reenviar', 'danger');
        }
    } catch (error) {
        console.error('Error al reenviar notificaci√≥n:', error);
        mostrarToast('‚ùå Error de conexi√≥n al reenviar', 'danger');
    }
}

/**
 * Marca una pieza como INCORRECTA (WPB - Wrong Part Boxed)
 * 
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * ================================
 * Se usa cuando la pieza recibida NO es la correcta:
 * - El proveedor envi√≥ la pieza equivocada
 * - No es compatible con el equipo
 * - No cumple las especificaciones
 * 
 * IMPORTANTE: Despu√©s de marcar como incorrecta, debes crear
 * un NUEVO seguimiento para pedir la pieza correcta.
 * 
 * @param {number} seguimientoId - ID del seguimiento de la pieza
 */
async function marcarIncorrecto(seguimientoId) {
    // Doble confirmaci√≥n para evitar errores
    const confirmacion = confirm(
        '‚ö†Ô∏è ¬øEst√°s seguro de marcar esta pieza como INCORRECTA?\n\n' +
        'Esto indica que el proveedor envi√≥ la pieza equivocada.\n' +
        'Deber√°s crear un NUEVO pedido para la pieza correcta.\n\n' +
        '¬øContinuar?'
    );
    
    if (!confirmacion) return;
    
    // Construir URL
    const url = "{% url 'servicio_tecnico:marcar_incorrecta' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        // Mostrar indicador de carga
        mostrarToast('üìù Registrando pieza incorrecta...', 'info');
        
        // Realizar petici√≥n AJAX
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Procesar respuesta
        if (data.success) {
            mostrarToast(data.message, 'warning');
            
            // Actualizar el card visualmente
            const card = document.querySelector(`.seguimiento-card[data-seguimiento-id="${seguimientoId}"]`);
            if (card && data.seguimiento_html) {
                card.outerHTML = data.seguimiento_html;
            } else {
                // Fallback: recargar p√°gina
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            mostrarToast(data.error || 'Error al marcar como incorrecta', 'danger');
        }
    } catch (error) {
        console.error('Error al marcar pieza incorrecta:', error);
        mostrarToast('‚ùå Error de conexi√≥n', 'danger');
    }
}

/**
 * Marca una pieza como DA√ëADA o NO FUNCIONAL (DOA - Dead On Arrival)
 * 
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * ================================
 * Se usa cuando la pieza recibida est√° DA√ëADA o NO FUNCIONA:
 * - Lleg√≥ f√≠sicamente da√±ada (rota, golpeada)
 * - No funciona al probarla (defecto de f√°brica)
 * - Tiene problemas t√©cnicos que la hacen inservible
 * 
 * IMPORTANTE: Despu√©s de marcar como da√±ada, debes:
 * 1. Solicitar reemplazo al proveedor (garant√≠a)
 * 2. Crear un NUEVO seguimiento para el reemplazo
 * 
 * @param {number} seguimientoId - ID del seguimiento de la pieza
 */
async function marcarDanado(seguimientoId) {
    // Doble confirmaci√≥n para evitar errores
    const confirmacion = confirm(
        '‚ö†Ô∏è ¬øEst√°s seguro de marcar esta pieza como DA√ëADA/NO FUNCIONAL?\n\n' +
        'Esto indica que la pieza lleg√≥ da√±ada o no funciona.\n' +
        'Deber√°s solicitar reemplazo al proveedor.\n\n' +
        '¬øContinuar?'
    );
    
    if (!confirmacion) return;
    
    // Construir URL
    const url = "{% url 'servicio_tecnico:marcar_danada' 0 %}".replace('/0/', `/${seguimientoId}/`);
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    try {
        // Mostrar indicador de carga
        mostrarToast('üìù Registrando pieza da√±ada...', 'info');
        
        // Realizar petici√≥n AJAX
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Procesar respuesta
        if (data.success) {
            mostrarToast(data.message, 'warning');
            
            // Actualizar el card visualmente
            const card = document.querySelector(`.seguimiento-card[data-seguimiento-id="${seguimientoId}"]`);
            if (card && data.seguimiento_html) {
                card.outerHTML = data.seguimiento_html;
            } else {
                // Fallback: recargar p√°gina
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            mostrarToast(data.error || 'Error al marcar como da√±ada', 'danger');
        }
    } catch (error) {
        console.error('Error al marcar pieza da√±ada:', error);
        mostrarToast('‚ùå Error de conexi√≥n', 'danger');
    }
}

/**
 * Funci√≥n helper para mostrar notificaciones toast
 */
function mostrarToast(mensaje, tipo = 'info') {
    // Crear elemento de alerta temporal
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-ocultar despu√©s de 3 segundos
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// ============================================================================
// GESTI√ìN DE SELECCI√ìN DE PIEZAS EN COTIZACI√ìN
// ============================================================================

/**
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * Esta secci√≥n maneja la selecci√≥n de piezas cuando el cliente acepta/rechaza
 * una cotizaci√≥n. Permite seleccionar individualmente qu√© piezas se aceptan.
 */

document.addEventListener('DOMContentLoaded', function() {
    // Solo ejecutar si existe el formulario de gesti√≥n de cotizaci√≥n
    const formGestionar = document.getElementById('formGestionarCotizacion');
    if (!formGestionar) return;
    
    // Elementos del DOM
    const checkboxSelectAll = document.getElementById('selectAllPiezas');
    const checkboxesPiezas = document.querySelectorAll('.pieza-checkbox');
    const radioAceptar = document.querySelector('input[name="accion"][value="aceptar"]');
    const radioRechazar = document.querySelector('input[name="accion"][value="rechazar"]');
    const camposRechazo = document.getElementById('camposRechazo');
    
    // -------------------------------------------------------------------------
    // 1. FUNCIONALIDAD: Seleccionar/Deseleccionar todas las piezas
    // -------------------------------------------------------------------------
    if (checkboxSelectAll) {
        checkboxSelectAll.addEventListener('change', function() {
            const isChecked = this.checked;
            checkboxesPiezas.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            // Actualizar visualmente las filas
            actualizarEstiloFilas();
        });
    }
    
    // Actualizar checkbox "Seleccionar todas" si se desmarca alguna pieza individual
    checkboxesPiezas.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Si todas est√°n marcadas, marcar "Seleccionar todas"
            const todasMarcadas = Array.from(checkboxesPiezas).every(cb => cb.checked);
            if (checkboxSelectAll) {
                checkboxSelectAll.checked = todasMarcadas;
            }
            
            // Actualizar visualmente las filas
            actualizarEstiloFilas();
        });
    });
    
    // -------------------------------------------------------------------------
    // 2. FUNCIONALIDAD: Mostrar/ocultar campos de rechazo
    // -------------------------------------------------------------------------
    function actualizarCamposRechazo() {
        if (radioRechazar && radioRechazar.checked) {
            // Si rechaza, mostrar campos de rechazo
            if (camposRechazo) {
                camposRechazo.style.display = 'block';
            }
            
            // Deshabilitar checkboxes (no importan si rechaza todo)
            checkboxesPiezas.forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.checked = false; // Desmarcar todas
            });
            if (checkboxSelectAll) {
                checkboxSelectAll.disabled = true;
                checkboxSelectAll.checked = false;
            }
        } else {
            // Si acepta o no ha decidido, ocultar campos de rechazo
            if (camposRechazo) {
                camposRechazo.style.display = 'none';
            }
            
            // Habilitar checkboxes
            checkboxesPiezas.forEach(checkbox => {
                checkbox.disabled = false;
            });
            if (checkboxSelectAll) {
                checkboxSelectAll.disabled = false;
                checkboxSelectAll.checked = true; // Marcar todas por defecto
            }
            
            // Marcar todas las piezas si acepta
            if (radioAceptar && radioAceptar.checked) {
                checkboxesPiezas.forEach(checkbox => {
                    checkbox.checked = true;
                });
            }
        }
        
        actualizarEstiloFilas();
    }
    
    // Escuchar cambios en los radio buttons
    if (radioAceptar) {
        radioAceptar.addEventListener('change', actualizarCamposRechazo);
    }
    if (radioRechazar) {
        radioRechazar.addEventListener('change', actualizarCamposRechazo);
    }
    
    // -------------------------------------------------------------------------
    // 3. FUNCIONALIDAD: Validaci√≥n antes de enviar
    // -------------------------------------------------------------------------
    // 3. FUNCIONALIDAD: Validaci√≥n antes de enviar
    // -------------------------------------------------------------------------
    formGestionar.addEventListener('submit', function(e) {
        const accionSeleccionada = document.querySelector('input[name="accion"]:checked');
        
        if (!accionSeleccionada) {
            e.preventDefault();
            alert('‚ùå Por favor selecciona si el cliente acepta o rechaza la cotizaci√≥n.');
            return;
        }
        
        // Si acepta, procesar piezas seleccionadas (si existen)
        if (accionSeleccionada.value === 'aceptar') {
            const piezasSeleccionadas = Array.from(checkboxesPiezas).filter(cb => cb.checked);
            
            // NUEVO: Ya no se requiere que haya piezas seleccionadas
            // Se permite aceptar cotizaciones con solo mano de obra
            
            // CR√çTICO: Copiar los checkboxes al formulario antes de enviar (solo si hay piezas)
            // Los checkboxes est√°n fuera del form, as√≠ que debemos clonarlos
            if (piezasSeleccionadas.length > 0) {
                piezasSeleccionadas.forEach(checkbox => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'piezas_seleccionadas';
                    hiddenInput.value = checkbox.value;
                    formGestionar.appendChild(hiddenInput);
                });
            }
            
            // Confirmaci√≥n con resumen adaptado
            let mensaje;
            if (piezasSeleccionadas.length > 0) {
                mensaje = `¬øConfirmar aceptaci√≥n de ${piezasSeleccionadas.length} pieza(s)?`;
            } else if (checkboxesPiezas.length > 0) {
                // Hay piezas disponibles pero no seleccion√≥ ninguna
                mensaje = '¬øConfirmar aceptaci√≥n de la cotizaci√≥n SIN piezas (solo mano de obra)?';
            } else {
                // No hay piezas en la cotizaci√≥n
                mensaje = '¬øConfirmar aceptaci√≥n de la cotizaci√≥n (solo mano de obra)?';
            }
            
            if (!confirm(mensaje)) {
                e.preventDefault();
                return;
            }
        }
        
        // Si rechaza, confirmar
        if (accionSeleccionada.value === 'rechazar') {
            if (!confirm('¬øEst√°s seguro de rechazar TODA la cotizaci√≥n?')) {
                e.preventDefault();
                return;
            }
        }
    });
    
    // -------------------------------------------------------------------------
    // 4. HELPER: Actualizar estilos visuales de las filas
    // -------------------------------------------------------------------------
    function actualizarEstiloFilas() {
        checkboxesPiezas.forEach(checkbox => {
            const fila = checkbox.closest('tr');
            if (fila) {
                if (checkbox.checked && !checkbox.disabled) {
                    // Pieza seleccionada: resaltar con fondo verde claro
                    fila.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                    fila.style.borderLeft = '4px solid #28a745';
                } else if (checkbox.disabled) {
                    // Rechazada: fondo gris
                    fila.style.backgroundColor = 'rgba(108, 117, 125, 0.1)';
                    fila.style.borderLeft = '4px solid #6c757d';
                } else {
                    // Desmarcada pero habilitada: fondo rojo claro
                    fila.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                    fila.style.borderLeft = '4px solid #dc3545';
                }
            }
        });
    }
    
    // Inicializar estilos al cargar
    actualizarEstiloFilas();
    actualizarCamposRechazo();
});

// ============================================================================
// FUNCI√ìN: ELIMINAR IMAGEN DE LA GALER√çA
// ============================================================================

/**
 * Confirma y elimina una imagen de la galer√≠a.
 * 
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * Esta funci√≥n maneja todo el proceso de eliminar una imagen:
 * 1. Muestra un cuadro de confirmaci√≥n para evitar borrados accidentales
 * 2. Env√≠a petici√≥n AJAX al servidor para eliminar imagen y archivos
 * 3. Si tiene √©xito, elimina visualmente la tarjeta de la imagen del DOM
 * 4. Muestra feedback al usuario (√©xito o error)
 * 
 * @param {number} imagenId - ID de la imagen a eliminar
 * @param {string} tipoImagen - Tipo de imagen (para mensaje de confirmaci√≥n)
 * @param {Event} event - Evento del click (para prevenir propagaci√≥n)
 */
function confirmarEliminarImagen(imagenId, tipoImagen, event) {
    // Prevenir que se abra el lightbox al hacer click en eliminar
    event.stopPropagation();
    
    // Doble confirmaci√≥n para seguridad
    const confirmacion = confirm(
        `‚ö†Ô∏è ¬øEst√°s seguro de eliminar esta imagen de ${tipoImagen}?\n\n` +
        `Esta acci√≥n NO se puede deshacer.\n` +
        `Se eliminar√°n tanto la imagen comprimida como la original.`
    );
    
    if (!confirmacion) {
        return; // Usuario cancel√≥
    }
    
    // Obtener el contenedor de la imagen para efectos visuales
    const contenedorImagen = document.querySelector(`[data-imagen-id="${imagenId}"]`);
    const columnaPadre = contenedorImagen ? contenedorImagen.closest('.col-md-3') : null;
    
    // Mostrar feedback visual: desactivar bot√≥n y a√±adir spinner
    const btnEliminar = event.currentTarget;
    const iconoOriginal = btnEliminar.innerHTML;
    btnEliminar.disabled = true;
    btnEliminar.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btnEliminar.style.opacity = '0.6';
    
    // Preparar datos para la petici√≥n
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // URL de eliminaci√≥n
    const url = "{% url 'servicio_tecnico:eliminar_imagen' 0 %}".replace('/0/', `/${imagenId}/`);
    
    // Enviar petici√≥n AJAX
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // √âxito: Mostrar mensaje y eliminar del DOM con animaci√≥n
            mostrarToast(data.message || '‚úÖ Imagen eliminada correctamente', 'success');
            
            // Animar salida y eliminar del DOM
            if (columnaPadre) {
                columnaPadre.style.transition = 'all 0.3s ease-out';
                columnaPadre.style.opacity = '0';
                columnaPadre.style.transform = 'scale(0.8)';
                
                setTimeout(() => {
                    columnaPadre.remove();
                    
                    // Verificar si ya no quedan im√°genes en esta categor√≠a
                    verificarCategoriasVacias();
                }, 300);
            }
        } else {
            // Error del servidor
            mostrarToast(data.error || '‚ùå Error al eliminar la imagen', 'danger');
            
            // Restaurar bot√≥n
            btnEliminar.disabled = false;
            btnEliminar.innerHTML = iconoOriginal;
            btnEliminar.style.opacity = '1';
        }
    })
    .catch(error => {
        // Error de red o JavaScript
        console.error('Error al eliminar imagen:', error);
        mostrarToast('‚ùå Error de conexi√≥n. Por favor intenta nuevamente.', 'danger');
        
        // Restaurar bot√≥n
        btnEliminar.disabled = false;
        btnEliminar.innerHTML = iconoOriginal;
        btnEliminar.style.opacity = '1';
    });
}

/**
 * Verifica si alguna categor√≠a qued√≥ sin im√°genes y muestra mensaje apropiado.
 * 
 * EXPLICACI√ìN:
 * Despu√©s de eliminar una imagen, revisamos si la categor√≠a (tab) qued√≥ vac√≠a.
 * Si es as√≠, mostramos un mensaje "No hay im√°genes de [tipo] a√∫n" en lugar
 * de dejar el espacio en blanco.
 */
function verificarCategoriasVacias() {
    const tabs = document.querySelectorAll('.tab-pane');
    
    tabs.forEach(tab => {
        const imagenes = tab.querySelectorAll('.gallery-image-container');
        
        if (imagenes.length === 0) {
            // No quedan im√°genes en esta categor√≠a
            const tipoCategoria = tab.id; // El ID del tab es el tipo de imagen
            const nombreCategoria = tab.querySelector('.text-center')?.textContent || tipoCategoria;
            
            // Mostrar mensaje de categor√≠a vac√≠a
            tab.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-image" style="font-size: 3rem;"></i>
                    <p class="mt-2">No hay im√°genes de ${tipoCategoria} a√∫n.</p>
                </div>
            `;
        }
    });
}

// ============================================================================
// FEEDBACK VISUAL AL GUARDAR FECHAS DE DIAGN√ìSTICO Y REPARACI√ìN
// ============================================================================

/**
 * Agrega animaci√≥n de guardado exitoso a las secciones de fechas.
 * 
 * EXPLICACI√ìN PARA PRINCIPIANTES:
 * - Cuando el formulario de configuraci√≥n se guarda exitosamente
 * - Agregamos una animaci√≥n "pulse" a las secciones de fechas
 * - Esto da feedback visual inmediato al usuario
 * - La animaci√≥n dura 600ms y luego se remueve autom√°ticamente
 */
document.addEventListener('DOMContentLoaded', function() {
    const formConfiguracion = document.getElementById('formConfiguracion');
    
    if (formConfiguracion) {
        formConfiguracion.addEventListener('submit', function(e) {
            // Guardar referencia a las secciones de fechas
            const seccionesFechas = document.querySelectorAll('.fechas-seccion');
            
            // Agregar clase de guardado despu√©s de enviar el formulario
            // Nota: La animaci√≥n solo se ve si la p√°gina no recarga inmediatamente
            seccionesFechas.forEach(seccion => {
                // Esperar un momento para que el formulario se procese
                setTimeout(() => {
                    seccion.classList.add('guardado-exitoso');
                    
                    // Remover la clase despu√©s de la animaci√≥n (600ms)
                    setTimeout(() => {
                        seccion.classList.remove('guardado-exitoso');
                    }, 600);
                }, 100);
            });
        });
    }
    
    // Efecto visual al cambiar fechas
    const inputsFechas = document.querySelectorAll(
        'input[name="fecha_inicio_diagnostico"], ' +
        'input[name="fecha_fin_diagnostico"], ' +
        'input[name="fecha_inicio_reparacion"], ' +
        'input[name="fecha_fin_reparacion"]'
    );
    
    inputsFechas.forEach(input => {
        // Agregar efecto de "cambio pendiente"
        input.addEventListener('change', function() {
            const seccion = this.closest('.fechas-seccion');
            if (seccion) {
                // Agregar borde pulsante para indicar cambio pendiente
                seccion.style.borderLeft = '4px solid #ffc107';
                seccion.style.paddingLeft = '8px';
                seccion.style.transition = 'all 0.3s ease';
                
                // Tooltip o mensaje visual
                const label = this.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    const textoOriginal = label.innerHTML;
                    label.innerHTML = textoOriginal + ' <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">Cambio pendiente</span>';
                    
                    // Limpiar el badge al hacer submit
                    formConfiguracion.addEventListener('submit', function() {
                        label.innerHTML = textoOriginal;
                        seccion.style.borderLeft = '';
                        seccion.style.paddingLeft = '';
                    }, { once: true });
                }
            }
        });
    });
});

</script>

<!-- ============================================================================
     VENTA MOSTRADOR - JavaScript (SIEMPRE cargado - Refactor Oct 2025)
     Panel VM ahora visible en todas las √≥rdenes como complemento opcional
     ============================================================================ -->
<script src="{% static 'js/venta_mostrador.js' %}?v=2.2"></script>

<!-- ============================================================================
     PLANTILLAS AUTOM√ÅTICAS PARA COMENTARIOS DE RECHAZO
     ============================================================================ -->
<script src="{% static 'js/plantillas_rechazo.js' %}"></script>

<!-- ============================================================================
     MODAL ENVIAR IM√ÅGENES AL CLIENTE - JavaScript
     ============================================================================ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // =========================================================================
    // ELEMENTOS DEL DOM
    // =========================================================================
    const checkboxesImagenes = document.querySelectorAll('.checkbox-imagen');
    const contadorImagenes = document.getElementById('contadorImagenesSeleccionadas');
    const previsualizacionArchivos = document.getElementById('previsualizacionArchivos');
    const selectTodas = document.getElementById('seleccionarTodasImagenes');
    const mensajePersonalizado = document.getElementById('mensaje_personalizado');
    const previsualizacionMensaje = document.getElementById('previsualizacionMensajePersonalizado');
    const textoMensajePersonalizado = document.getElementById('textoMensajePersonalizado');
    const btnEnviarImagenes = document.getElementById('btnEnviarImagenes');
    const formEnviarImagenes = document.getElementById('formEnviarImagenesCliente');
    
    // =========================================================================
    // FUNCI√ìN: Actualizar contador de im√°genes seleccionadas
    // =========================================================================
    function actualizarContador() {
        const seleccionadas = document.querySelectorAll('.checkbox-imagen:checked').length;
        
        if (contadorImagenes) {
            contadorImagenes.textContent = seleccionadas + ' seleccionada' + (seleccionadas !== 1 ? 's' : '');
            
            // Cambiar color del badge seg√∫n cantidad
            contadorImagenes.className = 'badge ms-2';
            if (seleccionadas === 0) {
                contadorImagenes.classList.add('bg-secondary');
            } else if (seleccionadas < 3) {
                contadorImagenes.classList.add('bg-warning', 'text-dark');
            } else {
                contadorImagenes.classList.add('bg-primary');
            }
        }
        
        if (previsualizacionArchivos) {
            previsualizacionArchivos.innerHTML = `<i class="bi bi-images"></i> ${seleccionadas} imagen${seleccionadas !== 1 ? 'es' : ''}`;
        }
        
        // =====================================================================
        // CR√çTICO: Validaci√≥n de email antes de habilitar bot√≥n de env√≠o
        // =====================================================================
        // Solo habilitar/deshabilitar el bot√≥n si el email es V√ÅLIDO
        // Si tiene el atributo data-email-invalido, el bot√≥n SIEMPRE est√° disabled
        // (este atributo se establece en el template cuando el email es inv√°lido)
        if (btnEnviarImagenes) {
            const emailInvalido = btnEnviarImagenes.hasAttribute('data-email-invalido');
            
            if (emailInvalido) {
                // Email inv√°lido: bot√≥n SIEMPRE deshabilitado (no importa cu√°ntas im√°genes)
                btnEnviarImagenes.disabled = true;
                btnEnviarImagenes.title = '‚ö†Ô∏è Debes configurar un email v√°lido antes de enviar';
                btnEnviarImagenes.classList.add('btn-outline-secondary');
                btnEnviarImagenes.classList.remove('btn-primary');
            } else {
                // Email v√°lido: habilitar/deshabilitar seg√∫n im√°genes seleccionadas
                btnEnviarImagenes.disabled = seleccionadas === 0;
                btnEnviarImagenes.classList.remove('btn-outline-secondary');
                btnEnviarImagenes.classList.add('btn-primary');
                
                if (seleccionadas === 0) {
                    btnEnviarImagenes.title = 'Debes seleccionar al menos una imagen';
                } else {
                    btnEnviarImagenes.title = 'Enviar ' + seleccionadas + ' imagen' + (seleccionadas !== 1 ? 'es' : '') + ' al cliente';
                }
            }
        }
    }
    
    // =========================================================================
    // EVENTO: Cambio en checkboxes individuales de im√°genes
    // =========================================================================
    checkboxesImagenes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            actualizarContador();
            
            // Agregar efecto visual al card
            const card = this.closest('.card');
            if (card) {
                if (this.checked) {
                    card.classList.add('border-primary', 'border-3', 'shadow');
                } else {
                    card.classList.remove('border-primary', 'border-3', 'shadow');
                }
            }
        });
    });
    
    // =========================================================================
    // EVENTO: Seleccionar/deseleccionar todas las im√°genes
    // =========================================================================
    if (selectTodas) {
        selectTodas.addEventListener('change', function() {
            checkboxesImagenes.forEach(checkbox => {
                checkbox.checked = this.checked;
                
                // Aplicar efecto visual
                const card = checkbox.closest('.card');
                if (card) {
                    if (this.checked) {
                        card.classList.add('border-primary', 'border-3', 'shadow');
                    } else {
                        card.classList.remove('border-primary', 'border-3', 'shadow');
                    }
                }
            });
            
            actualizarContador();
        });
    }
    
    // =========================================================================
    // EVENTO: Actualizar previsualizaci√≥n del mensaje personalizado
    // =========================================================================
    if (mensajePersonalizado) {
        mensajePersonalizado.addEventListener('input', function() {
            const texto = this.value.trim();
            
            if (previsualizacionMensaje && textoMensajePersonalizado) {
                if (texto) {
                    previsualizacionMensaje.style.display = 'block';
                    textoMensajePersonalizado.textContent = texto;
                } else {
                    previsualizacionMensaje.style.display = 'none';
                }
            }
        });
    }
    
    // =========================================================================
    // EVENTO: Env√≠o del formulario con validaci√≥n
    // =========================================================================
    if (formEnviarImagenes) {
        formEnviarImagenes.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // =====================================================================
            // VALIDACI√ìN 1: Verificar que el email del cliente sea v√°lido
            // =====================================================================
            const btnSubmit = document.getElementById('btnEnviarImagenes');
            if (btnSubmit && btnSubmit.hasAttribute('data-email-invalido')) {
                alert(
                    '‚ùå No se puede enviar el correo\n\n' +
                    'El email del cliente no est√° configurado o es inv√°lido.\n' +
                    'Por favor, actualiza el email del cliente antes de intentar enviar las im√°genes.\n\n' +
                    'Usa el bot√≥n "Editar Email del Cliente Ahora" para configurarlo.'
                );
                return;
            }
            
            // =====================================================================
            // VALIDACI√ìN 2: Verificar que se hayan seleccionado im√°genes
            // =====================================================================
            const imagenesSeleccionadas = document.querySelectorAll('.checkbox-imagen:checked').length;
            
            if (imagenesSeleccionadas === 0) {
                alert('‚ö†Ô∏è Debes seleccionar al menos una imagen para enviar.');
                return;
            }
            
            // =====================================================================
            // CONFIRMACI√ìN FINAL: Confirmar env√≠o con el usuario
            // =====================================================================
            const confirmacion = confirm(
                `üìß ¬øConfirmas el env√≠o de ${imagenesSeleccionadas} imagen${imagenesSeleccionadas !== 1 ? 'es' : ''} al cliente?\n\n` +
                'El correo se procesar√° en segundo plano.'
            );
            
            if (!confirmacion) return;
            
            // Deshabilitar bot√≥n y mostrar loader (reusar variable btnSubmit ya declarada arriba)
            let textoOriginal = '';
            
            if (btnSubmit) {
                textoOriginal = btnSubmit.innerHTML;
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
            }
            
            // Preparar datos del formulario
            const formData = new FormData(this);
            
            try {
                // Enviar petici√≥n AJAX con headers correctos
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json',  // Indicar que esperamos JSON
                        'X-Requested-With': 'XMLHttpRequest'  // Indicar que es AJAX
                    },
                    body: formData
                });
                
                // Verificar si la respuesta es JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Si no es JSON, probablemente es un redirect (HTML)
                    // El correo se envi√≥ correctamente, pero el servidor devolvi√≥ HTML
                    console.warn('Respuesta no es JSON, recargando p√°gina...');
                    location.reload();
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Cerrar modal de env√≠o
                    const modalEnviar = bootstrap.Modal.getInstance(document.getElementById('modalEnviarImagenesCliente'));
                    if (modalEnviar) {
                        modalEnviar.hide();
                    }
                    
                    // Construir modal simple de confirmaci√≥n (segundo plano)
                    const cantidadImagenes = data.data ? data.data.imagenes_seleccionadas : imagenesSeleccionadas;
                    const destinatario = data.data ? data.data.destinatario : '';
                    
                    const modalConfirmacionHTML = `
                        <div class="modal fade" id="modalConfirmacionEnvioImagenes" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">
                                            <i class="bi bi-send-check"></i> Im√°genes en Proceso
                                        </h5>
                                    </div>
                                    <div class="modal-body">
                                        <div class="text-center mb-3">
                                            <i class="bi bi-gear" style="font-size: 3rem; color: #198754;"></i>
                                        </div>
                                        <p class="text-center fs-5 mb-2">
                                            <strong>${cantidadImagenes}</strong> imagen${cantidadImagenes !== 1 ? 'es' : ''} 
                                            se enviar√°n <strong>en segundo plano</strong> a <strong>${destinatario}</strong>.
                                        </p>
                                        <p class="text-center text-muted mb-0">
                                            <i class="bi bi-info-circle me-1"></i>
                                            La compresi√≥n y env√≠o se est√°n procesando. Puedes continuar trabajando normalmente.
                                        </p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" onclick="location.reload()">
                                            <i class="bi bi-check-lg"></i> Aceptar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Agregar modal al DOM si no existe
                    let modalConfirmacion = document.getElementById('modalConfirmacionEnvioImagenes');
                    if (modalConfirmacion) {
                        modalConfirmacion.remove();
                    }
                    document.body.insertAdjacentHTML('beforeend', modalConfirmacionHTML);
                    
                    // Mostrar modal de confirmaci√≥n
                    modalConfirmacion = new bootstrap.Modal(document.getElementById('modalConfirmacionEnvioImagenes'));
                    modalConfirmacion.show();
                    
                } else {
                    // Error del servidor
                    alert('‚ùå Error al enviar el correo:\n\n' + (data.error || 'Error desconocido'));
                }
                
            } catch (error) {
                console.error('Error al enviar correo:', error);
                alert('‚ùå Error de conexi√≥n al enviar el correo.\n\nPor favor, verifica tu conexi√≥n a internet e intenta nuevamente.');
            } finally {
                // Restaurar bot√≥n solo si existe
                if (btnSubmit) {
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = textoOriginal;
                }
            }
        });
    }
    
    // =========================================================================
    // INICIALIZACI√ìN: Actualizar contador al cargar
    // =========================================================================
    actualizarContador();
    
    // =========================================================================
    // HOVER EFFECT: Resaltar cards al pasar el mouse
    // =========================================================================
    // EXPLICACI√ìN PARA PRINCIPIANTES:
    // Las cards de im√°genes usan .imagen-selectable, pero el checkbox dentro
    // puede ser .checkbox-imagen (modal im√°genes al cliente) o 
    // .checkbox-imagen-diag (modal diagn√≥stico). Buscamos ambos para evitar
    // un error de null cuando querySelector no encuentra la clase correcta.
    document.querySelectorAll('.imagen-selectable').forEach(card => {
        card.addEventListener('mouseenter', function() {
            const checkbox = this.querySelector('.checkbox-imagen') || this.querySelector('.checkbox-imagen-diag');
            if (checkbox && !checkbox.checked) {
                this.style.transform = 'scale(1.05)';
                this.style.transition = 'transform 0.2s ease';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>

<!-- ============================================================================ -->
<!-- SCRIPT: AUTOCOMPLETADO DE MODELOS EN MODAL DE EDICI√ìN -->
<!-- ============================================================================ -->
<!-- 
    EXPLICACI√ìN:
    Este script habilita la funcionalidad de autocompletado inteligente del campo
    "Modelo" dentro del modal de edici√≥n de informaci√≥n del equipo.
    
    CARACTER√çSTICAS:
    - Se activa autom√°ticamente cuando el modal se abre
    - Convierte el campo en un Select2 con b√∫squeda AJAX
    - Muestra modelos disponibles con badges de gama (Alta/Media/Baja)
    - Permite escribir modelos personalizados si no existen en la base
    - Se limpia autom√°ticamente al cerrar el modal (previene memory leaks)
    
    COMPILADO DESDE: static/ts/modelo_autocomplete_modal.ts
-->
<script src="{% static 'js/modelo_autocomplete_modal.js' %}"></script>

<!-- ============================================================
    CONTROL DEL BOT√ìN FLOTANTE "IR A GALER√çA DE IM√ÅGENES"
    ============================================================
    FUNCIONALIDAD:
    - Bot√≥n flotante FAB que permite navegar r√°pidamente a la galer√≠a
    - Aparece despu√©s de 300px de scroll
    - Se oculta autom√°ticamente cuando la galer√≠a est√° visible
    - Scroll suave animado con efecto de highlight en destino
    - No interfiere con el bot√≥n "scroll to top" existente
    ============================================================ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnIrGaleria = document.getElementById('btnIrGaleria');
    const seccionGaleria = document.getElementById('galeria-imagenes');
    
    if (!btnIrGaleria || !seccionGaleria) return;
    
    // Funci√≥n para verificar si la galer√≠a est√° visible en viewport
    function verificarVisibilidadGaleria() {
        const galeriaRect = seccionGaleria.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        
        // Si la galer√≠a est√° visible en viewport, ocultar bot√≥n
        const galeriaVisible = galeriaRect.top < windowHeight && galeriaRect.bottom > 0;
        
        if (galeriaVisible) {
            btnIrGaleria.classList.remove('visible');
        } else if (window.scrollY > 300) {
            // Solo mostrar si hemos scrolleado al menos 300px
            btnIrGaleria.classList.add('visible');
        } else {
            btnIrGaleria.classList.remove('visible');
        }
    }
    
    // Verificar al hacer scroll
    window.addEventListener('scroll', verificarVisibilidadGaleria);
    
    // Verificar al cargar la p√°gina
    setTimeout(verificarVisibilidadGaleria, 100);
    
    // Acci√≥n al hacer click: scroll suave a la galer√≠a
    btnIrGaleria.addEventListener('click', function() {
        seccionGaleria.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
        });
        
        // Efecto visual: resaltar brevemente la galer√≠a al llegar
        setTimeout(function() {
            seccionGaleria.classList.add('highlight-section');
            setTimeout(() => {
                seccionGaleria.classList.remove('highlight-section');
            }, 2000);
        }, 500); // Esperar a que termine el scroll
    });
});
</script>

{% endblock %}
