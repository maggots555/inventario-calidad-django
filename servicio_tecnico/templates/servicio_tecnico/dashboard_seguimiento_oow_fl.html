{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Seguimiento OOW-/FL- - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- Estilos espec√≠ficos del dashboard OOW-/FL- -->
<link rel="stylesheet" href="{% static 'css/dashboard_oow_fl.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <!-- ====================================================================
         ENCABEZADO DEL DASHBOARD
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-graph-up-arrow"></i>
                        Dashboard de Seguimiento OOW-/FL-
                    </h2>
                    <p class="text-muted mb-0">
                        An√°lisis completo y m√©tricas de √≥rdenes con prefijo OOW- y FL-
                    </p>
                </div>
                <div>
                    {% if total_alertas > 0 %}
                    <span class="badge bg-danger fs-5">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        {{ total_alertas }} Alerta{{ total_alertas|pluralize }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================
         SECCI√ìN DE FILTROS
         ==================================================================== -->
    <div class="filter-section">
        <form method="get" id="formFiltros" class="row g-3">
            <div class="col-md-3">
                <label for="prefijo" class="form-label fw-bold">
                    <i class="bi bi-funnel"></i> Prefijo
                </label>
                <select name="prefijo" id="prefijo" class="form-select">
                    <option value="ambos" {% if filtros.prefijo == 'ambos' %}selected{% endif %}>
                        OOW- y FL- (Ambos)
                    </option>
                    <option value="OOW" {% if filtros.prefijo == 'OOW' %}selected{% endif %}>
                        Solo OOW-
                    </option>
                    <option value="FL" {% if filtros.prefijo == 'FL' %}selected{% endif %}>
                        Solo FL-
                    </option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="responsable_id" class="form-label fw-bold">
                    <i class="bi bi-person-badge"></i> Responsable
                </label>
                <select name="responsable_id" id="responsable_id" class="form-select">
                    <option value="">Todos los responsables</option>
                    {% for responsable in lista_responsables %}
                    <option value="{{ responsable.id }}" 
                            {% if filtros.responsable_id|stringformat:"s" == responsable.id|stringformat:"s" %}selected{% endif %}>
                        {{ responsable.nombre_completo }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="fecha_desde" class="form-label fw-bold">
                    <i class="bi bi-calendar-event"></i> Desde
                </label>
                <input type="date" name="fecha_desde" id="fecha_desde" 
                       class="form-control" value="{{ filtros.fecha_desde }}">
            </div>
            
            <div class="col-md-2">
                <label for="fecha_hasta" class="form-label fw-bold">
                    <i class="bi bi-calendar-event"></i> Hasta
                </label>
                <input type="date" name="fecha_hasta" id="fecha_hasta" 
                       class="form-control" value="{{ filtros.fecha_hasta }}">
            </div>
            
            <div class="col-md-2">
                <label for="estado" class="form-label fw-bold">
                    <i class="bi bi-list-check"></i> Estado
                </label>
                <select name="estado" id="estado" class="form-select">
                    <option value="">Todos los estados</option>
                    {% for codigo, nombre in lista_estados %}
                    <option value="{{ codigo }}" {% if filtros.estado == codigo %}selected{% endif %}>
                        {{ nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="sucursal_id" class="form-label fw-bold">
                    <i class="bi bi-building"></i> Sucursal
                </label>
                <select name="sucursal_id" id="sucursal_id" class="form-select">
                    <option value="">Todas las sucursales</option>
                    {% for sucursal in lista_sucursales %}
                    <option value="{{ sucursal.id }}" 
                            {% if filtros.sucursal_id|stringformat:"s" == sucursal.id|stringformat:"s" %}selected{% endif %}>
                        {{ sucursal.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-9 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Aplicar Filtros
                </button>
                <a href="{% url 'servicio_tecnico:dashboard_seguimiento_oow_fl' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Limpiar
                </a>
                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </button>
            </div>
        </form>
    </div>
    
    <!-- ====================================================================
         TARJETAS DE M√âTRICAS GENERALES
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #667eea;">
                <div class="card-body">
                    <p class="metric-value text-primary">{{ metricas.total_ordenes }}</p>
                    <p class="metric-label">Total √ìrdenes OOW-/FL-</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #f093fb;">
                <div class="card-body">
                    <p class="metric-value text-info">{{ metricas.total_ventas_mostrador }}</p>
                    <p class="metric-label">Ventas Mostrador</p>
                    <small class="text-muted">${{ metricas.monto_ventas_mostrador|floatformat:2 }}</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #4facfe;">
                <div class="card-body">
                    <p class="metric-value text-success">{{ metricas.ordenes_activas }}</p>
                    <p class="metric-label">√ìrdenes en Proceso</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #43e97b;">
                <div class="card-body">
                    <p class="metric-value text-dark">{{ metricas.ordenes_entregadas }}</p>
                    <p class="metric-label">√ìrdenes Entregadas</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Segunda fila de m√©tricas -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #fa709a;">
                <div class="card-body">
                    <p class="metric-value text-warning">${{ metricas.monto_total|floatformat:2 }}</p>
                    <p class="metric-label">Monto Total Generado</p>
                    <small class="text-muted">
                        Ventas + Cotizaciones
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #fccb90;">
                <div class="card-body">
                    <p class="metric-value">{{ metricas.tiempo_promedio }}</p>
                    <p class="metric-label">D√≠as Promedio (H√°biles)</p>
                    <small class="text-muted">Tiempo de servicio</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #a8edea;">
                <div class="card-body">
                    <!-- ENCABEZADO: TOTAL -->
                    <div class="mb-3 pb-3 border-bottom">
                        <p class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-text"></i> Total Cotizaciones
                        </p>
                        <p class="metric-value text-primary mb-0">{{ metricas.total_con_cotizacion }}</p>
                    </div>
                    
                    <!-- DESGLOSE: 3 FILAS CON COLORES DIFERENCIADOS -->
                    <div class="cotizaciones-desglose">
                        <!-- ACEPTADAS -->
                        <div class="estado-item estado-aceptadas">
                            <strong class="text-success">{{ metricas.cotizaciones_aceptadas }}</strong>
                            <small>
                                <span class="d-block fw-bold">‚úÖ Aceptadas</span>
                                <span class="text-muted">Listas para reparar</span>
                            </small>
                        </div>
                        
                        <!-- PENDIENTES -->
                        <div class="estado-item estado-pendientes">
                            <strong class="text-warning">{{ metricas.cotizaciones_pendientes }}</strong>
                            <small>
                                <span class="d-block fw-bold">‚è≥ Pendientes</span>
                                <span class="text-muted">Esperando respuesta</span>
                            </small>
                        </div>
                        
                        <!-- RECHAZADAS -->
                        <div class="estado-item estado-rechazadas">
                            <strong class="text-danger">{{ metricas.cotizaciones_rechazadas }}</strong>
                            <small>
                                <span class="d-block fw-bold">‚ùå Rechazadas</span>
                                <span class="text-muted">Cliente no acept√≥</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="border-left-color: #d299c2;">
                <div class="card-body">
                    <p class="metric-value">{{ metricas.porcentaje_en_tiempo }}%</p>
                    <p class="metric-label">En Tiempo (‚â§15 d√≠as)</p>
                    <small class="text-muted">Cumplimiento SLA</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================
         ALERTAS Y ATENCI√ìN REQUERIDA
         ==================================================================== -->
    {% if total_alertas > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Alertas y Atenci√≥n Requerida ({{ total_alertas }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if alertas.retrasadas %}
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-danger mb-0">
                                <h6 class="alert-heading">
                                    <i class="bi bi-clock-history"></i>
                                    √ìrdenes Retrasadas (>15 d√≠as)
                                    <span class="badge bg-dark">{{ alertas.retrasadas|length }}</span>
                                </h6>
                                <ul class="mb-0 ps-3">
                                    {% for item in alertas.retrasadas|slice:":5" %}
                                    <li>
                                        <a href="{% url 'servicio_tecnico:detalle_orden' item.orden.id %}" class="text-dark">
                                            {{ item.orden.detalle_equipo.orden_cliente }} - 
                                            <strong>{{ item.dias }} d√≠as h√°biles</strong>
                                        </a>
                                    </li>
                                    {% endfor %}
                                    {% if alertas.retrasadas|length > 5 %}
                                    <li class="text-muted">... y {{ alertas.retrasadas|length|add:"-5" }} m√°s</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if alertas.sin_actualizacion %}
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-warning mb-0">
                                <h6 class="alert-heading">
                                    <i class="bi bi-hourglass-split"></i>
                                    Sin Actualizaci√≥n (>5 d√≠as)
                                    <span class="badge bg-dark">{{ alertas.sin_actualizacion|length }}</span>
                                </h6>
                                <ul class="mb-0 ps-3">
                                    {% for item in alertas.sin_actualizacion|slice:":5" %}
                                    <li>
                                        <a href="{% url 'servicio_tecnico:detalle_orden' item.orden.id %}" class="text-dark">
                                            {{ item.orden.detalle_equipo.orden_cliente }} - 
                                            <strong>{{ item.dias }} d√≠as h√°biles</strong>
                                        </a>
                                    </li>
                                    {% endfor %}
                                    {% if alertas.sin_actualizacion|length > 5 %}
                                    <li class="text-muted">... y {{ alertas.sin_actualizacion|length|add:"-5" }} m√°s</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if alertas.cotizaciones_pendientes %}
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-info mb-0">
                                <h6 class="alert-heading">
                                    <i class="bi bi-file-earmark-text"></i>
                                    Cotizaciones Pendientes (>7 d√≠as)
                                    <span class="badge bg-dark">{{ alertas.cotizaciones_pendientes|length }}</span>
                                </h6>
                                <ul class="mb-0 ps-3">
                                    {% for item in alertas.cotizaciones_pendientes|slice:":5" %}
                                    <li>
                                        <a href="{% url 'servicio_tecnico:detalle_orden' item.orden.id %}" class="text-dark">
                                            {{ item.orden.detalle_equipo.orden_cliente }} - 
                                            <strong>{{ item.dias }} d√≠as sin respuesta</strong>
                                        </a>
                                    </li>
                                    {% endfor %}
                                    {% if alertas.cotizaciones_pendientes|length > 5 %}
                                    <li class="text-muted">... y {{ alertas.cotizaciones_pendientes|length|add:"-5" }} m√°s</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if alertas.en_reparacion_larga %}
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-secondary mb-0">
                                <h6 class="alert-heading">
                                    <i class="bi bi-wrench"></i>
                                    En Reparaci√≥n Prolongada (>10 d√≠as)
                                    <span class="badge bg-dark">{{ alertas.en_reparacion_larga|length }}</span>
                                </h6>
                                <ul class="mb-0 ps-3">
                                    {% for item in alertas.en_reparacion_larga|slice:":5" %}
                                    <li>
                                        <a href="{% url 'servicio_tecnico:detalle_orden' item.orden.id %}" class="text-dark">
                                            {{ item.orden.detalle_equipo.orden_cliente }} - 
                                            <strong>{{ item.dias }} d√≠as en reparaci√≥n</strong>
                                        </a>
                                    </li>
                                    {% endfor %}
                                    {% if alertas.en_reparacion_larga|length > 5 %}
                                    <li class="text-muted">... y {{ alertas.en_reparacion_larga|length|add:"-5" }} m√°s</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ====================================================================
         GR√ÅFICOS PRINCIPALES
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart-fill"></i>
                        √ìrdenes por Responsable de Seguimiento
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartResponsables"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-pie-chart-fill"></i>
                        Distribuci√≥n por Estado
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartDistribucionEstados"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="bi bi-hourglass-split"></i>
                        D√≠as Promedio por Estatus (D√≠as H√°biles)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartDiasEstatus"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Evoluci√≥n Mensual (√öltimos 6 Meses)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartEvolucionMensual"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================
         NUEVOS GR√ÅFICOS: VENTAS MOSTRADOR
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card h-100 chart-card">
                <div class="card-header d-flex align-items-center gap-2">
                    <i class="bi bi-cart-fill" style="color: #f093fb; font-size: 1.25rem;"></i>
                    <h6 class="mb-0" style="color: #333;">
                        Ventas Mostrador por Responsable
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if grafico_ventas_mostrador_responsables.labels|length > 0 %}
                        <div class="chart-container chart-horizontal flex-grow-1">
                            <canvas id="chartVentasMostradorResponsables"></canvas>
                        </div>
                        <div class="mt-3 small text-muted">
                            <p class="mb-0">
                                <strong>üìä Informaci√≥n:</strong>
                                Muestra el monto total en ventas mostrador por cada responsable,
                                con el tipo de producto predominante.
                            </p>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0 align-self-center">
                            <i class="bi bi-inbox"></i> No hay datos de ventas mostrador para mostrar.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-3">
            <div class="card h-100 chart-card">
                <div class="card-header d-flex align-items-center gap-2 top-productos">
                    <i class="bi bi-star-fill" style="color: #43e97b; font-size: 1.25rem;"></i>
                    <h6 class="mb-0" style="color: #333;">
                        TOP 5 Productos M√°s Vendidos
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if grafico_top_productos.labels|length > 0 %}
                        <div class="chart-container chart-vertical flex-grow-1">
                            <canvas id="chartTopProductos"></canvas>
                        </div>
                        <div class="mt-3 small text-muted">
                            <p class="mb-0">
                                <strong>üìà Informaci√≥n:</strong>
                                Ranking de las 5 piezas/productos m√°s vendidas en mostrador,
                                ordenadas por cantidad de unidades vendidas.
                            </p>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0 align-self-center">
                            <i class="bi bi-inbox"></i> No hay productos vendidos para mostrar.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================
         DATOS POR RESPONSABLE DE SEGUIMIENTO
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill"></i>
                        Desempe√±o por Responsable de Seguimiento
                    </h5>
                </div>
                <div class="card-body">
                    {% if responsables %}
                        {% for resp in responsables %}
                        <div class="responsable-section">
                            <div class="responsable-header" data-bs-toggle="collapse" 
                                 data-bs-target="#responsable{{ resp.id }}" 
                                 aria-expanded="false">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="bi bi-person-circle"></i>
                                        {{ resp.nombre }}
                                    </h6>
                                    <small>{{ resp.total_ordenes }} orden{{ resp.total_ordenes|pluralize:"es" }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-light text-dark me-2">
                                        {{ resp.tiempo_promedio }} d√≠as promedio
                                    </span>
                                    <i class="bi bi-chevron-down"></i>
                                </div>
                            </div>
                            <div class="collapse responsable-body" id="responsable{{ resp.id }}">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card bg-light mb-2">
                                            <div class="card-body py-2">
                                                <small class="text-muted d-block">Activas</small>
                                                <strong class="fs-5">{{ resp.ordenes_activas }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light mb-2">
                                            <div class="card-body py-2">
                                                <small class="text-muted d-block">Entregadas</small>
                                                <strong class="fs-5">{{ resp.ordenes_entregadas }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light mb-2">
                                            <div class="card-body py-2">
                                                <small class="text-muted d-block">Ventas Mostrador</small>
                                                <strong class="fs-5">{{ resp.ventas_mostrador }}</strong>
                                                <small class="text-muted d-block">${{ resp.monto_ventas_mostrador|floatformat:2 }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card h-100 mb-2">
                                            <div class="card-body py-2">
                                                <small class="text-muted d-block mb-2">
                                                    <i class="bi bi-file-earmark-check"></i> Cotizaciones
                                                </small>
                                                
                                                {% if resp.con_cotizacion > 0 %}
                                                    <!-- Desglose de cotizaciones -->
                                                    <div class="cotizaciones-desglose-compact">
                                                        <div class="estado-item-compact estado-aceptadas-compact" title="Cotizaciones Aceptadas">
                                                            <span class="estado-numero">‚úÖ {{ resp.cotizaciones_aceptadas }}</span>
                                                        </div>
                                                        {% if resp.cotizaciones_pendientes > 0 %}
                                                        <div class="estado-item-compact estado-pendientes-compact" title="Cotizaciones Pendientes">
                                                            <span class="estado-numero">‚è≥ {{ resp.cotizaciones_pendientes }}</span>
                                                        </div>
                                                        {% endif %}
                                                        {% if resp.cotizaciones_rechazadas > 0 %}
                                                        <div class="estado-item-compact estado-rechazadas-compact" title="Cotizaciones Rechazadas">
                                                            <span class="estado-numero">‚ùå {{ resp.cotizaciones_rechazadas }}</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <small class="text-muted d-block mt-2">
                                                        Total: ${{ resp.monto_cotizaciones|floatformat:2 }}
                                                    </small>
                                                {% else %}
                                                    <span class="badge bg-secondary">Sin cotizaciones</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <div class="card bg-success text-white">
                                            <div class="card-body py-2">
                                                <small class="d-block">Monto Total Generado</small>
                                                <strong class="fs-5">${{ resp.monto_total|floatformat:2 }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-info text-white">
                                            <div class="card-body py-2">
                                                <small class="d-block">Tasa de Entrega</small>
                                                <strong class="fs-5">{{ resp.tasa_finalizacion }}%</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <a href="?responsable_id={{ resp.id }}&prefijo={{ filtros.prefijo }}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="bi bi-filter"></i> Filtrar solo este responsable
                                    </a>
                                </div>
                                
                                <!-- TABLA: DESGLOSE DE VENTAS MOSTRADOR POR RESPONSABLE -->
                                {% if resp.monto_ventas_mostrador > 0 %}
                                <div class="mt-4 pt-3 border-top">
                                    <h6 class="mb-3">
                                        <i class="bi bi-basket-fill"></i>
                                        Desglose de Ventas Mostrador
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 50%;">Producto / Servicio</th>
                                                    <th style="width: 15%;" class="text-center">Cantidad</th>
                                                    <th style="width: 35%;" class="text-end">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% comment %} Esta tabla ser√° poblada por JavaScript usando los datos del gr√°fico {% endcomment %}
                                                <tr id="desglose-{{ resp.id }}-empty">
                                                    <td colspan="3" class="text-center text-muted">
                                                        Cargando datos...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mb-0">
                            No hay datos de responsables con los filtros aplicados.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================
         TABLA: D√çAS PROMEDIO POR ESTATUS
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i>
                        D√≠as Promedio por Estatus (D√≠as H√°biles)
                    </h5>
                </div>
                <div class="card-body">
                    {% if dias_por_estatus %}
                    <div class="table-responsive">
                        <table class="table table-dashboard table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Estado</th>
                                    <th>Promedio (d√≠as h√°biles)</th>
                                    <th>M√≠nimo</th>
                                    <th>M√°ximo</th>
                                    <th>Total √ìrdenes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for estado, stats in dias_por_estatus.items %}
                                <tr>
                                    <td><strong>{{ estado|title }}</strong></td>
                                    <td>
                                        <span class="badge {% if stats.promedio <= 2 %}bg-success{% elif stats.promedio <= 5 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ stats.promedio }} d√≠as
                                        </span>
                                    </td>
                                    <td>{{ stats.min }} d√≠as</td>
                                    <td>{{ stats.max }} d√≠as</td>
                                    <td>{{ stats.total_ordenes }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        No hay datos suficientes para calcular promedios por estatus.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================
         TABLA: EVOLUCI√ìN MENSUAL
         ==================================================================== -->
    {% if datos_mensuales %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar3"></i>
                        Evoluci√≥n Mensual
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dashboard table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th>Total √ìrdenes</th>
                                    <th>Finalizadas</th>
                                    <th>Entregadas</th>
                                    <th>Ventas Mostrador</th>
                                    <th>Cotizaciones Aceptadas</th>
                                    <th>Monto Total</th>
                                    <th>D√≠as Promedio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mes in datos_mensuales %}
                                <tr>
                                    <td><strong>{{ mes.mes }}</strong></td>
                                    <td>{{ mes.total_ordenes }}</td>
                                    <td>{{ mes.ordenes_finalizadas }}</td>
                                    <td>{{ mes.ordenes_entregadas }}</td>
                                    <td>{{ mes.ventas_mostrador }}</td>
                                    <td>{{ mes.cotizaciones_aceptadas }}</td>
                                    <td>${{ mes.monto_total|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge {% if mes.dias_promedio <= 10 %}bg-success{% elif mes.dias_promedio <= 15 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ mes.dias_promedio }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ====================================================================
         TABLA DETALLADA DE √ìRDENES
         ==================================================================== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i>
                        √ìrdenes Detalladas
                        <span class="badge bg-light text-dark">{{ total_ordenes_tabla }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if ordenes %}
                    <div class="table-responsive">
                        <table class="table table-dashboard table-bordered table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Orden Cliente</th>
                                    <th>N¬∞ Orden</th>
                                    <th>Tipo Equipo</th>
                                    <th>Marca/Modelo</th>
                                    <th>Responsable</th>
                                    <th>Estado</th>
                                    <th>D√≠as H√°biles</th>
                                    <th>Sucursal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for orden in ordenes %}
                                <tr>
                                    <td><strong>{{ orden.detalle_equipo.orden_cliente }}</strong></td>
                                    <td>{{ orden.numero_orden_interno }}</td>
                                    <td>{{ orden.detalle_equipo.get_tipo_equipo_display }}</td>
                                    <td>
                                        {{ orden.detalle_equipo.marca }}
                                        <small class="text-muted d-block">{{ orden.detalle_equipo.modelo|truncatechars:30 }}</small>
                                    </td>
                                    <td>{{ orden.responsable_seguimiento.nombre_completo|truncatechars:25 }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if orden.estado == 'entregado' %}bg-success
                                            {% elif orden.estado == 'finalizado' %}bg-info
                                            {% elif orden.estado == 'reparacion' %}bg-warning
                                            {% elif orden.estado == 'cancelado' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ orden.get_estado_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ orden.color_dias_sin_actualizacion }}">
                                            {{ orden.dias_habiles_en_servicio }}
                                        </span>
                                        {% if orden.dias_sin_actualizacion_estado > 5 %}
                                        <i class="bi bi-exclamation-triangle-fill text-danger" 
                                           title="{{ orden.dias_sin_actualizacion_estado }} d√≠as sin actualizar"></i>
                                        {% endif %}
                                    </td>
                                    <td>{{ orden.sucursal.nombre|truncatechars:20 }}</td>
                                    <td>
                                        <a href="{% url 'servicio_tecnico:detalle_orden' orden.id %}" 
                                           class="btn btn-sm btn-primary" 
                                           title="Ver detalle completo">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if total_ordenes_tabla > 100 %}
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle"></i>
                        <strong>Nota:</strong> Mostrando las primeras 100 √≥rdenes de {{ total_ordenes_tabla }} totales.
                        Usa los filtros para refinar los resultados.
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        No hay √≥rdenes con los filtros aplicados.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ========================================================================
// CONFIGURACI√ìN DE GR√ÅFICOS CON CHART.JS
// ========================================================================

// GR√ÅFICO 1: √ìrdenes por Responsable
const ctxResponsables = document.getElementById('chartResponsables');
if (ctxResponsables) {
    new Chart(ctxResponsables, {
        type: 'bar',
        data: {
            labels: {{ grafico_responsables.labels|safe }},
            datasets: [{
                label: '√ìrdenes',
                data: {{ grafico_responsables.data|safe }},
                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// GR√ÅFICO 2: Distribuci√≥n por Estado (Pie)
const ctxDistribucion = document.getElementById('chartDistribucionEstados');
if (ctxDistribucion) {
    new Chart(ctxDistribucion, {
        type: 'pie',
        data: {
            labels: {{ grafico_distribucion_estados.labels|safe }},
            datasets: [{
                data: {{ grafico_distribucion_estados.data|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
}

// GR√ÅFICO 3: D√≠as por Estatus
const ctxDiasEstatus = document.getElementById('chartDiasEstatus');
if (ctxDiasEstatus) {
    new Chart(ctxDiasEstatus, {
        type: 'bar',
        data: {
            labels: {{ grafico_dias_estatus.labels|safe }},
            datasets: [{
                label: 'D√≠as H√°biles Promedio',
                data: {{ grafico_dias_estatus.data|safe }},
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
}

// GR√ÅFICO 4: Evoluci√≥n Mensual
const ctxEvolucion = document.getElementById('chartEvolucionMensual');
if (ctxEvolucion) {
    new Chart(ctxEvolucion, {
        type: 'line',
        data: {
            labels: {{ grafico_evolucion_mensual.labels|safe }},
            datasets: [
                {
                    label: 'Total √ìrdenes',
                    data: {{ grafico_evolucion_mensual.data_ordenes|safe }},
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Finalizadas',
                    data: {{ grafico_evolucion_mensual.data_finalizadas|safe }},
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    tension: 0.4
                },
                {
                    label: 'Entregadas',
                    data: {{ grafico_evolucion_mensual.data_entregadas|safe }},
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 5
                    }
                }
            }
        }
    });
}

// ========================================================================
// GR√ÅFICO 5: VENTAS MOSTRADOR POR RESPONSABLE (NUEVO)
// ========================================================================
const ctxVentasMostrador = document.getElementById('chartVentasMostradorResponsables');
if (ctxVentasMostrador && {{ grafico_ventas_mostrador_responsables.labels|safe|length }} > 0) {
    // Preparar tooltips con desglose detallado de productos
    const desgloseData = {{ grafico_ventas_mostrador_responsables.desglose|safe }};
    
    const ventasTooltip = {
        callbacks: {
            title: function(context) {
                return context[0].label + ' - Total: $' + 
                       context[0].parsed.x.toLocaleString('es-CO', {
                           minimumFractionDigits: 0,
                           maximumFractionDigits: 0
                       });
            },
            label: function(context) {
                return '';  // Vac√≠o para que no muestre la l√≠nea por defecto
            },
            afterLabel: function(context) {
                const respIndex = context.dataIndex;
                const productos = desgloseData[respIndex];
                
                if (!productos || productos.length === 0) {
                    return 'Sin desglose disponible';
                }
                
                let lineas = [];
                productos.forEach((producto, idx) => {
                    const desc = producto.descripcion.substring(0, 35);
                    const cantidad = producto.cantidad;
                    const monto = producto.subtotal.toLocaleString('es-CO', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    lineas.push('  ‚Ä¢ ' + desc + ' - ' + cantidad + 'x ($' + monto + ')');
                });
                
                return lineas.join('\n');
            },
            padding: 10,
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#f093fb',
            borderWidth: 1
        }
    };
    
    new Chart(ctxVentasMostrador, {
        type: 'bar',
        data: {
            labels: {{ grafico_ventas_mostrador_responsables.labels|safe }},
            datasets: [{
                label: 'Ventas Mostrador ($)',
                data: {{ grafico_ventas_mostrador_responsables.data|safe }},
                backgroundColor: 'rgba(240, 147, 251, 0.7)',
                borderColor: 'rgba(240, 147, 251, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: ventasTooltip
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString('es-CO', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            });
                        }
                    }
                }
            }
        }
    });
}

// ========================================================================
// GR√ÅFICO 6: TOP PRODUCTOS VENDIDOS (NUEVO)
// ========================================================================
const ctxTopProductos = document.getElementById('chartTopProductos');
if (ctxTopProductos && {{ grafico_top_productos.labels|safe|length }} > 0) {
    // Preparar tooltips con monto total
    const productosTooltip = {
        callbacks: {
            label: function(context) {
                const cantidad = context.parsed.y;
                const montoIndex = context.dataIndex;
                const montos = {{ grafico_top_productos.montos|safe }};
                const monto = montos[montoIndex];
                
                return [
                    'Unidades: ' + cantidad,
                    'Total: $' + monto.toLocaleString('es-CO', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    })
                ];
            }
        }
    };
    
    new Chart(ctxTopProductos, {
        type: 'bar',
        data: {
            labels: {{ grafico_top_productos.labels|safe }},
            datasets: [{
                label: 'Cantidad Vendida (unidades)',
                data: {{ grafico_top_productos.data|safe }},
                backgroundColor: 'rgba(67, 233, 123, 0.7)',
                borderColor: 'rgba(67, 233, 123, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'x',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: productosTooltip
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// ========================================================================
// FUNCI√ìN: POBLAR TABLAS DE DESGLOSE DE VENTAS POR RESPONSABLE
// ========================================================================
function poblarTableasDesglose() {
    // Obtener datos del gr√°fico de ventas mostrador
    const labels = {{ grafico_ventas_mostrador_responsables.labels|safe }};
    const desgloseData = {{ grafico_ventas_mostrador_responsables.desglose|safe }};
    
    // Obtener los IDs de responsables desde el HTML
    const responsableSections = document.querySelectorAll('.responsable-section');
    let indiceGrafico = 0;
    
    responsableSections.forEach((section) => {
        // Obtener el ID del responsable desde el atributo data-bs-target del header
        const header = section.querySelector('.responsable-header');
        const targetId = header.getAttribute('data-bs-target');
        const respId = targetId.replace('#responsable', '');
        
        // Obtener la tabla de desglose de este responsable
        const tabla = section.querySelector('tbody');
        const emptyRow = section.querySelector('[id^="desglose-"]');
        
        if (tabla && emptyRow) {
            // Buscar si este responsable tiene desglose en los datos del gr√°fico
            const respIndex = labels.findIndex(label => {
                // Comparar el √≠ndice con el orden en que aparecen en responsables
                return tabla.closest('.collapse').id.includes(respId);
            });
            
            // Usar el √≠ndice del responsable que tiene ventas mostrador
            const desgloseResponsable = desgloseData[indiceGrafico];
            
            if (desgloseResponsable && desgloseResponsable.length > 0) {
                // Limpiar la fila vac√≠a
                emptyRow.remove();
                
                // Agregar cada producto al desglose
                desgloseResponsable.forEach((producto) => {
                    const fila = document.createElement('tr');
                    const descripcion = producto.descripcion.substring(0, 50);
                    const cantidad = producto.cantidad;
                    const subtotal = producto.subtotal.toLocaleString('es-CO', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2,
                        currency: 'COP'
                    });
                    
                    fila.innerHTML = `
                        <td>${descripcion}</td>
                        <td class="text-center"><span class="badge bg-info">${cantidad}</span></td>
                        <td class="text-end"><strong>$${subtotal}</strong></td>
                    `;
                    
                    tabla.appendChild(fila);
                });
                
                indiceGrafico++;
            }
        }
    });
}

// ========================================================================
// FUNCI√ìN DE EXPORTACI√ìN A EXCEL (Placeholder)
// ========================================================================
function exportarExcel() {
    alert('Funci√≥n de exportaci√≥n a Excel en desarrollo.\nPr√≥ximamente podr√°s descargar el reporte completo.');
    // TODO: Implementar exportaci√≥n real
}

// ========================================================================
// INICIALIZAR TABLAS DE DESGLOSE
// ========================================================================
document.addEventListener('DOMContentLoaded', function() {
    poblarTableasDesglose();
});
</script>
{% endblock %}
